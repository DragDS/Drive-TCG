<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617 55%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem 1.25rem 2.5rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .nav-btn {
      border-radius: 999px;
      padding: 0.3rem 0.9rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      color: #e5e7eb;
      font-size: 0.82rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease,
        transform 0.1s ease;
    }

    .nav-btn span {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .nav-btn:hover {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-color: #374151;
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: radial-gradient(circle at top left, #1d4ed8, #020617);
      border-color: #1d4ed8;
    }

    .panel {
      border-radius: 1rem;
      border: 1px solid #1f2937;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), #020617);
      padding: 1rem;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.8);
    }

    .panel h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
      letter-spacing: 0.04em;
    }

    .panel h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.4rem;
      font-size: 0.9rem;
      letter-spacing: 0.02em;
    }

    .layout-two {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap: 1rem;
    }

    .layout-three {
      display: grid;
      grid-template-columns: 0.9fr 1.1fr 1.1fr;
      gap: 1rem;
    }

    @media (max-width: 960px) {
      .layout-two,
      .layout-three {
        grid-template-columns: 1fr;
      }
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }

    .toolbar .spacer {
      flex: 1;
    }

    .button {
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      background: radial-gradient(circle at top left, #1d4ed8, #1e293b);
      color: #e5e7eb;
      padding: 0.3rem 0.9rem;
      font-size: 0.82rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      transition: background 0.12s ease, transform 0.08s ease,
        box-shadow 0.12s ease;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
    }

    .button.secondary {
      border-color: #4b5563;
      background: radial-gradient(circle at top left, #111827, #020617);
      box-shadow: none;
    }

    .button.danger {
      border-color: #b91c1c;
      background: radial-gradient(circle at top left, #b91c1c, #111827);
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(37, 99, 235, 0.5);
      background: radial-gradient(circle at top left, #2563eb, #0f172a);
    }

    .button.secondary:hover {
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.7);
    }

    .button.danger:hover {
      box-shadow: 0 6px 14px rgba(185, 28, 28, 0.6);
    }

    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
      margin: 0.1rem 0;
    }

    .status {
      margin-top: 0.25rem;
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .status.ok {
      color: #22c55e;
    }

    .status.error {
      color: #f97316;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    @media (max-width: 720px) {
      .field-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .field label {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    input[type="text"],
    select,
    textarea,
    input[type="file"],
    input[type="number"] {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 0.25rem 0.5rem;
      font-size: 0.82rem;
      outline: none;
      min-height: 1.9rem;
    }

    input[type="text"]:focus,
    select:focus,
    textarea:focus,
    input[type="number"]:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    textarea {
      min-height: 5rem;
      resize: vertical;
    }

    .card-preview {
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(
        circle at top left,
        rgba(148, 163, 184, 0.16),
        #020617
      );
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      padding: 0.6rem;
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
      min-height: 180px;
    }

    .card-preview-img {
      flex: 0 0 40%;
      max-width: 40%;
      background: #020617;
      border-radius: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .card-preview-img img {
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
    }

    .card-preview-body {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.8rem;
    }

    .card-preview-header {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
      align-items: baseline;
    }

    .card-preview-name {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-preview-type {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .card-preview-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .card-preview-label {
      font-weight: 600;
      color: #e5e7eb;
    }

    .card-preview-text {
      border-radius: 0.5rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.4rem 0.5rem;
      white-space: pre-wrap;
      font-size: 0.78rem;
    }

    .bulk-grid {
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      font-size: 0.78rem;
    }

    .bulk-row {
      display: grid;
      grid-template-columns: 2.2rem minmax(0, 2.5fr) minmax(0, 1.5fr)
        minmax(0, 1.5fr) minmax(0, 1.5fr);
      gap: 0.4rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }

    .bulk-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.7);
    }

    .bulk-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.45);
    }

    .bulk-row-header {
      font-weight: 600;
      color: #9ca3af;
      border-bottom: 1px solid #1f2937;
      margin-bottom: 0.2rem;
    }

    .bulk-row input[type="checkbox"] {
      transform: scale(1.1);
    }

    .library-list {
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      font-size: 0.78rem;
    }

    .library-row {
      display: grid;
      grid-template-columns: 2.5rem minmax(0, 3fr) minmax(0, 1.5fr)
        minmax(0, 1.5fr) minmax(0, 1.4fr);
      gap: 0.4rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
      cursor: pointer;
    }

    .library-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.7);
    }

    .library-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.45);
    }

    .library-row.active {
      outline: 1px solid #facc15;
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.8);
    }

    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.05rem 0.4rem;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(640px, calc(100% - 2rem));
      max-height: calc(100vh - 4rem);
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 0.7rem 0.9rem;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 0.9rem;
    }

    .modal-body {
      padding: 0.8rem 0.9rem 0.9rem;
      overflow-y: auto;
      font-size: 0.78rem;
    }

    .modal-close {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      padding: 0.1rem 0.5rem;
      font-size: 0.8rem;
    }

    .modal-close:hover {
      background: #111827;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Admin Panel</h1>
        <p>
          Edit single cards, bulk-import from Excel, and manage preconstructed decks in your browser.
        </p>
      </div>
    </header>

    <nav>
      <button id="navSingleBtn" class="nav-btn active" type="button">
        Single Card Editor
        <span>edit 1 card at a time</span>
      </button>
      <button id="navBulkBtn" class="nav-btn" type="button">
        Bulk Import
        <span>from Excel → JSON</span>
      </button>
      <button id="navPreconsBtn" class="nav-btn" type="button">
        Preconstructed Decks
        <span>drive-precons.json</span>
      </button>
      <button id="navHelpBtn" class="nav-btn" type="button">
        Help / Workflow
        <span>how to use this page</span>
      </button>
    </nav>

    <!-- SINGLE CARD EDITOR -->
    <section id="singleSection" class="panel">
      <h2>Single Card Editor</h2>
      <p class="small-note">
        Works with the in-memory copy of
        <span class="inline-code">drive-card.json</span>. Remember to download
        and upload the updated JSON to GitHub when you’re done.
      </p>

      <div class="layout-two">
        <!-- Left: fields -->
        <div>
          <h3>Card Basics</h3>
          <div class="field-grid">
            <div class="field">
              <label for="cardIdInput">Card ID (internal)</label>
              <input
                id="cardIdInput"
                type="text"
                placeholder="Auto-generated if blank"
              />
              <p class="small-note">
                This isn’t shown on the card. It’s just for the JSON library.
              </p>
            </div>
            <div class="field">
              <label for="cardNameInput">Name</label>
              <input id="cardNameInput" type="text" />
            </div>
            <div class="field">
              <label for="cardTypeInput">Type</label>
              <select id="cardTypeInput">
                <option value="">– Choose Type –</option>
                <option value="Driver">Driver</option>
                <option value="Named Driver">Named Driver</option>
                <option value="Vehicle">Vehicle</option>
                <option value="Named Vehicle">Named Vehicle</option>
                <option value="Crew">Crew</option>
                <option value="Mod">Mod</option>
                <option value="Condition">Condition</option>
                <option value="Track">Track</option>
                <option value="Misc">Misc</option>
              </select>
            </div>
            <div class="field">
              <label for="cardSetNameInput">Set Name</label>
              <input
                id="cardSetNameInput"
                type="text"
                placeholder="1…2…3…RACE!, Junkyard, etc."
              />
            </div>
            <div class="field">
              <label for="cardNumberInput">Card Number</label>
              <input id="cardNumberInput" type="text" placeholder="01, 02A…" />
            </div>
            <div class="field">
              <label for="cardRarityInput">Rarity</label>
              <input id="cardRarityInput" type="text" placeholder="Common, Rare…" />
            </div>
          </div>

          <h3>Traits & Tags</h3>
          <div class="field-grid">
            <div class="field" data-show-for="Track,Vehicle,Named Vehicle">
              <label for="cardVehicleTypesInput">Vehicle Types</label>
              <input
                id="cardVehicleTypesInput"
                type="text"
                placeholder="Drag, Drift, Off-Road…"
              />
              <p class="small-note">Used by Tracks and Vehicles (Vehicle Type column).</p>
            </div>
            <div class="field">
              <label for="cardTagsInput">Tags</label>
              <input
                id="cardTagsInput"
                type="text"
                placeholder="Sponsor, Father’s Day, Junkyard…"
              />
            </div>
          </div>

          <h3>Art, Mods & HP/CON</h3>
          <div class="field-grid">
            <!-- Image URL: shown for all types -->
            <div class="field">
              <label for="cardImageUrlInput">Image URL</label>
              <input
                id="cardImageUrlInput"
                type="text"
                placeholder="images/Set1/DANNYS_R-2-4.png"
              />
              <p class="small-note">
                Relative URL from your site root (same as used on the main card viewer).
              </p>
            </div>

            <!-- Mod-only fields -->
            <div class="field" data-show-for="Mod">
              <label for="modTypeInput">Mod Type</label>
              <input
                id="modTypeInput"
                type="text"
                placeholder="TYPE from Excel (e.g., ALL, Drag)"
              />
            </div>
            <div class="field" data-show-for="Mod">
              <label for="modBasePartInput">Mod – Base Part</label>
              <input
                id="modBasePartInput"
                type="text"
                placeholder="Base Part (Engine, Headers, Tires…)"
              />
            </div>
            <div class="field" data-show-for="Mod">
              <label for="modL1Input">Mod – Level 1</label>
              <input id="modL1Input" type="text" placeholder="Mod Lvl 1 (e.g., 1/2)" />
            </div>
            <div class="field" data-show-for="Mod">
              <label for="modL2Input">Mod – Level 2</label>
              <input id="modL2Input" type="text" placeholder="Mod Lvl 2" />
            </div>
            <div class="field" data-show-for="Mod">
              <label for="modL3Input">Mod – Level 3</label>
              <input id="modL3Input" type="text" placeholder="Mod Lvl 3" />
            </div>
            <div class="field" data-show-for="Mod">
              <label for="modL4Input">Mod – Level 4</label>
              <input id="modL4Input" type="text" placeholder="Mod Lvl 4" />
            </div>

            <!-- Vehicle / Named Vehicle-only fields -->
            <div class="field" data-show-for="Vehicle,Named Vehicle">
              <label for="vehicleHpConInput">Vehicle / Named Vehicle – HP/CON</label>
              <input id="vehicleHpConInput" type="text" placeholder="VEHICLE HP/CON (e.g., 10/4)" />
            </div>
            <div class="field" data-show-for="Vehicle,Named Vehicle">
              <label for="pitCostInput">Pit Cost</label>
              <input
                id="pitCostInput"
                type="number"
                min="0"
                placeholder="PIT COST from Excel"
              />
            </div>

            <!-- Extra JSON always visible, advanced -->
            <div class="field">
              <label for="extraJsonInput">Extra JSON (advanced)</label>
              <input
                id="extraJsonInput"
                type="text"
                placeholder='{"sponsorBrand":"WOLF"}'
              />
            </div>
          </div>

          <h3>Rules Text</h3>
          <div class="field">
            <label for="cardNotesInput">Rules / Trait Text</label>
            <textarea id="cardNotesInput"></textarea>
          </div>

          <div
            style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.4rem;"
          >
            <button id="singleNewBtn" class="button secondary" type="button">
              New Card
            </button>
            <button id="singleSaveBtn" class="button" type="button">
              Save / Update in Library
            </button>
            <button id="singleDeleteBtn" class="button danger" type="button">
              Delete from Library
            </button>
          </div>
          <div id="singleStatus" class="status small-note"></div>
        </div>

        <!-- Right: preview + card library -->
        <div>
          <h3>Preview</h3>
          <div id="singlePreview" class="card-preview">
            <div class="card-preview-img">
              <span class="small-note">No image</span>
            </div>
            <div class="card-preview-body">
              <div class="card-preview-header">
                <div class="card-preview-name">(No Name)</div>
                <div class="card-preview-type">–</div>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Set:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Rarity:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Vehicle Types:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Tags:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Stats:</span>
                <span>–</span>
              </div>
              <div class="card-preview-text">Rules text will appear here.</div>
            </div>
          </div>

          <h3>Card Library (in-memory)</h3>
          <div class="field">
            <input
              id="cardLibrarySearchInput"
              type="text"
              placeholder="Search by name / type / set…"
            />
          </div>
          <div id="cardLibraryList" class="library-list">
            <p class="small-note">
              Library will appear here after loading drive-card.json.
            </p>
          </div>
          <p class="small-note">Click a card to load it into the editor.</p>

          <h3>Save Updated Library</h3>
          <button
            id="downloadCardsJsonBtn"
            class="button secondary"
            type="button"
          >
            Download drive-card.json
          </button>
        </div>
      </div>
    </section>

    <!-- BULK IMPORT SECTION -->
    <section id="bulkSection" class="panel" style="display:none;">
      <h2>Bulk Import from Excel</h2>
      <p class="small-note">
        Load your <span class="inline-code">Drive Cards.xlsx</span>, pick a
        sheet, then select which rows to import into
        <span class="inline-code">drive-card.json</span>. Existing cards with
        the same name + type + set will be updated.
      </p>

      <div class="layout-three">
        <div>
          <h3>Step 1 – Upload Excel &amp; pick sheet</h3>
          <div class="toolbar">
            <input id="bulkFileInput" type="file" accept=".xlsx" />
          </div>
          <div class="field">
            <label for="bulkSheetSelect">Sheet</label>
            <select id="bulkSheetSelect">
              <option value="">– No workbook loaded –</option>
            </select>
          </div>
          <p id="bulkStep1Status" class="status small-note"></p>
          <button
            id="bulkParseSheetBtn"
            class="button"
            type="button"
          >
            Parse Selected Sheet
          </button>
        </div>

        <div>
          <h3>Step 2 – Filter &amp; select cards to include</h3>
          <div class="field">
            <input
              id="bulkSearchInput"
              type="text"
              placeholder="Filter by name / type / set…"
            />
          </div>
          <div class="field">
            <select id="bulkTypeFilter">
              <option value="">All Types</option>
            </select>
          </div>
          <div class="field">
            <select id="bulkSetFilter">
              <option value="">All Sets</option>
            </select>
          </div>

          <div id="bulkGrid" class="bulk-grid">
            <div class="bulk-row bulk-row-header">
              <div></div>
              <div>Name</div>
              <div>Type</div>
              <div>Set</div>
              <div>Rarity</div>
            </div>
            <p class="small-note">No sheet parsed yet.</p>
          </div>
          <p id="bulkStep2Status" class="status small-note"></p>
        </div>

        <div>
          <h3>Step 3 – Apply to drive-card.json</h3>
          <p class="small-note">
            Selected rows will either create new card entries, or update
            existing ones that match by <strong>Name + Type + Set</strong>.
          </p>
          <div class="field">
            <label>When matching existing cards…</label>
            <select id="bulkUpdateModeSelect">
              <option value="update">
                Update existing card &amp; create new if missing
              </option>
              <option value="createOnly">
                Only create new cards (do not update existing)
              </option>
              <option value="updateOnly">
                Only update existing (ignore new names)
              </option>
            </select>
          </div>
          <button id="bulkApplyBtn" class="button" type="button">
            Apply to in-memory Library
          </button>
          <p id="bulkStep3Status" class="status small-note"></p>

          <h3>Save Updated Library</h3>
          <button
            id="downloadCardsJsonBtn_bulk"
            class="button secondary"
            type="button"
          >
            Download drive-card.json
          </button>
          <p class="small-note">
            After download, upload
            <span class="inline-code">drive-card.json</span> to your GitHub repo
            root (same folder as
            <span class="inline-code">index.html</span> and
            <span class="inline-code">admin.html</span>).
          </p>
        </div>
      </div>
    </section>

    <!-- PRECONSTRUCTED DECKS SECTION -->
    <section id="preconsSection" class="panel" style="display:none;">
      <h2>Preconstructed Decks</h2>
      <p class="small-note">
        Manage <span class="inline-code">drive-precons.json</span>. Each precon
        is a named deck with an id, description, and a mapping of cardId →
        quantity.
      </p>

      <div class="layout-two">
        <div>
          <h3>Precon List</h3>
          <div class="toolbar">
            <button
              id="preconNewBtn"
              class="button secondary"
              type="button"
            >
              New Precon
            </button>
            <button
              id="preconDeleteBtn"
              class="button danger"
              type="button"
            >
              Delete Selected
            </button>
            <span class="spacer"></span>
            <button
              id="preconReloadBtn"
              class="button secondary"
              type="button"
            >
              Reload from JSON
            </button>
          </div>
          <div id="preconLibraryList" class="library-list"></div>
          <p id="preconListStatus" class="status small-note"></p>

          <h3>Save JSON</h3>
          <button
            id="downloadPreconsJsonBtn"
            class="button secondary"
            type="button"
          >
            Download drive-precons.json
          </button>
        </div>

        <div>
          <h3>Precon Details</h3>
          <div class="field-grid">
            <div class="field">
              <label for="preconIdInput">Precon ID</label>
              <input
                id="preconIdInput"
                type="text"
                placeholder="starter-set1-speed"
              />
            </div>
            <div class="field">
              <label for="preconNameInput">Name</label>
              <input id="preconNameInput" type="text" />
            </div>
          </div>
          <div class="field">
            <label for="preconNotesInput">Description / Notes</label>
            <textarea id="preconNotesInput"></textarea>
          </div>

          <h3>Cards in this Precon</h3>
          <div class="field">
            <label for="preconCardSearchInput">Add Card (search by name)</label>
            <input
              id="preconCardSearchInput"
              type="text"
              placeholder="Start typing a card name…"
            />
          </div>
          <p class="small-note">
            Enter a name substring, then choose a result to add or adjust its
            quantity. Use 0 to remove a card.
          </p>
          <div id="preconCardList" class="library-list"></div>

          <div
            style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.4rem;"
          >
            <button
              id="preconSaveBtn"
              class="button"
              type="button"
            >
              Save Changes to Precon
            </button>
          </div>
          <p id="preconEditStatus" class="status small-note"></p>
        </div>
      </div>
    </section>

    <!-- HELP SECTION -->
    <section id="helpSection" class="panel" style="display:none;">
      <h2>Admin Workflow &amp; Tips</h2>
      <p class="small-note">
        This page never writes directly to GitHub. It only loads and saves JSON
        in your browser. You always manually upload the resulting
        <span class="inline-code">drive-card.json</span> and
        <span class="inline-code">drive-precons.json</span> to your GitHub repo.
      </p>

      <h3>Single Card Editor Workflow</h3>
      <ol class="small-note">
        <li>
          Ensure <span class="inline-code">drive-card.json</span> is in the same
          folder as <span class="inline-code">index.html</span> and
          <span class="inline-code">admin.html</span>.
        </li>
        <li>
          Open this page in your browser — it will automatically load the JSON
          into memory.
        </li>
        <li>
          Use the <strong>Card Library</strong> list on the right to find and
          load an existing card, or click <strong>New Card</strong> to start
          from scratch.
        </li>
        <li>Fill in Name, Type, Set, Rarity, and rules text.</li>
        <li>
          For Mods, fill Mod Type, Base Part, and Level stats. For Vehicles /
          Named Vehicles, fill HP/CON and Pit Cost.
        </li>
        <li>
          Click <strong>Save / Update in Library</strong> to keep the card in
          the in-memory list.
        </li>
        <li>
          When you're done editing, click
          <strong>Download drive-card.json</strong> and upload that file to
          GitHub.
        </li>
      </ol>

      <h3>Bulk Import Workflow (Excel)</h3>
      <ol class="small-note">
        <li>Use your master <span class="inline-code">Drive Cards.xlsx</span>.</li>
        <li>
          In <strong>Bulk Import</strong>, upload the
          <span class="inline-code">.xlsx</span> file.
        </li>
        <li>
          Select a sheet (e.g. <strong>Crew Cards</strong>) and click
          <strong>Parse Selected Sheet</strong>.
        </li>
        <li>
          Filter by type / set, tick the rows you want, and choose your update
          mode (update / create / update-only).
        </li>
        <li>Click <strong>Apply to in-memory Library</strong>.</li>
        <li>Repeat for other sheets if needed.</li>
        <li>
          When done, click <strong>Download drive-card.json</strong> and upload
          to GitHub.
        </li>
      </ol>

      <h3>Precon Workflow</h3>
      <ol class="small-note">
        <li>Go to <strong>Preconstructed Decks</strong>.</li>
        <li>
          Use <strong>Reload from JSON</strong> to load existing precons, or
          <strong>New Precon</strong> to start a fresh one.
        </li>
        <li>
          Fill in the Precon ID, Name, Description, and add cards by searching
          for their names.
        </li>
        <li>
          Adjust quantities (0 removes the card). Then click
          <strong>Save Changes to Precon</strong>.
        </li>
        <li>
          Use <strong>Download drive-precons.json</strong> to save the updated
          deck file and upload it to GitHub.
        </li>
      </ol>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Debug / Info</h3>
        <button id="modalCloseBtn" class="modal-close" type="button">✕</button>
      </div>
      <div id="modalBody" class="modal-body small-note"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const AppState = {
      cards: [],
      cardsById: {},
      precons: [],
      selectedLibraryCardId: null,
      selectedPreconId: null,
      bulkWorkbook: null,
      bulkSheetName: "",
      bulkRows: []
    };

    // SHEET_CONFIG now matches your Drive Cards.xlsx columns
    const SHEET_CONFIG = {
      "Crew Cards": {
        type: "Crew",
        nameCol: "Crew Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Crew Trait",
        cardNumberCol: "Card Number"
      },
      "Mod Cards": {
        type: "Mod",
        nameCol: "Mod Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Mod Ability",
        cardNumberCol: "Card Number",
        modTypeCol: "Mod TYPE",
        modBasePartCol: "Base Part",
        modL1Col: "Mod Lvl 1",
        modL2Col: "Mod Lvl 2",
        modL3Col: "Mod Lvl 3",
        modL4Col: "Mod Lvl 4"
      },
      "Driver Cards": {
        type: "Driver",
        nameCol: "Driver Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Driver Trait",
        cardNumberCol: "Card Number"
      },
      "Named Driver Cards": {
        type: "Named Driver",
        nameCol: "Driver Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Driver Trait",
        cardNumberCol: "Card Number"
      },
      "Condition Cards": {
        type: "Condition",
        nameCol: "Condition Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Condition Trait",
        cardNumberCol: "Card Number"
      },
      "Track Cards": {
        type: "Track",
        nameCol: "Track Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Track Trait",
        cardNumberCol: "Card Number",
        vehicleTypeCol: "Vehicle Type"
      },
      "Vehicle Cards": {
        type: "Vehicle",
        nameCol: "VEHICLE name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "TRAIT",
        cardNumberCol: "Card Number",
        vehicleTypeCol: "Vehicle Type",
        hpConCol: "VEHICLE HP/CON",
        pitCostCol: "PIT COST"
      },
      "NAMED VEHICLE": {
        type: "Named Vehicle",
        nameCol: "NAMED VEHICLE NAME",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "VEHICLE TRAIT",
        cardNumberCol: "Card Number",
        vehicleTypeCol: "Vehicle Type",
        hpConCol: "VEHICLE HP/CON",
        pitCostCol: "PIT COST"
      },
      "MISC": {
        type: "Misc",
        nameCol: "TOKENS/COUNTERS",
        setCol: null,
        rarityCol: "RARITY",
        notesCol: "ABILITY",
        cardNumberCol: "Card Number"
      }
    };

    const Dom = {
      // nav
      navSingleBtn: document.getElementById("navSingleBtn"),
      navBulkBtn: document.getElementById("navBulkBtn"),
      navPreconsBtn: document.getElementById("navPreconsBtn"),
      navHelpBtn: document.getElementById("navHelpBtn"),

      singleSection: document.getElementById("singleSection"),
      bulkSection: document.getElementById("bulkSection"),
      preconsSection: document.getElementById("preconsSection"),
      helpSection: document.getElementById("helpSection"),

      // single card inputs
      cardIdInput: document.getElementById("cardIdInput"),
      cardNameInput: document.getElementById("cardNameInput"),
      cardTypeInput: document.getElementById("cardTypeInput"),
      cardSetNameInput: document.getElementById("cardSetNameInput"),
      cardNumberInput: document.getElementById("cardNumberInput"),
      cardRarityInput: document.getElementById("cardRarityInput"),
      cardVehicleTypesInput: document.getElementById("cardVehicleTypesInput"),
      cardTagsInput: document.getElementById("cardTagsInput"),
      cardImageUrlInput: document.getElementById("cardImageUrlInput"),

      modTypeInput: document.getElementById("modTypeInput"),
      modBasePartInput: document.getElementById("modBasePartInput"),
      modL1Input: document.getElementById("modL1Input"),
      modL2Input: document.getElementById("modL2Input"),
      modL3Input: document.getElementById("modL3Input"),
      modL4Input: document.getElementById("modL4Input"),

      vehicleHpConInput: document.getElementById("vehicleHpConInput"),
      pitCostInput: document.getElementById("pitCostInput"),
      extraJsonInput: document.getElementById("extraJsonInput"),
      cardNotesInput: document.getElementById("cardNotesInput"),

      singleNewBtn: document.getElementById("singleNewBtn"),
      singleSaveBtn: document.getElementById("singleSaveBtn"),
      singleDeleteBtn: document.getElementById("singleDeleteBtn"),
      singleStatus: document.getElementById("singleStatus"),

      singlePreview: document.getElementById("singlePreview"),

      cardLibrarySearchInput: document.getElementById("cardLibrarySearchInput"),
      cardLibraryList: document.getElementById("cardLibraryList"),

      // bulk
      bulkFileInput: document.getElementById("bulkFileInput"),
      bulkSheetSelect: document.getElementById("bulkSheetSelect"),
      bulkParseSheetBtn: document.getElementById("bulkParseSheetBtn"),
      bulkStep1Status: document.getElementById("bulkStep1Status"),

      bulkSearchInput: document.getElementById("bulkSearchInput"),
      bulkTypeFilter: document.getElementById("bulkTypeFilter"),
      bulkSetFilter: document.getElementById("bulkSetFilter"),
      bulkGrid: document.getElementById("bulkGrid"),
      bulkStep2Status: document.getElementById("bulkStep2Status"),

      bulkUpdateModeSelect: document.getElementById("bulkUpdateModeSelect"),
      bulkApplyBtn: document.getElementById("bulkApplyBtn"),
      bulkStep3Status: document.getElementById("bulkStep3Status"),

      downloadCardsJsonBtn_single: document.getElementById("downloadCardsJsonBtn"),
      downloadCardsJsonBtn_bulk: document.getElementById("downloadCardsJsonBtn_bulk"),

      // precons
      preconNewBtn: document.getElementById("preconNewBtn"),
      preconDeleteBtn: document.getElementById("preconDeleteBtn"),
      preconReloadBtn: document.getElementById("preconReloadBtn"),
      preconLibraryList: document.getElementById("preconLibraryList"),
      preconListStatus: document.getElementById("preconListStatus"),

      preconIdInput: document.getElementById("preconIdInput"),
      preconNameInput: document.getElementById("preconNameInput"),
      preconNotesInput: document.getElementById("preconNotesInput"),
      preconCardSearchInput: document.getElementById("preconCardSearchInput"),
      preconCardList: document.getElementById("preconCardList"),
      preconSaveBtn: document.getElementById("preconSaveBtn"),
      preconEditStatus: document.getElementById("preconEditStatus"),
      downloadPreconsJsonBtn: document.getElementById("downloadPreconsJsonBtn"),

      // modal
      modalBackdrop: document.getElementById("modalBackdrop"),
      modalBody: document.getElementById("modalBody"),
      modalCloseBtn: document.getElementById("modalCloseBtn")
    };

    function showSection(section) {
      Dom.singleSection.style.display = section === "single" ? "" : "none";
      Dom.bulkSection.style.display = section === "bulk" ? "" : "none";
      Dom.preconsSection.style.display = section === "precons" ? "" : "none";
      Dom.helpSection.style.display = section === "help" ? "" : "none";

      Dom.navSingleBtn.classList.toggle("active", section === "single");
      Dom.navBulkBtn.classList.toggle("active", section === "bulk");
      Dom.navPreconsBtn.classList.toggle("active", section === "precons");
      Dom.navHelpBtn.classList.toggle("active", section === "help");
    }

    function openModal(html) {
      Dom.modalBody.innerHTML = html;
      Dom.modalBackdrop.classList.add("open");
    }

    function closeModal() {
      Dom.modalBackdrop.classList.remove("open");
    }

    function normalizeNameTypeSet(card) {
      const name = (card.name || "").trim().toLowerCase();
      const type = (card.type || "").trim().toLowerCase();
      const setName = (card.setName || "").trim().toLowerCase();
      return `${name}||${type}||${setName}`;
    }

    function parseVehicleTypes(str) {
      if (!str) return [];
      return String(str)
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseTags(str) {
      if (!str) return [];
      return String(str)
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseHpCon(val) {
      const out = { hp: undefined, con: undefined };
      if (!val) return out;
      const cleaned = String(val).replace(/\s/g, "");
      const parts = cleaned.split("/");
      if (parts[0] !== undefined && parts[0] !== "") out.hp = Number(parts[0]);
      if (parts[1] !== undefined && parts[1] !== "") out.con = Number(parts[1]);
      return out;
    }

    function readCell(row, ...keys) {
      for (const k of keys) {
        if (!k) continue;
        if (Object.prototype.hasOwnProperty.call(row, k)) {
          const v = row[k];
          if (v !== undefined && v !== null && v !== "") {
            return v;
          }
        }
      }

      const cols = Object.keys(row).map(col => ({
        name: col,
        norm: col.toLowerCase().replace(/\s+/g, "")
      }));
      for (const k of keys) {
        if (!k) continue;
        const target = String(k).toLowerCase().replace(/\s+/g, "");
        for (const col of cols) {
          if (col.norm === target) {
            const v = row[col.name];
            if (v !== undefined && v !== null && v !== "") {
              return v;
            }
          }
        }
      }
      return "";
    }

    function cardToJson(card) {
      const clean = JSON.parse(JSON.stringify(card));
      ["tempSheet", "tempRow", "selected"].forEach(k => delete clean[k]);
      return clean;
    }

    const CardData = {
      getVehicleTypes(card) {
        if (!card) return [];
        if (Array.isArray(card.vehicleTypes) && card.vehicleTypes.length) {
          return card.vehicleTypes;
        }
        const e = card.extra || {};
        if (Array.isArray(e.vehicleTypes) && e.vehicleTypes.length) {
          return e.vehicleTypes;
        }
        if (e.vehicleType) return [e.vehicleType];
        return [];
      },
      getModStats(card) {
        if (!card || card.type !== "Mod") return null;
        const e = card.extra || {};
        const parts = [];
        if (e.modLevel1) parts.push(`L1 ${e.modLevel1}`);
        if (e.modLevel2) parts.push(`L2 ${e.modLevel2}`);
        if (e.modLevel3) parts.push(`L3 ${e.modLevel3}`);
        if (e.modLevel4) parts.push(`L4 ${e.modLevel4}`);
        if (!parts.length && !e.modBasePart) return null;
        const label = e.modType
          ? `${e.modType} ${e.modBasePart || "Mod"}`
          : (e.modBasePart || "Mod");
        return parts.length ? `${label}: ${parts.join(" / ")}` : label;
      },
      getVehicleStats(card) {
        if (!card || (card.type !== "Vehicle" && card.type !== "Named Vehicle"))
          return null;
        const e = card.extra || {};
        const bits = [];
        if (e.hp !== undefined || e.con !== undefined) {
          bits.push(`HP/CON: ${e.hp || "?"}/${e.con || "?"}`);
        }
        if (e.pitCost !== undefined) {
          bits.push(`PIT: ${e.pitCost}`);
        }
        return bits.length ? bits.join(" | ") : null;
      }
    };

    // Show/hide type-specific fields based on data-show-for attribute
    function updateFieldVisibility() {
      const type = Dom.cardTypeInput.value || "";
      const nodes = document.querySelectorAll("[data-show-for]");
      nodes.forEach(el => {
        const spec = (el.getAttribute("data-show-for") || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);
        const show =
          !spec.length || spec.includes("*") || spec.includes(type);
        el.style.display = show ? "" : "none";
      });
    }

    function renderSinglePreview() {
      const card = collectSingleCardFromInputs(false);
      const previewEl = Dom.singlePreview;
      previewEl.innerHTML = "";

      const imgWrap = document.createElement("div");
      imgWrap.className = "card-preview-img";
      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.name || "Card";
        imgWrap.appendChild(img);
      } else {
        const span = document.createElement("span");
        span.className = "small-note";
        span.textContent = "No image";
        imgWrap.appendChild(span);
      }

      const body = document.createElement("div");
      body.className = "card-preview-body";

      const header = document.createElement("div");
      header.className = "card-preview-header";
      const nameEl = document.createElement("div");
      nameEl.className = "card-preview-name";
      nameEl.textContent = card.name || "(No Name)";
      const typeEl = document.createElement("div");
      typeEl.className = "card-preview-type";
      typeEl.textContent = card.type || "–";
      header.appendChild(nameEl);
      header.appendChild(typeEl);

      const rowSet = document.createElement("div");
      rowSet.className = "card-preview-row";
      rowSet.innerHTML =
        '<span class="card-preview-label">Set:</span> <span>' +
        (card.setName || "–") +
        "</span>";

      const rowRarity = document.createElement("div");
      rowRarity.className = "card-preview-row";
      rowRarity.innerHTML =
        '<span class="card-preview-label">Rarity:</span> <span>' +
        (card.rarity || "–") +
        "</span>";

      const rowVehicles = document.createElement("div");
      rowVehicles.className = "card-preview-row";
      const vt = CardData.getVehicleTypes(card);
      rowVehicles.innerHTML =
        '<span class="card-preview-label">Vehicle Types:</span> <span>' +
        (vt.length ? vt.join(", ") : "–") +
        "</span>";

      const rowTags = document.createElement("div");
      rowTags.className = "card-preview-row";
      const tags = card.tags || [];
      rowTags.innerHTML =
        '<span class="card-preview-label">Tags:</span> <span>' +
        (tags.length ? tags.join(", ") : "–") +
        "</span>";

      const rowStats = document.createElement("div");
      rowStats.className = "card-preview-row";
      const modStats = CardData.getModStats(card);
      const vehStats = CardData.getVehicleStats(card);
      const statPieces = [];
      if (modStats) statPieces.push(modStats);
      if (vehStats) statPieces.push(vehStats);
      rowStats.innerHTML =
        '<span class="card-preview-label">Stats:</span> <span>' +
        (statPieces.length ? statPieces.join(" | ") : "–") +
        "</span>";

      const rulesEl = document.createElement("div");
      rulesEl.className = "card-preview-text";
      rulesEl.textContent = card.notes || "Rules text will appear here.";

      body.appendChild(header);
      body.appendChild(rowSet);
      body.appendChild(rowRarity);
      body.appendChild(rowVehicles);
      body.appendChild(rowTags);
      body.appendChild(rowStats);
      body.appendChild(rulesEl);

      previewEl.appendChild(imgWrap);
      previewEl.appendChild(body);
    }

    function collectSingleCardFromInputs(requireId) {
      const id = Dom.cardIdInput.value.trim();
      const name = Dom.cardNameInput.value.trim();
      const type = Dom.cardTypeInput.value;
      const setName = Dom.cardSetNameInput.value.trim();
      const cardNumber = Dom.cardNumberInput.value.trim();
      const rarity = Dom.cardRarityInput.value.trim();
      const vehTypesStr = Dom.cardVehicleTypesInput.value.trim();
      const tagsStr = Dom.cardTagsInput.value.trim();
      const imageUrl = Dom.cardImageUrlInput.value.trim();
      const notes = Dom.cardNotesInput.value;

      const vehTypes = parseVehicleTypes(vehTypesStr);
      const tags = parseTags(tagsStr);

      const modType = Dom.modTypeInput.value.trim();
      const modBase = Dom.modBasePartInput.value.trim();
      const modL1 = Dom.modL1Input.value.trim();
      const modL2 = Dom.modL2Input.value.trim();
      const modL3 = Dom.modL3Input.value.trim();
      const modL4 = Dom.modL4Input.value.trim();

      const hpConStr = Dom.vehicleHpConInput.value.trim();
      const hpCon = parseHpCon(hpConStr);

      const pitCostStr = Dom.pitCostInput.value.trim();
      const pitCost = pitCostStr !== "" ? Number(pitCostStr) : undefined;

      let extra = {};
      if (Dom.extraJsonInput.value.trim()) {
        try {
          extra = JSON.parse(Dom.extraJsonInput.value);
        } catch (e) {
          console.error("Invalid extra JSON, ignoring:", e);
          extra = {};
        }
      }

      if (type === "Mod") {
        extra.modType = modType || undefined;
        extra.modBasePart = modBase || undefined;
        extra.modLevel1 = modL1 || undefined;
        extra.modLevel2 = modL2 || undefined;
        extra.modLevel3 = modL3 || undefined;
        extra.modLevel4 = modL4 || undefined;
      }

      if (type === "Vehicle" || type === "Named Vehicle") {
        if (hpCon.hp !== undefined) extra.hp = hpCon.hp;
        if (hpCon.con !== undefined) extra.con = hpCon.con;
        if (pitCost !== undefined && !Number.isNaN(pitCost)) {
          extra.pitCost = pitCost;
        }
      }

      const card = {
        id: id || (requireId ? "" : "card-" + Math.random().toString(36).slice(2)),
        name,
        type,
        setName,
        cardNumber,
        rarity,
        tags,
        notes,
        imageUrl,
        extra,
        vehicleTypes: vehTypes
      };
      return card;
    }

    function fillSingleCardInputs(card) {
      Dom.cardIdInput.value = card.id || "";
      Dom.cardNameInput.value = card.name || "";
      Dom.cardTypeInput.value = card.type || "";
      Dom.cardSetNameInput.value = card.setName || "";
      Dom.cardNumberInput.value = card.cardNumber || "";
      Dom.cardRarityInput.value = card.rarity || "";
      Dom.cardVehicleTypesInput.value = (card.vehicleTypes || []).join(", ");
      Dom.cardTagsInput.value = (card.tags || []).join(", ");
      Dom.cardImageUrlInput.value = card.imageUrl || "";
      Dom.cardNotesInput.value = card.notes || "";

      const e = card.extra || {};
      Dom.modTypeInput.value = e.modType || "";
      Dom.modBasePartInput.value = e.modBasePart || "";
      Dom.modL1Input.value = e.modLevel1 || "";
      Dom.modL2Input.value = e.modLevel2 || "";
      Dom.modL3Input.value = e.modLevel3 || "";
      Dom.modL4Input.value = e.modLevel4 || "";

      const hpConStr =
        e.hp !== undefined || e.con !== undefined
          ? `${e.hp || ""}/${e.con || ""}`
          : "";
      Dom.vehicleHpConInput.value = hpConStr;

      Dom.pitCostInput.value =
        e.pitCost !== undefined && e.pitCost !== null ? String(e.pitCost) : "";

      const extraClean = JSON.parse(JSON.stringify(e || {}));
      Dom.extraJsonInput.value = Object.keys(extraClean).length
        ? JSON.stringify(extraClean)
        : "";

      renderSinglePreview();
      updateFieldVisibility();
    }

    function renderCardLibraryList() {
      const container = Dom.cardLibraryList;
      container.innerHTML = "";

      if (!AppState.cards.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent =
          "No cards loaded yet. Make sure drive-card.json is next to admin.html.";
        container.appendChild(p);
        return;
      }

      const query = Dom.cardLibrarySearchInput.value
        .toLowerCase()
        .trim();

      const cards = [...AppState.cards].sort(
        (a, b) =>
          (a.type || "").localeCompare(b.type || "") ||
          (a.setName || "").localeCompare(b.setName || "") ||
          (a.name || "").localeCompare(b.name || "")
      );

      const filtered = cards.filter(c => {
        if (!query) return true;
        const haystack = [
          c.name,
          c.type,
          c.setName,
          c.cardNumber,
          c.rarity
        ]
          .join(" ")
          .toLowerCase();
        return haystack.includes(query);
      });

      filtered.forEach((card, idx) => {
        const row = document.createElement("div");
        row.className = "library-row";
        if (card.id === AppState.selectedLibraryCardId) {
          row.classList.add("active");
        }

        const idxCell = document.createElement("div");
        idxCell.textContent = String(idx + 1);

        const nameCell = document.createElement("span");
        nameCell.className = "truncate";
        nameCell.textContent = card.name || "(No Name)";

        const typeCell = document.createElement("span");
        typeCell.className = "truncate";
        typeCell.textContent = card.type || "";

        const setCell = document.createElement("span");
        setCell.className = "truncate";
        setCell.textContent = card.setName || "";

        const rarityCell = document.createElement("span");
        rarityCell.className = "truncate";
        rarityCell.textContent = card.rarity || "";

        row.appendChild(idxCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(setCell);
        row.appendChild(rarityCell);

        row.addEventListener("click", () => {
          AppState.selectedLibraryCardId = card.id;
          fillSingleCardInputs(card);
          renderCardLibraryList();
          Dom.singleStatus.textContent = `Loaded card: ${card.name}`;
          Dom.singleStatus.className = "status small-note ok";
        });

        container.appendChild(row);
      });

      if (!filtered.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No cards matching that search.";
        container.appendChild(p);
      }
    }

    function handleSingleNew() {
      AppState.selectedLibraryCardId = null;
      Dom.cardIdInput.value = "";
      Dom.cardNameInput.value = "";
      Dom.cardTypeInput.value = "";
      Dom.cardSetNameInput.value = "";
      Dom.cardNumberInput.value = "";
      Dom.cardRarityInput.value = "";
      Dom.cardVehicleTypesInput.value = "";
      Dom.cardTagsInput.value = "";
      Dom.cardImageUrlInput.value = "";
      Dom.cardNotesInput.value = "";
      Dom.modTypeInput.value = "";
      Dom.modBasePartInput.value = "";
      Dom.modL1Input.value = "";
      Dom.modL2Input.value = "";
      Dom.modL3Input.value = "";
      Dom.modL4Input.value = "";
      Dom.vehicleHpConInput.value = "";
      Dom.pitCostInput.value = "";
      Dom.extraJsonInput.value = "";
      Dom.singleStatus.textContent = "New blank card.";
      Dom.singleStatus.className = "status small-note";
      renderSinglePreview();
      renderCardLibraryList();
      updateFieldVisibility();
    }

    function handleSingleSave() {
      const card = collectSingleCardFromInputs(false);
      if (!card.name || !card.type || !card.setName) {
        Dom.singleStatus.textContent =
          "Name, Type, and Set are required to save.";
        Dom.singleStatus.className = "status small-note error";
        return;
      }

      let existing = null;
      if (card.id && AppState.cardsById[card.id]) {
        existing = AppState.cardsById[card.id];
      } else {
        const key = normalizeNameTypeSet(card);
        existing = AppState.cards.find(c => normalizeNameTypeSet(c) === key);
      }

      if (existing) {
        existing.name = card.name;
        existing.type = card.type;
        existing.setName = card.setName;
        existing.cardNumber = card.cardNumber;
        existing.rarity = card.rarity;
        existing.tags = card.tags;
        existing.notes = card.notes;
        existing.imageUrl = card.imageUrl;
        existing.vehicleTypes = card.vehicleTypes;
        existing.extra = card.extra;
        card.id = existing.id;
      } else {
        if (!card.id) {
          card.id = "card-" + Math.random().toString(36).slice(2);
        }
        AppState.cards.push(card);
        AppState.cardsById[card.id] = card;
      }

      AppState.selectedLibraryCardId = card.id;
      fillSingleCardInputs(card);
      renderCardLibraryList();

      Dom.singleStatus.textContent = "Card saved to in-memory library.";
      Dom.singleStatus.className = "status small-note ok";
    }

    function handleSingleDelete() {
      const id = Dom.cardIdInput.value.trim();
      if (!id) {
        Dom.singleStatus.textContent =
          "No card id present. Load a card from the library first.";
        Dom.singleStatus.className = "status small-note error";
        return;
      }
      if (!AppState.cardsById[id]) {
        Dom.singleStatus.textContent =
          "Card id not found in library. Nothing to delete.";
        Dom.singleStatus.className = "status small-note error";
        return;
      }
      AppState.cards = AppState.cards.filter(c => c.id !== id);
      delete AppState.cardsById[id];
      AppState.selectedLibraryCardId = null;
      handleSingleNew();
      Dom.singleStatus.textContent = "Card deleted from library.";
      Dom.singleStatus.className = "status small-note ok";
    }

    function downloadJsonFile(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    const Bulk = {
      parseWorkbook(file) {
        Dom.bulkStep1Status.textContent = "Reading workbook…";
        Dom.bulkStep1Status.className = "status small-note";
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: "array" });
            AppState.bulkWorkbook = wb;
            Dom.bulkSheetSelect.innerHTML = "";
            wb.SheetNames.forEach(name => {
              const opt = document.createElement("option");
              opt.value = name;
              opt.textContent = name;
              Dom.bulkSheetSelect.appendChild(opt);
            });
            Dom.bulkStep1Status.textContent =
              "Workbook loaded. Choose a sheet and click Parse Selected Sheet.";
            Dom.bulkStep1Status.className = "status small-note ok";
          } catch (err) {
            console.error(err);
            Dom.bulkStep1Status.textContent =
              "Error reading workbook. Check console.";
            Dom.bulkStep1Status.className = "status small-note error";
          }
        };
        reader.onerror = () => {
          Dom.bulkStep1Status.textContent =
            "File read error. Please try again.";
          Dom.bulkStep1Status.className = "status small-note error";
        };
        reader.readAsArrayBuffer(file);
      },

      parseSheet() {
        const wb = AppState.bulkWorkbook;
        const sheetName = Dom.bulkSheetSelect.value;
        if (!wb || !sheetName) {
          Dom.bulkStep2Status.textContent =
            "No workbook or sheet selected.";
          Dom.bulkStep2Status.className = "status small-note error";
          return;
        }
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
        const cfg = SHEET_CONFIG[sheetName] || null;

        AppState.bulkSheetName = sheetName;
        AppState.bulkRows = rows.map((row, idx) => {
          const raw = row;
          const out = {
            tempSheet: sheetName,
            tempRow: idx + 2,
            selected: true
          };

          let type = cfg ? cfg.type : "";
          let name = cfg ? readCell(raw, cfg.nameCol) :
            raw["Name"] || raw["Card Name"] || "";
          let setName = cfg
            ? readCell(raw, cfg.setCol, "SET")
            : raw["SET"] || "";
          let rarity = cfg
            ? readCell(raw, cfg.rarityCol, "RARITY")
            : raw["RARITY"] || "";
          let notes = cfg
            ? readCell(
                raw,
                cfg.notesCol,
                "Crew Trait",
                "Driver Trait",
                "Condition Trait",
                "Track Trait",
                "TRAIT",
                "ABILITY"
              )
            : raw["TRAIT"] || raw["ABILITY"] || "";
          let cardNumber = cfg
            ? readCell(raw, cfg.cardNumberCol, "Card Number")
            : raw["Card Number"] || "";

          const extra = {};
          let vehicleTypes = [];

          if (cfg && cfg.vehicleTypeCol) {
            const vtVal = readCell(raw, cfg.vehicleTypeCol, "Vehicle Type");
            vehicleTypes = parseVehicleTypes(vtVal);
          }

          if (cfg && cfg.modTypeCol) {
            extra.modType = readCell(raw, cfg.modTypeCol, "Mod TYPE") || undefined;
          }

          if (cfg && cfg.modBasePartCol) {
            extra.modBasePart = readCell(raw, cfg.modBasePartCol, "Base Part") || undefined;
            extra.modLevel1 = readCell(raw, cfg.modL1Col, "Mod Lvl 1") || undefined;
            extra.modLevel2 = readCell(raw, cfg.modL2Col, "Mod Lvl 2") || undefined;
            extra.modLevel3 = readCell(raw, cfg.modL3Col, "Mod Lvl 3") || undefined;
            extra.modLevel4 = readCell(raw, cfg.modL4Col, "Mod Lvl 4") || undefined;
          }

          if (cfg && cfg.hpConCol) {
            const hpConVal = readCell(raw, cfg.hpConCol, "VEHICLE HP/CON", "HP/CON");
            const parsed = parseHpCon(hpConVal);
            if (parsed.hp !== undefined) extra.hp = parsed.hp;
            if (parsed.con !== undefined) extra.con = parsed.con;
          }

          if (cfg && cfg.pitCostCol) {
            const pitVal = readCell(raw, cfg.pitCostCol, "PIT COST");
            const n = pitVal === "" ? undefined : Number(pitVal);
            if (n !== undefined && !Number.isNaN(n)) extra.pitCost = n;
          }

          out.card = {
            id: null,
            name: name,
            type: type || raw["TYPE"] || "",
            setName,
            cardNumber,
            rarity,
            tags: [],
            notes,
            imageUrl: "",
            extra,
            vehicleTypes
          };

          return out;
        });

        Dom.bulkStep2Status.textContent =
          `Parsed ${AppState.bulkRows.length} row(s) from ${sheetName}.`;
        Dom.bulkStep2Status.className = "status small-note ok";

        Bulk.renderGrid();
      },

      renderGrid() {
        const container = Dom.bulkGrid;
        container.innerHTML = "";
        const header = document.createElement("div");
        header.className = "bulk-row bulk-row-header";
        header.innerHTML =
          "<div></div><div>Name</div><div>Type</div><div>Set</div><div>Rarity</div>";
        container.appendChild(header);

        if (!AppState.bulkRows.length) {
          const p = document.createElement("p");
          p.className = "small-note";
          p.textContent = "No rows parsed yet.";
          container.appendChild(p);
          return;
        }

        const search = Dom.bulkSearchInput.value.toLowerCase().trim();
        const typeFilter = Dom.bulkTypeFilter.value;
        const setFilter = Dom.bulkSetFilter.value;

        const rows = AppState.bulkRows.filter(r => {
          const c = r.card || {};
          if (typeFilter && c.type !== typeFilter) return false;
          if (setFilter && c.setName !== setFilter) return false;
          if (!search) return true;
          const haystack = [c.name, c.type, c.setName, c.rarity]
            .join(" ")
            .toLowerCase();
          return haystack.includes(search);
        });

        const types = new Set();
        const sets = new Set();
        AppState.bulkRows.forEach(r => {
          if (r.card.type) types.add(r.card.type);
          if (r.card.setName) sets.add(r.card.setName);
        });

        Dom.bulkTypeFilter.innerHTML = '<option value="">All Types</option>';
        Array.from(types)
          .sort()
          .forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            Dom.bulkTypeFilter.appendChild(opt);
          });

        Dom.bulkSetFilter.innerHTML = '<option value="">All Sets</option>';
        Array.from(sets)
          .sort()
          .forEach(s => {
            const opt = document.createElement("option");
            opt.value = s;
            opt.textContent = s;
            Dom.bulkSetFilter.appendChild(opt);
          });

        rows.forEach((rowObj, idx) => {
          const c = rowObj.card;
          const row = document.createElement("div");
          row.className = "bulk-row";

          const checkboxCell = document.createElement("div");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = rowObj.selected;
          checkbox.addEventListener("change", () => {
            rowObj.selected = checkbox.checked;
          });
          checkboxCell.appendChild(checkbox);

          const nameCell = document.createElement("div");
          nameCell.textContent = c.name || "(No Name)";

          const typeCell = document.createElement("div");
          typeCell.textContent = c.type || "";

          const setCell = document.createElement("div");
          setCell.textContent = c.setName || "";

          const rarityCell = document.createElement("div");
          rarityCell.textContent = c.rarity || "";

          row.appendChild(checkboxCell);
          row.appendChild(nameCell);
          row.appendChild(typeCell);
          row.appendChild(setCell);
          row.appendChild(rarityCell);
          container.appendChild(row);
        });
      },

      applyToLibrary() {
        const mode = Dom.bulkUpdateModeSelect.value || "update";
        let created = 0;
        let updated = 0;
        let skipped = 0;

        const cardIndex = {};
        AppState.cards.forEach(c => {
          const key = normalizeNameTypeSet(c);
          if (!cardIndex[key]) cardIndex[key] = [];
          cardIndex[key].push(c);
        });

        AppState.bulkRows.forEach(rowObj => {
          if (!rowObj.selected) {
            skipped++;
            return;
          }
          const newCard = cardToJson(rowObj.card);
          const key = normalizeNameTypeSet(newCard);
          const matches = cardIndex[key] || [];

          if (matches.length) {
            if (mode === "createOnly") {
              skipped++;
              return;
            }
            const card = matches[0];
            card.rarity = newCard.rarity || card.rarity;
            card.notes = newCard.notes || card.notes;
            card.cardNumber = newCard.cardNumber || card.cardNumber;
            card.vehicleTypes = newCard.vehicleTypes.length
              ? newCard.vehicleTypes
              : card.vehicleTypes;
            card.extra = Object.assign({}, card.extra || {}, newCard.extra || {});
            updated++;
          } else {
            if (mode === "updateOnly") {
              skipped++;
              return;
            }
            AppState.cards.push(newCard);
            const libIdxKey = normalizeNameTypeSet(newCard);
            if (!cardIndex[libIdxKey]) cardIndex[libIdxKey] = [];
            cardIndex[libIdxKey].push(newCard);
            created++;
          }
        });

        Dom.bulkStep3Status.textContent =
          `Done. Created ${created}, updated ${updated}, skipped ${skipped}. Remember to download drive-card.json.`;
        Dom.bulkStep3Status.className = "status small-note ok";
        renderCardLibraryList();
      }
    };

    function renderPreconList() {
      const container = Dom.preconLibraryList;
      container.innerHTML = "";
      if (!AppState.precons.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent =
          "No precons loaded. Click Reload from JSON or create a new one.";
        container.appendChild(p);
        return;
      }

      const list = [...AppState.precons].sort((a, b) =>
        (a.name || "").localeCompare(b.name || "")
      );
      list.forEach((precon, idx) => {
        const row = document.createElement("div");
        row.className = "library-row";
        if (precon.id === AppState.selectedPreconId) {
          row.classList.add("active");
        }

        const idxCell = document.createElement("div");
        idxCell.textContent = String(idx + 1);

        const nameCell = document.createElement("span");
        nameCell.className = "truncate";
        nameCell.textContent = precon.name || "(Unnamed precon)";

        const typeCell = document.createElement("span");
        typeCell.className = "truncate";
        typeCell.textContent = precon.id || "";

        const setCell = document.createElement("span");
        setCell.className = "truncate";
        setCell.textContent = "";

        const qtyCell = document.createElement("span");
        const cardsMap = precon.cards || {};
        const totalQty = Object.values(cardsMap).reduce(
          (sum, q) => sum + (Number(q) || 0),
          0
        );
        qtyCell.textContent = totalQty ? `${totalQty} cards` : "0 cards";

        row.appendChild(idxCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(setCell);
        row.appendChild(qtyCell);

        row.addEventListener("click", () => {
          AppState.selectedPreconId = precon.id;
          fillPreconEditor(precon);
          renderPreconList();
        });

        container.appendChild(row);
      });

      Dom.preconListStatus.textContent =
        `${AppState.precons.length} precon(s) loaded.`;
      Dom.preconListStatus.className = "status small-note ok";
    }

    function fillPreconEditor(precon) {
      Dom.preconIdInput.value = precon.id || "";
      Dom.preconNameInput.value = precon.name || "";
      Dom.preconNotesInput.value = precon.notes || "";
      Dom.preconEditStatus.textContent = "";
      renderCardLibraryForPrecons();
    }

    function renderCardLibraryForPrecons() {
      const container = Dom.preconCardList;
      container.innerHTML = "";

      const precon = AppState.precons.find(
        p => p.id === AppState.selectedPreconId
      );
      if (!precon) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No precon selected.";
        container.appendChild(p);
        return;
      }

      const cardsMap = precon.cards || {};
      const entries = Object.entries(cardsMap)
        .map(([cardId, qty]) => {
          const card = AppState.cardsById[cardId];
          return { cardId, card, qty: Number(qty) || 0 };
        })
        .filter(e => e.card && e.qty > 0)
        .sort(
          (a, b) =>
            (a.card.type || "").localeCompare(b.card.type || "") ||
            (a.card.name || "").localeCompare(b.card.name || "")
        );

      if (!entries.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No cards in this precon.";
        container.appendChild(p);
        return;
      }

      entries.forEach((entry, idx) => {
        const row = document.createElement("div");
        row.className = "library-row";

        const idxCell = document.createElement("div");
        idxCell.textContent = String(idx + 1);

        const nameCell = document.createElement("span");
        nameCell.className = "truncate";
        nameCell.textContent = `${entry.qty}x ${entry.card.name}`;

        const typeCell = document.createElement("span");
        typeCell.className = "truncate";
        typeCell.textContent = entry.card.type || "";

        const setCell = document.createElement("span");
        setCell.className = "truncate";
        setCell.textContent = entry.card.setName || "";

        const qtyCell = document.createElement("span");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.value = entry.qty;
        qtyInput.style.width = "3rem";
        qtyInput.addEventListener("change", () => {
          const newQty = Number(qtyInput.value) || 0;
          if (!precon.cards) precon.cards = {};
          if (newQty <= 0) {
            delete precon.cards[entry.cardId];
          } else {
            precon.cards[entry.cardId] = newQty;
          }
          renderCardLibraryForPrecons();
        });
        qtyCell.appendChild(qtyInput);

        row.appendChild(idxCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(setCell);
        row.appendChild(qtyCell);
        container.appendChild(row);
      });
    }

    function handlePreconNew() {
      const id = "precon-" + Math.random().toString(36).slice(2);
      const precon = {
        id,
        name: "New Precon",
        notes: "",
        cards: {}
      };
      AppState.precons.push(precon);
      AppState.selectedPreconId = id;
      renderPreconList();
      fillPreconEditor(precon);
      Dom.preconEditStatus.textContent = "New precon created.";
      Dom.preconEditStatus.className = "status small-note ok";
    }

    function handlePreconDelete() {
      const id = AppState.selectedPreconId;
      if (!id) {
        Dom.preconEditStatus.textContent = "No precon selected.";
        Dom.preconEditStatus.className = "status small-note error";
        return;
      }
      AppState.precons = AppState.precons.filter(p => p.id !== id);
      AppState.selectedPreconId = null;
      Dom.preconIdInput.value = "";
      Dom.preconNameInput.value = "";
      Dom.preconNotesInput.value = "";
      Dom.preconCardList.innerHTML = "";
      renderPreconList();
      Dom.preconEditStatus.textContent = "Precon deleted.";
      Dom.preconEditStatus.className = "status small-note ok";
    }

    function handlePreconSave() {
      const id = Dom.preconIdInput.value.trim();
      if (!id) {
        Dom.preconEditStatus.textContent = "Precon ID is required.";
        Dom.preconEditStatus.className = "status small-note error";
        return;
      }
      let precon = AppState.precons.find(p => p.id === AppState.selectedPreconId);
      if (!precon) {
        precon = { id, name: "", notes: "", cards: {} };
        AppState.precons.push(precon);
      }
      precon.id = id;
      precon.name = Dom.preconNameInput.value.trim() || "Unnamed Precon";
      precon.notes = Dom.preconNotesInput.value;
      if (!precon.cards) precon.cards = {};

      AppState.selectedPreconId = precon.id;
      renderPreconList();
      Dom.preconEditStatus.textContent = "Precon saved (in-memory).";
      Dom.preconEditStatus.className = "status small-note ok";
    }

    function handlePreconCardSearch() {
      const query = Dom.preconCardSearchInput.value.trim().toLowerCase();
      if (!query) {
        renderCardLibraryForPrecons();
        return;
      }
      const precon = AppState.precons.find(
        p => p.id === AppState.selectedPreconId
      );
      if (!precon) {
        renderCardLibraryForPrecons();
        return;
      }
      if (!precon.cards) precon.cards = {};

      const results = AppState.cards
        .filter(c => (c.name || "").toLowerCase().includes(query))
        .slice(0, 25);

      const container = Dom.preconCardList;
      container.innerHTML = "";
      if (!results.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No cards matching that name.";
        container.appendChild(p);
        return;
      }

      results.forEach(card => {
        const row = document.createElement("div");
        row.className = "library-row";

        const idxCell = document.createElement("div");
        idxCell.textContent = "";

        const nameCell = document.createElement("span");
        nameCell.className = "truncate";
        nameCell.textContent = card.name;

        const typeCell = document.createElement("span");
        typeCell.className = "truncate";
        typeCell.textContent = card.type || "";

        const setCell = document.createElement("span");
        setCell.className = "truncate";
        setCell.textContent = card.setName || "";

        const qtyCell = document.createElement("span");
        const qtyInput = document.createElement("input");
        qtyInput.type = "number";
        qtyInput.min = "0";
        qtyInput.style.width = "3rem";
        qtyInput.value = precon.cards[card.id] || 0;
        qtyInput.addEventListener("change", () => {
          const qty = Number(qtyInput.value) || 0;
          if (qty <= 0) {
            delete precon.cards[card.id];
          } else {
            precon.cards[card.id] = qty;
          }
        });
        qtyCell.appendChild(qtyInput);

        row.appendChild(idxCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(setCell);
        row.appendChild(qtyCell);
        container.appendChild(row);
      });
    }

    function loadCards() {
      return fetch("drive-card.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch drive-card.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json))
            throw new Error("drive-card.json is not an array.");
          AppState.cards = json;
          AppState.cardsById = {};
          AppState.cards.forEach(card => {
            if (!card.id) {
              card.id = "card-" + Math.random().toString(36).slice(2);
            }
            if (!card.extra) card.extra = {};
            if (!Array.isArray(card.tags)) card.tags = [];
            if (typeof card.imageUrl !== "string") card.imageUrl = "";
            AppState.cardsById[card.id] = card;
          });
          renderCardLibraryList();
        })
        .catch(err => {
          console.error(err);
          AppState.cards = [];
          AppState.cardsById = {};
          renderCardLibraryList();
        });
    }

    function loadPrecons() {
      return fetch("drive-precons.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch drive-precons.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json))
            throw new Error("drive-precons.json is not an array");
          AppState.precons = json;
          renderPreconList();
        })
        .catch(err => {
          console.error(err);
          AppState.precons = [];
          renderPreconList();
        });
    }

    function init() {
      Dom.navSingleBtn.addEventListener("click", () => showSection("single"));
      Dom.navBulkBtn.addEventListener("click", () => showSection("bulk"));
      Dom.navPreconsBtn.addEventListener("click", () => showSection("precons"));
      Dom.navHelpBtn.addEventListener("click", () => showSection("help"));

      Dom.modalCloseBtn.addEventListener("click", closeModal);
      Dom.modalBackdrop.addEventListener("click", e => {
        if (e.target === Dom.modalBackdrop) closeModal();
      });

      [
        Dom.cardNameInput,
        Dom.cardTypeInput,
        Dom.cardSetNameInput,
        Dom.cardNumberInput,
        Dom.cardRarityInput,
        Dom.cardVehicleTypesInput,
        Dom.cardTagsInput,
        Dom.cardImageUrlInput,
        Dom.cardNotesInput,
        Dom.modTypeInput,
        Dom.modBasePartInput,
        Dom.modL1Input,
        Dom.modL2Input,
        Dom.modL3Input,
        Dom.modL4Input,
        Dom.vehicleHpConInput,
        Dom.pitCostInput,
        Dom.extraJsonInput
      ].forEach(el => {
        el.addEventListener("input", renderSinglePreview);
      });

      // Update visible fields when type changes
      Dom.cardTypeInput.addEventListener("change", () => {
        updateFieldVisibility();
        renderSinglePreview();
      });

      Dom.singleNewBtn.addEventListener("click", handleSingleNew);
      Dom.singleSaveBtn.addEventListener("click", handleSingleSave);
      Dom.singleDeleteBtn.addEventListener("click", handleSingleDelete);
      Dom.cardLibrarySearchInput.addEventListener(
        "input",
        renderCardLibraryList
      );

      Dom.downloadCardsJsonBtn_single.addEventListener("click", () => {
        const data = AppState.cards.map(cardToJson);
        downloadJsonFile("drive-card.json", data);
      });
      Dom.downloadCardsJsonBtn_bulk.addEventListener("click", () => {
        const data = AppState.cards.map(cardToJson);
        downloadJsonFile("drive-card.json", data);
      });

      Dom.bulkFileInput.addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) Bulk.parseWorkbook(file);
      });
      Dom.bulkParseSheetBtn.addEventListener("click", () => Bulk.parseSheet());
      Dom.bulkSearchInput.addEventListener("input", () => Bulk.renderGrid());
      Dom.bulkTypeFilter.addEventListener("change", () => Bulk.renderGrid());
      Dom.bulkSetFilter.addEventListener("change", () => Bulk.renderGrid());
      Dom.bulkApplyBtn.addEventListener("click", () => Bulk.applyToLibrary());

      Dom.preconNewBtn.addEventListener("click", handlePreconNew);
      Dom.preconDeleteBtn.addEventListener("click", handlePreconDelete);
      Dom.preconReloadBtn.addEventListener("click", () => {
        loadPrecons();
      });
      Dom.preconSaveBtn.addEventListener("click", handlePreconSave);
      Dom.preconCardSearchInput.addEventListener(
        "input",
        handlePreconCardSearch
      );
      Dom.downloadPreconsJsonBtn.addEventListener("click", () => {
        const data = AppState.precons;
        downloadJsonFile("drive-precons.json", data);
      });

      handleSingleNew();
      loadCards();
      loadPrecons();
      showSection("single");
      updateFieldVisibility();
    }

    init();
  </script>
</body>
</html>
