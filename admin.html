<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.25rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      align-items: baseline;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header small {
      color: #9ca3af;
      font-size: 0.85rem;
    }

    a {
      color: #38bdf8;
    }

    .mode-toggle {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .mode-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mode-btn {
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease,
        box-shadow 0.08s ease;
    }
    .mode-btn:hover {
      background: #030712;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .mode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      margin-bottom: 0.75rem;
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }

    .layout-two {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.8fr);
      gap: 0.75rem;
    }
    @media (max-width: 900px) {
      .layout-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border-radius: 0.45rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.08s ease, box-shadow 0.08s ease,
        transform 0.05s ease;
    }
    button:hover {
      background: #020617;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }
    button.secondary {
      background: #020617;
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button.danger:hover {
      background: #7f1d1d;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .card-list {
      max-height: 420px;
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      background: #020617;
      font-size: 0.8rem;
    }
    .card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
      cursor: pointer;
    }
    .card-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .card-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .card-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .card-row-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-row-sub {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .form-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.5rem;
    }
    @media (max-width: 900px) {
      .form-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .form-group {
      margin-bottom: 0.45rem;
    }
    .form-label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      color: #9ca3af;
    }

    .image-preview {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 120px;
    }
    .image-preview img {
      max-width: 100%;
      max-height: 240px;
      object-fit: contain;
      border-radius: 0.45rem;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .step-box {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.6rem;
      background: rgba(15,23,42,0.8);
      margin-bottom: 0.5rem;
    }
    .bulk-list {
      max-height: 360px;
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      background: #020617;
      font-size: 0.8rem;
    }

    .precon-layout {
      display: grid;
      grid-template-columns: minmax(0,1.2fr) minmax(0,1.8fr);
      gap: 0.75rem;
    }
    @media (max-width: 900px) {
      .precon-layout {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .precon-list {
      max-height: 360px;
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      background: #020617;
      font-size: 0.8rem;
    }
    .precon-row {
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
      cursor: pointer;
    }
    .precon-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .precon-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .precon-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .precon-cards {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      background: #020617;
      font-size: 0.8rem;
    }
    .precon-card-row {
      display: flex;
      justify-content: space-between;
      gap: 0.35rem;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }
    .precon-card-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .precon-card-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Admin</h1>
        <small>Manage the official card library, bulk imports, and preconstructed decks.</small>
      </div>
    </header>

    <div class="mode-toggle">
      <span class="mode-label">Mode:</span>
      <button id="modeCardsBtn" class="mode-btn active">Card Editor</button>
      <button id="modeBulkBtn" class="mode-btn">Bulk Import</button>
      <button id="modePreconsBtn" class="mode-btn">Precon Admin</button>
    </div>

    <!-- CARD EDITOR LAYOUT -->
    <div id="cardAdminLayout">
      <div class="panel">
        <div class="toolbar">
          <button id="loadLibraryBtn" type="button">Load Library JSON</button>
          <input id="loadLibraryInput" type="file" accept="application/json" style="display:none;" />
          <button id="saveLibraryBtn" type="button">Download Library JSON</button>
          <span class="small-note" id="librarySummary"></span>
        </div>
      </div>

      <div class="layout-two">
        <section class="panel">
          <h2>Cards in Library</h2>
          <div class="toolbar">
            <input id="cardListSearch" type="text" placeholder="Search name / type / set..." />
            <button id="newCardBtn" type="button">+ New Card</button>
            <button id="deleteCardBtn" class="danger" type="button">Delete Selected</button>
          </div>
          <div id="cardList" class="card-list"></div>
        </section>

        <section class="panel">
          <h2>Card Details</h2>
          <div class="form-grid">
            <div>
              <div class="form-group">
                <label class="form-label" for="cardNameInput">Card Name</label>
                <input id="cardNameInput" type="text" />
              </div>
              <div class="form-group">
                <label class="form-label" for="cardTypeInput">Card Type</label>
                <select id="cardTypeInput">
                  <option value="">-- Select Type --</option>
                  <option value="Crew">Crew</option>
                  <option value="Driver">Driver</option>
                  <option value="Named Driver">Named Driver</option>
                  <option value="Mod">Mod</option>
                  <option value="Vehicle">Vehicle</option>
                  <option value="Named Vehicle">Named Vehicle</option>
                  <option value="Track">Track</option>
                  <option value="Condition">Condition</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label" for="cardRarityInput">Rarity</label>
                <input id="cardRarityInput" type="text" placeholder="Common, Rare, etc." />
              </div>
              <div class="form-group">
                <label class="form-label" for="cardSetInput">Set Name</label>
                <input id="cardSetInput" type="text" placeholder="Set 1, Set 1 & 2, etc." />
              </div>
              <div class="form-group">
                <label class="form-label" for="cardNumberInput">Card Number</label>
                <input id="cardNumberInput" type="text" placeholder="001, 02A, etc." />
              </div>
              <div class="form-group">
                <label class="form-label" for="cardTagsInput">Tags (comma separated)</label>
                <input id="cardTagsInput" type="text" placeholder="Starter, Promo, Junkyard, ..." />
              </div>
            </div>
            <div>
              <div id="extraFieldsContainer"></div>
              <div class="form-group">
                <label class="form-label">Card Image</label>
                <input id="cardImageInput" type="file" accept="image/png,image/jpeg" />
                <div class="image-preview" id="cardImagePreview">
                  <span class="small-note">No image chosen.</span>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="cardNotesInput">Rules Text</label>
            <textarea id="cardNotesInput" placeholder="Enter rules text here..."></textarea>
          </div>

          <div class="toolbar">
            <button id="saveCardBtn" type="button">Save Card</button>
            <button id="duplicateCardBtn" class="secondary" type="button">Duplicate Card</button>
          </div>
          <p class="small-note">
            Extra fields automatically change based on the Card Type (Mod levels, Vehicle HP/CON, Driver/Track vehicle types, etc.).
          </p>
        </section>
      </div>
    </div>

    <!-- BULK IMPORT LAYOUT -->
    <div id="bulkLayout" style="display:none;">
      <section class="panel">
        <h2>Bulk Import from Excel</h2>
        <p class="small-note">
          Recommended flow: export from your master <strong>Drive Cards.xlsx</strong>, then use:
          Step 1 (load workbook) → Step 2 (filter & select rows) → Step 3 (attach images & import).
        </p>

        <!-- STEP 1 -->
        <div class="step-box">
          <div class="step-title">Step 1 – Upload .xlsx and choose sheet</div>
          <div class="toolbar">
            <input id="bulkFileInput" type="file" accept=".xlsx" />
            <select id="bulkSheetSelect" style="max-width:220px;">
              <option value="">-- Sheet --</option>
            </select>
            <button id="bulkParseSheetBtn" type="button">Parse Sheet</button>
          </div>
          <div id="bulkStep1Status" class="small-note"></div>
        </div>

        <!-- STEP 2 -->
        <div id="bulkStep2" class="step-box" style="display:none;">
          <div class="step-title">Step 2 – Filter & select cards to include</div>
          <div id="bulkFilters" style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:0.5rem; align-items:center;">
            <input
              id="bulkFilterText"
              type="text"
              placeholder="Filter by name / type / set..."
              style="flex:1; min-width:180px; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:0.85rem;"
            />

            <select
              id="bulkFilterType"
              style="min-width:140px; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:0.85rem;"
            >
              <option value="">All Types</option>
            </select>

            <select
              id="bulkFilterSet"
              style="min-width:140px; padding:0.3rem 0.6rem; border-radius:999px; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:0.85rem;"
            >
              <option value="">All Sets</option>
            </select>

            <button id="bulkSelectShownBtn" type="button">Select shown</button>
            <button id="bulkClearShownBtn" type="button">Clear shown</button>
          </div>

          <div id="bulkSelectionList" class="bulk-list"></div>

          <div style="margin-top:0.4rem; display:flex; justify-content:flex-end; gap:0.4rem;">
            <button id="bulkToStep3Btn" type="button">Continue to Step 3</button>
          </div>
        </div>

        <!-- STEP 3 -->
        <div id="bulkStep3" class="step-box" style="display:none;">
          <div class="step-title">Step 3 – Attach images & import</div>
          <p class="small-note">
            For each selected card, choose its image. You can reuse images that are already in the library by skipping upload – but for <strong>new</strong> cards you’ll generally want to attach an image.
          </p>
          <div id="bulkImageList" class="bulk-list"></div>
          <div style="margin-top:0.4rem; display:flex; justify-content:space-between; gap:0.4rem; flex-wrap:wrap;">
            <span class="small-note" id="bulkStep3Summary"></span>
            <button id="bulkImportFinishBtn" type="button">Finish Import (add to library)</button>
          </div>
        </div>
      </section>
    </div>

    <!-- PRECON ADMIN LAYOUT -->
    <div id="preconLayout" style="display:none;">
      <section class="panel">
        <h2>Precon Admin</h2>
        <div class="toolbar">
          <button id="loadPreconsBtn" type="button">Load Precons JSON</button>
          <input id="loadPreconsInput" type="file" accept="application/json" style="display:none;" />
          <button id="savePreconsBtn" type="button">Download Precons JSON</button>
          <button id="newPreconBtn" type="button">+ New Precon</button>
          <button id="deletePreconBtn" class="danger" type="button">Delete Selected</button>
        </div>
        <div class="precon-layout">
          <div>
            <div class="precon-list" id="preconList"></div>
          </div>
          <div>
            <div class="form-group">
              <label class="form-label" for="preconNameInput">Precon Name</label>
              <input id="preconNameInput" type="text" />
            </div>
            <div class="form-group">
              <label class="form-label" for="preconNotesInput">Precon Notes / Description</label>
              <textarea id="preconNotesInput"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Cards in Precon</label>
              <div id="preconCardsList" class="precon-cards"></div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="preconCardSelect">Add Card</label>
                <select id="preconCardSelect"></select>
              </div>
              <div class="form-group">
                <label class="form-label" for="preconCardQtyInput">Qty</label>
                <input id="preconCardQtyInput" type="number" min="1" value="1" />
              </div>
            </div>
            <div class="toolbar">
              <button id="preconAddCardBtn" type="button">Add Card to Precon</button>
              <button id="preconSaveBtn" type="button">Save Precon Changes</button>
            </div>
            <p class="small-note" id="preconStatsInfo"></p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const AdminState = {
      cards: [],
      selectedCardId: null,
      precons: [],
      selectedPreconIndex: null
    };

    let bulkWorkbook = null;
    let bulkCards = [];
    const bulkFilterState = { text: "", type: "", set: "" };

    const STORAGE_KEYS = {
      lastMode: "driveAdminMode_v1"
    };

    const Dom = {
      modeCardsBtn: document.getElementById("modeCardsBtn"),
      modeBulkBtn: document.getElementById("modeBulkBtn"),
      modePreconsBtn: document.getElementById("modePreconsBtn"),

      cardAdminLayout: document.getElementById("cardAdminLayout"),
      bulkLayout: document.getElementById("bulkLayout"),
      preconLayout: document.getElementById("preconLayout"),

      loadLibraryBtn: document.getElementById("loadLibraryBtn"),
      loadLibraryInput: document.getElementById("loadLibraryInput"),
      saveLibraryBtn: document.getElementById("saveLibraryBtn"),
      librarySummary: document.getElementById("librarySummary"),

      cardList: document.getElementById("cardList"),
      cardListSearch: document.getElementById("cardListSearch"),
      newCardBtn: document.getElementById("newCardBtn"),
      deleteCardBtn: document.getElementById("deleteCardBtn"),

      cardNameInput: document.getElementById("cardNameInput"),
      cardTypeInput: document.getElementById("cardTypeInput"),
      cardRarityInput: document.getElementById("cardRarityInput"),
      cardSetInput: document.getElementById("cardSetInput"),
      cardNumberInput: document.getElementById("cardNumberInput"),
      cardTagsInput: document.getElementById("cardTagsInput"),
      cardNotesInput: document.getElementById("cardNotesInput"),
      extraFieldsContainer: document.getElementById("extraFieldsContainer"),
      cardImageInput: document.getElementById("cardImageInput"),
      cardImagePreview: document.getElementById("cardImagePreview"),

      saveCardBtn: document.getElementById("saveCardBtn"),
      duplicateCardBtn: document.getElementById("duplicateCardBtn"),

      bulkFileInput: document.getElementById("bulkFileInput"),
      bulkSheetSelect: document.getElementById("bulkSheetSelect"),
      bulkParseSheetBtn: document.getElementById("bulkParseSheetBtn"),
      bulkStep1Status: document.getElementById("bulkStep1Status"),
      bulkStep2: document.getElementById("bulkStep2"),
      bulkStep3: document.getElementById("bulkStep3"),
      bulkSelectionList: document.getElementById("bulkSelectionList"),
      bulkFilterText: document.getElementById("bulkFilterText"),
      bulkFilterType: document.getElementById("bulkFilterType"),
      bulkFilterSet: document.getElementById("bulkFilterSet"),
      bulkSelectShownBtn: document.getElementById("bulkSelectShownBtn"),
      bulkClearShownBtn: document.getElementById("bulkClearShownBtn"),
      bulkToStep3Btn: document.getElementById("bulkToStep3Btn"),
      bulkImageList: document.getElementById("bulkImageList"),
      bulkStep3Summary: document.getElementById("bulkStep3Summary"),
      bulkImportFinishBtn: document.getElementById("bulkImportFinishBtn"),

      loadPreconsBtn: document.getElementById("loadPreconsBtn"),
      loadPreconsInput: document.getElementById("loadPreconsInput"),
      savePreconsBtn: document.getElementById("savePreconsBtn"),
      newPreconBtn: document.getElementById("newPreconBtn"),
      deletePreconBtn: document.getElementById("deletePreconBtn"),
      preconList: document.getElementById("preconList"),
      preconNameInput: document.getElementById("preconNameInput"),
      preconNotesInput: document.getElementById("preconNotesInput"),
      preconCardsList: document.getElementById("preconCardsList"),
      preconCardSelect: document.getElementById("preconCardSelect"),
      preconCardQtyInput: document.getElementById("preconCardQtyInput"),
      preconAddCardBtn: document.getElementById("preconAddCardBtn"),
      preconSaveBtn: document.getElementById("preconSaveBtn"),
      preconStatsInfo: document.getElementById("preconStatsInfo")
    };

    const Mode = {
      set(mode) {
        Dom.cardAdminLayout.style.display = mode === "cards" ? "" : "none";
        Dom.bulkLayout.style.display = mode === "bulk" ? "" : "none";
        Dom.preconLayout.style.display = mode === "precons" ? "" : "none";

        Dom.modeCardsBtn.classList.toggle("active", mode === "cards");
        Dom.modeBulkBtn.classList.toggle("active", mode === "bulk");
        Dom.modePreconsBtn.classList.toggle("active", mode === "precons");

        localStorage.setItem(STORAGE_KEYS.lastMode, mode);
      },
      init() {
        Dom.modeCardsBtn.addEventListener("click", () => Mode.set("cards"));
        Dom.modeBulkBtn.addEventListener("click", () => Mode.set("bulk"));
        Dom.modePreconsBtn.addEventListener("click", () => Mode.set("precons"));

        const last = localStorage.getItem(STORAGE_KEYS.lastMode) || "cards";
        Mode.set(last);
      }
    };

    const CardLib = {
      createEmptyCard() {
        return {
          id: "card-" + Math.random().toString(36).slice(2),
          name: "",
          type: "",
          rarity: "",
          setName: "",
          cardNumber: "",
          notes: "",
          tags: [],
          imageData: "",
          extra: {}
        };
      },

      getCardById(id) {
        return AdminState.cards.find(c => c.id === id) || null;
      },

      updateLibrarySummary() {
        const total = AdminState.cards.length;
        const types = {};
        AdminState.cards.forEach(c => {
          types[c.type || "Unknown"] = (types[c.type || "Unknown"] || 0) + 1;
        });
        const parts = Object.entries(types)
          .sort((a,b) => a[0].localeCompare(b[0]))
          .map(([t,n]) => `${t}: ${n}`);
        Dom.librarySummary.textContent = `${total} cards in library` + (parts.length ? " · " + parts.join(" · ") : "");
      },

      renderCardList() {
        const q = Dom.cardListSearch.value.trim().toLowerCase();
        Dom.cardList.innerHTML = "";

        const filtered = AdminState.cards.filter(c => {
          if (!q) return true;
          const haystack = [
            c.name || "",
            c.type || "",
            c.setName || "",
            c.cardNumber || ""
          ].join(" ").toLowerCase();
          return haystack.includes(q);
        });

        if (!filtered.length) {
          Dom.cardList.innerHTML = "<div class='small-note'>No cards match this search.</div>";
          return;
        }

        filtered
          .slice()
          .sort((a,b) => {
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.setName || "").localeCompare(b.setName || "") ||
                   (a.cardNumber || "").localeCompare(b.cardNumber || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(card => {
            const div = document.createElement("div");
            div.className = "card-row" + (card.id === AdminState.selectedCardId ? " selected" : "");
            div.dataset.cardId = card.id;

            const info = document.createElement("div");
            info.style.flex = "1";
            info.style.minWidth = "0";

            const main = document.createElement("div");
            main.className = "card-row-main";
            main.textContent = card.name || "(No Name)";

            const sub = document.createElement("div");
            sub.className = "card-row-sub";
            const num = card.cardNumber ? " #" + card.cardNumber : "";
            sub.textContent = `${card.type || ""} · ${card.setName || ""}${num}`;

            info.appendChild(main);
            info.appendChild(sub);
            div.appendChild(info);

            div.addEventListener("click", () => {
              AdminState.selectedCardId = card.id;
              CardLib.renderCardList();
              CardLib.loadSelectedCardIntoForm();
            });

            Dom.cardList.appendChild(div);
          });
      },

      loadSelectedCardIntoForm() {
        const card = CardLib.getCardById(AdminState.selectedCardId);
        if (!card) {
          Dom.cardNameInput.value = "";
          Dom.cardTypeInput.value = "";
          Dom.cardRarityInput.value = "";
          Dom.cardSetInput.value = "";
          Dom.cardNumberInput.value = "";
          Dom.cardTagsInput.value = "";
          Dom.cardNotesInput.value = "";
          CardLib.renderExtraFields("");
          Dom.cardImagePreview.innerHTML = "<span class='small-note'>No image chosen.</span>";
          return;
        }

        Dom.cardNameInput.value = card.name || "";
        Dom.cardTypeInput.value = card.type || "";
        Dom.cardRarityInput.value = card.rarity || "";
        Dom.cardSetInput.value = card.setName || "";
        Dom.cardNumberInput.value = card.cardNumber || "";
        Dom.cardTagsInput.value = (card.tags || []).join(", ");
        Dom.cardNotesInput.value = card.notes || "";

        CardLib.renderExtraFields(card.type || "", card.extra || {});
        if (card.imageData) {
          Dom.cardImagePreview.innerHTML = "";
          const img = document.createElement("img");
          img.src = card.imageData;
          Dom.cardImagePreview.appendChild(img);
        } else {
          Dom.cardImagePreview.innerHTML = "<span class='small-note'>No image chosen.</span>";
        }
      },

      renderExtraFields(type, extra = {}) {
        const container = Dom.extraFieldsContainer;
        container.innerHTML = "";

        const addField = (label, id, value, placeholder = "", typeInput="text") => {
          const wrap = document.createElement("div");
          wrap.className = "form-group";
          const lab = document.createElement("label");
          lab.className = "form-label";
          lab.textContent = label;
          const input = document.createElement("input");
          input.id = id;
          input.type = typeInput;
          input.value = value ?? "";
          input.placeholder = placeholder;
          wrap.appendChild(lab);
          wrap.appendChild(input);
          container.appendChild(wrap);
        };

        if (type === "Vehicle" || type === "Named Vehicle") {
          addField("Vehicle Type", "extraVehicleTypeInput", extra.vehicleType || "", "Drag, Drift, Off-Road, Rally...");
          addField("HP", "extraHpInput", extra.hp ?? "", "", "number");
          addField("CON", "extraConInput", extra.con ?? "", "", "number");
        } else if (type === "Driver" || type === "Named Driver" || type === "Track") {
          const wrap = document.createElement("div");
          wrap.className = "form-group";
          const lab = document.createElement("label");
          lab.className = "form-label";
          lab.textContent = "Vehicle Types (Drag, Drift, Off-Road, Rally – choose one or more)";
          const select = document.createElement("select");
          select.id = "extraVehicleTypesInput";
          select.multiple = true;
          select.size = 4;
          select.style.height = "90px";

          const typesArr = ["Drag","Drift","Off-Road","Rally"];
          const chosen = extra.vehicleTypes || [];
          typesArr.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;
            opt.selected = chosen.includes(t);
            select.appendChild(opt);
          });

          wrap.appendChild(lab);
          wrap.appendChild(select);
          container.appendChild(wrap);
        } else if (type === "Mod") {
          addField("Base Part", "extraModBasePartInput", extra.modBasePart || "", "Engine, Headers, Tires...");
          addField("Level 1", "extraModL1Input", extra.modLevel1 || "", "e.g., 1/2");
          addField("Level 2", "extraModL2Input", extra.modLevel2 || "", "e.g., 2/2");
          addField("Level 3", "extraModL3Input", extra.modLevel3 || "", "e.g., 3/3");
          addField("Level 4", "extraModL4Input", extra.modLevel4 || "", "e.g., 5/3");
        } else {
          container.innerHTML = "<p class='small-note'>No extra fields for this card type.</p>";
        }
      },

      readExtraFromForm(type) {
        const extra = {};
        if (type === "Vehicle" || type === "Named Vehicle") {
          const vType = document.getElementById("extraVehicleTypeInput")?.value || "";
          const hpVal = document.getElementById("extraHpInput")?.value;
          const conVal = document.getElementById("extraConInput")?.value;
          if (vType) extra.vehicleType = vType;
          if (hpVal !== "") extra.hp = Number(hpVal);
          if (conVal !== "") extra.con = Number(conVal);
        } else if (type === "Driver" || type === "Named Driver" || type === "Track") {
          const select = document.getElementById("extraVehicleTypesInput");
          if (select) {
            const chosen = Array.from(select.selectedOptions).map(o => o.value);
            extra.vehicleTypes = chosen;
          }
        } else if (type === "Mod") {
          const base = document.getElementById("extraModBasePartInput")?.value || "";
          const l1 = document.getElementById("extraModL1Input")?.value || "";
          const l2 = document.getElementById("extraModL2Input")?.value || "";
          const l3 = document.getElementById("extraModL3Input")?.value || "";
          const l4 = document.getElementById("extraModL4Input")?.value || "";
          if (base) extra.modBasePart = base;
          if (l1) extra.modLevel1 = l1;
          if (l2) extra.modLevel2 = l2;
          if (l3) extra.modLevel3 = l3;
          if (l4) extra.modLevel4 = l4;
        }
        return extra;
      },

      saveCurrentCard() {
        let card = CardLib.getCardById(AdminState.selectedCardId);
        if (!card) {
          card = CardLib.createEmptyCard();
          AdminState.cards.push(card);
          AdminState.selectedCardId = card.id;
        }

        card.name = Dom.cardNameInput.value.trim();
        card.type = Dom.cardTypeInput.value;
        card.rarity = Dom.cardRarityInput.value.trim();
        card.setName = Dom.cardSetInput.value.trim();
        card.cardNumber = Dom.cardNumberInput.value.trim();
        card.notes = Dom.cardNotesInput.value;
        card.tags = (Dom.cardTagsInput.value || "")
          .split(",")
          .map(t => t.trim())
          .filter(t => t);

        card.extra = CardLib.readExtraFromForm(card.type);

        AdminState.cards = AdminState.cards.map(c => (c.id === card.id ? card : c));
        CardLib.updateLibrarySummary();
        CardLib.renderCardList();
        alert("Card saved.");
      },

      duplicateSelectedCard() {
        const original = CardLib.getCardById(AdminState.selectedCardId);
        if (!original) {
          alert("No card selected to duplicate.");
          return;
        }
        const copy = JSON.parse(JSON.stringify(original));
        copy.id = "card-" + Math.random().toString(36).slice(2);
        copy.name = original.name + " (Copy)";
        AdminState.cards.push(copy);
        AdminState.selectedCardId = copy.id;
        CardLib.updateLibrarySummary();
        CardLib.renderCardList();
        CardLib.loadSelectedCardIntoForm();
      },

      deleteSelectedCard() {
        if (!AdminState.selectedCardId) {
          alert("No card selected.");
          return;
        }
        const card = CardLib.getCardById(AdminState.selectedCardId);
        if (!card) return;
        if (!confirm(`Delete card "${card.name}" from the library?`)) return;
        AdminState.cards = AdminState.cards.filter(c => c.id !== card.id);
        AdminState.selectedCardId = null;
        CardLib.updateLibrarySummary();
        CardLib.renderCardList();
        CardLib.loadSelectedCardIntoForm();
      },

      async loadLibraryFromFile(file) {
        try {
          const text = await file.text();
          const json = JSON.parse(text);
          AdminState.cards = Array.isArray(json) ? json : [];
          AdminState.cards.forEach(c => {
            if (!c.id) c.id = "card-" + Math.random().toString(36).slice(2);
            if (!c.extra) c.extra = {};
            if (!Array.isArray(c.tags)) c.tags = [];
          });
          AdminState.selectedCardId = null;
          CardLib.updateLibrarySummary();
          CardLib.renderCardList();
          CardLib.loadSelectedCardIntoForm();
          alert("Library loaded.");
        } catch (e) {
          console.error(e);
          alert("Error reading JSON library.");
        }
      },

      saveLibraryToFile() {
        const blob = new Blob([JSON.stringify(AdminState.cards, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "drive-card.json";
        a.click();
        URL.revokeObjectURL(url);
      },

      init() {
        Dom.cardTypeInput.addEventListener("change", () => {
          CardLib.renderExtraFields(Dom.cardTypeInput.value || "", {});
        });

        Dom.cardImageInput.addEventListener("change", () => {
          const file = Dom.cardImageInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            if (!AdminState.selectedCardId) {
              const newCard = CardLib.createEmptyCard();
              AdminState.cards.push(newCard);
              AdminState.selectedCardId = newCard.id;
            }
            const card = CardLib.getCardById(AdminState.selectedCardId);
            card.imageData = reader.result;
            Dom.cardImagePreview.innerHTML = "";
            const img = document.createElement("img");
            img.src = reader.result;
            Dom.cardImagePreview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });

        Dom.cardListSearch.addEventListener("input", () => CardLib.renderCardList());

        Dom.newCardBtn.addEventListener("click", () => {
          const card = CardLib.createEmptyCard();
          AdminState.cards.push(card);
          AdminState.selectedCardId = card.id;
          CardLib.updateLibrarySummary();
          CardLib.renderCardList();
          CardLib.loadSelectedCardIntoForm();
        });
        Dom.deleteCardBtn.addEventListener("click", () => CardLib.deleteSelectedCard());
        Dom.saveCardBtn.addEventListener("click", () => CardLib.saveCurrentCard());
        Dom.duplicateCardBtn.addEventListener("click", () => CardLib.duplicateSelectedCard());

        Dom.loadLibraryBtn.addEventListener("click", () => Dom.loadLibraryInput.click());
        Dom.loadLibraryInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) CardLib.loadLibraryFromFile(file);
        });
        Dom.saveLibraryBtn.addEventListener("click", () => CardLib.saveLibraryToFile());

        CardLib.updateLibrarySummary();
        CardLib.renderCardList();
        CardLib.loadSelectedCardIntoForm();
      }
    };

    const BulkImport = {
      handleFileChange(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            bulkWorkbook = XLSX.read(data, { type: "array" });
            Dom.bulkSheetSelect.innerHTML = "<option value=''>-- Sheet --</option>";
            bulkWorkbook.SheetNames.forEach(name => {
              const opt = document.createElement("option");
              opt.value = name;
              opt.textContent = name;
              Dom.bulkSheetSelect.appendChild(opt);
            });
            Dom.bulkStep1Status.textContent = `Workbook loaded. Sheets: ${bulkWorkbook.SheetNames.join(", ")}. Select a sheet and click “Parse Sheet”.`;
          } catch (err) {
            console.error(err);
            Dom.bulkStep1Status.textContent = "Error reading workbook. Make sure it's a valid .xlsx file.";
          }
        };
        reader.readAsArrayBuffer(file);
      },

      parseSheet() {
        if (!bulkWorkbook) {
          alert("Upload a .xlsx file first.");
          return;
        }
        const sheetName = Dom.bulkSheetSelect.value;
        if (!sheetName) {
          alert("Select a sheet.");
          return;
        }
        const ws = bulkWorkbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
        if (!rows.length) {
          Dom.bulkStep1Status.textContent = "Sheet has no rows.";
          return;
        }

        bulkCards = rows.map((row, idx) => {
          let name = "";
          let type = "";
          let setName = "";
          let rarity = "";

          switch (sheetName) {
            case "Crew Cards":
              name    = row["Crew Name"];
              type    = "Crew";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Mod Cards":
              name    = row["Mod Name"];
              type    = "Mod";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Driver Cards":
              name    = row["Driver Name"];
              type    = "Driver";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Named Driver Cards":
              name    = row["Driver Name"];
              type    = "Named Driver";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Condition Cards":
              name    = row["Condition Name"];
              type    = "Condition";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Track Cards":
              name    = row["Track Name"];
              type    = "Track";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "Vehicle Cards":
              name    = row["VEHICLE name"];
              type    = "Vehicle";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "NAMED VEHICLE":
              name    = row["NAMED VEHICLE NAME"];
              type    = "Named Vehicle";
              setName = row["SET"];
              rarity  = row["RARITY"];
              break;
            case "MISC":
              name    = row["TOKENS/COUNTERS"];
              type    = "Misc";
              setName = "";
              rarity  = row["RARITY"];
              break;
            default:
              name    = row["Card Name"] || row["Name"] || row["Card"] || "";
              type    = row["Card Type"] || row["Type"] || "";
              setName = row["SET"] || row["Set"] || row["Set Name"] || "";
              rarity  = row["RARITY"] || row["Rarity"] || "";
          }

          name    = name    || "";
          type    = type    || "";
          setName = setName || "";
          rarity  = rarity  || "";

          return {
            index: idx,
            sheetName,
            name,
            type,
            setName,
            rarity,
            raw: row,
            selected: !!name
          };
        }).filter(c => c.name);

        Dom.bulkStep1Status.textContent = `Parsed ${bulkCards.length} potential cards from "${sheetName}".`;

        BulkImport.buildFilterOptions();
        BulkImport.renderSelectionList();
        Dom.bulkStep2.style.display = "";
        Dom.bulkStep3.style.display = "none";
      },

      buildFilterOptions() {
        const typeSet = new Set();
        const setSet = new Set();

        bulkCards.forEach(c => {
          if (c.type) typeSet.add(c.type);
          if (c.setName) setSet.add(c.setName);
        });

        Dom.bulkFilterType.innerHTML = "<option value=''>All Types</option>";
        Dom.bulkFilterSet.innerHTML = "<option value=''>All Sets</option>";

        Array.from(typeSet).sort().forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          Dom.bulkFilterType.appendChild(opt);
        });

        Array.from(setSet).sort().forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          Dom.bulkFilterSet.appendChild(opt);
        });
      },

      renderSelectionList() {
        Dom.bulkSelectionList.innerHTML = "";

        const q = bulkFilterState.text.trim().toLowerCase();
        const tf = bulkFilterState.type;
        const sf = bulkFilterState.set;

        const filtered = bulkCards.filter(card => {
          if (tf && card.type !== tf) return false;
          if (sf && card.setName !== sf) return false;

          if (q) {
            const haystack = [
              card.name || "",
              card.type || "",
              card.setName || "",
              card.rarity || ""
            ].join(" ").toLowerCase();
            if (!haystack.includes(q)) return false;
          }
          return true;
        });

        if (!filtered.length) {
          Dom.bulkSelectionList.innerHTML =
            "<div class='small-note'>No rows match the current filters.</div>";
          return;
        }

        filtered.forEach(card => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.justifyContent = "space-between";
          row.style.gap = "0.5rem";
          row.style.padding = "0.2rem 0.3rem";
          row.style.borderRadius = "0.4rem";
          row.style.background = card.index % 2 === 0 ?
            "rgba(15,23,42,0.7)" :
            "rgba(15,23,42,0.45)";

          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.alignItems = "center";
          left.style.gap = "0.4rem";
          left.style.flex = "1";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.checked = !!card.selected;
          checkbox.addEventListener("change", () => {
            card.selected = checkbox.checked;
          });

          const label = document.createElement("div");
          label.style.fontSize = "0.8rem";
          label.innerHTML = `<strong>${card.name}</strong><br>
            <span style="color:#9ca3af; font-size:0.75rem;">${card.type || ""} · ${card.setName || ""}</span>`;

          left.appendChild(checkbox);
          left.appendChild(label);

          row.appendChild(left);
          Dom.bulkSelectionList.appendChild(row);
        });
      },

      goToStep3() {
        const chosen = bulkCards.filter(c => c.selected);
        if (!chosen.length) {
          alert("No cards selected. Use the checkboxes in Step 2.");
          return;
        }
        Dom.bulkStep3.style.display = "";
        BulkImport.renderImageStep(chosen);
      },

      renderImageStep(selectedCards) {
        Dom.bulkImageList.innerHTML = "";
        Dom.bulkStep3Summary.textContent = `${selectedCards.length} cards selected. Attach images as needed, then click “Finish Import”.`;

        selectedCards.forEach(card => {
          const row = document.createElement("div");
          row.style.display = "grid";
          row.style.gridTemplateColumns = "minmax(0,1.3fr) minmax(0,1.7fr)";
          row.style.gap = "0.4rem";
          row.style.padding = "0.3rem 0.35rem";
          row.style.borderRadius = "0.5rem";
          row.style.marginBottom = "0.35rem";
          row.style.background = card.index % 2 === 0 ?
            "rgba(15,23,42,0.7)" :
            "rgba(15,23,42,0.45)";

          const left = document.createElement("div");
          left.innerHTML = `<div style="font-size:0.85rem; font-weight:600;">${card.name}</div>
            <div style="font-size:0.75rem; color:#9ca3af;">${card.type || ""} · ${card.setName || ""}</div>`;

          const right = document.createElement("div");
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/png,image/jpeg";

          const preview = document.createElement("div");
          preview.className = "image-preview";
          preview.style.minHeight = "80px";
          preview.innerHTML = "<span class='small-note'>No image chosen yet.</span>";

          fileInput.addEventListener("change", () => {
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              card.imageData = reader.result;
              preview.innerHTML = "";
              const img = document.createElement("img");
              img.src = reader.result;
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          });

          right.appendChild(fileInput);
          right.appendChild(preview);

          row.appendChild(left);
          row.appendChild(right);
          Dom.bulkImageList.appendChild(row);
        });
      },

      finishImport() {
        const selected = bulkCards.filter(c => c.selected);
        if (!selected.length) {
          alert("No cards selected.");
          return;
        }

        let countAdded = 0;

        const parseList = (val) =>
          String(val || "")
            .split(",")
            .map(t => t.trim())
            .filter(Boolean);

        const parseHpCon = (val) => {
          const out = { hp: undefined, con: undefined };
          if (!val) return out;
          const cleaned = String(val).replace(/\s/g, "");
          const parts = cleaned.split("/");
          if (parts[0] !== undefined && parts[0] !== "") out.hp = Number(parts[0]);
          if (parts[1] !== undefined && parts[1] !== "") out.con = Number(parts[1]);
          return out;
        };

        selected.forEach(bc => {
          const row   = bc.raw || {};
          const sheet = bc.sheetName || "";

          const card = CardLib.createEmptyCard();

          card.name     = bc.name ||
                          row["Card Name"] ||
                          row["Name"] ||
                          row["Card"] ||
                          "";
          card.type     = bc.type ||
                          row["Card Type"] ||
                          row["Type"] ||
                          "";
          card.setName  = bc.setName ||
                          row["SET"] ||
                          row["Set"] ||
                          row["Set Name"] ||
                          "";
          card.rarity   = bc.rarity ||
                          row["RARITY"] ||
                          row["Rarity"] ||
                          "";
          card.cardNumber =
            row["Card Number"] ||
            row["Number"] ||
            "";

          const tagsVal =
            row["Tags"] ||
            row["Tag"] ||
            "";
          card.tags = parseList(tagsVal);

          card.imageData = bc.imageData || "";
          card.extra = {};

          switch (sheet) {
            case "Crew Cards":
              card.notes = row["Crew Trait"] || "";
              break;

            case "Mod Cards":
              card.notes = row["Mod Ability"] || "";
              card.extra.modBasePart = row["Base Part"] || "";
              card.extra.modLevel1   = row["Mod Lvl 1"] || "";
              card.extra.modLevel2   = row["Mod Lvl 2"] || "";
              card.extra.modLevel3   = row["Mod Lvl 3"] || "";
              card.extra.modLevel4   = row["Mod Lvl 4"] || "";
              card.extra.modType     = row["Mod TYPE"] || "";
              break;

            case "Driver Cards":
              card.notes = row["Driver Trait"] || "";
              break;

            case "Named Driver Cards":
              card.notes = row["Driver Trait"] || "";
              card.type  = "Named Driver";
              break;

            case "Condition Cards":
              card.notes = row["Condition Trait"] || "";
              break;

            case "Track Cards":
              card.notes = row["Track Trait"] || "";
              if (row["Vehicle Type"]) {
                const vtStr = String(row["Vehicle Type"]).toUpperCase();
                if (vtStr.includes("ALL")) {
                  card.extra.vehicleTypes = ["Drag","Drift","Off-Road","Rally"];
                } else {
                  const map = {"DRAG":"Drag","DRIFT":"Drift","OFF-ROAD":"Off-Road","OFF ROAD":"Off-Road","RALLY":"Rally"};
                  const parts = vtStr.split(/[\/,]/).map(s => s.trim()).filter(Boolean);
                  card.extra.vehicleTypes = Array.from(new Set(
                    parts.map(p => map[p] || null).filter(Boolean)
                  ));
                }
              }
              break;

            case "Vehicle Cards":
              card.notes = row["TRAIT"] || "";
              card.type  = "Vehicle";
              card.extra.vehicleType = row["Vehicle Type"] || "";
              const hpCon1 = parseHpCon(row["VEHICLE HP/CON"]);
              if (hpCon1.hp !== undefined) card.extra.hp = hpCon1.hp;
              if (hpCon1.con !== undefined) card.extra.con = hpCon1.con;
              break;

            case "NAMED VEHICLE":
              card.notes = row["VEHICLE TRAIT"] || "";
              card.type  = "Named Vehicle";
              card.extra.vehicleType = row["Vehicle Type"] || "";
              const hpCon2 = parseHpCon(row["VEHICLE HP/CON"]);
              if (hpCon2.hp !== undefined) card.extra.hp = hpCon2.hp;
              if (hpCon2.con !== undefined) card.extra.con = hpCon2.con;
              break;

            case "MISC":
              card.notes = row["ABILITY"] || "";
              card.type  = "Misc";
              break;

            default:
              card.notes =
                row["Rules Text"] ||
                row["Text"] ||
                row["Rules"] ||
                "";
              break;
          }

          AdminState.cards.push(card);
          countAdded++;
        });

        CardLib.updateLibrarySummary();
        CardLib.renderCardList();
        alert(`Imported ${countAdded} cards into the library. You can now download the updated JSON.`);
      },

      init() {
        Dom.bulkFileInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) BulkImport.handleFileChange(file);
        });
        Dom.bulkParseSheetBtn.addEventListener("click", () => BulkImport.parseSheet());

        Dom.bulkFilterText.addEventListener("input", () => {
          bulkFilterState.text = Dom.bulkFilterText.value;
          BulkImport.renderSelectionList();
        });
        Dom.bulkFilterType.addEventListener("change", () => {
          bulkFilterState.type = Dom.bulkFilterType.value;
          BulkImport.renderSelectionList();
        });
        Dom.bulkFilterSet.addEventListener("change", () => {
          bulkFilterState.set = Dom.bulkFilterSet.value;
          BulkImport.renderSelectionList();
        });

        Dom.bulkSelectShownBtn.addEventListener("click", () => {
          const q = bulkFilterState.text.trim().toLowerCase();
          const tf = bulkFilterState.type;
          const sf = bulkFilterState.set;

          bulkCards.forEach(card => {
            if (tf && card.type !== tf) return;
            if (sf && card.setName !== sf) return;

            if (q) {
              const haystack = [
                card.name || "",
                card.type || "",
                card.setName || "",
                card.rarity || ""
              ].join(" ").toLowerCase();
              if (!haystack.includes(q)) return;
            }

            card.selected = true;
          });

          BulkImport.renderSelectionList();
        });

        Dom.bulkClearShownBtn.addEventListener("click", () => {
          const q = bulkFilterState.text.trim().toLowerCase();
          const tf = bulkFilterState.type;
          const sf = bulkFilterState.set;

          bulkCards.forEach(card => {
            if (tf && card.type !== tf) return;
            if (sf && card.setName !== sf) return;

            if (q) {
              const haystack = [
                card.name || "",
                card.type || "",
                card.setName || "",
                card.rarity || ""
              ].join(" ").toLowerCase();
              if (!haystack.includes(q)) return;
            }

            card.selected = false;
          });

          BulkImport.renderSelectionList();
        });

        Dom.bulkToStep3Btn.addEventListener("click", () => BulkImport.goToStep3());
        Dom.bulkImportFinishBtn.addEventListener("click", () => BulkImport.finishImport());
      }
    };

    const PreconAdmin = {
      getActivePrecon() {
        if (AdminState.selectedPreconIndex == null) return null;
        return AdminState.precons[AdminState.selectedPreconIndex] || null;
      },

      renderPreconList() {
        Dom.preconList.innerHTML = "";
        if (!AdminState.precons.length) {
          Dom.preconList.innerHTML = "<div class='small-note'>No precons yet. Create one with “+ New Precon”.</div>";
          return;
        }
        AdminState.precons.forEach((p, idx) => {
          const div = document.createElement("div");
          div.className = "precon-row" + (idx === AdminState.selectedPreconIndex ? " selected" : "");
          div.innerHTML = `<strong>${p.name || "(Untitled Precon)"}</strong><br>
            <span style="font-size:0.75rem; color:#9ca3af;">Cards: ${PreconAdmin.totalCards(p)}</span>`;
          div.addEventListener("click", () => {
            AdminState.selectedPreconIndex = idx;
            PreconAdmin.renderPreconList();
            PreconAdmin.loadActivePreconIntoForm();
          });
          Dom.preconList.appendChild(div);
        });
      },

      totalCards(precon) {
        return Object.values(precon.cards || {}).reduce((a,b) => a + Number(b || 0), 0);
      },

      loadActivePreconIntoForm() {
        const p = PreconAdmin.getActivePrecon();
        if (!p) {
          Dom.preconNameInput.value = "";
          Dom.preconNotesInput.value = "";
          Dom.preconCardsList.innerHTML = "<div class='small-note'>No precon selected.</div>";
          Dom.preconStatsInfo.textContent = "";
          return;
        }

        Dom.preconNameInput.value = p.name || "";
        Dom.preconNotesInput.value = p.notes || "";
        PreconAdmin.renderPreconCardsList();
      },

      renderPreconCardsList() {
        const p = PreconAdmin.getActivePrecon();
        if (!p) {
          Dom.preconCardsList.innerHTML = "<div class='small-note'>No precon selected.</div>";
          return;
        }
        const cardsObj = p.cards || {};
        const entries = Object.entries(cardsObj);
        Dom.preconCardsList.innerHTML = "";

        if (!entries.length) {
          Dom.preconCardsList.innerHTML = "<div class='small-note'>No cards in this precon yet.</div>";
          Dom.preconStatsInfo.textContent = "Cards: 0";
          return;
        }

        entries
          .slice()
          .sort(([aId],[bId]) => {
            const a = CardLib.getCardById(aId);
            const b = CardLib.getCardById(bId);
            if (!a || !b) return 0;
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(([cardId, qty]) => {
            const card = CardLib.getCardById(cardId);
            const row = document.createElement("div");
            row.className = "precon-card-row";

            const info = document.createElement("div");
            info.style.flex = "1";
            info.style.minWidth = "0";
            info.innerHTML = `<div class="card-row-main">${qty}x ${card ? card.name : "(Unknown card)"}</div>
              <div class="card-row-sub">${card ? (card.type || "") : cardId}</div>`;

            const btn = document.createElement("button");
            btn.className = "secondary";
            btn.type = "button";
            btn.textContent = "Remove";
            btn.addEventListener("click", () => {
              delete p.cards[cardId];
              PreconAdmin.renderPreconCardsList();
            });

            row.appendChild(info);
            row.appendChild(btn);
            Dom.preconCardsList.appendChild(row);
          });

        const total = PreconAdmin.totalCards(p);
        Dom.preconStatsInfo.textContent = `Cards: ${total}`;
      },

      refreshPreconCardSelect() {
        Dom.preconCardSelect.innerHTML = "";
        const optNone = document.createElement("option");
        optNone.value = "";
        optNone.textContent = "-- Select card --";
        Dom.preconCardSelect.appendChild(optNone);

        AdminState.cards
          .slice()
          .sort((a,b) => (a.name || "").localeCompare(b.name || ""))
          .forEach(card => {
            const opt = document.createElement("option");
            opt.value = card.id;
            opt.textContent = `${card.name} [${card.type || ""}]`;
            Dom.preconCardSelect.appendChild(opt);
          });
      },

      newPrecon() {
        const p = {
          name: "New Precon",
          notes: "",
          cards: {}
        };
        AdminState.precons.push(p);
        AdminState.selectedPreconIndex = AdminState.precons.length - 1;
        PreconAdmin.renderPreconList();
        PreconAdmin.loadActivePreconIntoForm();
      },

      deletePrecon() {
        if (AdminState.selectedPreconIndex == null) {
          alert("No precon selected.");
          return;
        }
        const p = PreconAdmin.getActivePrecon();
        if (!p) return;
        if (!confirm(`Delete precon "${p.name}"?`)) return;
        AdminState.precons.splice(AdminState.selectedPreconIndex, 1);
        AdminState.selectedPreconIndex = null;
        PreconAdmin.renderPreconList();
        PreconAdmin.loadActivePreconIntoForm();
      },

      saveActivePrecon() {
        const p = PreconAdmin.getActivePrecon();
        if (!p) {
          alert("No precon selected.");
          return;
        }
        p.name = Dom.preconNameInput.value.trim() || p.name || "Precon";
        p.notes = Dom.preconNotesInput.value;
        PreconAdmin.renderPreconList();
        alert("Precon changes saved (in memory). Download JSON to persist.");
      },

      addCardToPrecon() {
        const p = PreconAdmin.getActivePrecon();
        if (!p) {
          alert("No precon selected.");
          return;
        }
        const cardId = Dom.preconCardSelect.value;
        if (!cardId) {
          alert("Select a card to add.");
          return;
        }
        const qty = Number(Dom.preconCardQtyInput.value) || 1;
        p.cards[cardId] = (p.cards[cardId] || 0) + qty;
        PreconAdmin.renderPreconCardsList();
      },

      async loadPreconsFromFile(file) {
        try {
          const text = await file.text();
          const json = JSON.parse(text);
          AdminState.precons = Array.isArray(json) ? json : [];
          AdminState.selectedPreconIndex = AdminState.precons.length ? 0 : null;
          PreconAdmin.renderPreconList();
          PreconAdmin.loadActivePreconIntoForm();
          alert("Precons loaded.");
        } catch (e) {
          console.error(e);
          alert("Error reading precons JSON.");
        }
      },

      savePreconsToFile() {
        const blob = new Blob([JSON.stringify(AdminState.precons, null, 2)], {
          type: "application/json"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "drive-precons.json";
        a.click();
        URL.revokeObjectURL(url);
      },

      init() {
        Dom.newPreconBtn.addEventListener("click", () => PreconAdmin.newPrecon());
        Dom.deletePreconBtn.addEventListener("click", () => PreconAdmin.deletePrecon());
        Dom.preconAddCardBtn.addEventListener("click", () => PreconAdmin.addCardToPrecon());
        Dom.preconSaveBtn.addEventListener("click", () => PreconAdmin.saveActivePrecon());

        Dom.loadPreconsBtn.addEventListener("click", () => Dom.loadPreconsInput.click());
        Dom.loadPreconsInput.addEventListener("change", e => {
          const file = e.target.files[0];
          if (file) PreconAdmin.loadPreconsFromFile(file);
        });
        Dom.savePreconsBtn.addEventListener("click", () => PreconAdmin.savePreconsToFile());
      }
    };

    (function init() {
      Mode.init();
      CardLib.init();
      BulkImport.init();
      PreconAdmin.init();

      const originalUpdateSummary = CardLib.updateLibrarySummary;
      CardLib.updateLibrarySummary = function() {
        originalUpdateSummary.call(CardLib);
        PreconAdmin.refreshPreconCardSelect();
      };
      PreconAdmin.refreshPreconCardSelect();
    })();
  </script>
</body>
</html>
