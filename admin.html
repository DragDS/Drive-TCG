<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE Card Library â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.7rem;
    }
    header small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    header .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-left: auto;
    }

    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .mode-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mode-btn {
      border-radius: 999px;
      padding: 0.35rem 0.85rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.1s ease, transform 0.05s ease,
        box-shadow 0.1s ease, border-color 0.1s ease;
    }
    .mode-btn:hover {
      background: #030712;
      box-shadow: 0 6px 14px rgba(0,0,0,0.4);
    }
    .mode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 2.2fr);
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    textarea {
      min-height: 4rem;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      transition: background 0.1s ease, transform 0.05s ease,
        box-shadow 0.1s ease;
    }
    button:hover {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button.danger:hover {
      background: #7f1d1d;
    }
    button.secondary {
      background: #020617;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }
    @media (max-width: 700px) {
      .field-group {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .field {
      margin-bottom: 0.4rem;
    }
    .field label {
      display: block;
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }

    .small-note {
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .card-list {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      overflow: hidden;
      max-height: calc(100vh - 210px);
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 900px) {
      .card-list {
        max-height: 400px;
      }
    }
    .card-list-header,
    .card-list-row {
      display: grid;
      grid-template-columns: minmax(0,1.9fr) minmax(0,1fr) minmax(0,1fr) minmax(0,0.6fr);
      gap: 0.25rem;
      font-size: 0.78rem;
      padding: 0.25rem 0.4rem;
      align-items: center;
    }
    .card-list-header {
      background: #020617;
      border-bottom: 1px solid #1f2937;
      font-weight: 600;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .card-list-body {
      overflow-y: auto;
      flex: 1;
    }
    .card-list-row {
      cursor: pointer;
    }
    .card-list-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.6);
    }
    .card-list-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.3);
    }
    .card-list-row:hover {
      background: rgba(34, 197, 94, 0.15);
    }
    .card-list-row.active {
      outline: 1px solid #22c55e;
      background: rgba(34, 197, 94, 0.2);
    }

    .tag-input {
      font-size: 0.8rem;
    }

    .vehicle-types-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.8rem;
    }
    .vehicle-types-group label {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      margin: 0;
      cursor: pointer;
    }
    .vehicle-types-group input[type="checkbox"],
    .vehicle-types-group input[type="radio"] {
      accent-color: #22c55e;
    }

    .mod-levels {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
    }

    .image-preview {
      margin-top: 0.4rem;
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      text-align: center;
    }
    .image-preview img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .deck-list {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      padding: 0.4rem;
      font-size: 0.78rem;
      max-height: 260px;
      overflow-y: auto;
      background: #020617;
    }
    .deck-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.35rem;
      padding: 0.15rem 0.2rem;
      border-radius: 0.4rem;
    }
    .deck-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.6);
    }
    .deck-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.3);
    }
    .deck-row-info {
      flex: 1;
      min-width: 0;
    }
    .deck-row-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .deck-row-sub {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .deck-row-qty {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      flex-shrink: 0;
    }
    .deck-qty-number {
      min-width: 1.2rem;
      text-align: center;
      font-size: 0.8rem;
    }
    .deck-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.05rem 0.4rem;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .deck-btn:hover {
      background: #020617;
    }

    .card-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
      flex-wrap: wrap;
    }
    .submode-toggle {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .submode-btn {
      border-radius: 999px;
      padding: 0.2rem 0.7rem;
      font-size: 0.78rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.1s ease, border-color 0.1s ease,
        box-shadow 0.1s ease, transform 0.05s ease;
    }
    .submode-btn:hover {
      background: #030712;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .submode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .bulk-step {
      margin-top: 0.7rem;
      padding-top: 0.5rem;
      border-top: 1px solid #111827;
    }
    .bulk-step h3 {
      margin: 0 0 0.35rem;
      font-size: 0.9rem;
    }
    .bulk-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.35rem;
      align-items: center;
    }
    .bulk-textarea {
      width: 100%;
      min-height: 120px;
      font-size: 0.8rem;
    }
    .bulk-mapping-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
      margin-top: 0.35rem;
    }
    @media (max-width: 700px) {
      .bulk-mapping-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .bulk-mapping-row {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      padding: 0.35rem 0.45rem;
      background: rgba(15,23,42,0.6);
      font-size: 0.78rem;
    }
    .bulk-mapping-row label {
      display: block;
      margin-bottom: 0.15rem;
      font-size: 0.78rem;
      color: #e5e7eb;
    }
    .bulk-mapping-row select {
      width: 100%;
      padding: 0.3rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.78rem;
    }

    .drop-zone {
      border-radius: 0.5rem;
      border: 1px dashed #4b5563;
      padding: 0.3rem 0.4rem;
      font-size: 0.75rem;
      text-align: center;
      min-width: 110px;
      cursor: pointer;
      background: rgba(15,23,42,0.5);
      color: #9ca3af;
    }
    .drop-zone.dragover {
      border-style: solid;
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      color: #bbf7d0;
    }
    .drop-zone img {
      max-width: 90px;
      max-height: 60px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE Card Library â€“ Admin</h1>
        <small>Cards mode: edit or bulk import cards. Precons mode: build official decks. Export JSON files for the public site.</small>
      </div>
      <div class="header-actions">
        <button id="exportJsonBtn">Export JSON (drive-card.json)</button>
        <button id="exportPreconsBtn">Export Precons JSON</button>
      </div>
    </header>

    <div class="mode-toggle">
      <span class="mode-label">Mode:</span>
      <button id="modeCardsBtn" class="mode-btn active">Cards</button>
      <button id="modePreconsBtn" class="mode-btn">Precons</button>
    </div>

    <div class="layout">
      <!-- LEFT: Card list -->
      <section class="panel">
        <h2>Card Library</h2>
        <div class="toolbar">
          <input id="searchListInput" type="text" placeholder="Search by name, type, set, card #" />
          <button id="newCardBtn" type="button">+ New Card</button>
          <small id="countLabel"></small>
        </div>
        <div class="card-list">
          <div class="card-list-header">
            <div>Name</div>
            <div>Type</div>
            <div>Set</div>
            <div>#</div>
          </div>
          <div id="cardListBody" class="card-list-body"></div>
        </div>
      </section>

      <!-- RIGHT: Cards editor / bulk, or Precons -->
      <section class="panel">
        <!-- CARD MODE PANEL -->
        <div id="cardEditorPanel">
          <div class="card-editor-header">
            <h2 id="editorTitle">New Card</h2>
            <div class="submode-toggle">
              <button id="singleModeBtn" class="submode-btn active">Single Card Editor</button>
              <button id="bulkModeBtn" class="submode-btn">Bulk Import</button>
            </div>
          </div>

          <div id="singleToolbar" class="toolbar">
            <button id="saveCardBtn" type="button">ðŸ’¾ Save Card</button>
            <button id="deleteCardBtn" class="danger" type="button">ðŸ—‘ Delete</button>
            <button id="duplicateCardBtn" class="secondary" type="button">ðŸ“„ Duplicate</button>
          </div>

          <!-- Single card editor -->
          <div id="singleCardPanel">
            <div class="field">
              <label for="cardNameInput">Card Name</label>
              <input id="cardNameInput" type="text" placeholder="e.g. Pops, Junkyard Dog" />
            </div>

            <div class="field-group">
              <div class="field">
                <label for="cardTypeSelect">Card Type</label>
                <select id="cardTypeSelect">
                  <option value="">Select typeâ€¦</option>
                  <option value="Crew">Crew</option>
                  <option value="Driver">Driver</option>
                  <option value="Named Driver">Named Driver</option>
                  <option value="Vehicle">Vehicle</option>
                  <option value="Named Vehicle">Named Vehicle</option>
                  <option value="Mod">Mod</option>
                  <option value="Track">Track</option>
                  <option value="Condition">Condition</option>
                </select>
              </div>
              <div class="field">
                <label for="rarityInput">Rarity</label>
                <input id="rarityInput" type="text" placeholder="e.g. Common, Rare" />
              </div>
            </div>

            <div class="field-group">
              <div class="field">
                <label for="setNameInput">Set Name</label>
                <input id="setNameInput" type="text" placeholder="e.g. Set 1, Junkyard Mini Set" />
              </div>
              <div class="field">
                <label for="cardNumberInput">Card Number</label>
                <input id="cardNumberInput" type="text" placeholder="e.g. 001" />
              </div>
            </div>

            <div class="field">
              <label for="tagsInput">Tags (comma separated)</label>
              <input id="tagsInput" type="text" class="tag-input" placeholder="e.g. junkyard, drag, starter" />
            </div>

            <div class="field">
              <label for="rulesTextInput">Rules Text</label>
              <textarea id="rulesTextInput" placeholder="Card rules / effects text"></textarea>
            </div>

            <!-- Type-specific sections -->
            <div id="driverSection" style="display:none; margin-top:0.4rem;">
              <div class="field">
                <label>Vehicle Types (Driver / Named Driver / Track)</label>
                <div class="vehicle-types-group">
                  <label><input type="checkbox" class="vehTypeMulti" value="Drag" /> Drag</label>
                  <label><input type="checkbox" class="vehTypeMulti" value="Drift" /> Drift</label>
                  <label><input type="checkbox" class="vehTypeMulti" value="Off-Road" /> Off-Road</label>
                  <label><input type="checkbox" class="vehTypeMulti" value="Rally" /> Rally</label>
                </div>
                <div class="small-note">Drivers, Named Drivers, and Tracks can work with multiple vehicle types.</div>
              </div>
            </div>

            <div id="vehicleSection" style="display:none; margin-top:0.4rem;">
              <div class="field">
                <label>Vehicle Type</label>
                <div class="vehicle-types-group">
                  <label><input type="radio" name="vehicleTypeSingle" value="Drag" /> Drag</label>
                  <label><input type="radio" name="vehicleTypeSingle" value="Drift" /> Drift</label>
                  <label><input type="radio" name="vehicleTypeSingle" value="Off-Road" /> Off-Road</label>
                  <label><input type="radio" name="vehicleTypeSingle" value="Rally" /> Rally</label>
                </div>
              </div>
              <div class="field-group">
                <div class="field">
                  <label for="hpInput">HP</label>
                  <input id="hpInput" type="number" min="0" placeholder="e.g. 8" />
                </div>
                <div class="field">
                  <label for="conInput">CON</label>
                  <input id="conInput" type="number" min="0" placeholder="e.g. 2" />
                </div>
              </div>
              <div class="small-note">Vehicle and Named Vehicle cards use a single primary type plus HP/CON.</div>
            </div>

            <div id="modSection" style="display:none; margin-top:0.4rem;">
              <div class="field">
                <label for="modBasePartInput">Base Part</label>
                <input id="modBasePartInput" type="text" placeholder="e.g. Engine, Headers, Tires" />
              </div>
              <div class="mod-levels">
                <div class="field">
                  <label for="modLevel1Input">Level 1</label>
                  <input id="modLevel1Input" type="text" placeholder="e.g. 1/2" />
                </div>
                <div class="field">
                  <label for="modLevel2Input">Level 2</label>
                  <input id="modLevel2Input" type="text" placeholder="e.g. 2/2" />
                </div>
                <div class="field">
                  <label for="modLevel3Input">Level 3</label>
                  <input id="modLevel3Input" type="text" placeholder="e.g. 3/3" />
                </div>
                <div class="field">
                  <label for="modLevel4Input">Level 4</label>
                  <input id="modLevel4Input" type="text" placeholder="e.g. 5/3 or â€”" />
                </div>
              </div>
            </div>

            <div class="field" style="margin-top:0.6rem;">
              <label for="imageInput">Card Image (PNG/JPEG)</label>
              <input id="imageInput" type="file" accept="image/*" />
              <div class="image-preview" id="imagePreview">
                <small>No image loaded yet.</small>
              </div>
            </div>

            <div class="small-note">
              Images are stored as data URLs (base64) in drive-card.json. The public site and deck builder already use <code>imageData</code>.
            </div>
          </div>

          <!-- Bulk Import Panel -->
          <div id="bulkPanel" style="display:none;">
            <!-- Step 1 -->
            <div class="bulk-step">
              <h3>Step 1 â€“ Load data</h3>
              <p class="small-note">
                Option A: Upload your full DRIVE workbook (<strong>.xlsx</strong>).  
                Option B: Paste or upload CSV/text from a single sheet.
              </p>

              <!-- XLSX upload -->
              <div class="bulk-row">
                <input id="xlsxFileInput" type="file" accept=".xlsx" />
                <select id="xlsxSheetSelect">
                  <option value="">Select sheetâ€¦</option>
                </select>
                <button id="xlsxLoadSheetBtn" type="button">Load Sheet from XLSX</button>
              </div>
              <small id="xlsxStatus" class="small-note"></small>

              <hr style="border:none;border-top:1px solid #111827;width:100%;margin:0.6rem 0;">

              <!-- Text / CSV import -->
              <textarea id="bulkRawInput" class="bulk-textarea" placeholder="Paste data from a single sheet (including header row) or use CSV below..."></textarea>
              <div class="bulk-row">
                <input id="bulkFileInput" type="file" accept=".csv,.txt" />
                <button id="bulkParseBtn" type="button">Parse CSV/Text</button>
                <small id="bulkParseStatus" class="small-note"></small>
              </div>
            </div>

            <!-- Step 2 â€“ Mapping (only for CSV/Text) -->
            <div id="bulkMappingContainer" class="bulk-step" style="display:none;">
              <h3>Step 2 â€“ Map columns to card fields</h3>
              <p class="small-note">
                This step is only used for manual CSV/Text import. XLSX imports use automatic mapping based on sheet type.
              </p>
              <div id="bulkMappingFields" class="bulk-mapping-grid"></div>
              <div class="bulk-row" style="margin-top:0.5rem;">
                <button id="bulkGenerateBtn" type="button">Generate Draft Cards</button>
                <small id="bulkMappingStatus" class="small-note"></small>
              </div>
            </div>

            <!-- Step 3 â€“ Images & Import -->
            <div id="bulkPreviewContainer" class="bulk-step" style="display:none;">
              <h3>Step 3 â€“ Attach images & import</h3>
              <p class="small-note">
                For each draft card, drag & drop its image file onto the slot, or click the slot to choose a file.  
                When you're ready, import all drafts into the main library.
              </p>
              <div id="bulkPreviewList" class="deck-list"></div>
              <div class="bulk-row" style="margin-top:0.5rem;">
                <button id="bulkImportBtn" type="button">Import Draft Cards into Library</button>
                <button id="bulkClearBtn" type="button" class="secondary">Clear Bulk Session</button>
                <small id="bulkImportStatus" class="small-note"></small>
              </div>
            </div>
          </div>
        </div>

        <!-- PRECON MODE PANEL -->
        <div id="preconPanel" style="display:none;">
          <h2>Precon Decks</h2>
          <div class="toolbar">
            <select id="preconSelect"></select>
            <button id="newPreconBtn" type="button">+ New Precon</button>
            <button id="duplicatePreconBtn" class="secondary" type="button">ðŸ“„ Duplicate</button>
            <button id="deletePreconBtn" class="danger" type="button">ðŸ—‘ Delete</button>
          </div>

          <div class="field">
            <label for="preconNameInput">Precon Name</label>
            <input id="preconNameInput" type="text" placeholder="e.g. Junkyard Starter" />
          </div>

          <div class="field">
            <label for="preconNotesInput">Description / Notes</label>
            <textarea id="preconNotesInput" placeholder="Optional description for this precon"></textarea>
          </div>

          <div class="field">
            <button id="addSelectedCardToPreconBtn" type="button">+ Add Selected Card from Library</button>
            <div class="small-note">
              Select a card in the library on the left, then click this to add it to the active precon.
            </div>
          </div>

          <div class="field">
            <label>Precon Contents</label>
            <div id="preconStats" class="small-note"></div>
            <div id="preconList" class="deck-list" style="margin-top:0.25rem;"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- XLSX library for reading your DRIVE workbook in the browser -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    let cards = [];
    let selectedIndex = -1;
    let currentImageData = "";

    // quick sanity check
    if (typeof XLSX === "undefined") {
      console.error("XLSX library failed to load. Check the script src URL.");
    }

    // Precon decks
    let precons = [];
    let activePreconIndex = 0;
    const PRECONS_KEY = "drivePrecons_v1";

    // Bulk import state
    let bulkHeaders = [];
    let bulkRows = [];
    let bulkDraftCards = [];
    const bulkFieldDefs = [
      { key: "name", label: "Card Name" },
      { key: "type", label: "Card Type" },
      { key: "rarity", label: "Rarity" },
      { key: "setName", label: "Set Name" },
      { key: "cardNumber", label: "Card Number" },
      { key: "tags", label: "Tags (comma or ; separated)" },
      { key: "notes", label: "Rules Text" },
      { key: "extra.vehicleTypes", label: "Vehicle Types (multi)" },
      { key: "extra.vehicleType", label: "Vehicle Type (single)" },
      { key: "extra.hp", label: "HP" },
      { key: "extra.con", label: "CON" },
      { key: "extra.modBasePart", label: "Mod Base Part" },
      { key: "extra.modLevel1", label: "Mod Level 1" },
      { key: "extra.modLevel2", label: "Mod Level 2" },
      { key: "extra.modLevel3", label: "Mod Level 3" },
      { key: "extra.modLevel4", label: "Mod Level 4" }
    ];
    let bulkMapping = {};

    // XLSX workbook state
    let xlsxWorkbook = null;

    // Mode toggle
    const modeCardsBtn = document.getElementById("modeCardsBtn");
    const modePreconsBtn = document.getElementById("modePreconsBtn");
    const cardEditorPanel = document.getElementById("cardEditorPanel");
    const preconPanel = document.getElementById("preconPanel");

    const searchListInput = document.getElementById("searchListInput");
    const cardListBody = document.getElementById("cardListBody");
    const countLabel = document.getElementById("countLabel");

    const newCardBtn = document.getElementById("newCardBtn");
    const saveCardBtn = document.getElementById("saveCardBtn");
    const deleteCardBtn = document.getElementById("deleteCardBtn");
    const duplicateCardBtn = document.getElementById("duplicateCardBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportPreconsBtn = document.getElementById("exportPreconsBtn");
    const editorTitle = document.getElementById("editorTitle");

    const cardNameInput = document.getElementById("cardNameInput");
    const cardTypeSelect = document.getElementById("cardTypeSelect");
    const rarityInput = document.getElementById("rarityInput");
    const setNameInput = document.getElementById("setNameInput");
    const cardNumberInput = document.getElementById("cardNumberInput");
    const tagsInput = document.getElementById("tagsInput");
    const rulesTextInput = document.getElementById("rulesTextInput");

    const driverSection = document.getElementById("driverSection");
    const vehicleSection = document.getElementById("vehicleSection");
    const modSection = document.getElementById("modSection");

    const vehTypeMultiInputs = Array.from(document.querySelectorAll(".vehTypeMulti"));
    const hpInput = document.getElementById("hpInput");
    const conInput = document.getElementById("conInput");

    const modBasePartInput = document.getElementById("modBasePartInput");
    const modLevel1Input = document.getElementById("modLevel1Input");
    const modLevel2Input = document.getElementById("modLevel2Input");
    const modLevel3Input = document.getElementById("modLevel3Input");
    const modLevel4Input = document.getElementById("modLevel4Input");

    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");

    // Card submode (single vs bulk)
    const singleModeBtn = document.getElementById("singleModeBtn");
    const bulkModeBtn = document.getElementById("bulkModeBtn");
    const singleToolbar = document.getElementById("singleToolbar");
    const singleCardPanel = document.getElementById("singleCardPanel");
    const bulkPanel = document.getElementById("bulkPanel");
    let cardSubmode = "single";

    // Bulk DOM
    const bulkRawInput = document.getElementById("bulkRawInput");
    const bulkFileInput = document.getElementById("bulkFileInput");
    const bulkParseBtn = document.getElementById("bulkParseBtn");
    const bulkParseStatus = document.getElementById("bulkParseStatus");
    const bulkMappingContainer = document.getElementById("bulkMappingContainer");
    const bulkMappingFields = document.getElementById("bulkMappingFields");
    const bulkGenerateBtn = document.getElementById("bulkGenerateBtn");
    const bulkMappingStatus = document.getElementById("bulkMappingStatus");
    const bulkPreviewContainer = document.getElementById("bulkPreviewContainer");
    const bulkPreviewList = document.getElementById("bulkPreviewList");
    const bulkImportBtn = document.getElementById("bulkImportBtn");
    const bulkClearBtn = document.getElementById("bulkClearBtn");
    const bulkImportStatus = document.getElementById("bulkImportStatus");

    // XLSX DOM
    const xlsxFileInput = document.getElementById("xlsxFileInput");
    const xlsxSheetSelect = document.getElementById("xlsxSheetSelect");
    const xlsxLoadSheetBtn = document.getElementById("xlsxLoadSheetBtn");
    const xlsxStatus = document.getElementById("xlsxStatus");

    // Precon UI
    const preconSelect = document.getElementById("preconSelect");
    const newPreconBtn = document.getElementById("newPreconBtn");
    const duplicatePreconBtn = document.getElementById("duplicatePreconBtn");
    const deletePreconBtn = document.getElementById("deletePreconBtn");
    const preconNameInput = document.getElementById("preconNameInput");
    const preconNotesInput = document.getElementById("preconNotesInput");
    const addSelectedCardToPreconBtn = document.getElementById("addSelectedCardToPreconBtn");
    const preconList = document.getElementById("preconList");
    const preconStats = document.getElementById("preconStats");

    function setMode(mode) {
      if (mode === "cards") {
        cardEditorPanel.style.display = "";
        preconPanel.style.display = "none";
        modeCardsBtn.classList.add("active");
        modePreconsBtn.classList.remove("active");
      } else {
        cardEditorPanel.style.display = "none";
        preconPanel.style.display = "";
        modeCardsBtn.classList.remove("active");
        modePreconsBtn.classList.add("active");
      }
    }

    modeCardsBtn.addEventListener("click", () => setMode("cards"));
    modePreconsBtn.addEventListener("click", () => setMode("precons"));

    function setCardSubmode(mode) {
      cardSubmode = mode;
      if (mode === "single") {
        singleCardPanel.style.display = "";
        singleToolbar.style.display = "";
        bulkPanel.style.display = "none";
        singleModeBtn.classList.add("active");
        bulkModeBtn.classList.remove("active");
        const card = selectedIndex >= 0 ? cards[selectedIndex] : null;
        editorTitle.textContent = card ? `Edit Card: ${card.name || ""}` : "New Card";
      } else {
        singleCardPanel.style.display = "none";
        singleToolbar.style.display = "none";
        bulkPanel.style.display = "";
        singleModeBtn.classList.remove("active");
        bulkModeBtn.classList.add("active");
        editorTitle.textContent = "Bulk Import Cards";
      }
    }

    singleModeBtn.addEventListener("click", () => setCardSubmode("single"));
    bulkModeBtn.addEventListener("click", () => setCardSubmode("bulk"));

    async function loadExistingJson() {
      try {
        const res = await fetch("drive-card.json", { cache: "no-store" });
        if (!res.ok) {
          cards = [];
          return;
        }
        const json = await res.json();
        cards = Array.isArray(json) ? json : [];
      } catch {
        console.warn("Unable to load drive-card.json; starting empty.");
        cards = [];
      }
    }

    function renderCardList() {
      const q = searchListInput.value.trim().toLowerCase();
      let filtered = cards.map((c, idx) => ({ card: c, index: idx }));

      if (q) {
        filtered = filtered.filter(({ card }) => {
          const text =
            (card.name || "") + " " +
            (card.type || "") + " " +
            (card.setName || "") + " " +
            (card.cardNumber || "");
          return text.toLowerCase().includes(q);
        });
      }

      countLabel.textContent = `${filtered.length} cards shown / ${cards.length} total`;

      cardListBody.innerHTML = "";
      filtered.forEach(({ card, index }) => {
        const row = document.createElement("div");
        row.className = "card-list-row" + (index === selectedIndex ? " active" : "");
        row.dataset.index = index;

        const nameDiv = document.createElement("div");
        nameDiv.textContent = card.name || "(No Name)";
        const typeDiv = document.createElement("div");
        typeDiv.textContent = card.type || "";
        const setDiv = document.createElement("div");
        setDiv.textContent = card.setName || "";
        const numDiv = document.createElement("div");
        numDiv.textContent = card.cardNumber || "";

        row.appendChild(nameDiv);
        row.appendChild(typeDiv);
        row.appendChild(setDiv);
        row.appendChild(numDiv);

        row.addEventListener("click", () => {
          selectedIndex = index;
          setCardSubmode("single");
          loadCardIntoForm(cards[index]);
          renderCardList();
        });

        cardListBody.appendChild(row);
      });
    }

    function setTypeSectionsVisibility(type) {
      driverSection.style.display = "none";
      vehicleSection.style.display = "none";
      modSection.style.display = "none";

      if (type === "Driver" || type === "Named Driver" || type === "Track") {
        driverSection.style.display = "block";
      }
      if (type === "Vehicle" || type === "Named Vehicle") {
        vehicleSection.style.display = "block";
      }
      if (type === "Mod") {
        modSection.style.display = "block";
      }
    }

    function clearForm() {
      editorTitle.textContent = "New Card";
      selectedIndex = -1;

      cardNameInput.value = "";
      cardTypeSelect.value = "";
      rarityInput.value = "";
      setNameInput.value = "";
      cardNumberInput.value = "";
      tagsInput.value = "";
      rulesTextInput.value = "";

      vehTypeMultiInputs.forEach(el => el.checked = false);
      document.querySelectorAll("input[name='vehicleTypeSingle']").forEach(el => el.checked = false);
      hpInput.value = "";
      conInput.value = "";

      modBasePartInput.value = "";
      modLevel1Input.value = "";
      modLevel2Input.value = "";
      modLevel3Input.value = "";
      modLevel4Input.value = "";

      currentImageData = "";
      imagePreview.innerHTML = "<small>No image loaded yet.</small>";

      setTypeSectionsVisibility("");
    }

    function loadCardIntoForm(card) {
      editorTitle.textContent = `Edit Card: ${card.name || ""}`;
      cardNameInput.value = card.name || "";
      cardTypeSelect.value = card.type || "";
      rarityInput.value = card.rarity || "";
      setNameInput.value = card.setName || "";
      cardNumberInput.value = card.cardNumber || "";
      tagsInput.value = (card.tags || []).join(", ");
      rulesTextInput.value = card.notes || "";

      const extra = card.extra || {};
      setTypeSectionsVisibility(card.type || "");

      vehTypeMultiInputs.forEach(el => el.checked = false);
      document.querySelectorAll("input[name='vehicleTypeSingle']").forEach(el => el.checked = false);
      hpInput.value = "";
      conInput.value = "";

      modBasePartInput.value = "";
      modLevel1Input.value = "";
      modLevel2Input.value = "";
      modLevel3Input.value = "";
      modLevel4Input.value = "";

      if ((card.type === "Driver" || card.type === "Named Driver" || card.type === "Track") &&
          Array.isArray(extra.vehicleTypes)) {
        vehTypeMultiInputs.forEach(el => {
          if (extra.vehicleTypes.includes(el.value)) el.checked = true;
        });
      }

      if (card.type === "Vehicle" || card.type === "Named Vehicle") {
        if (extra.vehicleType) {
          const match = document.querySelector(
            "input[name='vehicleTypeSingle'][value='" + extra.vehicleType + "']"
          );
          if (match) match.checked = true;
        }
        if (extra.hp != null) hpInput.value = extra.hp;
        if (extra.con != null) conInput.value = extra.con;
      }

      if (card.type === "Mod") {
        modBasePartInput.value = extra.modBasePart || "";
        modLevel1Input.value = extra.modLevel1 || "";
        modLevel2Input.value = extra.modLevel2 || "";
        modLevel3Input.value = extra.modLevel3 || "";
        modLevel4Input.value = extra.modLevel4 || "";
      }

      currentImageData = card.imageData || "";
      if (currentImageData) {
        imagePreview.innerHTML = `<img src="${currentImageData}" alt="Card image" />`;
      } else {
        imagePreview.innerHTML = "<small>No image loaded yet.</small>";
      }
    }

    function buildCardFromForm(existingCard) {
      const name = cardNameInput.value.trim();
      const type = cardTypeSelect.value;
      const rarity = rarityInput.value.trim();
      const setName = setNameInput.value.trim();
      const cardNumber = cardNumberInput.value.trim();
      const tags = tagsInput.value.split(",").map(t => t.trim()).filter(Boolean);
      const notes = rulesTextInput.value.trim();

      if (!name) {
        alert("Card Name is required.");
        return null;
      }
      if (!type) {
        alert("Card Type is required.");
        return null;
      }

      let extra = {};
      if (type === "Driver" || type === "Named Driver" || type === "Track") {
        const selectedTypes = vehTypeMultiInputs.filter(el => el.checked).map(el => el.value);
        if (selectedTypes.length) extra.vehicleTypes = selectedTypes;
      }

      if (type === "Vehicle" || type === "Named Vehicle") {
        const vehTypeSingle = document.querySelector("input[name='vehicleTypeSingle']:checked");
        if (vehTypeSingle) extra.vehicleType = vehTypeSingle.value;
        if (hpInput.value !== "") extra.hp = parseInt(hpInput.value, 10);
        if (conInput.value !== "") extra.con = parseInt(conInput.value, 10);
      }

      if (type === "Mod") {
        extra.modBasePart = modBasePartInput.value.trim();
        extra.modLevel1 = modLevel1Input.value.trim();
        extra.modLevel2 = modLevel2Input.value.trim();
        extra.modLevel3 = modLevel3Input.value.trim();
        extra.modLevel4 = modLevel4Input.value.trim();
      }

      const card = existingCard ? { ...existingCard } : {};
      if (!card.id) {
        card.id = "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
      }

      card.name = name;
      card.type = type;
      card.rarity = rarity;
      card.setName = setName;
      card.cardNumber = cardNumber;
      card.tags = tags;
      card.notes = notes;
      card.extra = extra;
      card.imageData = currentImageData || card.imageData || "";

      return card;
    }

    function exportJson() {
      const blob = new Blob([JSON.stringify(cards, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drive-card.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        currentImageData = e.target.result;
        imagePreview.innerHTML = `<img src="${currentImageData}" alt="Card image" />`;
      };
      reader.readAsDataURL(file);
    });

    cardTypeSelect.addEventListener("change", () => {
      setTypeSectionsVisibility(cardTypeSelect.value);
    });

    newCardBtn.addEventListener("click", () => {
      setCardSubmode("single");
      clearForm();
      renderCardList();
    });

    saveCardBtn.addEventListener("click", () => {
      const existing = selectedIndex >= 0 ? cards[selectedIndex] : null;
      const card = buildCardFromForm(existing);
      if (!card) return;

      if (selectedIndex >= 0) {
        cards[selectedIndex] = card;
      } else {
        cards.push(card);
        selectedIndex = cards.length - 1;
      }

      renderCardList();
      loadCardIntoForm(card);
      alert("Card saved.");
    });

    deleteCardBtn.addEventListener("click", () => {
      if (selectedIndex < 0) {
        alert("No card selected.");
        return;
      }
      const card = cards[selectedIndex];
      if (!confirm(`Delete card "${card.name}"? This cannot be undone.`)) return;
      const deletedCardId = card.id;
      cards.splice(selectedIndex, 1);
      selectedIndex = -1;
      clearForm();
      renderCardList();

      precons.forEach(p => {
        if (p.cards && p.cards[deletedCardId]) delete p.cards[deletedCardId];
      });
      savePreconsToStorage();
      renderPreconUI();
    });

    duplicateCardBtn.addEventListener("click", () => {
      if (selectedIndex < 0) {
        alert("Select a card to duplicate.");
        return;
      }
      const original = cards[selectedIndex];
      const copy = { ...original };
      copy.id = "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
      copy.name = original.name + " (Copy)";
      cards.push(copy);
      selectedIndex = cards.length - 1;
      renderCardList();
      loadCardIntoForm(copy);
    });

    exportJsonBtn.addEventListener("click", exportJson);
    searchListInput.addEventListener("input", renderCardList);

    // ------------ Bulk Import helpers (CSV/Text) ------------
    function parseBulkInput(raw) {
      raw = (raw || "").trim();
      if (!raw) return { headers: [], rows: [] };
      const lines = raw.split(/\r?\n/).filter(l => l.trim() !== "");
      if (lines.length < 2) return { headers: [], rows: [] };
      const headerLine = lines[0];
      const tabCount = (headerLine.match(/\t/g) || []).length;
      const commaCount = (headerLine.match(/,/g) || []).length;
      const delimiter = tabCount > commaCount ? "\t" : ",";

      const headers = headerLine.split(delimiter).map(h => h.trim());
      const rows = lines.slice(1).map(line => {
        const cols = line.split(delimiter).map(c => c.trim());
        while (cols.length < headers.length) cols.push("");
        return cols;
      });
      return { headers, rows };
    }

    function resetBulkState() {
      bulkHeaders = [];
      bulkRows = [];
      bulkDraftCards = [];
      bulkMapping = {};
      bulkParseStatus.textContent = "";
      bulkMappingStatus.textContent = "";
      bulkImportStatus.textContent = "";
      bulkPreviewList.innerHTML = "";
      bulkMappingFields.innerHTML = "";
      bulkMappingContainer.style.display = "none";
      bulkPreviewContainer.style.display = "none";
    }

    bulkFileInput.addEventListener("change", () => {
      const file = bulkFileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        bulkRawInput.value = e.target.result;
      };
      reader.readAsText(file);
    });

    bulkParseBtn.addEventListener("click", () => {
      resetBulkState();
      const raw = bulkRawInput.value;
      const { headers, rows } = parseBulkInput(raw);
      if (!headers.length || !rows.length) {
        bulkParseStatus.textContent = "No valid rows found. Check that you included a header row and at least one data row.";
        return;
      }
      bulkHeaders = headers;
      bulkRows = rows;
      bulkParseStatus.textContent = `Parsed ${rows.length} row(s) with ${headers.length} column(s).`;
      buildBulkMappingUI();
    });

    function buildBulkMappingUI() {
      bulkMappingFields.innerHTML = "";
      bulkMapping = {};

      if (!bulkHeaders.length) {
        bulkMappingContainer.style.display = "none";
        return;
      }
      bulkMappingContainer.style.display = "";

      bulkFieldDefs.forEach(def => {
        const row = document.createElement("div");
        row.className = "bulk-mapping-row";

        const label = document.createElement("label");
        label.textContent = def.label;

        const select = document.createElement("select");
        const skipOpt = document.createElement("option");
        skipOpt.value = "";
        skipOpt.textContent = "Skip";
        select.appendChild(skipOpt);

        bulkHeaders.forEach((h, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = h || `(Column ${idx + 1})`;

          const normalizedH = (h || "").toLowerCase();
          const normalizedL = def.label.toLowerCase();
          if (
            normalizedH.includes("name") && def.key === "name" ||
            normalizedH === "type" && def.key === "type" ||
            normalizedH.includes("set") && def.key === "setName" ||
            (normalizedH === "number" || normalizedH === "card number") && def.key === "cardNumber" ||
            normalizedH.includes("rarity") && def.key === "rarity" ||
            normalizedH.includes("tag") && def.key === "tags" ||
            normalizedH.includes("rule") && def.key === "notes" ||
            normalizedH.includes("hp") && def.key === "extra.hp" ||
            normalizedH.includes("con") && def.key === "extra.con" ||
            normalizedH.includes("vehicle types") && def.key === "extra.vehicleTypes" ||
            normalizedH === "vehicle type" && def.key === "extra.vehicleType" ||
            normalizedH.includes("base part") && def.key === "extra.modBasePart"
          ) {
            opt.selected = true;
            bulkMapping[def.key] = idx;
          }

          select.appendChild(opt);
        });

        select.addEventListener("change", () => {
          const v = select.value;
          bulkMapping[def.key] = v === "" ? null : Number(v);
        });

        row.appendChild(label);
        row.appendChild(select);
        bulkMappingFields.appendChild(row);
      });
    }

    bulkGenerateBtn.addEventListener("click", () => {
      bulkDraftCards = [];
      bulkPreviewList.innerHTML = "";
      bulkImportStatus.textContent = "";

      if (!bulkRows.length) {
        bulkMappingStatus.textContent = "No rows to generate from. Go back to Step 1 and parse data.";
        return;
      }

      const nameCol = bulkMapping["name"];
      const typeCol = bulkMapping["type"];
      if (nameCol == null || typeCol == null) {
        bulkMappingStatus.textContent = "At minimum, map Card Name and Card Type.";
        return;
      }

      bulkRows.forEach(cols => {
        const card = { extra: {} };
        bulkFieldDefs.forEach(def => {
          const colIndex = bulkMapping[def.key];
          if (colIndex == null) return;
          const rawVal = (cols[colIndex] || "").trim();
          if (!rawVal && def.key !== "notes" && def.key !== "tags") return;

          switch (def.key) {
            case "name":
            case "type":
            case "rarity":
            case "setName":
            case "cardNumber":
            case "notes":
              card[def.key] = rawVal;
              break;
            case "tags":
              card.tags = rawVal
                ? rawVal.split(/[;,]/).map(t => t.trim()).filter(Boolean)
                : [];
              break;
            case "extra.vehicleTypes":
              if (rawVal) {
                card.extra.vehicleTypes = rawVal
                  .split(/[;,]/)
                  .map(t => t.trim())
                  .filter(Boolean);
              }
              break;
            case "extra.vehicleType":
              if (rawVal) card.extra.vehicleType = rawVal;
              break;
            case "extra.hp":
              if (rawVal !== "") card.extra.hp = parseInt(rawVal, 10);
              break;
            case "extra.con":
              if (rawVal !== "") card.extra.con = parseInt(rawVal, 10);
              break;
            case "extra.modBasePart":
              card.extra.modBasePart = rawVal;
              break;
            case "extra.modLevel1":
            case "extra.modLevel2":
            case "extra.modLevel3":
            case "extra.modLevel4":
              const key = def.key.split(".")[1];
              card.extra[key] = rawVal;
              break;
          }
        });

        if (!card.name || !card.type) return;

        card.id = "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000) + "-" + bulkDraftCards.length;
        card.imageData = "";
        bulkDraftCards.push(card);
      });

      if (!bulkDraftCards.length) {
        bulkMappingStatus.textContent = "No valid draft cards could be created. Check Name/Type columns.";
        bulkPreviewContainer.style.display = "none";
        return;
      }

      bulkMappingStatus.textContent = `Created ${bulkDraftCards.length} draft card(s). Attach images in Step 3.`;
      renderBulkPreview();
    });

    // ------------ XLSX helpers ------------
    const ALL_VEHICLE_TYPES = ["Drag","Drift","Off-Road","Rally"];

    function parseVehicleTypesFromString(str) {
      if (!str) return [];
      let s = String(str).toUpperCase().trim();
      if (!s) return [];
      if (s.includes("ALL")) return [...ALL_VEHICLE_TYPES];
      const rawParts = s.split(/[\/&,+]/);
      const out = [];
      rawParts.forEach(p => {
        const t = p.trim();
        if (!t) return;
        if (t.includes("DRAG") && !out.includes("Drag")) out.push("Drag");
        else if (t.includes("DRIFT") && !out.includes("Drift")) out.push("Drift");
        else if (t.includes("OFF") && !out.includes("Off-Road")) out.push("Off-Road");
        else if (t.includes("RALLY") && !out.includes("Rally")) out.push("Rally");
      });
      return out;
    }

    function extractTypeLineAndRules(traitStr) {
      if (!traitStr) return { vehicleTypes: [], rulesText: "" };
      const lines = String(traitStr).split(/\r?\n/);
      let typeLineIdx = lines.findIndex(l => l.toUpperCase().startsWith("TYPE"));
      let vehicleTypes = [];
      if (typeLineIdx >= 0) {
        const line = lines[typeLineIdx];
        const parts = line.split(":");
        const typePart = parts[1] || "";
        vehicleTypes = parseVehicleTypesFromString(typePart);
        lines.splice(typeLineIdx, 1);
      }
      const cleanRules = lines.join("\n").trim();
      return { vehicleTypes, rulesText: cleanRules };
    }

    function parseHpCon(hpConStr) {
      const out = {};
      if (!hpConStr) return out;
      const parts = String(hpConStr).split("/");
      if (parts.length >= 2) {
        const hp = parseInt(parts[0], 10);
        const con = parseInt(parts[1], 10);
        if (!Number.isNaN(hp)) out.hp = hp;
        if (!Number.isNaN(con)) out.con = con;
      }
      return out;
    }

    function makeBaseCard(name, type, setName, rarity, cardNumber) {
      const card = {
        id: "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000) + "-" + bulkDraftCards.length,
        name: name || "",
        type: type || "",
        setName: setName || "",
        rarity: rarity || "",
        cardNumber: cardNumber || "",
        tags: [],
        notes: "",
        extra: {},
        imageData: ""
      };
      return card;
    }

    function buildDraftCardsFromSheet(sheetName, rows) {
      const result = [];
      const normalizedSheet = sheetName.toLowerCase();

      function pushIfValid(card) {
        if (!card.name || !card.type) return;
        result.push(card);
      }

      if (normalizedSheet === "crew cards") {
        rows.forEach(row => {
          const card = makeBaseCard(
            row["SET"],
            "Crew", // overwritten below
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          card.name = (row["Crew Name"] || "").toString();
          card.notes = (row["Crew Trait"] || "").toString();
          pushIfValid(card);
        });
      }
      else if (normalizedSheet === "mod cards") {
        rows.forEach(row => {
          const card = makeBaseCard(
            row["Mod Name"],
            "Mod",
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          const modTypeText = (row["Mod TYPE"] || "").toString();
          const abilityText = (row["Mod Ability"] || "").toString();
          card.notes = [modTypeText, abilityText].filter(Boolean).join("\n");
          card.extra.modBasePart = (row["Base Part"] || "").toString();
          card.extra.modLevel1 = (row["Mod Lvl 1"] || "").toString();
          card.extra.modLevel2 = (row["Mod Lvl 2"] || "").toString();
          card.extra.modLevel3 = (row["Mod Lvl 3"] || "").toString();
          card.extra.modLevel4 = (row["Mod Lvl 4"] || "").toString();
          pushIfValid(card);
        });
      }
      else if (normalizedSheet === "driver cards" || normalizedSheet === "named driver cards") {
        const cardType = normalizedSheet === "driver cards" ? "Driver" : "Named Driver";
        rows.forEach(row => {
          const rawTrait = (row["Driver Trait"] || "").toString();
          const { vehicleTypes, rulesText } = extractTypeLineAndRules(rawTrait);

          const card = makeBaseCard(
            row["Driver Name"],
            cardType,
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          card.notes = rulesText;
          if (vehicleTypes.length) card.extra.vehicleTypes = vehicleTypes;
          pushIfValid(card);
        });
      }
      else if (normalizedSheet === "condition cards") {
        rows.forEach(row => {
          const card = makeBaseCard(
            row["Condition Name"],
            "Condition",
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          card.notes = (row["Condition Trait"] || "").toString();
          pushIfValid(card);
        });
      }
      else if (normalizedSheet === "track cards") {
        rows.forEach(row => {
          const card = makeBaseCard(
            row["Track Name"],
            "Track",
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          card.notes = (row["Track Trait"] || "").toString();
          const vt = parseVehicleTypesFromString(row["Vehicle Type"]);
          if (vt.length) card.extra.vehicleTypes = vt;
          pushIfValid(card);
        });
      }
      else if (normalizedSheet === "vehicle cards" || normalizedSheet === "named vehicle") {
        const cardType = normalizedSheet === "vehicle cards" ? "Vehicle" : "Named Vehicle";
        const nameKey = normalizedSheet === "vehicle cards" ? "VEHICLE name" : "NAMED VEHICLE NAME";
        const traitKey = normalizedSheet === "vehicle cards" ? "TRAIT" : "VEHICLE TRAIT";

        rows.forEach(row => {
          const card = makeBaseCard(
            row[nameKey],
            cardType,
            row["SET"],
            row["RARITY"],
            row["Card Number"]
          );
          card.notes = (row[traitKey] || "").toString();

          const hpCon = parseHpCon(row["VEHICLE HP/CON"]);
          if (hpCon.hp != null) card.extra.hp = hpCon.hp;
          if (hpCon.con != null) card.extra.con = hpCon.con;

          const vtList = parseVehicleTypesFromString(row["Vehicle Type"]);
          if (vtList.length) {
            card.extra.vehicleTypes = vtList;
            card.extra.vehicleType = vtList[0];
          }

          pushIfValid(card);
        });
      }

      return result;
    }

    xlsxFileInput.addEventListener("change", () => {
      if (typeof XLSX === "undefined") {
        xlsxStatus.textContent = "XLSX library not loaded. Check the script tag URL at the bottom of admin.html.";
        return;
      }

      const file = xlsxFileInput.files[0];
      if (!file) return;
      xlsxStatus.textContent = "Loading workbook...";
      xlsxSheetSelect.innerHTML = '<option value="">Select sheetâ€¦</option>';
      xlsxWorkbook = null;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = e.target.result; // ArrayBuffer
          const wb = XLSX.read(data, { type: "array" });
          xlsxWorkbook = wb;

          const knownSheets = [
            "Crew Cards",
            "Mod Cards",
            "Driver Cards",
            "Named Driver Cards",
            "Condition Cards",
            "Track Cards",
            "Vehicle Cards",
            "NAMED VEHICLE"
          ];

          wb.SheetNames.forEach(name => {
            if (!knownSheets.includes(name)) return;
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            xlsxSheetSelect.appendChild(opt);
          });

          if (xlsxSheetSelect.options.length <= 1) {
            xlsxStatus.textContent =
              "Workbook loaded, but no expected DRIVE sheets were found (Crew Cards, Mod Cards, etc.).";
          } else {
            xlsxStatus.textContent =
              "Workbook loaded. Select a sheet and click 'Load Sheet from XLSX'.";
          }
        } catch (err) {
          console.error("XLSX read error:", err);
          xlsxStatus.textContent =
            "Error reading workbook: " + (err && err.message ? err.message : "unknown error");
        }
      };

      reader.readAsArrayBuffer(file);
    });

    xlsxLoadSheetBtn.addEventListener("click", () => {
      if (!xlsxWorkbook) {
        xlsxStatus.textContent = "No workbook loaded yet.";
        return;
      }
      const sheetName = xlsxSheetSelect.value;
      if (!sheetName) {
        xlsxStatus.textContent = "Select a sheet first.";
        return;
      }

      resetBulkState();
      bulkRawInput.value = "";
      bulkParseStatus.textContent = "";
      bulkMappingContainer.style.display = "none";

      try {
        const ws = xlsxWorkbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
        const drafts = buildDraftCardsFromSheet(sheetName, rows);
        if (!drafts.length) {
          xlsxStatus.textContent = `No valid cards found in sheet "${sheetName}".`;
          return;
        }
        bulkDraftCards = drafts;
        xlsxStatus.textContent = `Loaded ${drafts.length} draft card(s) from "${sheetName}". Attach images in Step 3.`;
        renderBulkPreview();
      } catch (err) {
        console.error(err);
        xlsxStatus.textContent = "Failed to parse sheet. Check column names or data.";
      }
    });

    // ------------ Bulk preview / images ------------
    function renderBulkPreview() {
      bulkPreviewContainer.style.display = "";
      bulkPreviewList.innerHTML = "";

      if (!bulkDraftCards.length) {
        bulkPreviewList.innerHTML = "<div class='small-note'>No draft cards yet. Generate them from Step 2 or load from XLSX.</div>";
        return;
      }

      bulkDraftCards.forEach((card, idx) => {
        const row = document.createElement("div");
        row.className = "deck-row";

        const info = document.createElement("div");
        info.className = "deck-row-info";

        const main = document.createElement("div");
        main.className = "deck-row-main";
        main.textContent = `${card.name || "(No Name)"} [${card.type || ""}]`;

        const sub = document.createElement("div");
        sub.className = "deck-row-sub";
        const setLabel = card.setName || "";
        const num = card.cardNumber ? ` #${card.cardNumber}` : "";
        sub.textContent = `${setLabel}${num}`;

        info.appendChild(main);
        info.appendChild(sub);

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.alignItems = "center";
        right.style.gap = "0.35rem";

        const dz = document.createElement("div");
        dz.className = "drop-zone";
        dz.dataset.index = String(idx);

        if (card.imageData) {
          const img = document.createElement("img");
          img.src = card.imageData;
          img.alt = "Preview";
          dz.innerHTML = "";
          dz.appendChild(img);
        } else {
          dz.textContent = "Drop image or click";
        }

        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.style.display = "none";

        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          handleBulkImageFile(idx, file);
        });

        dz.addEventListener("click", () => {
          fileInput.click();
        });

        dz.addEventListener("dragover", (e) => {
          e.preventDefault();
          dz.classList.add("dragover");
        });
        dz.addEventListener("dragleave", (e) => {
          e.preventDefault();
          dz.classList.remove("dragover");
        });
        dz.addEventListener("drop", (e) => {
          e.preventDefault();
          dz.classList.remove("dragover");
          const file = e.dataTransfer.files[0];
          if (!file) return;
          handleBulkImageFile(idx, file);
        });

        right.appendChild(dz);
        right.appendChild(fileInput);

        row.appendChild(info);
        row.appendChild(right);
        bulkPreviewList.appendChild(row);
      });
    }

    function handleBulkImageFile(index, file) {
      const reader = new FileReader();
      reader.onload = e => {
        bulkDraftCards[index].imageData = e.target.result;
        renderBulkPreview();
      };
      reader.readAsDataURL(file);
    }

    bulkImportBtn.addEventListener("click", () => {
      if (!bulkDraftCards.length) {
        bulkImportStatus.textContent = "No draft cards to import.";
        return;
      }
      cards = cards.concat(bulkDraftCards);
      const importedCount = bulkDraftCards.length;
      bulkDraftCards = [];
      bulkPreviewList.innerHTML = "";
      bulkImportStatus.textContent = `Imported ${importedCount} card(s) into the main library. Don't forget to Export JSON when you're done.`;
      renderCardList();
    });

    bulkClearBtn.addEventListener("click", () => {
      resetBulkState();
      bulkRawInput.value = "";
      xlsxStatus.textContent = "";
      bulkImportStatus.textContent = "Bulk session cleared.";
    });

    // ------------ Precons ------------
    function loadPreconsFromStorage() {
      try {
        const raw = localStorage.getItem(PRECONS_KEY);
        if (!raw) {
          precons = [{ id: "precon-1", name: "Precon 1", notes: "", cards: {} }];
          activePreconIndex = 0;
          return;
        }
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length) {
          precons = parsed;
        } else {
          precons = [{ id: "precon-1", name: "Precon 1", notes: "", cards: {} }];
        }
      } catch {
        precons = [{ id: "precon-1", name: "Precon 1", notes: "", cards: {} }];
      }
      activePreconIndex = 0;
    }

    function savePreconsToStorage() {
      localStorage.setItem(PRECONS_KEY, JSON.stringify(precons));
    }

    function getActivePrecon() {
      return precons[activePreconIndex] || null;
    }

    function populatePreconSelect() {
      preconSelect.innerHTML = "";
      precons.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = p.name || `Precon ${idx + 1}`;
        preconSelect.appendChild(opt);
      });
      preconSelect.value = String(activePreconIndex);
    }

    function renderPreconUI() {
      const p = getActivePrecon();
      if (!p) {
        preconNameInput.value = "";
        preconNotesInput.value = "";
        preconList.innerHTML = "<div class='small-note'>No precon decks defined.</div>";
        preconStats.textContent = "";
        return;
      }

      preconNameInput.value = p.name || "";
      preconNotesInput.value = p.notes || "";

      const entries = Object.entries(p.cards || {});
      let total = 0;
      let typeCounts = {};
      preconList.innerHTML = "";

      if (!entries.length) {
        preconList.innerHTML = "<div class='small-note'>No cards in this precon yet.</div>";
      } else {
        entries
          .sort(([aId],[bId]) => {
            const a = cards.find(c => c.id === aId);
            const b = cards.find(c => c.id === bId);
            if (!a || !b) return 0;
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(([cardId, count]) => {
            const c = cards.find(c => c.id === cardId);
            if (!c) return;
            const n = Number(count) || 0;
            total += n;
            typeCounts[c.type] = (typeCounts[c.type] || 0) + n;

            const row = document.createElement("div");
            row.className = "deck-row";

            const info = document.createElement("div");
            info.className = "deck-row-info";

            const main = document.createElement("div");
            main.className = "deck-row-main";
            main.textContent = `${n}x ${c.name}`;

            const sub = document.createElement("div");
            sub.className = "deck-row-sub";
            const setLabel = c.setName || "";
            const num = c.cardNumber ? ` #${c.cardNumber}` : "";
            sub.textContent = `[${c.type}] ${setLabel}${num}`;

            info.appendChild(main);
            info.appendChild(sub);

            const qty = document.createElement("div");
            qty.className = "deck-row-qty";

            const minusBtn = document.createElement("button");
            minusBtn.className = "deck-btn";
            minusBtn.textContent = "âˆ’";
            minusBtn.onclick = () => {
              if (p.cards[cardId] <= 1) {
                delete p.cards[cardId];
              } else {
                p.cards[cardId] = p.cards[cardId] - 1;
              }
              savePreconsToStorage();
              renderPreconUI();
            };

            const number = document.createElement("span");
            number.className = "deck-qty-number";
            number.textContent = String(n);

            const plusBtn = document.createElement("button");
            plusBtn.className = "deck-btn";
            plusBtn.textContent = "+";
            plusBtn.onclick = () => {
              p.cards[cardId] = (p.cards[cardId] || 0) + 1;
              savePreconsToStorage();
              renderPreconUI();
            };

            qty.appendChild(minusBtn);
            qty.appendChild(number);
            qty.appendChild(plusBtn);

            row.appendChild(info);
            row.appendChild(qty);
            preconList.appendChild(row);
          });
      }

      const orderedTypes = [
        "Vehicle","Named Vehicle","Driver","Named Driver",
        "Crew","Mod","Track","Condition"
      ];
      let statsParts = [];
      orderedTypes.forEach(t => {
        if (typeCounts[t]) statsParts.push(`${t}: ${typeCounts[t]}`);
      });
      Object.keys(typeCounts).forEach(t => {
        if (!orderedTypes.includes(t)) statsParts.push(`${t}: ${typeCounts[t]}`);
      });

      preconStats.textContent = `Total cards: ${total}` +
        (statsParts.length ? " Â· " + statsParts.join(" Â· ") : "");
    }

    preconSelect.addEventListener("change", () => {
      activePreconIndex = Number(preconSelect.value) || 0;
      renderPreconUI();
    });

    newPreconBtn.addEventListener("click", () => {
      const name = prompt("Name for the new precon deck?", `Precon ${precons.length + 1}`);
      if (!name) return;
      const p = {
        id: "precon-" + Date.now() + "-" + Math.floor(Math.random() * 100000),
        name,
        notes: "",
        cards: {},
      };
      precons.push(p);
      activePreconIndex = precons.length - 1;
      savePreconsToStorage();
      populatePreconSelect();
      renderPreconUI();
    });

    duplicatePreconBtn.addEventListener("click", () => {
      const p = getActivePrecon();
      if (!p) {
        alert("No precon selected.");
        return;
      }
      const copy = {
        id: "precon-" + Date.now() + "-" + Math.floor(Math.random() * 100000),
        name: p.name + " (Copy)",
        notes: p.notes,
        cards: { ...p.cards },
      };
      precons.push(copy);
      activePreconIndex = precons.length - 1;
      savePreconsToStorage();
      populatePreconSelect();
      renderPreconUI();
    });

    deletePreconBtn.addEventListener("click", () => {
      if (!precons.length) return;
      if (precons.length === 1) {
        if (!confirm("Delete the only precon deck? This will create a new empty one.")) return;
        precons = [{ id: "precon-1", name: "Precon 1", notes: "", cards: {} }];
        activePreconIndex = 0;
      } else {
        const p = getActivePrecon();
        if (!p) return;
        if (!confirm(`Delete precon "${p.name}"? This cannot be undone.`)) return;
        precons.splice(activePreconIndex, 1);
        if (activePreconIndex >= precons.length) activePreconIndex = precons.length - 1;
      }
      savePreconsToStorage();
      populatePreconSelect();
      renderPreconUI();
    });

    preconNameInput.addEventListener("input", () => {
      const p = getActivePrecon();
      if (!p) return;
      p.name = preconNameInput.value;
      savePreconsToStorage();
      populatePreconSelect();
    });

    preconNotesInput.addEventListener("input", () => {
      const p = getActivePrecon();
      if (!p) return;
      p.notes = preconNotesInput.value;
      savePreconsToStorage();
    });

    addSelectedCardToPreconBtn.addEventListener("click", () => {
      const p = getActivePrecon();
      if (!p) {
        alert("No active precon deck.");
        return;
      }
      if (selectedIndex < 0 || !cards[selectedIndex]) {
        alert("Select a card from the library list on the left first.");
        return;
      }
      const card = cards[selectedIndex];
      if (!card.id) {
        alert("This card has no ID. Please save it first, then add to precon.");
        return;
      }
      p.cards[card.id] = (p.cards[card.id] || 0) + 1;
      savePreconsToStorage();
      renderPreconUI();
    });

    function exportPrecons() {
      if (!precons.length) {
        alert("No precon decks to export.");
        return;
      }
      const blob = new Blob([JSON.stringify(precons, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drive-precons.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    exportPreconsBtn.addEventListener("click", exportPrecons);

    (async function init() {
      await loadExistingJson();
      loadPreconsFromStorage();
      clearForm();
      renderCardList();
      populatePreconSelect();
      renderPreconUI();
      setMode("cards");
      setCardSubmode("single");
    })();
  </script>
</body>
</html>
