<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.05em;
    }
    header p {
      margin: 0;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .pill-nav {
      display: inline-flex;
      border-radius: 999px;
      padding: 0.15rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid #1f2937;
      box-shadow: 0 12px 25px rgba(0,0,0,0.7);
    }
    .pill-nav button {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 0.78rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .pill-nav button.active {
      background: radial-gradient(circle at top left, #1d4ed8, #0b1120);
      color: #e5e7eb;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.6);
    }
    .pill-nav button span.icon {
      font-size: 0.9em;
    }

    .panel {
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), #020617);
      padding: 0.75rem 0.9rem 0.9rem;
      box-shadow: 0 18px 40px rgba(0,0,0,0.8);
      margin-bottom: 0.75rem;
    }

    h2 {
      margin: 0 0 0.4rem;
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    h3 {
      margin: 0.5rem 0 0.25rem;
      font-size: 0.86rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    .small-note {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.05rem 0.35rem;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 0.75rem;
    }
    @media (max-width: 1080px) {
      .layout-main {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.8fr);
        grid-template-rows: auto auto;
      }
      .single-layout-right {
        grid-column: 1 / -1;
        order: 3;
      }
    }
    @media (max-width: 820px) {
      .layout-main {
        grid-template-columns: minmax(0, 1fr);
      }
      .single-layout-right {
        order: 3;
      }
    }

    .status {
      margin-top: 0.25rem;
    }
    .status.ok {
      color: #4ade80;
    }
    .status.warn {
      color: #facc15;
    }
    .status.err {
      color: #f97373;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      font-size: 0.78rem;
    }
    .field label {
      color: #9ca3af;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
      min-height: 1.9rem;
      outline: none;
    }
    .field textarea {
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      padding: 0.25rem 0.4rem;
      font-size: 0.8rem;
      min-height: 1.9rem;
      outline: none;
    }
    .field textarea {
      resize: vertical;
      min-height: 4rem;
    }
    .hidden-set-basic {
      display: none;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.45);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
      align-items: center;
    }
    .button {
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at top left, #2563eb, #1e293b);
      color: #e5e7eb;
      font-size: 0.8rem;
      padding: 0.25rem 0.8rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      box-shadow: 0 10px 25px rgba(37,99,235,0.5);
    }
    .button.secondary {
      background: radial-gradient(circle at top left, #6b7280, #020617);
      box-shadow: 0 8px 18px rgba(0,0,0,0.7);
    }
    .button.danger {
      background: radial-gradient(circle at top left, #ef4444, #7f1d1d);
      box-shadow: 0 10px 25px rgba(220,38,38,0.6);
    }
    .button.small {
      font-size: 0.75rem;
      padding: 0.2rem 0.6rem;
    }
    .button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .card-preview {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), #020617);
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.85);
    }
    .card-preview-header {
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
      font-size: 0.86rem;
    }
    .card-preview-name {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-preview-type {
      font-size: 0.78rem;
      color: #9ca3af;
      white-space: nowrap;
    }
    .card-preview-row {
      display: flex;
      justify-content: space-between;
      gap: 0.3rem;
      font-size: 0.75rem;
    }
    .card-preview-label {
      color: #9ca3af;
    }
    .card-preview-text {
      margin-top: 0.25rem;
      padding: 0.35rem 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      background: #020617;
      font-size: 0.75rem;
      white-space: pre-wrap;
    }
    .card-preview-img {
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      background: #020617;
      min-height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.25rem;
      overflow: hidden;
    }
    .card-preview-img img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
    }

    .json-view {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
      background: #020617;
      border-radius: 0.4rem;
      border: 1px solid #1f2937;
      padding: 0.35rem 0.45rem;
      max-height: 260px;
      overflow: auto;
      margin-top: 0.25rem;
    }

    .library-header {
      display: grid;
      grid-template-columns: 2.5rem minmax(0, 3fr) minmax(0, 1.5fr) minmax(0, 1.5fr) minmax(0, 1.4fr);
      gap: 0.4rem;
      padding: 0.25rem 0.3rem;
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .library-list {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.85), #020617);
      max-height: 340px;
      overflow-y: auto;
      font-size: 0.75rem;
    }
    .library-row {
      display: grid;
      grid-template-columns: 2.5rem minmax(0, 3fr) minmax(0, 1.5fr) minmax(0, 1.5fr) minmax(0, 1.4fr);
      gap: 0.4rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
      cursor: pointer;
    }
    .library-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .library-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .library-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .library-row span.truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.open {
      display: flex;
    }
    .modal {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid #1f2937;
      padding: 0.8rem;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 30px 60px rgba(0,0,0,0.9);
    }
    .modal header {
      margin-bottom: 0.4rem;
    }
    .modal header h2 {
      margin-bottom: 0.1rem;
    }

    .bulk-flex {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
      gap: 0.75rem;
    }
    @media (max-width: 900px) {
      .bulk-flex {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .bulk-table {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.85), #020617);
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.74rem;
    }
    .bulk-row {
      display: grid;
      grid-template-columns: 1.7rem minmax(0, 3fr) minmax(0, 1.5fr) minmax(0, 1.5fr) minmax(0, 1.7fr);
      gap: 0.3rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      cursor: pointer;
    }
    .bulk-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .bulk-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .bulk-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .bulk-row span.truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bulk-summary-box {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.74rem;
    }

    .precon-list {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.85), #020617);
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.74rem;
      margin-bottom: 0.4rem;
    }
    .precon-row {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.2rem 0.3rem;
      cursor: pointer;
    }
    .precon-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .precon-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .precon-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .precon-row-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    ul {
      margin: 0.25rem 0 0.4rem 1.1rem;
      padding: 0;
    }
    li {
      margin-bottom: 0.2rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG ‚Äì Admin</h1>
        <p>Manage cards, bulk imports, and preconstructed decks entirely in your browser.</p>
      </div>
      <nav class="pill-nav">
        <button id="navSingleBtn" class="active" type="button">
          <span class="icon">üìù</span> Single Card
        </button>
        <button id="navBulkBtn" type="button">
          <span class="icon">üì•</span> Bulk Import
        </button>
        <button id="navPreconsBtn" type="button">
          <span class="icon">üÇ°</span> Precons
        </button>
        <button id="navHelpBtn" type="button">
          <span class="icon">‚ùî</span> Help
        </button>
      </nav>
    </header>

    <!-- SINGLE CARD EDITOR -->
    <section id="singleSection" class="panel">
      <h2>Single Card Editor</h2>
      <p class="small-note">
        Edit or create one card at a time. Changes are in-memory only until you download
        <span class="inline-code">drive-card.json</span>.
      </p>

      <div class="layout-main">
        <!-- LEFT: Basic card fields + prints -->
        <div>
          <h3>Card Basics</h3>
          <div class="field-grid">
            <div class="field">
              <label for="cardIdInput">Internal ID (read-only)</label>
              <input id="cardIdInput" type="text" placeholder="Generated automatically" readonly />
            </div>
            <div class="field">
              <label for="cardNameInput">Card Name</label>
              <input id="cardNameInput" type="text" placeholder="Danny's GTS-4" />
            </div>
            <div class="field">
              <label for="cardTypeInput">Type</label>
              <select id="cardTypeInput">
                <option value="">‚Äì Select ‚Äì</option>
                <option value="Crew">Crew</option>
                <option value="Driver">Driver</option>
                <option value="Named Driver">Named Driver</option>
                <option value="Mod">Mod</option>
                <option value="Vehicle">Vehicle</option>
                <option value="Named Vehicle">Named Vehicle</option>
                <option value="Track">Track</option>
                <option value="Condition">Condition</option>
                <option value="Misc">Misc</option>
              </select>
            </div>
            <div class="field hidden-set-basic">
              <label for="cardSetNameInput">Set Name (display / primary print)</label>
              <input id="cardSetNameInput" type="text" placeholder="SET 1" />
            </div>
            <div class="field hidden-set-basic">
              <label for="cardNumberInput">Card Number (primary print)</label>
              <input id="cardNumberInput" type="text" placeholder="01-001" />
            </div>
            <div class="field">
              <label for="cardRarityInput">Rarity</label>
              <input id="cardRarityInput" type="text" placeholder="Common / Rare / Promo‚Ä¶" />
            </div>
            <div class="field">
              <label for="cardVehicleTypesInput">Vehicle Types (comma separated)</label>
              <input id="cardVehicleTypesInput" type="text" placeholder="Drag, Drift‚Ä¶" />
            </div>
            <div class="field">
              <label for="cardTagsInput">Tags (comma separated)</label>
              <input id="cardTagsInput" type="text" placeholder="Junkyard, Starter Deck‚Ä¶" />
            </div>
            <div class="field">
              <label for="cardImageUrlInput">Image URL</label>
              <input id="cardImageUrlInput" type="text" placeholder="images/Set1/DANNYS_GTS-4.png" />
            </div>
          </div>
          <p class="small-note">
            Set &amp; card number are managed below under <strong>Prints (Sets / Card Numbers)</strong>.
          </p>

          <h3>Prints (Sets / Card Numbers)</h3>
          <div class="field-grid">
            <div class="field">
              <label for="printSetSelect">Set</label>
              <select id="printSetSelect">
                <option value="">‚Äì Select ‚Äì</option>
                <option value="SET 1">SET 1</option>
                <option value="SET 2">SET 2</option>
                <option value="SET 3">SET 3</option>
                <option value="SET 4">SET 4</option>
                <option value="SET 5">SET 5</option>
                <option value="CUSTOM">Custom‚Ä¶</option>
              </select>
            </div>
            <div class="field">
              <label for="printCustomSetInput">Custom Set Name</label>
              <input id="printCustomSetInput" type="text" placeholder="Father's Day Mini, Promo‚Ä¶" />
            </div>
            <div class="field">
              <label for="printCardNumberInput">Card Number (for this Set)</label>
              <input id="printCardNumberInput" type="text" placeholder="01-001" />
            </div>
          </div>
          <div class="button-row">
            <button id="printSetPrimaryBtn" class="button small" type="button">
              Set Print
            </button>
            <button id="printClearAllBtn" class="button secondary small" type="button">
              Clear All Prints for this Card
            </button>
          </div>
          <div id="cardPrintsList" class="bulk-summary-box" style="margin-top:0.3rem;">
            <span class="small-note">No prints configured yet.</span>
          </div>

          <h3>Rules Text</h3>
          <div class="field">
            <label for="cardNotesInput">Card Rules / Reminder Text</label>
            <textarea id="cardNotesInput" placeholder="When this Vehicle wins a race, draw 1 card."></textarea>
          </div>

          <div class="button-row">
            <button id="singleNewBtn" class="button secondary" type="button">
              New Card
            </button>
            <button id="singleSaveBtn" class="button" type="button">
              Save / Update in Library
            </button>
            <button id="singleDeleteBtn" class="button danger" type="button">
              Delete from Library
            </button>
            <span id="singleStatus" class="status small-note"></span>
          </div>
        </div>

        <!-- MIDDLE: Type-specific extras + preview + library -->
        <div>
          <h3>Type-Specific Fields</h3>
          <div class="field-grid">
            <div class="field">
              <label for="modBasePartInput">Mod ‚Äì Base Part</label>
              <input id="modBasePartInput" type="text" placeholder="Engine / Tires / Suspension‚Ä¶" />
            </div>
            <div class="field">
              <label for="modL1Input">Mod ‚Äì Level 1</label>
              <input id="modL1Input" type="text" placeholder="1/2 etc" />
            </div>
            <div class="field">
              <label for="modL2Input">Mod ‚Äì Level 2</label>
              <input id="modL2Input" type="text" placeholder="2/2 etc" />
            </div>
            <div class="field">
              <label for="modL3Input">Mod ‚Äì Level 3</label>
              <input id="modL3Input" type="text" placeholder="3/3 etc" />
            </div>
            <div class="field">
              <label for="modL4Input">Mod ‚Äì Level 4</label>
              <input id="modL4Input" type="text" placeholder="5/3 etc" />
            </div>
            <div class="field">
              <label for="vehicleHpConInput">Vehicle / Named Vehicle ‚Äì HP/CON</label>
              <input id="vehicleHpConInput" type="text" placeholder="10/4 etc" />
            </div>
          </div>

          <h3>Visual Preview</h3>
          <div id="singlePreview" class="card-preview">
            <div class="card-preview-img">
              <span class="small-note">No image</span>
            </div>
            <div class="card-preview-body">
              <div class="card-preview-header">
                <div class="card-preview-name">(No Name)</div>
                <div class="card-preview-type">‚Äì</div>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Set:</span>
                <span>‚Äì</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Rarity:</span>
                <span>‚Äì</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Vehicle Types:</span>
                <span>‚Äì</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Tags:</span>
                <span>‚Äì</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Stats:</span>
                <span>‚Äì</span>
              </div>
              <div class="card-preview-text">Rules text will appear here.</div>
            </div>
          </div>

          <h3>Card Library (in-memory)</h3>
          <div class="field">
            <input id="cardLibrarySearchInput" type="text"
                   placeholder="Filter by name, type, set‚Ä¶" />
          </div>
          <div class="library-header">
            <span>#</span>
            <span>Name</span>
            <span>Type</span>
            <span>Set</span>
            <span>Rarity</span>
          </div>
          <div id="cardLibraryList" class="library-list"></div>

          <div class="button-row">
            <button id="downloadCardsJsonBtn_single" class="button secondary small" type="button">
              Download drive-card.json
            </button>
          </div>
        </div>

        <!-- RIGHT: Notes -->
        <div class="single-layout-right">
          <h3>Notes</h3>
          <p class="small-note">
            Use the <strong>Bulk Import</strong> tab for adding many cards from spreadsheet exports.
            Use this Single Card editor for cleanup, small tweaks, or one-off cards.
          </p>
          <p class="small-note">
            The preview and library always reflect the in-memory state. You can safely refresh and
            re-load the original <span class="inline-code">drive-card.json</span> if needed.
          </p>
        </div>
      </div>
    </section>

    <!-- BULK IMPORT -->
    <section id="bulkSection" class="panel" style="display:none;">
      <h2>Bulk Import</h2>
      <p class="small-note">
        Import cards from Excel/CSV, map columns, and apply changes to the in-memory library.
      </p>

      <div class="bulk-flex">
        <div>
          <h3>Step 1 ‚Äì Upload Spreadsheet</h3>
          <div class="field">
            <label for="bulkFileInput">Spreadsheet File (.xlsx, .xls, or .csv)</label>
            <input id="bulkFileInput" type="file" accept=".xlsx,.xls,.csv" />
          </div>
          <p id="bulkStep1Status" class="small-note status"></p>

          <h3>Step 2 ‚Äì Filter &amp; Select Rows</h3>
          <div class="field-grid">
            <div class="field">
              <label for="bulkSetFilterInput">Filter by Set</label>
              <input id="bulkSetFilterInput" type="text" placeholder="SET 1" />
            </div>
            <div class="field">
              <label for="bulkTypeFilterInput">Filter by Type</label>
              <input id="bulkTypeFilterInput" type="text" placeholder="Vehicle / Mod / Driver‚Ä¶" />
            </div>
            <div class="field">
              <label for="bulkNameFilterInput">Filter by Name</label>
              <input id="bulkNameFilterInput" type="text" placeholder="Danny, Junkyard Dog‚Ä¶" />
            </div>
          </div>
          <div class="button-row">
            <button id="bulkSelectViewedBtn" class="button small" type="button">
              Select Viewed Rows
            </button>
            <button id="bulkClearViewedBtn" class="button secondary small" type="button">
              Clear Viewed Rows
            </button>
            <button id="bulkClearAllBtn" class="button secondary small" type="button">
              Clear All Selections
            </button>
          </div>
          <p id="bulkStep2Status" class="small-note status"></p>

          <div id="bulkTable" class="bulk-table"></div>
        </div>

        <div>
          <h3>Step 3 ‚Äì Apply to Library</h3>
          <div class="field">
            <label for="bulkUpdateModeSelect">Update Mode</label>
            <select id="bulkUpdateModeSelect">
              <option value="upsert-name-type-set">
                Upsert by Name + Type + Set (recommended)
              </option>
              <option value="insert-only">
                Insert new cards only (skip matches)
              </option>
              <option value="replace-all">
                Replace entire library with imported cards
              </option>
            </select>
          </div>
          <div class="bulk-summary-box">
            <strong class="small-note">Summary</strong>
            <div id="bulkSelectionSummary" class="small-note">
              No rows selected.
            </div>
          </div>

          <div class="button-row">
            <button id="bulkApplyBtn" class="button" type="button">
              Apply to Library
            </button>
          </div>
          <p id="bulkStep3Status" class="small-note status"></p>

          <h3>Download Updated drive-card.json</h3>
          <p class="small-note">
            After applying changes, download the updated
            <span class="inline-code">drive-card.json</span> and replace it in your project.
          </p>
          <div class="button-row">
            <button id="downloadCardsJsonBtn_bulk" class="button secondary small" type="button">
              Download drive-card.json
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- PRECONSTRUCTED DECKS -->
    <section id="preconsSection" class="panel" style="display:none;">
      <h2>Preconstructed Decks</h2>
      <p class="small-note">
        Create and manage preconstructed decks that reference cards by id. These can be exported
        as <span class="inline-code">drive-precons.json</span> for use on the site or tools.
      </p>

      <div class="bulk-flex">
        <div>
          <h3>Existing Precons</h3>
          <div id="preconList" class="precon-list"></div>
          <p id="preconListStatus" class="small-note status"></p>
          <div class="button-row">
            <button id="preconNewBtn" class="button small" type="button">
              New Precon
            </button>
            <button id="preconDeleteBtn" class="button danger small" type="button">
              Delete Precon
            </button>
          </div>

          <h3>Import drive-precons.json</h3>
          <div class="field">
            <label for="preconFileInput">Precons JSON File</label>
            <input id="preconFileInput" type="file" accept=".json" />
          </div>
          <div class="button-row">
            <button id="downloadPreconsJsonBtn" class="button secondary small" type="button">
              Download drive-precons.json
            </button>
          </div>
        </div>

        <div>
          <h3>Precon Details</h3>
          <div class="field-grid">
            <div class="field">
              <label for="preconIdInput">Precon ID (read-only)</label>
              <input id="preconIdInput" type="text" readonly placeholder="Generated automatically" />
            </div>
            <div class="field">
              <label for="preconNameInput">Name</label>
              <input id="preconNameInput" type="text" placeholder="Danny's Junkyard Starter" />
            </div>
          </div>
          <div class="field">
            <label for="preconDescriptionInput">Description</label>
            <textarea id="preconDescriptionInput" placeholder="Short description shown to users."></textarea>
          </div>

          <h3>Cards in This Precon</h3>
          <div id="preconCardsList" class="bulk-summary-box small-note">
            No precon selected.
          </div>
          <div class="button-row">
            <button id="preconAddCardBtn" class="button small" type="button">
              Add Card from Library
            </button>
          </div>
          <div class="button-row">
            <button id="preconSaveBtn" class="button" type="button">
              Save Changes
            </button>
            <span id="preconStatus" class="status small-note"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- HELP / WORKFLOW -->
    <section id="helpSection" class="panel" style="display:none;">
      <h2>Workflow Help</h2>
      <p class="small-note">
        This tool is designed to keep all card and precon data in a small set of JSON files that
        you can version-control (e.g., GitHub) and deploy with the site.
      </p>

      <h3>Core Files</h3>
      <ul class="small-note">
        <li>
          <span class="inline-code">drive-card.json</span> ‚Äì all cards: types, sets, stats, text.
        </li>
        <li>
          <span class="inline-code">drive-precons.json</span> ‚Äì preconstructed decks, referencing cards by id.
        </li>
      </ul>

      <h3>Recommended Workflow</h3>
      <ol class="small-note">
        <li>
          Start with <strong>Bulk Import</strong> for large spreadsheet-based data entry (e.g., Set 1).
        </li>
        <li>
          Use the <strong>Single Card Editor</strong> to refine individual cards, add images, clarify rules text,
          and manage prints/sets.
        </li>
        <li>
          Use the <strong>Precons</strong> tab to build starter decks and special theme decks.
        </li>
        <li>
          Download <span class="inline-code">drive-card.json</span> and
          <span class="inline-code">drive-precons.json</span> and commit them to your repo.
        </li>
      </ol>

      <h3>About Sets &amp; Prints</h3>
      <p class="small-note">
        Each card has a <em>primary</em> set and card number, plus an optional list of prints:
      </p>
      <ul class="small-note">
        <li>
          The primary <strong>Set Name</strong> and <strong>Card Number</strong> are stored in
          <span class="inline-code">setName</span> and <span class="inline-code">cardNumber</span>.
        </li>
        <li>
          Additional reprints are stored in <span class="inline-code">prints</span>, each with
          <span class="inline-code">setId</span> and <span class="inline-code">cardNumber</span>.
        </li>
        <li>
          In the Single Card editor, use <strong>Prints (Sets / Card Numbers)</strong> to manage these.
          The first entry is treated as the primary print.
        </li>
      </ul>

      <h3>Troubleshooting</h3>
      <ul class="small-note">
        <li>
          If card changes don‚Äôt appear on the site, double-check that you deployed the latest
          <span class="inline-code">drive-card.json</span>.
        </li>
        <li>
          If a precon is missing cards, ensure those cards exist in
          <span class="inline-code">drive-card.json</span> and have stable <span class="inline-code">id</span> values.
        </li>
        <li>
          Keep backup copies of your JSON files before large bulk imports.
        </li>
      </ul>
    </section>
  </div>

  <!-- MODAL FOR PRECON CARD PICKER -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <header>
        <h2>Select Card</h2>
        <p class="small-note">Search the library and add a card to the current precon.</p>
      </header>
      <div class="field">
        <input id="modalSearchInput" type="text" placeholder="Name, type, set‚Ä¶" />
      </div>
      <div id="modalCardList" class="precon-list" style="max-height:260px;"></div>
      <div class="button-row">
        <button id="modalCloseBtn" class="button secondary small" type="button">
          Close
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const AppState = {
      cards: [],
      cardsById: {},
      selectedLibraryCardId: null,
      currentSinglePrints: [],

      bulkRows: [],
      bulkSelectedRowIds: new Set(),
      bulkFilters: {
        name: "",
        type: "",
        set: ""
      },

      precons: [],
      selectedPreconId: null
    };

    const Dom = {
      navSingleBtn: document.getElementById("navSingleBtn"),
      navBulkBtn: document.getElementById("navBulkBtn"),
      navPreconsBtn: document.getElementById("navPreconsBtn"),
      navHelpBtn: document.getElementById("navHelpBtn"),

      singleSection: document.getElementById("singleSection"),
      bulkSection: document.getElementById("bulkSection"),
      preconsSection: document.getElementById("preconsSection"),
      helpSection: document.getElementById("helpSection"),

      cardIdInput: document.getElementById("cardIdInput"),
      cardNameInput: document.getElementById("cardNameInput"),
      cardTypeInput: document.getElementById("cardTypeInput"),
      cardSetNameInput: document.getElementById("cardSetNameInput"),
      cardNumberInput: document.getElementById("cardNumberInput"),
      cardRarityInput: document.getElementById("cardRarityInput"),
      cardVehicleTypesInput: document.getElementById("cardVehicleTypesInput"),
      cardTagsInput: document.getElementById("cardTagsInput"),
      cardImageUrlInput: document.getElementById("cardImageUrlInput"),
      modBasePartInput: document.getElementById("modBasePartInput"),
      modL1Input: document.getElementById("modL1Input"),
      modL2Input: document.getElementById("modL2Input"),
      modL3Input: document.getElementById("modL3Input"),
      modL4Input: document.getElementById("modL4Input"),
      vehicleHpConInput: document.getElementById("vehicleHpConInput"),
      cardNotesInput: document.getElementById("cardNotesInput"),

      printSetSelect: document.getElementById("printSetSelect"),
      printCustomSetInput: document.getElementById("printCustomSetInput"),
      printCardNumberInput: document.getElementById("printCardNumberInput"),
      cardPrintsList: document.getElementById("cardPrintsList"),
      printSetPrimaryBtn: document.getElementById("printSetPrimaryBtn"),
      printClearAllBtn: document.getElementById("printClearAllBtn"),

      singleNewBtn: document.getElementById("singleNewBtn"),
      singleSaveBtn: document.getElementById("singleSaveBtn"),
      singleDeleteBtn: document.getElementById("singleDeleteBtn"),
      singleStatus: document.getElementById("singleStatus"),

      singlePreview: document.getElementById("singlePreview"),

      cardLibrarySearchInput: document.getElementById("cardLibrarySearchInput"),
      cardLibraryList: document.getElementById("cardLibraryList"),

      bulkFileInput: document.getElementById("bulkFileInput"),
      bulkStep1Status: document.getElementById("bulkStep1Status"),
      bulkSetFilterInput: document.getElementById("bulkSetFilterInput"),
      bulkTypeFilterInput: document.getElementById("bulkTypeFilterInput"),
      bulkNameFilterInput: document.getElementById("bulkNameFilterInput"),
      bulkSelectViewedBtn: document.getElementById("bulkSelectViewedBtn"),
      bulkClearViewedBtn: document.getElementById("bulkClearViewedBtn"),
      bulkClearAllBtn: document.getElementById("bulkClearAllBtn"),
      bulkStep2Status: document.getElementById("bulkStep2Status"),
      bulkTable: document.getElementById("bulkTable"),
      bulkSelectionSummary: document.getElementById("bulkSelectionSummary"),
      bulkUpdateModeSelect: document.getElementById("bulkUpdateModeSelect"),
      bulkApplyBtn: document.getElementById("bulkApplyBtn"),
      bulkStep3Status: document.getElementById("bulkStep3Status"),

      downloadCardsJsonBtn_single: document.getElementById("downloadCardsJsonBtn_single"),
      downloadCardsJsonBtn_bulk: document.getElementById("downloadCardsJsonBtn_bulk"),

      preconList: document.getElementById("preconList"),
      preconListStatus: document.getElementById("preconListStatus"),
      preconIdInput: document.getElementById("preconIdInput"),
      preconNameInput: document.getElementById("preconNameInput"),
      preconDescriptionInput: document.getElementById("preconDescriptionInput"),
      preconCardsList: document.getElementById("preconCardsList"),
      preconNewBtn: document.getElementById("preconNewBtn"),
      preconDeleteBtn: document.getElementById("preconDeleteBtn"),
      preconAddCardBtn: document.getElementById("preconAddCardBtn"),
      preconSaveBtn: document.getElementById("preconSaveBtn"),
      preconStatus: document.getElementById("preconStatus"),
      preconFileInput: document.getElementById("preconFileInput"),
      downloadPreconsJsonBtn: document.getElementById("downloadPreconsJsonBtn"),

      modalBackdrop: document.getElementById("modalBackdrop"),
      modalSearchInput: document.getElementById("modalSearchInput"),
      modalCardList: document.getElementById("modalCardList"),
      modalCloseBtn: document.getElementById("modalCloseBtn")
    };

    function showSection(section) {
      const map = {
        single: Dom.singleSection,
        bulk: Dom.bulkSection,
        precons: Dom.preconsSection,
        help: Dom.helpSection
      };
      Object.values(map).forEach(el => el.style.display = "none");
      map[section].style.display = "";

      Dom.navSingleBtn.classList.toggle("active", section === "single");
      Dom.navBulkBtn.classList.toggle("active", section === "bulk");
      Dom.navPreconsBtn.classList.toggle("active", section === "precons");
      Dom.navHelpBtn.classList.toggle("active", section === "help");
    }

    function initNav() {
      Dom.navSingleBtn.addEventListener("click", () => showSection("single"));
      Dom.navBulkBtn.addEventListener("click", () => showSection("bulk"));
      Dom.navPreconsBtn.addEventListener("click", () => showSection("precons"));
      Dom.navHelpBtn.addEventListener("click", () => showSection("help"));
    }

    function parseVehicleTypes(str) {
      if (!str) return [];
      return String(str).split(",").map(s => s.trim()).filter(Boolean);
    }

    function parseTags(str) {
      if (!str) return [];
      return String(str).split(",").map(s => s.trim()).filter(Boolean);
    }

    function parseHpCon(val) {
      const out = { hp: undefined, con: undefined };
      if (!val) return out;
      const cleaned = String(val).replace(/\s/g, "");
      const parts = cleaned.split("/");
      if (parts[0] !== undefined && parts[0] !== "") out.hp = Number(parts[0]);
      if (parts[1] !== undefined && parts[1] !== "") out.con = Number(parts[1]);
      return out;
    }

    function normalizeNameTypeSet(card) {
      const name = (card.name || "").trim().toLowerCase();
      const type = (card.type || "").trim().toLowerCase();
      const setNameSource =
        card.setName ||
        (Array.isArray(card.prints) && card.prints.length
          ? (card.prints[0].setId || "")
          : "");
      const setName = setNameSource.trim().toLowerCase();
      return `${name}__${type}__${setName}`;
    }

    function cardToJson(card) {
      const clean = JSON.parse(JSON.stringify(card));
      [
        "tempIndex",
        "tempRowId",
        "tempSelected",
        "_bulkSource",
        "_bulkRowIndex"
      ].forEach(k => {
        if (clean && Object.prototype.hasOwnProperty.call(clean, k)) {
          delete clean[k];
        }
      });
      return clean;
    }

    const CardData = {
      getVehicleTypes(card) {
        if (!card) return [];
        if (Array.isArray(card.vehicleTypes) && card.vehicleTypes.length) {
          return card.vehicleTypes;
        }
        const e = card.extra || {};
        if (Array.isArray(e.vehicleTypes) && e.vehicleTypes.length) {
          return e.vehicleTypes;
        }
        if (e.vehicleType) return [e.vehicleType];
        return [];
      },
      getModStats(card) {
        if (!card || card.type !== "Mod") return "";
        const e = card.extra || {};
        const parts = [];
        if (e.modBasePart) parts.push(`Base: ${e.modBasePart}`);
        const levels = [];
        if (e.modLevel1) levels.push(`L1 ${e.modLevel1}`);
        if (e.modLevel2) levels.push(`L2 ${e.modLevel2}`);
        if (e.modLevel3) levels.push(`L3 ${e.modLevel3}`);
        if (e.modLevel4) levels.push(`L4 ${e.modLevel4}`);
        if (levels.length) parts.push(levels.join(" / "));
        return parts.join(" | ");
      },
      getVehicleStats(card) {
        if (!card || (card.type !== "Vehicle" && card.type !== "Named Vehicle")) {
          return "";
        }
        const e = card.extra || {};
        const parts = [];
        if (e.hp !== undefined || e.con !== undefined) {
          parts.push(`HP/CON: ${e.hp || "?"}/${e.con || "?"}`);
        }
        return parts.join(" | ");
      }
    };

    function renderSinglePreview() {
      const previewEl = Dom.singlePreview;
      previewEl.innerHTML = "";

      const card = collectSingleCardFromInputs(false);
      const imgWrap = document.createElement("div");
      imgWrap.className = "card-preview-img";
      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.name || "Card image";
        imgWrap.appendChild(img);
      } else {
        const span = document.createElement("span");
        span.className = "small-note";
        span.textContent = "No image";
        imgWrap.appendChild(span);
      }

      const body = document.createElement("div");
      body.className = "card-preview-body";

      const header = document.createElement("div");
      header.className = "card-preview-header";
      const nameEl = document.createElement("div");
      nameEl.className = "card-preview-name";
      nameEl.textContent = card.name || "(No Name)";
      const typeEl = document.createElement("div");
      typeEl.className = "card-preview-type";
      typeEl.textContent = card.type || "‚Äì";
      header.appendChild(nameEl);
      header.appendChild(typeEl);

      const rowSet = document.createElement("div");
      rowSet.className = "card-preview-row";
      rowSet.innerHTML = `<span class="card-preview-label">Set:</span><span>${card.setName || "‚Äì"}</span>`;

      const rowRarity = document.createElement("div");
      rowRarity.className = "card-preview-row";
      rowRarity.innerHTML = `<span class="card-preview-label">Rarity:</span><span>${card.rarity || "‚Äì"}</span>`;

      const rowVehicles = document.createElement("div");
      rowVehicles.className = "card-preview-row";
      rowVehicles.innerHTML =
        `<span class="card-preview-label">Vehicle Types:</span><span>${CardData.getVehicleTypes(card).join(", ") || "‚Äì"}</span>`;

      const rowTags = document.createElement("div");
      rowTags.className = "card-preview-row";
      rowTags.innerHTML =
        `<span class="card-preview-label">Tags:</span><span>${(card.tags || []).join(", ") || "‚Äì"}</span>`;

      const rowStats = document.createElement("div");
      rowStats.className = "card-preview-row";
      const statsLabel = document.createElement("span");
      statsLabel.className = "card-preview-label";
      statsLabel.textContent = "Stats:";
      const statsVal = document.createElement("span");
      const modStats = CardData.getModStats(card);
      const vehStats = CardData.getVehicleStats(card);
      const parts = [];
      if (modStats) parts.push(modStats);
      if (vehStats) parts.push(vehStats);
      statsVal.textContent = parts.join(" | ") || "‚Äì";
      rowStats.appendChild(statsLabel);
      rowStats.appendChild(statsVal);

      const rulesEl = document.createElement("div");
      rulesEl.className = "card-preview-text";
      rulesEl.textContent = card.notes || "Rules text will appear here.";

      body.appendChild(header);
      body.appendChild(rowSet);
      body.appendChild(rowRarity);
      body.appendChild(rowVehicles);
      body.appendChild(rowTags);
      body.appendChild(rowStats);
      body.appendChild(rulesEl);

      previewEl.appendChild(imgWrap);
      previewEl.appendChild(body);
    }

    function collectSingleCardFromInputs(requireId) {
      const id = Dom.cardIdInput.value.trim();
      const name = Dom.cardNameInput.value.trim();
      const type = Dom.cardTypeInput.value;
      const setName = Dom.cardSetNameInput.value.trim();
      const cardNumber = Dom.cardNumberInput.value.trim();
      const rarity = Dom.cardRarityInput.value.trim();
      const vehTypesStr = Dom.cardVehicleTypesInput.value.trim();
      const tagsStr = Dom.cardTagsInput.value.trim();
      const imageUrl = Dom.cardImageUrlInput.value.trim();
      const notes = Dom.cardNotesInput.value;

      const vehTypes = parseVehicleTypes(vehTypesStr);
      const tags = parseTags(tagsStr);

      const modBase = Dom.modBasePartInput.value.trim();
      const modL1 = Dom.modL1Input.value.trim();
      const modL2 = Dom.modL2Input.value.trim();
      const modL3 = Dom.modL3Input.value.trim();
      const modL4 = Dom.modL4Input.value.trim();

      const hpConStr = Dom.vehicleHpConInput.value.trim();
      const hpCon = parseHpCon(hpConStr);

      let extra = {};

      if (type === "Mod") {
        extra.modBasePart = modBase || undefined;
        extra.modLevel1 = modL1 || undefined;
        extra.modLevel2 = modL2 || undefined;
        extra.modLevel3 = modL3 || undefined;
        extra.modLevel4 = modL4 || undefined;
      }

      if (type === "Vehicle" || type === "Named Vehicle") {
        extra.hp = hpCon.hp !== undefined ? hpCon.hp : extra.hp;
        extra.con = hpCon.con !== undefined ? hpCon.con : extra.con;
      }

      // Build prints from currentSinglePrints
      let prints = Array.isArray(AppState.currentSinglePrints)
        ? AppState.currentSinglePrints.map(p => ({
            setId: (p.setId || "").trim(),
            cardNumber: (p.cardNumber || "").trim()
          }))
        : [];

      const primarySetId = prints.length ? prints[0].setId : "";
      const primaryCardNumber = prints.length ? prints[0].cardNumber : "";

      const card = {
        id: id || (requireId ? "" : "card-" + Math.random().toString(36).slice(2)),
        name,
        type,
        setName: primarySetId || setName,
        cardNumber: primaryCardNumber || cardNumber,
        rarity,
        tags,
        notes,
        imageUrl,
        extra,
        vehicleTypes: vehTypes,
        prints
      };
      return card;
    }

    function fillSingleCardInputs(card) {
      Dom.cardIdInput.value = card.id || "";
      Dom.cardNameInput.value = card.name || "";
      Dom.cardTypeInput.value = card.type || "";
      Dom.cardSetNameInput.value = card.setName || "";
      Dom.cardNumberInput.value = card.cardNumber || "";
      Dom.cardRarityInput.value = card.rarity || "";
      Dom.cardVehicleTypesInput.value = (card.vehicleTypes || []).join(", ");
      Dom.cardTagsInput.value = (card.tags || []).join(", ");
      Dom.cardImageUrlInput.value = card.imageUrl || "";
      Dom.cardNotesInput.value = card.notes || "";

      const e = card.extra || {};
      Dom.modBasePartInput.value = e.modBasePart || "";
      Dom.modL1Input.value = e.modLevel1 || "";
      Dom.modL2Input.value = e.modLevel2 || "";
      Dom.modL3Input.value = e.modLevel3 || "";
      Dom.modL4Input.value = e.modLevel4 || "";

      const hpConStr =
        e.hp !== undefined || e.con !== undefined ? `${e.hp || ""}/${e.con || ""}` : "";
      Dom.vehicleHpConInput.value = hpConStr;

      // Set up prints
      let prints = Array.isArray(card.prints) ? card.prints.slice() : [];
      if (!prints.length && (card.setName || card.cardNumber)) {
        prints.push({
          setId: card.setName || "",
          cardNumber: card.cardNumber || ""
        });
      }
      AppState.currentSinglePrints = prints;
      renderSinglePrints();

      renderSinglePreview();
    }

    function renderSinglePrints() {
      const listEl = Dom.cardPrintsList;
      const prints = AppState.currentSinglePrints || [];
      listEl.innerHTML = "";

      if (!prints.length) {
        listEl.innerHTML = "<span class='small-note'>No prints configured yet.</span>";
        return;
      }

      const ul = document.createElement("ul");
      ul.className = "small-note";

      prints.forEach((p, idx) => {
        const li = document.createElement("li");
        const labelParts = [];
        labelParts.push(p.setId || "(no set)");
        if (p.cardNumber) labelParts.push(`‚Äì ${p.cardNumber}`);
        if (idx === 0) labelParts.push("(primary)");
        const label = labelParts.join(" ");

        const span = document.createElement("span");
        span.textContent = label;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "button secondary small";
        btn.style.marginLeft = "0.4rem";
        btn.textContent = "Remove";
        btn.addEventListener("click", () => {
          AppState.currentSinglePrints.splice(idx, 1);
          // keep primary fields in sync with new first print (if any)
          const first = AppState.currentSinglePrints[0] || { setId: "", cardNumber: "" };
          Dom.cardSetNameInput.value = first.setId || "";
          Dom.cardNumberInput.value = first.cardNumber || "";

          renderSinglePrints();
          renderSinglePreview();
        });

        li.appendChild(span);
        li.appendChild(btn);
        ul.appendChild(li);
      });

      listEl.appendChild(ul);

      // sync hidden primary fields with first print
      const first = prints[0] || { setId: "", cardNumber: "" };
      Dom.cardSetNameInput.value = first.setId || "";
      Dom.cardNumberInput.value = first.cardNumber || "";
    }

    function resolvePrintSetId() {
      const sel = Dom.printSetSelect.value;
      if (sel === "CUSTOM") {
        return Dom.printCustomSetInput.value.trim();
      }
      return sel || "";
    }

    function handleSetPrintPrimary() {
      const setId = resolvePrintSetId();
      const cardNumber = Dom.printCardNumberInput.value.trim();

      if (!setId) {
        Dom.singleStatus.textContent = "Choose a set from the dropdown or enter a custom set.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }

      let prints = Array.isArray(AppState.currentSinglePrints)
        ? AppState.currentSinglePrints.slice()
        : [];

      // Remove existing entry with same setId
      prints = prints.filter(p => (p.setId || "") !== setId);

      // New primary print goes to the front
      prints.unshift({ setId, cardNumber });

      AppState.currentSinglePrints = prints;

      // Mirror into primary fields
      Dom.cardSetNameInput.value = setId;
      Dom.cardNumberInput.value = cardNumber;

      Dom.singleStatus.textContent = `Primary printing set to ${setId}${cardNumber ? " ‚Äì " + cardNumber : ""}.`;
      Dom.singleStatus.className = "status small-note ok";

      renderSinglePrints();
      renderSinglePreview();
    }

    function handleClearAllPrints() {
      if (!AppState.currentSinglePrints.length) return;
      if (!confirm("Clear all prints for this card?")) return;

      AppState.currentSinglePrints = [];
      Dom.cardSetNameInput.value = "";
      Dom.cardNumberInput.value = "";

      renderSinglePrints();
      renderSinglePreview();
    }

    async function loadCards() {
      AppState.cards = [];
      AppState.cardsById = {};
      try {
        const res = await fetch("drive-card.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed to fetch drive-card.json");
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("drive-card.json is not an array.");
        AppState.cards = data.map(c => cardToJson(c));
        AppState.cards.forEach(c => {
          if (!c.id) {
            c.id = "card-" + Math.random().toString(36).slice(2);
          }
          AppState.cardsById[c.id] = c;
        });
        renderCardLibraryList();
      } catch (e) {
        console.warn("Could not fetch drive-card.json, starting empty:", e);
        AppState.cards = [];
        AppState.cardsById = {};
        renderCardLibraryList();
      }
    }

    function renderCardLibraryList() {
      const listEl = Dom.cardLibraryList;
      listEl.innerHTML = "";
      const q = (Dom.cardLibrarySearchInput.value || "").trim().toLowerCase();

      let cards = AppState.cards.slice();
      if (q) {
        cards = cards.filter(c => {
          const text = [
            c.name,
            c.type,
            c.setName,
            c.rarity,
            (c.tags || []).join(",")
          ]
            .join(" | ")
            .toLowerCase();
          return text.includes(q);
        });
      }

      cards.sort((a, b) => {
        const sa = (a.setName || "").localeCompare(b.setName || "");
        if (sa !== 0) return sa;
        const ca = (a.cardNumber || "").localeCompare(b.cardNumber || "");
        if (ca !== 0) return ca;
        return (a.name || "").localeCompare(b.name || "");
      });

      cards.forEach((card, idx) => {
        const row = document.createElement("div");
        row.className = "library-row";
        if (card.id === AppState.selectedLibraryCardId) {
          row.classList.add("selected");
        }

        const colIdx = document.createElement("span");
        colIdx.textContent = idx + 1;

        const colName = document.createElement("span");
        colName.className = "truncate";
        colName.textContent = card.name || "(No Name)";

        const colType = document.createElement("span");
        colType.className = "truncate";
        colType.textContent = card.type || "";

        const colSet = document.createElement("span");
        colSet.className = "truncate";
        colSet.textContent = card.setName || "";

        const colRarity = document.createElement("span");
        colRarity.className = "truncate";
        colRarity.textContent = card.rarity || "";

        row.appendChild(colIdx);
        row.appendChild(colName);
        row.appendChild(colType);
        row.appendChild(colSet);
        row.appendChild(colRarity);

        row.addEventListener("click", () => {
          AppState.selectedLibraryCardId = card.id;
          fillSingleCardInputs(card);
          renderCardLibraryList();
        });

        listEl.appendChild(row);
      });
    }

    function handleSingleNew() {
      Dom.cardIdInput.value = "";
      Dom.cardNameInput.value = "";
      Dom.cardTypeInput.value = "";
      Dom.cardSetNameInput.value = "";
      Dom.cardNumberInput.value = "";
      Dom.cardRarityInput.value = "";
      Dom.cardVehicleTypesInput.value = "";
      Dom.cardTagsInput.value = "";
      Dom.cardImageUrlInput.value = "";
      Dom.cardNotesInput.value = "";
      Dom.modBasePartInput.value = "";
      Dom.modL1Input.value = "";
      Dom.modL2Input.value = "";
      Dom.modL3Input.value = "";
      Dom.modL4Input.value = "";
      Dom.vehicleHpConInput.value = "";
      Dom.printSetSelect.value = "";
      Dom.printCustomSetInput.value = "";
      Dom.printCardNumberInput.value = "";
      Dom.singleStatus.textContent = "";
      AppState.selectedLibraryCardId = null;
      AppState.currentSinglePrints = [];
      renderSinglePrints();
      renderSinglePreview();
      renderCardLibraryList();
    }

    function handleSingleSave() {
      const card = collectSingleCardFromInputs(false);

      if (!card.name || !card.type || !card.setName) {
        Dom.singleStatus.textContent =
          "Name, Type, and at least one Set/Print are required (use Set + Set Print).";
        Dom.singleStatus.className = "status small-note err";
        return;
      }

      // 1) If this card has an id and already exists in the library, update by id.
      if (card.id && AppState.cardsById[card.id]) {
        const idx = AppState.cards.findIndex(c => c.id === card.id);
        if (idx !== -1) {
          AppState.cards[idx] = card;
        }
        AppState.cardsById[card.id] = card;
        AppState.selectedLibraryCardId = card.id;

        Dom.singleStatus.textContent =
          "Updated existing card in library (match by ID).";
        Dom.singleStatus.className = "status small-note ok";

      } else {
        // 2) Fall back to matching by Name + Type + Set for new cards / imports.
        const key = normalizeNameTypeSet(card);
        let existingIndex = -1;
        for (let i = 0; i < AppState.cards.length; i++) {
          const c = AppState.cards[i];
          if (normalizeNameTypeSet(c) === key) {
            existingIndex = i;
            break;
          }
        }

        if (existingIndex !== -1) {
          // Update existing card that matches by Name+Type+Set.
          const existing = AppState.cards[existingIndex];
          // Preserve existing id, or generate one if somehow missing.
          card.id =
            existing.id ||
            card.id ||
            "card-" + Math.random().toString(36).slice(2);

          AppState.cards[existingIndex] = card;
          AppState.cardsById[card.id] = card;
          AppState.selectedLibraryCardId = card.id;

          Dom.singleStatus.textContent =
            "Updated existing card in library (match by Name+Type+Set).";
          Dom.singleStatus.className = "status small-note ok";

        } else {
          // 3) Truly new card: give it an id and push into the library.
          if (!card.id) {
            card.id = "card-" + Math.random().toString(36).slice(2);
          }
          AppState.cards.push(card);
          AppState.cardsById[card.id] = card;
          AppState.selectedLibraryCardId = card.id;

          Dom.singleStatus.textContent = "Added new card to library.";
          Dom.singleStatus.className = "status small-note ok";
        }
      }

      renderSinglePreview();
      renderCardLibraryList();
    }

    function handleSingleDelete() {
      const id = Dom.cardIdInput.value.trim();
      if (!id) {
        Dom.singleStatus.textContent = "No card id to delete.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }
      const idx = AppState.cards.findIndex(c => c.id === id);
      if (idx === -1) {
        Dom.singleStatus.textContent = "Card id not found in library.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }
      if (!confirm("Delete this card from the in-memory library?")) return;
      AppState.cards.splice(idx, 1);
      delete AppState.cardsById[id];
      if (AppState.selectedLibraryCardId === id) {
        AppState.selectedLibraryCardId = null;
      }
      Dom.singleStatus.textContent = "Card removed from in-memory library.";
      Dom.singleStatus.className = "status small-note ok";
      renderCardLibraryList();
      handleSingleNew();
    }

    function initSingleEditor() {
      Dom.cardLibrarySearchInput.addEventListener("input", renderCardLibraryList);

      [
        Dom.cardNameInput,
        Dom.cardTypeInput,
        Dom.cardSetNameInput,
        Dom.cardNumberInput,
        Dom.cardRarityInput,
        Dom.cardVehicleTypesInput,
        Dom.cardTagsInput,
        Dom.cardImageUrlInput,
        Dom.cardNotesInput,
        Dom.modBasePartInput,
        Dom.modL1Input,
        Dom.modL2Input,
        Dom.modL3Input,
        Dom.modL4Input,
        Dom.vehicleHpConInput
      ].forEach(el => {
        el.addEventListener("input", renderSinglePreview);
        el.addEventListener("change", renderSinglePreview);
      });

      Dom.singleSaveBtn.addEventListener("click", handleSingleSave);
      Dom.singleNewBtn.addEventListener("click", handleSingleNew);
      Dom.singleDeleteBtn.addEventListener("click", handleSingleDelete);

      Dom.printSetPrimaryBtn.addEventListener("click", handleSetPrintPrimary);
      Dom.printClearAllBtn.addEventListener("click", handleClearAllPrints);
      Dom.printSetSelect.addEventListener("change", () => {
        if (Dom.printSetSelect.value === "CUSTOM") {
          Dom.printCustomSetInput.focus();
        }
      });

      Dom.downloadCardsJsonBtn_single.addEventListener("click", () => {
        downloadJson("drive-card.json", AppState.cards.map(cardToJson));
      });
    }

    function normalizeCell(v) {
      if (v === null || v === undefined) return "";
      if (typeof v === "string") return v.trim();
      return String(v).trim();
    }

    function parseWorkbookToRows(workbook) {
      const ws = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
      if (!json.length) return [];

      const headerRow = json[0].map(normalizeCell);
      const rows = [];
      for (let i = 1; i < json.length; i++) {
        const rowArr = json[i];
        if (!rowArr.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== "")) {
          continue;
        }
        const obj = {};
        headerRow.forEach((h, idx) => {
          if (!h) return;
          obj[h] = normalizeCell(rowArr[idx]);
        });
        obj._rowIndex = i + 1;
        obj._rowId = "row-" + i;
        rows.push(obj);
      }
      return rows;
    }

    function mapRowToCard(row) {
      const name = row.Name || row.CardName || "";
      const type = row.Type || "";
      const setName = row.Set || row.SetName || "";
      const cardNumber = row.CardNumber || row.No || "";
      const rarity = row.Rarity || "";
      const imageUrl = row.ImageUrl || row.Image || "";
      const notes = row.Notes || row.Rules || "";
      const tagsStr = row.Tags || "";
      const vehicleTypesStr = row.VehicleTypes || "";
      const vehStatsStr = row.VehicleStats || "";
      const modBasePart = row.ModBasePart || row.BasePart || "";
      const modL1 = row.ModL1 || "";
      const modL2 = row.ModL2 || "";
      const modL3 = row.ModL3 || "";
      const modL4 = row.ModL4 || "";

      const tags = parseTags(tagsStr);
      const vehicleTypes = parseVehicleTypes(vehicleTypesStr);

      const vehStats = parseHpCon(vehStatsStr);

      let extra = {};
      if (type === "Mod") {
        extra.modBasePart = modBasePart || undefined;
        extra.modLevel1 = modL1 || undefined;
        extra.modLevel2 = modL2 || undefined;
        extra.modLevel3 = modL3 || undefined;
        extra.modLevel4 = modL4 || undefined;
      }
      if (type === "Vehicle" || type === "Named Vehicle") {
        extra.hp = vehStats.hp !== undefined ? vehStats.hp : extra.hp;
        extra.con = vehStats.con !== undefined ? vehStats.con : extra.con;
      }

      const prints = [];
      if (setName || cardNumber) {
        prints.push({
          setId: setName,
          cardNumber
        });
      }

      const card = {
        id: "",
        name,
        type,
        setName,
        cardNumber,
        rarity,
        tags,
        notes,
        imageUrl,
        extra,
        vehicleTypes,
        prints
      };

      card._bulkSource = row;
      return card;
    }

    function renderBulkTable() {
      const container = Dom.bulkTable;
      container.innerHTML = "";

      if (!AppState.bulkRows.length) {
        container.innerHTML = "<div class='small-note' style='padding:0.35rem;'>No spreadsheet loaded.</div>";
        return;
      }

      const nameFilter = (Dom.bulkNameFilterInput.value || "").trim().toLowerCase();
      const typeFilter = (Dom.bulkTypeFilterInput.value || "").trim().toLowerCase();
      const setFilter = (Dom.bulkSetFilterInput.value || "").trim().toLowerCase();

      let rows = AppState.bulkRows.slice();
      if (nameFilter) {
        rows = rows.filter(r =>
          String(r.Name || r.CardName || "")
            .toLowerCase()
            .includes(nameFilter)
        );
      }
      if (typeFilter) {
        rows = rows.filter(r =>
          String(r.Type || "")
            .toLowerCase()
            .includes(typeFilter)
        );
      }
      if (setFilter) {
        rows = rows.filter(r =>
          String(r.Set || r.SetName || "")
            .toLowerCase()
            .includes(setFilter)
        );
      }

      if (!rows.length) {
        container.innerHTML = "<div class='small-note' style='padding:0.35rem;'>No rows match current filters.</div>";
        return;
      }

      rows.forEach(row => {
        const rowEl = document.createElement("div");
        rowEl.className = "bulk-row";

        const rowId = row._rowId;
        const isSelected = AppState.bulkSelectedRowIds.has(rowId);
        if (isSelected) rowEl.classList.add("selected");

        const name = row.Name || row.CardName || "";
        const type = row.Type || "";
        const setName = row.Set || row.SetName || "";
        const cardNumber = row.CardNumber || row.No || "";

        const colCheck = document.createElement("span");
        colCheck.textContent = isSelected ? "‚úì" : "";

        const colName = document.createElement("span");
        colName.className = "truncate";
        colName.textContent = name || "(no name)";

        const colType = document.createElement("span");
        colType.className = "truncate";
        colType.textContent = type;

        const colSet = document.createElement("span");
        colSet.className = "truncate";
        colSet.textContent = setName;

        const colNo = document.createElement("span");
        colNo.className = "truncate";
        colNo.textContent = cardNumber;

        rowEl.appendChild(colCheck);
        rowEl.appendChild(colName);
        rowEl.appendChild(colType);
        rowEl.appendChild(colSet);
        rowEl.appendChild(colNo);

        rowEl.addEventListener("click", () => {
          if (AppState.bulkSelectedRowIds.has(rowId)) {
            AppState.bulkSelectedRowIds.delete(rowId);
          } else {
            AppState.bulkSelectedRowIds.add(rowId);
          }
          renderBulkTable();
          renderBulkSelectionSummary();
        });

        container.appendChild(rowEl);
      });
    }

    function renderBulkSelectionSummary() {
      const el = Dom.bulkSelectionSummary;
      const total = AppState.bulkRows.length;
      const selected = AppState.bulkSelectedRowIds.size;
      el.textContent = `${selected} of ${total} row(s) selected.`;
    }

    function handleBulkFileChange(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      Dom.bulkStep1Status.textContent = "Reading file‚Ä¶";
      Dom.bulkStep1Status.className = "small-note status";

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const rows = parseWorkbookToRows(workbook);
          AppState.bulkRows = rows;
          AppState.bulkSelectedRowIds.clear();
          Dom.bulkStep1Status.textContent = `Loaded ${rows.length} row(s) from ${file.name}.`;
          Dom.bulkStep1Status.className = "small-note status ok";
          renderBulkTable();
          renderBulkSelectionSummary();
        } catch (err) {
          console.error(err);
          Dom.bulkStep1Status.textContent = "Failed to parse spreadsheet.";
          Dom.bulkStep1Status.className = "small-note status err";
        }
      };
      reader.onerror = () => {
        Dom.bulkStep1Status.textContent = "Failed to read file.";
        Dom.bulkStep1Status.className = "small-note status err";
      };
      reader.readAsArrayBuffer(file);
    }

    function handleBulkSelectViewed() {
      const nameFilter = (Dom.bulkNameFilterInput.value || "").trim().toLowerCase();
      const typeFilter = (Dom.bulkTypeFilterInput.value || "").trim().toLowerCase();
      const setFilter = (Dom.bulkSetFilterInput.value || "").trim().toLowerCase();

      let rows = AppState.bulkRows.slice();
      if (nameFilter) {
        rows = rows.filter(r =>
          String(r.Name || r.CardName || "")
            .toLowerCase()
            .includes(nameFilter)
        );
      }
      if (typeFilter) {
        rows = rows.filter(r =>
          String(r.Type || "")
            .toLowerCase()
            .includes(typeFilter)
        );
      }
      if (setFilter) {
        rows = rows.filter(r =>
          String(r.Set || r.SetName || "")
            .toLowerCase()
            .includes(setFilter)
        );
      }

      rows.forEach(r => AppState.bulkSelectedRowIds.add(r._rowId));
      renderBulkTable();
      renderBulkSelectionSummary();
    }

    function handleBulkClearViewed() {
      const nameFilter = (Dom.bulkNameFilterInput.value || "").trim().toLowerCase();
      const typeFilter = (Dom.bulkTypeFilterInput.value || "").trim().toLowerCase();
      const setFilter = (Dom.bulkSetFilterInput.value || "").trim().toLowerCase();

      let rows = AppState.bulkRows.slice();
      if (nameFilter) {
        rows = rows.filter(r =>
          String(r.Name || r.CardName || "")
            .toLowerCase()
            .includes(nameFilter)
        );
      }
      if (typeFilter) {
        rows = rows.filter(r =>
          String(r.Type || "")
            .toLowerCase()
            .includes(typeFilter)
        );
      }
      if (setFilter) {
        rows = rows.filter(r =>
          String(r.Set || r.SetName || "")
            .toLowerCase()
            .includes(setFilter)
        );
      }

      rows.forEach(r => AppState.bulkSelectedRowIds.delete(r._rowId));
      renderBulkTable();
      renderBulkSelectionSummary();
    }

    function handleBulkClearAll() {
      AppState.bulkSelectedRowIds.clear();
      renderBulkTable();
      renderBulkSelectionSummary();
    }

    function applyBulkToLibrary() {
      const selectedRowIds = Array.from(AppState.bulkSelectedRowIds);
      if (!selectedRowIds.length) {
        Dom.bulkStep3Status.textContent = "No rows selected.";
        Dom.bulkStep3Status.className = "small-note status err";
        return;
      }

      const mode = Dom.bulkUpdateModeSelect.value;

      const selectedRows = AppState.bulkRows.filter(r => selectedRowIds.includes(r._rowId));
      const cardsFromRows = selectedRows.map(mapRowToCard);

      if (mode === "replace-all") {
        if (!confirm("Replace entire in-memory library with selected rows?")) return;
        AppState.cards = cardsFromRows.map(c => {
          c.id = c.id || "card-" + Math.random().toString(36).slice(2);
          return c;
        });
        AppState.cardsById = {};
        AppState.cards.forEach(c => {
          AppState.cardsById[c.id] = c;
        });
        Dom.bulkStep3Status.textContent = `Replaced library with ${AppState.cards.length} card(s).`;
        Dom.bulkStep3Status.className = "small-note status ok";
        renderCardLibraryList();
        return;
      }

      if (mode === "insert-only") {
        let inserted = 0;
        cardsFromRows.forEach(c => {
          const key = normalizeNameTypeSet(c);
          const existingIndex = AppState.cards.findIndex(ex => normalizeNameTypeSet(ex) === key);
          if (existingIndex === -1) {
            c.id = "card-" + Math.random().toString(36).slice(2);
            AppState.cards.push(c);
            AppState.cardsById[c.id] = c;
            inserted++;
          }
        });
        Dom.bulkStep3Status.textContent = `Inserted ${inserted} new card(s). Skipped duplicates.`;
        Dom.bulkStep3Status.className = "small-note status ok";
        renderCardLibraryList();
        return;
      }

      let upserts = 0;
      cardsFromRows.forEach(c => {
        const key = normalizeNameTypeSet(c);
        const idx = AppState.cards.findIndex(ex => normalizeNameTypeSet(ex) === key);
        if (idx === -1) {
          c.id = "card-" + Math.random().toString(36).slice(2);
          AppState.cards.push(c);
          AppState.cardsById[c.id] = c;
        } else {
          c.id = AppState.cards[idx].id || "card-" + Math.random().toString(36).slice(2);
          AppState.cards[idx] = c;
          AppState.cardsById[c.id] = c;
        }
        upserts++;
      });
      Dom.bulkStep3Status.textContent = `Applied ${upserts} upsert(s) to library.`;
      Dom.bulkStep3Status.className = "small-note status ok";
      renderCardLibraryList();
    }

    function initBulk() {
      Dom.bulkFileInput.addEventListener("change", handleBulkFileChange);

      [
        Dom.bulkSetFilterInput,
        Dom.bulkTypeFilterInput,
        Dom.bulkNameFilterInput
      ].forEach(input => {
        input.addEventListener("input", () => {
          renderBulkTable();
          renderBulkSelectionSummary();
        });
      });

      Dom.bulkSelectViewedBtn.addEventListener("click", handleBulkSelectViewed);
      Dom.bulkClearViewedBtn.addEventListener("click", handleBulkClearViewed);
      Dom.bulkClearAllBtn.addEventListener("click", handleBulkClearAll);
      Dom.bulkApplyBtn.addEventListener("click", applyBulkToLibrary);

      Dom.downloadCardsJsonBtn_bulk.addEventListener("click", () => {
        downloadJson("drive-card.json", AppState.cards.map(cardToJson));
      });
    }

    function downloadJson(filename, data) {
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function renderPreconList() {
      const listEl = Dom.preconList;
      listEl.innerHTML = "";

      if (!AppState.precons.length) {
        listEl.innerHTML = "<div class='small-note' style='padding:0.35rem;'>No precons loaded.</div>";
        return;
      }

      AppState.precons.forEach(precon => {
        const row = document.createElement("div");
        row.className = "precon-row";
        if (precon.id === AppState.selectedPreconId) row.classList.add("selected");

        const title = document.createElement("span");
        title.className = "precon-row-title";
        title.textContent = precon.name || "(Untitled)";

        const count = document.createElement("span");
        count.textContent = `${(precon.cards || []).length} cards`;

        row.appendChild(title);
        row.appendChild(count);

        row.addEventListener("click", () => {
          AppState.selectedPreconId = precon.id;
          fillPreconDetails(precon);
          renderPreconList();
        });

        listEl.appendChild(row);
      });

      Dom.preconListStatus.textContent = `${AppState.precons.length} precon(s) loaded.`;
      Dom.preconListStatus.className = "small-note status";
    }

    function fillPreconDetails(precon) {
      if (!precon) {
        Dom.preconIdInput.value = "";
        Dom.preconNameInput.value = "";
        Dom.preconDescriptionInput.value = "";
        Dom.preconCardsList.innerHTML = "No precon selected.";
        return;
      }

      Dom.preconIdInput.value = precon.id || "";
      Dom.preconNameInput.value = precon.name || "";
      Dom.preconDescriptionInput.value = precon.description || "";

      const cards = precon.cards || [];
      if (!cards.length) {
        Dom.preconCardsList.innerHTML = "No cards in this precon.";
        return;
      }

      const ul = document.createElement("ul");
      ul.className = "small-note";
      cards.forEach((pc, idx) => {
        const li = document.createElement("li");
        const card = AppState.cardsById[pc.cardId];
        const label = card
          ? `${card.name} (${card.setName || ""} ${card.cardNumber || ""}) ‚Äì x${pc.count}`
          : `Unknown card id ${pc.cardId} ‚Äì x${pc.count}`;
        li.textContent = label;
        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "button secondary small";
        removeBtn.style.marginLeft = "0.4rem";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => {
          precon.cards.splice(idx, 1);
          fillPreconDetails(precon);
        });
        li.appendChild(removeBtn);
        ul.appendChild(li);
      });
      Dom.preconCardsList.innerHTML = "";
      Dom.preconCardsList.appendChild(ul);
    }

    function handlePreconNew() {
      const id = "precon-" + Math.random().toString(36).slice(2);
      const precon = {
        id,
        name: "New Precon",
        description: "",
        cards: []
      };
      AppState.precons.push(precon);
      AppState.selectedPreconId = id;
      fillPreconDetails(precon);
      renderPreconList();
      Dom.preconStatus.textContent = "Created new precon.";
      Dom.preconStatus.className = "small-note status ok";
    }

    function handlePreconDelete() {
      if (!AppState.selectedPreconId) {
        Dom.preconStatus.textContent = "No precon selected.";
        Dom.preconStatus.className = "small-note status err";
        return;
      }
      if (!confirm("Delete this precon?")) return;
      AppState.precons = AppState.precons.filter(p => p.id !== AppState.selectedPreconId);
      AppState.selectedPreconId = null;
      fillPreconDetails(null);
      renderPreconList();
      Dom.preconStatus.textContent = "Precon deleted.";
      Dom.preconStatus.className = "small-note status ok";
    }

    function handlePreconSave() {
      const id = Dom.preconIdInput.value.trim();
      if (!id) {
        Dom.preconStatus.textContent = "No precon id to save.";
        Dom.preconStatus.className = "small-note status err";
        return;
      }
      const precon = AppState.precons.find(p => p.id === id);
      if (!precon) {
        Dom.preconStatus.textContent = "Precon not found in memory.";
        Dom.preconStatus.className = "small-note status err";
        return;
      }

      precon.name = Dom.preconNameInput.value.trim();
      precon.description = Dom.preconDescriptionInput.value.trim();

      renderPreconList();
      Dom.preconStatus.textContent = "Precon updated.";
      Dom.preconStatus.className = "small-note status ok";
    }

    function openModal() {
      Dom.modalBackdrop.classList.add("open");
      Dom.modalSearchInput.value = "";
      renderModalCardList();
      Dom.modalSearchInput.focus();
    }

    function closeModal() {
      Dom.modalBackdrop.classList.remove("open");
    }

    function renderModalCardList() {
      const listEl = Dom.modalCardList;
      listEl.innerHTML = "";

      const q = (Dom.modalSearchInput.value || "").trim().toLowerCase();
      let cards = AppState.cards.slice();
      if (q) {
        cards = cards.filter(c => {
          const text = [
            c.name,
            c.type,
            c.setName,
            c.cardNumber
          ]
            .join(" | ")
            .toLowerCase();
          return text.includes(q);
        });
      }

      if (!cards.length) {
        listEl.innerHTML = "<div class='small-note' style='padding:0.35rem;'>No cards match.</div>";
        return;
      }

      cards.forEach(card => {
        const row = document.createElement("div");
        row.className = "precon-row";

        const title = document.createElement("span");
        title.className = "precon-row-title";
        title.textContent = card.name || "(No Name)";

        const meta = document.createElement("span");
        meta.textContent = `${card.type || ""} ‚Äì ${card.setName || ""} ${card.cardNumber || ""}`;

        row.appendChild(title);
        row.appendChild(meta);

        row.addEventListener("click", () => {
          addCardToCurrentPrecon(card);
          closeModal();
        });

        listEl.appendChild(row);
      });
    }

    function addCardToCurrentPrecon(card) {
      if (!AppState.selectedPreconId) {
        Dom.preconStatus.textContent = "No precon selected.";
        Dom.preconStatus.className = "small-note status err";
        return;
      }
      const precon = AppState.precons.find(p => p.id === AppState.selectedPreconId);
      if (!precon) {
        Dom.preconStatus.textContent = "Precon not found.";
        Dom.preconStatus.className = "small-note status err";
        return;
      }

      const existing = precon.cards.find(pc => pc.cardId === card.id);
      if (existing) {
        existing.count = (existing.count || 1) + 1;
      } else {
        precon.cards.push({
          cardId: card.id,
          count: 1
        });
      }
      fillPreconDetails(precon);
      Dom.preconStatus.textContent = "Added card to precon.";
      Dom.preconStatus.className = "small-note status ok";
    }

    function handlePreconFileChange(evt) {
      const file = evt.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const json = JSON.parse(e.target.result);
          if (!Array.isArray(json)) throw new Error("Expected an array.");
          AppState.precons = json;
          AppState.selectedPreconId = null;
          fillPreconDetails(null);
          renderPreconList();
          Dom.preconListStatus.textContent = `Loaded ${json.length} precon(s) from file.`;
          Dom.preconListStatus.className = "small-note status ok";
        } catch (err) {
          console.error(err);
          Dom.preconListStatus.textContent = "Failed to parse precons JSON.";
          Dom.preconListStatus.className = "small-note status err";
        }
      };
      reader.onerror = () => {
        Dom.preconListStatus.textContent = "Failed to read precons file.";
        Dom.preconListStatus.className = "small-note status err";
      };
      reader.readAsText(file);
    }

    function initPrecons() {
      Dom.preconNewBtn.addEventListener("click", handlePreconNew);
      Dom.preconDeleteBtn.addEventListener("click", handlePreconDelete);
      Dom.preconSaveBtn.addEventListener("click", handlePreconSave);
      Dom.preconAddCardBtn.addEventListener("click", openModal);
      Dom.preconFileInput.addEventListener("change", handlePreconFileChange);

      Dom.downloadPreconsJsonBtn.addEventListener("click", () => {
        downloadJson("drive-precons.json", AppState.precons);
      });

      Dom.modalCloseBtn.addEventListener("click", closeModal);
      Dom.modalBackdrop.addEventListener("click", evt => {
        if (evt.target === Dom.modalBackdrop) closeModal();
      });
      Dom.modalSearchInput.addEventListener("input", renderModalCardList);
    }

    document.addEventListener("DOMContentLoaded", () => {
      initNav();
      initSingleEditor();
      initBulk();
      initPrecons();
      loadCards();
      renderSinglePreview();
      renderSinglePrints();
      renderPreconList();
    });
  </script>
</body>
</html>
