<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header small {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .nav {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      align-items: center;
    }
    .nav-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .nav-btn {
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease, box-shadow 0.08s ease;
    }
    .nav-btn:hover {
      background: #030712;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .nav-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.12);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      margin-bottom: 0.75rem;
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }
    .panel h3 {
      margin: 0.5rem 0 0.4rem;
      font-size: 0.95rem;
    }
    .layout-two {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 0.75rem;
    }
    @media (max-width: 900px) {
      .layout-two {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .layout-three {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr) minmax(0, 1.1fr);
      gap: 0.75rem;
    }
    @media (max-width: 1100px) {
      .layout-three {
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      }
    }
    @media (max-width: 900px) {
      .layout-three {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .toolbar input[type="text"],
    .toolbar select {
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .toolbar input[type="file"] {
      font-size: 0.8rem;
    }
    .toolbar .spacer {
      flex: 1;
    }
    .button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.08s ease, box-shadow 0.08s ease, transform 0.05s ease;
    }
    .button:hover {
      background: #020617;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }
    .button.secondary {
      background: #020617;
    }
    .button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    .button.danger:hover {
      background: #7f1d1d;
    }
    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .status {
      font-size: 0.78rem;
      margin-top: 0.25rem;
    }
    .status.ok {
      color: #4ade80;
    }
    .status.warn {
      color: #facc15;
    }
    .status.err {
      color: #f97373;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      font-size: 0.78rem;
    }
    .field label {
      color: #9ca3af;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      padding: 0.3rem 0.5rem;
      border-radius: 0.55rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .card-preview {
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(148,163,184,0.16), #020617);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      padding: 0.6rem;
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
      min-height: 180px;
    }
    .card-preview-img {
      flex: 0 0 40%;
      max-width: 40%;
      background: #020617;
      border-radius: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .card-preview-img img {
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
    }
    .card-preview-body {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.8rem;
    }
    .card-preview-header {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
      align-items: baseline;
    }
    .card-preview-name {
      font-size: 1rem;
      font-weight: 600;
    }
    .card-preview-type {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .card-preview-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .card-preview-label {
      font-weight: 600;
      color: #e5e7eb;
    }
    .card-preview-text {
      border-radius: 0.5rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      padding: 0.4rem 0.5rem;
      white-space: pre-wrap;
      font-size: 0.78rem;
    }

    .json-view {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.5rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre;
    }

    .bulk-grid {
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      font-size: 0.78rem;
    }
    .bulk-row {
      display: grid;
      grid-template-columns: 2.2rem minmax(0, 2.5fr) minmax(0, 1.5fr) minmax(0, 1.5fr) minmax(0, 1.5fr);
      gap: 0.4rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }
    .bulk-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .bulk-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .bulk-row-header {
      font-weight: 600;
      color: #9ca3af;
      border-bottom: 1px solid #1f2937;
      margin-bottom: 0.2rem;
    }
    .bulk-row input[type="checkbox"] {
      transform: scale(1.1);
    }

    .library-list {
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      font-size: 0.78rem;
    }
    .library-row {
      display: grid;
      grid-template-columns: 2.5rem minmax(0, 3fr) minmax(0, 1.5fr) minmax(0, 1.5fr) minmax(0, 1.4fr);
      gap: 0.4rem;
      align-items: center;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
      cursor: pointer;
    }
    .library-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .library-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .library-row.selected {
      border: 1px solid #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .library-row span.truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }
    .modal-backdrop.open {
      display: flex;
    }
    .modal {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .modal-header h3 {
      margin: 0;
      font-size: 1rem;
    }
    .modal-close {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 0.2rem 0.6rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .modal-close:hover {
      background: #111827;
    }
    .modal-body {
      font-size: 0.8rem;
    }

    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(15,23,42,0.9);
      border-radius: 0.25rem;
      padding: 0 0.25rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Admin</h1>
        <small>Manage drive-card.json and drive-precons.json for the public card library.</small>
      </div>
    </header>

    <nav class="nav">
      <span class="nav-label">Section:</span>
      <button id="navSingleBtn" class="nav-btn active" type="button">Single Card Editor</button>
      <button id="navBulkBtn" class="nav-btn" type="button">Bulk Import from Excel</button>
      <button id="navPreconsBtn" class="nav-btn" type="button">Preconstructed Decks</button>
      <button id="navHelpBtn" class="nav-btn" type="button">Help / Workflow</button>
    </nav>

    <!-- SINGLE CARD EDITOR -->
    <section id="singleSection" class="panel">
      <h2>Single Card Editor</h2>
      <p class="small-note">
        Edit or create a card entry for <span class="inline-code">drive-card.json</span>. Use the bulk importer for large updates.
      </p>

      <div class="layout-two">
        <div>
          <h3>Card Fields</h3>
          <div class="field-grid">
            <div class="field">
              <label for="cardIdInput">Card ID (internal)</label>
              <input id="cardIdInput" type="text" placeholder="auto or existing id" />
            </div>
            <div class="field">
              <label for="cardNameInput">Name</label>
              <input id="cardNameInput" type="text" />
            </div>
            <div class="field">
              <label for="cardTypeInput">Type</label>
              <select id="cardTypeInput">
                <option value="">– Select –</option>
                <option value="Crew">Crew</option>
                <option value="Driver">Driver</option>
                <option value="Named Driver">Named Driver</option>
                <option value="Mod">Mod</option>
                <option value="Vehicle">Vehicle</option>
                <option value="Named Vehicle">Named Vehicle</option>
                <option value="Track">Track</option>
                <option value="Condition">Condition</option>
                <option value="Misc">Misc</option>
              </select>
            </div>
            <div class="field">
              <label for="cardSetNameInput">Set Name (display)</label>
              <input id="cardSetNameInput" type="text" placeholder="Set 1 – 1…2…3…Race!" />
            </div>
            <div class="field">
              <label for="cardNumberInput">Card Number (within set)</label>
              <input id="cardNumberInput" type="text" placeholder="01-001" />
            </div>
            <div class="field">
              <label for="cardRarityInput">Rarity</label>
              <input id="cardRarityInput" type="text" placeholder="Common / Rare / Promo…" />
            </div>
            <div class="field">
              <label for="cardVehicleTypesInput">Vehicle Types (comma separated)</label>
              <input id="cardVehicleTypesInput" type="text" placeholder="Drag, Drift…" />
            </div>
            <div class="field">
              <label for="cardTagsInput">Tags (comma separated)</label>
              <input id="cardTagsInput" type="text" placeholder="Sponsor, Junkyard, Father&#39;s Day…" />
            </div>
            <div class="field">
              <label for="cardImageUrlInput">Image URL (relative)</label>
              <input id="cardImageUrlInput" type="text" placeholder="images/set1/dannys_r-2-4.png" />
            </div>
          </div>

          <h3>Type-Specific Extras</h3>
          <div class="field-grid">
            <div class="field">
              <label for="modBasePartInput">Mod – Base Part</label>
              <input id="modBasePartInput" type="text" placeholder="Engine, Headers, Tires…" />
            </div>
            <div class="field">
              <label for="modL1Input">Mod – Level 1</label>
              <input id="modL1Input" type="text" placeholder="1/2 etc" />
            </div>
            <div class="field">
              <label for="modL2Input">Mod – Level 2</label>
              <input id="modL2Input" type="text" />
            </div>
            <div class="field">
              <label for="modL3Input">Mod – Level 3</label>
              <input id="modL3Input" type="text" />
            </div>
            <div class="field">
              <label for="modL4Input">Mod – Level 4</label>
              <input id="modL4Input" type="text" />
            </div>

            <div class="field">
              <label for="vehicleHpConInput">Vehicle / Named Vehicle – HP/CON</label>
              <input id="vehicleHpConInput" type="text" placeholder="10/4 etc" />
            </div>
            <div class="field">
              <label for="extraJsonInput">Extra JSON (advanced)</label>
              <input id="extraJsonInput" type="text" placeholder='{"sponsorBrand":"WOLF"}' />
            </div>
          </div>

          <h3>Rules Text</h3>
          <div class="field">
            <label for="cardNotesInput">Rules / Trait Text</label>
            <textarea id="cardNotesInput"></textarea>
          </div>

          <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.4rem;">
            <button id="singleNewBtn" class="button secondary" type="button">New Card</button>
            <button id="singleSaveBtn" class="button" type="button">Save / Update in Library</button>
            <button id="singleDeleteBtn" class="button danger" type="button">Delete from Library</button>
          </div>
          <div id="singleStatus" class="status small-note"></div>
        </div>

        <div>
          <h3>Preview & JSON</h3>
          <div id="singlePreview" class="card-preview">
            <div class="card-preview-img">
              <span class="small-note">No image</span>
            </div>
            <div class="card-preview-body">
              <div class="card-preview-header">
                <div class="card-preview-name">(No Name)</div>
                <div class="card-preview-type">–</div>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Set:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Rarity:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Vehicle Types:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Tags:</span>
                <span>–</span>
              </div>
              <div class="card-preview-row">
                <span class="card-preview-label">Stats:</span>
                <span>–</span>
              </div>
              <div class="card-preview-text">Rules text will appear here.</div>
            </div>
          </div>

          <h3>Raw JSON for this Card</h3>
          <pre id="singleJsonView" class="json-view">{}</pre>
        </div>
      </div>
    </section>

    <!-- BULK IMPORT SECTION -->
    <section id="bulkSection" class="panel" style="display:none;">
      <h2>Bulk Import from Excel</h2>
      <p class="small-note">
        Load your <span class="inline-code">Drive Cards.xlsx</span>, pick a sheet, then select which rows to import into
        <span class="inline-code">drive-card.json</span>. Existing cards with the same name + type + set will be updated.
      </p>

      <div class="layout-three">
        <div>
          <h3>Step 1 – Upload Excel & pick sheet</h3>
          <div class="toolbar">
            <input id="bulkFileInput" type="file" accept=".xlsx" />
          </div>
          <div class="field">
            <label for="bulkSheetSelect">Sheet</label>
            <select id="bulkSheetSelect">
              <option value="">– No workbook loaded –</option>
            </select>
          </div>
          <p id="bulkStep1Status" class="status small-note"></p>
          <button id="bulkParseSheetBtn" class="button" type="button">Parse Selected Sheet</button>
        </div>

        <div>
          <h3>Step 2 – Filter & select cards to include</h3>
          <div class="field">
            <input id="bulkSearchInput" type="text" placeholder="Filter by name / type / set…" />
          </div>
          <div class="field">
            <select id="bulkTypeFilter">
              <option value="">All Types</option>
            </select>
          </div>
          <div class="field">
            <select id="bulkSetFilter">
              <option value="">All Sets</option>
            </select>
          </div>

          <div id="bulkGrid" class="bulk-grid">
            <div class="bulk-row bulk-row-header">
              <div></div>
              <div>Name</div>
              <div>Type</div>
              <div>Set</div>
              <div>Rarity</div>
            </div>
            <p class="small-note">No sheet parsed yet.</p>
          </div>
          <p id="bulkStep2Status" class="status small-note"></p>
        </div>

        <div>
          <h3>Step 3 – Apply to drive-card.json</h3>
          <p class="small-note">
            Selected rows will either create new card entries, or update existing ones that match by
            <strong>Name + Type + Set</strong>.
          </p>
          <div class="field">
            <label>When matching existing cards…</label>
            <select id="bulkUpdateModeSelect">
              <option value="update">Update existing card &amp; create new if missing</option>
              <option value="createOnly">Only create new cards (do not update existing)</option>
              <option value="updateOnly">Only update existing (ignore new names)</option>
            </select>
          </div>
          <button id="bulkApplyBtn" class="button" type="button">Apply to in-memory Library</button>
          <p id="bulkStep3Status" class="status small-note"></p>

          <h3>Save Updated Library</h3>
          <button id="downloadCardsJsonBtn" class="button secondary" type="button">
            Download drive-card.json
          </button>
          <p class="small-note">
            After download, upload <span class="inline-code">drive-card.json</span> to your GitHub repo root (same folder as
            <span class="inline-code">index.html</span> and <span class="inline-code">admin.html</span>).
          </p>
        </div>
      </div>
    </section>

    <!-- PRECONSTRUCTED DECKS SECTION -->
    <section id="preconsSection" class="panel" style="display:none;">
      <h2>Preconstructed Decks</h2>
      <p class="small-note">
        Manage <span class="inline-code">drive-precons.json</span>. Each precon is a named deck with an id, description,
        and a mapping of cardId → quantity.
      </p>

      <div class="layout-two">
        <div>
          <h3>Precon List</h3>
          <div class="toolbar">
            <button id="preconNewBtn" class="button secondary" type="button">New Precon</button>
            <button id="preconDeleteBtn" class="button danger" type="button">Delete Selected</button>
            <span class="spacer"></span>
            <button id="preconReloadBtn" class="button secondary" type="button">Reload from JSON</button>
          </div>
          <div id="preconLibraryList" class="library-list"></div>
          <p id="preconListStatus" class="status small-note"></p>

          <h3>Save JSON</h3>
          <button id="downloadPreconsJsonBtn" class="button secondary" type="button">
            Download drive-precons.json
          </button>
        </div>

        <div>
          <h3>Precon Details</h3>
          <div class="field-grid">
            <div class="field">
              <label for="preconIdInput">Precon ID</label>
              <input id="preconIdInput" type="text" placeholder="starter-set1-speed" />
            </div>
            <div class="field">
              <label for="preconNameInput">Name</label>
              <input id="preconNameInput" type="text" />
            </div>
          </div>
          <div class="field">
            <label for="preconNotesInput">Description / Notes</label>
            <textarea id="preconNotesInput"></textarea>
          </div>

          <h3>Cards in this Precon</h3>
          <div class="field">
            <label for="preconCardSearchInput">Add Card (search by name)</label>
            <input id="preconCardSearchInput" type="text" placeholder="Start typing a card name…" />
          </div>
          <p class="small-note">
            Enter a name substring, then choose a result to add or adjust its quantity. Use 0 to remove a card.
          </p>
          <div id="preconCardList" class="library-list"></div>

          <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.4rem;">
            <button id="preconSaveBtn" class="button" type="button">Save Changes to Precon</button>
          </div>
          <p id="preconEditStatus" class="status small-note"></p>
        </div>
      </div>
    </section>

    <!-- HELP SECTION -->
    <section id="helpSection" class="panel" style="display:none;">
      <h2>Admin Workflow & Tips</h2>
      <p class="small-note">
        This page never writes directly to GitHub. It only loads and saves JSON in your browser.
        You always manually upload the resulting <span class="inline-code">drive-card.json</span> and
        <span class="inline-code">drive-precons.json</span> to your GitHub repo.
      </p>

      <h3>Folder / Repo Structure</h3>
      <ul class="small-note">
        <li><span class="inline-code">/index.html</span> – public Card Library & Deck Builder</li>
        <li><span class="inline-code">/admin.html</span> – this admin page</li>
        <li><span class="inline-code">/drive-card.json</span> – all card entries (no images inside JSON)</li>
        <li><span class="inline-code">/drive-precons.json</span> – all preconstructed decks</li>
        <li><span class="inline-code">/images/set1/…</span> – card images (PNG, JPG)</li>
      </ul>

      <h3>Single Card Workflow</h3>
      <ol class="small-note">
        <li>Load existing <span class="inline-code">drive-card.json</span> automatically (the page does this on load).</li>
        <li>Use <strong>Single Card Editor</strong> to tweak or create a card.</li>
        <li>Set <strong>imageUrl</strong> to a relative path like
          <span class="inline-code">images/set1/dannys_r-2-4.png</span>.
        </li>
        <li>Click <strong>Save / Update in Library</strong>.</li>
        <li>When finished with a batch, click <strong>Download drive-card.json</strong>
          and upload it to GitHub.
        </li>
      </ol>

      <h3>Bulk Import Workflow (Excel)</h3>
      <ol class="small-note">
        <li>Export or maintain your master <span class="inline-code">Drive Cards.xlsx</span>.</li>
        <li>In <strong>Bulk Import</strong>, upload the <span class="inline-code">.xlsx</span> file.</li>
        <li>Select a sheet (e.g. <strong>Crew Cards</strong>) and click
          <strong>Parse Selected Sheet</strong>.
        </li>
        <li>Filter by type / set, tick the rows you want, and choose your
          update mode (update / create / update-only).
        </li>
        <li>Click <strong>Apply to in-memory Library</strong>.</li>
        <li>Repeat for other sheets if needed.</li>
        <li>When done, click <strong>Download drive-card.json</strong> and upload to GitHub.</li>
      </ol>

      <h3>Precon Workflow</h3>
      <ol class="small-note">
        <li>Go to <strong>Preconstructed Decks</strong>.</li>
        <li>Use <strong>Reload from JSON</strong> to load existing precons, or
          <strong>New Precon</strong> to start a fresh one.</li>
        <li>Fill in id, name, description.</li>
        <li>Use the card search to add cards and set quantities.</li>
        <li>Click <strong>Save Changes to Precon</strong>.</li>
        <li>When all precons are ready, click <strong>Download drive-precons.json</strong>
          and upload it to GitHub.</li>
      </ol>

      <h3>Image URL Tips</h3>
      <ul class="small-note">
        <li>Use lowercase, no spaces: <span class="inline-code">images/set1/dannys_r-2-4.png</span></li>
        <li>Keep filenames simple: letters, numbers, <span class="inline-code">_</span>, <span class="inline-code">-</span></li>
        <li>Do <strong>not</strong> include the domain in <span class="inline-code">imageUrl</span> –
          just the path from the repo root.</li>
      </ul>
    </section>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3>Debug / Info</h3>
        <button id="modalCloseBtn" class="modal-close" type="button">✕</button>
      </div>
      <div id="modalBody" class="modal-body small-note"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    const AppState = {
      cards: [],
      cardsById: {},
      precons: [],
      selectedLibraryCardId: null,
      selectedPreconId: null
    };

    const SHEET_CONFIG = {
      "Crew Cards": {
        type: "Crew",
        nameCol: "Crew Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Crew Trait"
      },
      "Mod Cards": {
        type: "Mod",
        nameCol: "Mod Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Mod Ability",
        modBasePartCol: "MOD BASE PART",
        modL1Col: "MOD LVL 1",
        modL2Col: "MOD LVL 2",
        modL3Col: "MOD LVL 3",
        modL4Col: "MOD LVL 4"
      },
      "Driver Cards": {
        type: "Driver",
        nameCol: "Driver Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Driver Trait"
      },
      "Named Driver Cards": {
        type: "Named Driver",
        nameCol: "Driver Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Driver Trait"
      },
      "Condition Cards": {
        type: "Condition",
        nameCol: "Condition Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Condition Trait"
      },
      "Track Cards": {
        type: "Track",
        nameCol: "Track Name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "Track Trait",
        vehicleTypeCol: "TRACK VEHICLE TYPE"
      },
      "Vehicle Cards": {
        type: "Vehicle",
        nameCol: "VEHICLE name",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "TRAIT",
        vehicleTypeCol: "VEHICLE TYPE",
        hpConCol: "HP/CON"
      },
      "NAMED VEHICLE": {
        type: "Named Vehicle",
        nameCol: "NAMED VEHICLE NAME",
        setCol: "SET",
        rarityCol: "RARITY",
        notesCol: "VEHICLE TRAIT",
        vehicleTypeCol: "VEHICLE TYPE",
        hpConCol: "HP/CON"
      },
      "MISC": {
        type: "Misc",
        nameCol: "TOKENS/COUNTERS",
        setCol: null,
        rarityCol: "RARITY",
        notesCol: "ABILITY"
      }
    };

    const Dom = {
      navSingleBtn: document.getElementById("navSingleBtn"),
      navBulkBtn: document.getElementById("navBulkBtn"),
      navPreconsBtn: document.getElementById("navPreconsBtn"),
      navHelpBtn: document.getElementById("navHelpBtn"),

      singleSection: document.getElementById("singleSection"),
      bulkSection: document.getElementById("bulkSection"),
      preconsSection: document.getElementById("preconsSection"),
      helpSection: document.getElementById("helpSection"),

      cardIdInput: document.getElementById("cardIdInput"),
      cardNameInput: document.getElementById("cardNameInput"),
      cardTypeInput: document.getElementById("cardTypeInput"),
      cardSetNameInput: document.getElementById("cardSetNameInput"),
      cardNumberInput: document.getElementById("cardNumberInput"),
      cardRarityInput: document.getElementById("cardRarityInput"),
      cardVehicleTypesInput: document.getElementById("cardVehicleTypesInput"),
      cardTagsInput: document.getElementById("cardTagsInput"),
      cardImageUrlInput: document.getElementById("cardImageUrlInput"),
      modBasePartInput: document.getElementById("modBasePartInput"),
      modL1Input: document.getElementById("modL1Input"),
      modL2Input: document.getElementById("modL2Input"),
      modL3Input: document.getElementById("modL3Input"),
      modL4Input: document.getElementById("modL4Input"),
      vehicleHpConInput: document.getElementById("vehicleHpConInput"),
      extraJsonInput: document.getElementById("extraJsonInput"),
      cardNotesInput: document.getElementById("cardNotesInput"),

      singleNewBtn: document.getElementById("singleNewBtn"),
      singleSaveBtn: document.getElementById("singleSaveBtn"),
      singleDeleteBtn: document.getElementById("singleDeleteBtn"),
      singleStatus: document.getElementById("singleStatus"),

      singlePreview: document.getElementById("singlePreview"),
      singleJsonView: document.getElementById("singleJsonView"),

      bulkFileInput: document.getElementById("bulkFileInput"),
      bulkSheetSelect: document.getElementById("bulkSheetSelect"),
      bulkParseSheetBtn: document.getElementById("bulkParseSheetBtn"),
      bulkStep1Status: document.getElementById("bulkStep1Status"),

      bulkSearchInput: document.getElementById("bulkSearchInput"),
      bulkTypeFilter: document.getElementById("bulkTypeFilter"),
      bulkSetFilter: document.getElementById("bulkSetFilter"),
      bulkGrid: document.getElementById("bulkGrid"),
      bulkStep2Status: document.getElementById("bulkStep2Status"),

      bulkUpdateModeSelect: document.getElementById("bulkUpdateModeSelect"),
      bulkApplyBtn: document.getElementById("bulkApplyBtn"),
      bulkStep3Status: document.getElementById("bulkStep3Status"),

      downloadCardsJsonBtn: document.getElementById("downloadCardsJsonBtn"),

      preconNewBtn: document.getElementById("preconNewBtn"),
      preconDeleteBtn: document.getElementById("preconDeleteBtn"),
      preconReloadBtn: document.getElementById("preconReloadBtn"),
      preconLibraryList: document.getElementById("preconLibraryList"),
      preconListStatus: document.getElementById("preconListStatus"),
      preconIdInput: document.getElementById("preconIdInput"),
      preconNameInput: document.getElementById("preconNameInput"),
      preconNotesInput: document.getElementById("preconNotesInput"),
      preconCardSearchInput: document.getElementById("preconCardSearchInput"),
      preconCardList: document.getElementById("preconCardList"),
      preconSaveBtn: document.getElementById("preconSaveBtn"),
      preconEditStatus: document.getElementById("preconEditStatus"),
      downloadPreconsJsonBtn: document.getElementById("downloadPreconsJsonBtn"),

      modalBackdrop: document.getElementById("modalBackdrop"),
      modalBody: document.getElementById("modalBody"),
      modalCloseBtn: document.getElementById("modalCloseBtn")
    };

    function showSection(section) {
      Dom.singleSection.style.display = section === "single" ? "" : "none";
      Dom.bulkSection.style.display = section === "bulk" ? "" : "none";
      Dom.preconsSection.style.display = section === "precons" ? "" : "none";
      Dom.helpSection.style.display = section === "help" ? "" : "none";

      Dom.navSingleBtn.classList.toggle("active", section === "single");
      Dom.navBulkBtn.classList.toggle("active", section === "bulk");
      Dom.navPreconsBtn.classList.toggle("active", section === "precons");
      Dom.navHelpBtn.classList.toggle("active", section === "help");
    }

    function openModal(html) {
      Dom.modalBody.innerHTML = html;
      Dom.modalBackdrop.classList.add("open");
    }
    function closeModal() {
      Dom.modalBackdrop.classList.remove("open");
    }

    function normalizeNameTypeSet(card) {
      const name = (card.name || "").trim().toLowerCase();
      const type = (card.type || "").trim().toLowerCase();
      const setName = (card.setName || "").trim().toLowerCase();
      return `${name}||${type}||${setName}`;
    }

    function ensureExtras(card) {
      if (!card.extra || typeof card.extra !== "object") {
        card.extra = {};
      }
      return card.extra;
    }

    function loadCards() {
      return fetch("drive-card.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch drive-card.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json)) throw new Error("drive-card.json is not an array.");
          AppState.cards = json;
          AppState.cardsById = {};
          AppState.cards.forEach(card => {
            if (!card.id) {
              card.id = "card-" + Math.random().toString(36).slice(2);
            }
            if (!card.extra) card.extra = {};
            if (!Array.isArray(card.tags)) card.tags = [];
            if (typeof card.imageUrl !== "string") card.imageUrl = "";
            AppState.cardsById[card.id] = card;
          });
          console.log("Loaded cards:", AppState.cards.length);
        })
        .catch(err => {
          console.error(err);
          AppState.cards = [];
          AppState.cardsById = {};
        });
    }

    function loadPrecons() {
      return fetch("drive-precons.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch drive-precons.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json)) throw new Error("drive-precons.json is not an array");
          AppState.precons = json;
          console.log("Loaded precons:", AppState.precons.length);
          renderPreconList();
        })
        .catch(err => {
          console.error(err);
          AppState.precons = [];
          renderPreconList();
        });
    }

    function parseVehicleTypes(str) {
      if (!str) return [];
      return String(str)
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseTags(str) {
      if (!str) return [];
      return String(str)
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseHpCon(val) {
      const out = { hp: undefined, con: undefined };
      if (!val) return out;
      const cleaned = String(val).replace(/\s/g, "");
      const parts = cleaned.split("/");
      if (parts[0] !== undefined && parts[0] !== "") out.hp = Number(parts[0]);
      if (parts[1] !== undefined && parts[1] !== "") out.con = Number(parts[1]);
      return out;
    }

    // Tolerant cell reader: exact match first, then case/whitespace-insensitive
    function readCell(row, ...keys) {
      // 1) Exact header match first
      for (const k of keys) {
        if (!k) continue;
        if (Object.prototype.hasOwnProperty.call(row, k)) {
          const v = row[k];
          if (v !== undefined && v !== null && v !== "") {
            return v;
          }
        }
      }

      // 2) Fuzzy fallback: case + whitespace insensitive
      //    e.g. "SET", "Set", " set " are treated the same
      const cols = Object.keys(row).map(col => ({
        name: col,
        norm: col.toLowerCase().replace(/\s+/g, "")
      }));

      for (const k of keys) {
        if (!k) continue;
        const target = String(k).toLowerCase().replace(/\s+/g, "");
        for (const col of cols) {
          if (col.norm === target) {
            const v = row[col.name];
            if (v !== undefined && v !== null && v !== "") {
              return v;
            }
          }
        }
      }

      return "";
    }

    function cardToJson(card) {
      const clean = JSON.parse(JSON.stringify(card));
      ["tempSheet", "tempRow", "selected"].forEach(k => delete clean[k]);
      return clean;
    }

    function renderSinglePreview() {
      const card = collectSingleCardFromInputs(false);
      const previewEl = Dom.singlePreview;
      previewEl.innerHTML = "";

      const imgWrap = document.createElement("div");
      imgWrap.className = "card-preview-img";
      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.name || "Card";
        imgWrap.appendChild(img);
      } else {
        const span = document.createElement("span");
        span.className = "small-note";
        span.textContent = "No image";
        imgWrap.appendChild(span);
      }

      const body = document.createElement("div");
      body.className = "card-preview-body";

      const header = document.createElement("div");
      header.className = "card-preview-header";
      const nameEl = document.createElement("div");
      nameEl.className = "card-preview-name";
      nameEl.textContent = card.name || "(No Name)";
      const typeEl = document.createElement("div");
      typeEl.className = "card-preview-type";
      typeEl.textContent = card.type || "–";
      header.appendChild(nameEl);
      header.appendChild(typeEl);

      const rowSet = document.createElement("div");
      rowSet.className = "card-preview-row";
      rowSet.innerHTML = `<span class="card-preview-label">Set:</span> <span>${card.setName || "–"}</span>`;

      const rowRarity = document.createElement("div");
      rowRarity.className = "card-preview-row";
      rowRarity.innerHTML = `<span class="card-preview-label">Rarity:</span> <span>${card.rarity || "–"}</span>`;

      const rowVehicles = document.createElement("div");
      rowVehicles.className = "card-preview-row";
      const vt = CardData.getVehicleTypes(card);
      rowVehicles.innerHTML = `<span class="card-preview-label">Vehicle Types:</span> <span>${vt.length ? vt.join(", ") : "–"}</span>`;

      const rowTags = document.createElement("div");
      rowTags.className = "card-preview-row";
      const tags = card.tags || [];
      rowTags.innerHTML = `<span class="card-preview-label">Tags:</span> <span>${tags.length ? tags.join(", ") : "–"}</span>`;

      const rowStats = document.createElement("div");
      rowStats.className = "card-preview-row";
      const modStats = CardData.getModStats(card);
      const vehStats = CardData.getVehicleStats(card);
      const statPieces = [];
      if (modStats) statPieces.push(modStats);
      if (vehStats) statPieces.push(vehStats);
      rowStats.innerHTML = `<span class="card-preview-label">Stats:</span> <span>${statPieces.length ? statPieces.join(" | ") : "–"}</span>`;

      const rulesEl = document.createElement("div");
      rulesEl.className = "card-preview-text";
      rulesEl.textContent = card.notes || "Rules text will appear here.";

      body.appendChild(header);
      body.appendChild(rowSet);
      body.appendChild(rowRarity);
      body.appendChild(rowVehicles);
      body.appendChild(rowTags);
      body.appendChild(rowStats);
      body.appendChild(rulesEl);

      previewEl.appendChild(imgWrap);
      previewEl.appendChild(body);
      Dom.singleJsonView.textContent = JSON.stringify(cardToJson(card), null, 2);
    }

    function collectSingleCardFromInputs(requireId) {
      const id = Dom.cardIdInput.value.trim();
      const name = Dom.cardNameInput.value.trim();
      const type = Dom.cardTypeInput.value;
      const setName = Dom.cardSetNameInput.value.trim();
      const cardNumber = Dom.cardNumberInput.value.trim();
      const rarity = Dom.cardRarityInput.value.trim();
      const vehTypesStr = Dom.cardVehicleTypesInput.value.trim();
      const tagsStr = Dom.cardTagsInput.value.trim();
      const imageUrl = Dom.cardImageUrlInput.value.trim();
      const notes = Dom.cardNotesInput.value;

      const vehTypes = parseVehicleTypes(vehTypesStr);
      const tags = parseTags(tagsStr);

      const modBase = Dom.modBasePartInput.value.trim();
      const modL1 = Dom.modL1Input.value.trim();
      const modL2 = Dom.modL2Input.value.trim();
      const modL3 = Dom.modL3Input.value.trim();
      const modL4 = Dom.modL4Input.value.trim();

      const hpConStr = Dom.vehicleHpConInput.value.trim();
      const hpCon = parseHpCon(hpConStr);

      let extra = {};
      if (Dom.extraJsonInput.value.trim()) {
        try {
          extra = JSON.parse(Dom.extraJsonInput.value);
        } catch (e) {
          console.error("Invalid extra JSON, ignoring:", e);
          extra = {};
        }
      }

      if (type === "Mod") {
        extra.modBasePart = modBase || undefined;
        extra.modLevel1 = modL1 || undefined;
        extra.modLevel2 = modL2 || undefined;
        extra.modLevel3 = modL3 || undefined;
        extra.modLevel4 = modL4 || undefined;
      }

      if (type === "Vehicle" || type === "Named Vehicle") {
        extra.hp = hpCon.hp !== undefined ? hpCon.hp : extra.hp;
        extra.con = hpCon.con !== undefined ? hpCon.con : extra.con;
      }

      const card = {
        id: id || (requireId ? "" : "card-" + Math.random().toString(36).slice(2)),
        name,
        type,
        setName,
        cardNumber,
        rarity,
        tags,
        notes,
        imageUrl,
        extra,
        vehicleTypes: vehTypes
      };
      return card;
    }

    function fillSingleCardInputs(card) {
      Dom.cardIdInput.value = card.id || "";
      Dom.cardNameInput.value = card.name || "";
      Dom.cardTypeInput.value = card.type || "";
      Dom.cardSetNameInput.value = card.setName || "";
      Dom.cardNumberInput.value = card.cardNumber || "";
      Dom.cardRarityInput.value = card.rarity || "";
      Dom.cardVehicleTypesInput.value = (card.vehicleTypes || []).join(", ");
      Dom.cardTagsInput.value = (card.tags || []).join(", ");
      Dom.cardImageUrlInput.value = card.imageUrl || "";
      Dom.cardNotesInput.value = card.notes || "";

      const e = card.extra || {};
      Dom.modBasePartInput.value = e.modBasePart || "";
      Dom.modL1Input.value = e.modLevel1 || "";
      Dom.modL2Input.value = e.modLevel2 || "";
      Dom.modL3Input.value = e.modLevel3 || "";
      Dom.modL4Input.value = e.modLevel4 || "";

      const hpConStr =
        e.hp !== undefined || e.con !== undefined ? `${e.hp || ""}/${e.con || ""}` : "";
      Dom.vehicleHpConInput.value = hpConStr;

      const extraClean = JSON.parse(JSON.stringify(e || {}));
      Dom.extraJsonInput.value = Object.keys(extraClean).length
        ? JSON.stringify(extraClean)
        : "";
      renderSinglePreview();
    }

    const CardData = {
      getVehicleTypes(card) {
        if (!card) return [];
        if (Array.isArray(card.vehicleTypes) && card.vehicleTypes.length) {
          return card.vehicleTypes;
        }
        const e = card.extra || {};
        if (Array.isArray(e.vehicleTypes) && e.vehicleTypes.length) {
          return e.vehicleTypes;
        }
        if (e.vehicleType) return [e.vehicleType];
        return [];
      },
      getModStats(card) {
        if (!card || card.type !== "Mod") return "";
        const e = card.extra || {};
        const parts = [];
        if (e.modBasePart) parts.push(`Base: ${e.modBasePart}`);
        const levels = [];
        if (e.modLevel1) levels.push(`L1 ${e.modLevel1}`);
        if (e.modLevel2) levels.push(`L2 ${e.modLevel2}`);
        if (e.modLevel3) levels.push(`L3 ${e.modLevel3}`);
        if (e.modLevel4) levels.push(`L4 ${e.modLevel4}`);
        if (levels.length) parts.push(levels.join(" · "));
        return parts.join(" | ");
      },
      getVehicleStats(card) {
        if (!card || (card.type !== "Vehicle" && card.type !== "Named Vehicle")) return "";
        const e = card.extra || {};
        const bits = [];
        if (typeof e.hp === "number") bits.push(`HP: ${e.hp}`);
        if (typeof e.con === "number") bits.push(`CON: ${e.con}`);
        return bits.join(" · ");
      }
    };

    function renderLibraryList() {
      const container = Dom.preconLibraryList; // reused only in precons; no separate library view for cards here
    }

    let bulkWorkbook = null;
    let bulkCards = [];
    let bulkFilterSearch = "";
    let bulkFilterType = "";
    let bulkFilterSet = "";

    const Bulk = {
      handleFileChange(evt) {
        const file = evt.target.files[0];
        if (!file) {
          bulkWorkbook = null;
          Dom.bulkSheetSelect.innerHTML = '<option value="">– No workbook loaded –</option>';
          Dom.bulkStep1Status.textContent = "";
          return;
        }
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            bulkWorkbook = XLSX.read(data, { type: "array" });
            Dom.bulkSheetSelect.innerHTML =
              '<option value="">– Select sheet –</option>' +
              bulkWorkbook.SheetNames.map(
                name => `<option value="${name}">${name}</option>`
              ).join("");
            Dom.bulkStep1Status.textContent =
              "Workbook loaded. Select a sheet and click Parse.";
            Dom.bulkStep1Status.className = "status small-note ok";
          } catch (err) {
            console.error(err);
            bulkWorkbook = null;
            Dom.bulkSheetSelect.innerHTML =
              '<option value="">– Error loading workbook –</option>';
            Dom.bulkStep1Status.textContent =
              "Could not read this file. Make sure it's a valid .xlsx file.";
            Dom.bulkStep1Status.className = "status small-note err";
          }
        };
        reader.readAsArrayBuffer(file);
      },

      parseSheet() {
        if (!bulkWorkbook) {
          alert("Upload a .xlsx file first.");
          return;
        }
        const sheetName = Dom.bulkSheetSelect.value;
        if (!sheetName) {
          alert("Select a sheet.");
          return;
        }
        const ws = bulkWorkbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });
        if (!rows.length) {
          Dom.bulkStep1Status.textContent = "Sheet has no rows.";
          Dom.bulkStep1Status.className = "status small-note warn";
          return;
        }

        const cfg = SHEET_CONFIG[sheetName] || {};
        bulkCards = rows
          .map((row, idx) => {
            const name    = readCell(row, cfg.nameCol, "Card Name", "Name", "Card");
            const type    = cfg.type || readCell(row, "Card Type", "Type");
            const setName = readCell(row, cfg.setCol, "SET", "Set", "Set Name", "Set 1", "SET 1", "Set Code");
            const rarity  = readCell(row, cfg.rarityCol, "RARITY", "Rarity");

            return {
              index: idx,
              sheetName,
              name: name || "",
              type: type || "",
              setName: setName || "",
              rarity: rarity || "",
              raw: row,
              selected: !!name
            };
          })
          .filter(row => row.name);

        Dom.bulkStep1Status.textContent =
          `Parsed ${bulkCards.length} potential cards from "${sheetName}".`;
        Dom.bulkStep1Status.className = "status small-note ok";

        const typeSet = new Set();
        const setNameSet = new Set();
        bulkCards.forEach(r => {
          if (r.type) typeSet.add(r.type);
          if (r.setName) setNameSet.add(r.setName);
        });
        Dom.bulkTypeFilter.innerHTML =
          '<option value="">All Types</option>' +
          Array.from(typeSet)
            .sort()
            .map(t => `<option value="${t}">${t}</option>`)
            .join("");

        Dom.bulkSetFilter.innerHTML =
          '<option value="">All Sets</option>' +
          Array.from(setNameSet)
            .sort()
            .map(s => `<option value="${s}">${s}</option>`)
            .join("");

        bulkFilterSearch = "";
        bulkFilterType = "";
        bulkFilterSet = "";
        Dom.bulkSearchInput.value = "";
        Dom.bulkTypeFilter.value = "";
        Dom.bulkSetFilter.value = "";
        Bulk.renderGrid();
      },

      renderGrid() {
        const container = Dom.bulkGrid;
        container.innerHTML =
          '<div class="bulk-row bulk-row-header">' +
          '<div><input id="bulkSelectAllCheckbox" type="checkbox" /></div>' +
          "<div>Name</div>" +
          "<div>Type</div>" +
          "<div>Set</div>" +
          "<div>Rarity</div>" +
          "</div>";

        const q = bulkFilterSearch.trim().toLowerCase();
        const rows = bulkCards.filter(r => {
          if (bulkFilterType && r.type !== bulkFilterType) return false;
          if (bulkFilterSet && r.setName !== bulkFilterSet) return false;
          if (q) {
            const haystack = `${r.name} ${r.type} ${r.setName} ${r.rarity}`.toLowerCase();
            if (!haystack.includes(q)) return false;
          }
          return true;
        });

        if (!rows.length) {
          const p = document.createElement("p");
          p.className = "small-note";
          p.textContent = "No rows match the current filters.";
          container.appendChild(p);
        } else {
          rows.forEach(r => {
            const rowEl = document.createElement("div");
            rowEl.className = "bulk-row";
            const cbCell = document.createElement("div");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = r.selected;
            cb.addEventListener("change", () => {
              r.selected = cb.checked;
            });
            cbCell.appendChild(cb);

            const nameCell = document.createElement("div");
            nameCell.textContent = r.name;
            const typeCell = document.createElement("div");
            typeCell.textContent = r.type;
            const setCell = document.createElement("div");
            setCell.textContent = r.setName;
            const rarityCell = document.createElement("div");
            rarityCell.textContent = r.rarity;

            rowEl.appendChild(cbCell);
            rowEl.appendChild(nameCell);
            rowEl.appendChild(typeCell);
            rowEl.appendChild(setCell);
            rowEl.appendChild(rarityCell);
            container.appendChild(rowEl);
          });
        }

        Dom.bulkStep2Status.textContent = `${rows.length} row(s) shown.`;
        Dom.bulkStep2Status.className = "status small-note";

        const selectAllCb = document.getElementById("bulkSelectAllCheckbox");
        if (selectAllCb) {
          selectAllCb.addEventListener("change", () => {
            const isChecked = selectAllCb.checked;
            rows.forEach(r => {
              r.selected = isChecked;
            });
            Bulk.renderGrid();
          });
        }
      },

      applyToLibrary() {
        if (!bulkCards.length) {
          alert("No parsed sheet data. Parse a sheet first.");
          return;
        }
        const selectedRows = bulkCards.filter(r => r.selected);
        if (!selectedRows.length) {
          alert("No rows selected.");
          return;
        }

        const mode = Dom.bulkUpdateModeSelect.value;
        const cardIndex = {};
        AppState.cards.forEach(card => {
          const key = normalizeNameTypeSet(card);
          if (!cardIndex[key]) cardIndex[key] = [];
          cardIndex[key].push(card);
        });

        let created = 0;
        let updated = 0;
        let skipped = 0;

        selectedRows.forEach(row => {
          const cfg = SHEET_CONFIG[row.sheetName] || {};
          const raw = row.raw;

          const name = row.name;
          const type = row.type;
          const setName = row.setName;
          const rarity = row.rarity;

          const key = `${name.trim().toLowerCase()}||${type.trim().toLowerCase()}||${setName.trim().toLowerCase()}`;
          const matches = cardIndex[key] || [];

          const newCard = {
            id: "card-" + Math.random().toString(36).slice(2),
            name,
            type,
            setName,
            cardNumber: "",
            rarity,
            tags: [],
            notes: "",
            imageUrl: "",
            extra: {},
            vehicleTypes: []
          };

          if (cfg.vehicleTypeCol) {
            const vtRaw = readCell(raw, cfg.vehicleTypeCol, "TRACK VEHICLE TYPE", "VEHICLE TYPE");
            newCard.vehicleTypes = parseVehicleTypes(vtRaw);
          }

          if (cfg.modBasePartCol) {
            const e = ensureExtras(newCard);
            e.modBasePart = readCell(raw, cfg.modBasePartCol, "MOD BASE PART");
            e.modLevel1 = readCell(raw, cfg.modL1Col, "MOD LVL 1");
            e.modLevel2 = readCell(raw, cfg.modL2Col, "MOD LVL 2");
            e.modLevel3 = readCell(raw, cfg.modL3Col, "MOD LVL 3");
            e.modLevel4 = readCell(raw, cfg.modL4Col, "MOD LVL 4");
          }

          if (cfg.hpConCol) {
            const hpConVal = readCell(raw, cfg.hpConCol, "HP/CON");
            const parsed = parseHpCon(hpConVal);
            const e = ensureExtras(newCard);
            if (parsed.hp !== undefined) e.hp = parsed.hp;
            if (parsed.con !== undefined) e.con = parsed.con;
          }

          newCard.notes = readCell(raw, cfg.notesCol, "Crew Trait", "Driver Trait", "Condition Trait", "Track Trait", "TRAIT", "ABILITY");

          if (matches.length) {
            if (mode === "createOnly") {
              skipped++;
              return;
            }
            const card = matches[0];
            card.rarity = newCard.rarity || card.rarity;
            card.notes = newCard.notes || card.notes;
            card.vehicleTypes = newCard.vehicleTypes.length ? newCard.vehicleTypes : card.vehicleTypes;
            card.extra = Object.assign({}, card.extra || {}, newCard.extra || {});
            updated++;
          } else {
            if (mode === "updateOnly") {
              skipped++;
              return;
            }
            AppState.cards.push(newCard);
            const libIdxKey = normalizeNameTypeSet(newCard);
            if (!cardIndex[libIdxKey]) cardIndex[libIdxKey] = [];
            cardIndex[libIdxKey].push(newCard);
            created++;
          }
        });

        Dom.bulkStep3Status.textContent =
          `Done. Created ${created}, updated ${updated}, skipped ${skipped}. Remember to download drive-card.json.`;
        Dom.bulkStep3Status.className = "status small-note ok";
      }
    };

    function renderCardLibraryForPrecons() {
      const container = Dom.preconCardList;
      const selectedPrecon = AppState.precons.find(p => p.id === AppState.selectedPreconId);
      const cardsMap = selectedPrecon ? selectedPrecon.cards || {} : {};
      container.innerHTML = "";

      const entries = Object.entries(cardsMap)
        .map(([cardId, qty]) => {
          const card = AppState.cardsById[cardId];
          return { cardId, card, qty: Number(qty) || 0 };
        })
        .filter(e => e.card && e.qty > 0)
        .sort((a, b) => (a.card.type || "").localeCompare(b.card.type || "") || (a.card.name || "").localeCompare(b.card.name || ""));

      if (!entries.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No cards in this precon.";
        container.appendChild(p);
        return;
      }

      entries.forEach((entry, idx) => {
        const row = document.createElement("div");
        row.className = "library-row";

        const idxCell = document.createElement("div");
        idxCell.textContent = String(idx + 1);

        const nameCell = document.createElement("span");
        nameCell.className = "truncate";
        nameCell.textContent = `${entry.qty}x ${entry.card.name}`;

        const typeCell = document.createElement("span");
        typeCell.className = "truncate";
        typeCell.textContent = entry.card.type || "";

        const setCell = document.createElement("span");
        setCell.className = "truncate";
        setCell.textContent = entry.card.setName || "";

        const qtyCell = document.createElement("span");
        qtyCell.textContent = entry.qty;

        row.appendChild(idxCell);
        row.appendChild(nameCell);
        row.appendChild(typeCell);
        row.appendChild(setCell);
        row.appendChild(qtyCell);

        row.addEventListener("click", () => {
          const newQtyStr = prompt(`Set quantity for "${entry.card.name}" (0 to remove):`, String(entry.qty));
          if (newQtyStr === null) return;
          const newQty = Math.max(0, Number(newQtyStr) || 0);
          if (!selectedPrecon.cards) selectedPrecon.cards = {};
          if (newQty === 0) {
            delete selectedPrecon.cards[entry.cardId];
          } else {
            selectedPrecon.cards[entry.cardId] = newQty;
          }
          renderCardLibraryForPrecons();
        });

        container.appendChild(row);
      });
    }

    function renderPreconList() {
      const container = Dom.preconLibraryList;
      container.innerHTML = "";
      if (!AppState.precons.length) {
        const p = document.createElement("p");
        p.className = "small-note";
        p.textContent = "No precons loaded yet.";
        container.appendChild(p);
      } else {
        AppState.precons.forEach((precon, idx) => {
          const row = document.createElement("div");
          row.className = "library-row" + (precon.id === AppState.selectedPreconId ? " selected" : "");
          const idxCell = document.createElement("div");
          idxCell.textContent = String(idx + 1);
          const nameCell = document.createElement("span");
          nameCell.className = "truncate";
          nameCell.textContent = precon.name || precon.id || "(Unnamed)";
          const idCell = document.createElement("span");
          idCell.className = "truncate";
          idCell.textContent = precon.id || "–";
          const cardCount = precon.cards ? Object.values(precon.cards).reduce((sum, n) => sum + Number(n || 0), 0) : 0;
          const cardsCell = document.createElement("span");
          cardsCell.textContent = `${cardCount} cards`;

          row.appendChild(idxCell);
          row.appendChild(nameCell);
          row.appendChild(idCell);
          row.appendChild(cardsCell);

          row.addEventListener("click", () => {
            AppState.selectedPreconId = precon.id;
            fillPreconEditor(precon);
            renderPreconList();
          });

          container.appendChild(row);
        });
      }

      Dom.preconListStatus.textContent = `${AppState.precons.length} precon deck(s) in memory.`;
      Dom.preconListStatus.className = "status small-note";
      const selectedPrecon = AppState.precons.find(p => p.id === AppState.selectedPreconId);
      if (selectedPrecon) {
        renderCardLibraryForPrecons();
      } else {
        Dom.preconCardList.innerHTML = "<p class='small-note'>Select a precon to view its cards.</p>";
      }
    }

    function fillPreconEditor(precon) {
      Dom.preconIdInput.value = precon.id || "";
      Dom.preconNameInput.value = precon.name || "";
      Dom.preconNotesInput.value = precon.notes || "";
      renderCardLibraryForPrecons();
      Dom.preconEditStatus.textContent = "";
    }

    function collectPreconFromInputs() {
      const id = Dom.preconIdInput.value.trim();
      const name = Dom.preconNameInput.value.trim();
      const notes = Dom.preconNotesInput.value;
      let existing = AppState.precons.find(p => p.id === id);
      if (!existing) {
        existing = { id, name, notes, cards: {} };
        AppState.precons.push(existing);
      } else {
        existing.name = name;
        existing.notes = notes;
      }
      return existing;
    }

    function handlePreconCardSearch() {
      const q = Dom.preconCardSearchInput.value.trim().toLowerCase();
      if (!q) return;
      const matches = AppState.cards.filter(c =>
        (c.name || "").toLowerCase().includes(q)
      );
      if (!matches.length) {
        alert("No cards found matching that search.");
        return;
      }
      const options = matches
        .slice(0, 25)
        .map((c, idx) => `${idx + 1}) ${c.name} [${c.type || ""}]`)
        .join("\n");
      const choice = prompt(
        `Choose a card number to add/update (1-${matches.length}):\n\n${options}`
      );
      if (!choice) return;
      const idx = Number(choice) - 1;
      if (idx < 0 || idx >= matches.length) {
        alert("Invalid choice.");
        return;
      }
      const card = matches[idx];
      const selectedPrecon = collectPreconFromInputs();
      if (!selectedPrecon.cards) selectedPrecon.cards = {};
      const currentQty = Number(selectedPrecon.cards[card.id] || 0);
      const newQtyStr = prompt(
        `Set quantity for "${card.name}" (0 to remove):`,
        String(currentQty || 1)
      );
      if (newQtyStr === null) return;
      const newQty = Math.max(0, Number(newQtyStr) || 0);
      if (newQty === 0) {
        delete selectedPrecon.cards[card.id];
      } else {
        selectedPrecon.cards[card.id] = newQty;
      }
      AppState.selectedPreconId = selectedPrecon.id;
      Dom.preconEditStatus.textContent =
        `Updated "${card.name}" quantity to ${newQty} in "${selectedPrecon.name || selectedPrecon.id}".`;
      Dom.preconEditStatus.className = "status small-note ok";
      renderPreconList();
      Dom.preconCardSearchInput.value = "";
    }

    function handleSingleSave() {
      const card = collectSingleCardFromInputs(false);
      if (!card.name || !card.type || !card.setName) {
        Dom.singleStatus.textContent =
          "Name, Type, and Set Name are required to save.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }

      const key = normalizeNameTypeSet(card);
      let existing = null;
      let existingIndex = -1;
      for (let i = 0; i < AppState.cards.length; i++) {
        const c = AppState.cards[i];
        if (normalizeNameTypeSet(c) === key) {
          existing = c;
          existingIndex = i;
          break;
        }
      }

      if (existing) {
        card.id = existing.id || card.id;
        AppState.cards[existingIndex] = card;
        AppState.cardsById[card.id] = card;
        Dom.singleStatus.textContent =
          "Updated existing card in library (match by Name+Type+Set).";
        Dom.singleStatus.className = "status small-note ok";
      } else {
        if (!card.id) {
          card.id = "card-" + Math.random().toString(36).slice(2);
        }
        AppState.cards.push(card);
        AppState.cardsById[card.id] = card;
        Dom.singleStatus.textContent = "Added new card to library.";
        Dom.singleStatus.className = "status small-note ok";
      }
      renderSinglePreview();
    }

    function handleSingleDelete() {
      const id = Dom.cardIdInput.value.trim();
      if (!id) {
        Dom.singleStatus.textContent = "No card id to delete.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }
      const idx = AppState.cards.findIndex(c => c.id === id);
      if (idx === -1) {
        Dom.singleStatus.textContent = "Card id not found in library.";
        Dom.singleStatus.className = "status small-note err";
        return;
      }
      if (!confirm("Delete this card from the in-memory library?")) return;
      AppState.cards.splice(idx, 1);
      delete AppState.cardsById[id];
      Dom.singleStatus.textContent = "Card removed from in-memory library.";
      Dom.singleStatus.className = "status small-note ok";
    }

    function handleSingleNew() {
      Dom.cardIdInput.value = "";
      Dom.cardNameInput.value = "";
      Dom.cardTypeInput.value = "";
      Dom.cardSetNameInput.value = "";
      Dom.cardNumberInput.value = "";
      Dom.cardRarityInput.value = "";
      Dom.cardVehicleTypesInput.value = "";
      Dom.cardTagsInput.value = "";
      Dom.cardImageUrlInput.value = "";
      Dom.cardNotesInput.value = "";
      Dom.modBasePartInput.value = "";
      Dom.modL1Input.value = "";
      Dom.modL2Input.value = "";
      Dom.modL3Input.value = "";
      Dom.modL4Input.value = "";
      Dom.vehicleHpConInput.value = "";
      Dom.extraJsonInput.value = "";
      Dom.singleStatus.textContent = "";
      renderSinglePreview();
    }

    function downloadJson(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json"
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function initNav() {
      Dom.navSingleBtn.addEventListener("click", () => showSection("single"));
      Dom.navBulkBtn.addEventListener("click", () => showSection("bulk"));
      Dom.navPreconsBtn.addEventListener("click", () => showSection("precons"));
      Dom.navHelpBtn.addEventListener("click", () => showSection("help"));
    }

    function initSingleEditor() {
      [
        Dom.cardIdInput,
        Dom.cardNameInput,
        Dom.cardTypeInput,
        Dom.cardSetNameInput,
        Dom.cardNumberInput,
        Dom.cardRarityInput,
        Dom.cardVehicleTypesInput,
        Dom.cardTagsInput,
        Dom.cardImageUrlInput,
        Dom.cardNotesInput,
        Dom.modBasePartInput,
        Dom.modL1Input,
        Dom.modL2Input,
        Dom.modL3Input,
        Dom.modL4Input,
        Dom.vehicleHpConInput,
        Dom.extraJsonInput
      ].forEach(el => {
        el.addEventListener("input", renderSinglePreview);
        el.addEventListener("change", renderSinglePreview);
      });

      Dom.singleSaveBtn.addEventListener("click", handleSingleSave);
      Dom.singleDeleteBtn.addEventListener("click", handleSingleDelete);
      Dom.singleNewBtn.addEventListener("click", handleSingleNew);
    }

    function initBulk() {
      Dom.bulkFileInput.addEventListener("change", Bulk.handleFileChange);
      Dom.bulkParseSheetBtn.addEventListener("click", () => Bulk.parseSheet());
      Dom.bulkSearchInput.addEventListener("input", () => {
        bulkFilterSearch = Dom.bulkSearchInput.value;
        Bulk.renderGrid();
      });
      Dom.bulkTypeFilter.addEventListener("change", () => {
        bulkFilterType = Dom.bulkTypeFilter.value;
        Bulk.renderGrid();
      });
      Dom.bulkSetFilter.addEventListener("change", () => {
        bulkFilterSet = Dom.bulkSetFilter.value;
        Bulk.renderGrid();
      });
      Dom.bulkApplyBtn.addEventListener("click", () => Bulk.applyToLibrary());
      Dom.downloadCardsJsonBtn.addEventListener("click", () => {
        downloadJson("drive-card.json", AppState.cards.map(cardToJson));
      });
    }

    function initPrecons() {
      Dom.preconNewBtn.addEventListener("click", () => {
        const id = prompt("New precon id (e.g., starter-set1-speed):");
        if (!id) return;
        const name = prompt("Precon name:", "");
        const precon = { id: id.trim(), name: name || id.trim(), notes: "", cards: {} };
        AppState.precons.push(precon);
        AppState.selectedPreconId = precon.id;
        fillPreconEditor(precon);
        renderPreconList();
      });

      Dom.preconDeleteBtn.addEventListener("click", () => {
        if (!AppState.selectedPreconId) {
          alert("No precon selected.");
          return;
        }
        if (!confirm("Delete this precon from the in-memory list?")) return;
        AppState.precons = AppState.precons.filter(p => p.id !== AppState.selectedPreconId);
        AppState.selectedPreconId = null;
        Dom.preconIdInput.value = "";
        Dom.preconNameInput.value = "";
        Dom.preconNotesInput.value = "";
        Dom.preconCardList.innerHTML = "<p class='small-note'>No precon selected.</p>";
        Dom.preconEditStatus.textContent = "";
        renderPreconList();
      });

      Dom.preconReloadBtn.addEventListener("click", () => {
        loadPrecons();
      });

      Dom.preconSaveBtn.addEventListener("click", () => {
        const precon = collectPreconFromInputs();
        AppState.selectedPreconId = precon.id;
        renderPreconList();
        Dom.preconEditStatus.textContent = "Precon saved in memory. Remember to download drive-precons.json.";
        Dom.preconEditStatus.className = "status small-note ok";
      });

      Dom.preconCardSearchInput.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          handlePreconCardSearch();
        }
      });

      Dom.downloadPreconsJsonBtn.addEventListener("click", () => {
        downloadJson("drive-precons.json", AppState.precons);
      });
    }

    function initModal() {
      Dom.modalCloseBtn.addEventListener("click", closeModal);
      Dom.modalBackdrop.addEventListener("click", e => {
        if (e.target === Dom.modalBackdrop) {
          closeModal();
        }
      });
    }

    (async function init() {
      initNav();
      initSingleEditor();
      initBulk();
      initPrecons();
      initModal();

      await loadCards();
      renderSinglePreview();
      await loadPrecons();

      showSection("single");
    })();
  </script>
</body>
</html>
