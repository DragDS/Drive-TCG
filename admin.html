<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE Card Library Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.7rem;
    }
    header small {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    header button {
      margin-left: auto;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 2.2fr);
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    textarea {
      min-height: 4rem;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.45rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
      transition: background 0.1s ease, transform 0.05s ease,
        box-shadow 0.1s ease;
    }
    button:hover {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button.danger:hover {
      background: #7f1d1d;
    }
    button.secondary {
      background: #020617;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }

    .field-group {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
    }
    @media (max-width: 700px) {
      .field-group {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .field {
      margin-bottom: 0.4rem;
    }
    .field label {
      display: block;
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.15rem;
    }

    .small-note {
      font-size: 0.76rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .card-list {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      overflow: hidden;
      max-height: calc(100vh - 210px);
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 900px) {
      .card-list {
        max-height: 400px;
      }
    }
    .card-list-header,
    .card-list-row {
      display: grid;
      grid-template-columns: minmax(0,1.9fr) minmax(0,1fr) minmax(0,1fr) minmax(0,0.6fr);
      gap: 0.25rem;
      font-size: 0.78rem;
      padding: 0.25rem 0.4rem;
      align-items: center;
    }
    .card-list-header {
      background: #020617;
      border-bottom: 1px solid #1f2937;
      font-weight: 600;
      color: #9ca3af;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .card-list-body {
      overflow-y: auto;
      flex: 1;
    }
    .card-list-row {
      cursor: pointer;
    }
    .card-list-row:nth-child(odd) {
      background: rgba(15, 23, 42, 0.6);
    }
    .card-list-row:nth-child(even) {
      background: rgba(15, 23, 42, 0.3);
    }
    .card-list-row:hover {
      background: rgba(34, 197, 94, 0.15);
    }
    .card-list-row.active {
      outline: 1px solid #22c55e;
      background: rgba(34, 197, 94, 0.2);
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 0.05rem 0.4rem;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .tag-input {
      font-size: 0.8rem;
    }

    .vehicle-types-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.8rem;
    }
    .vehicle-types-group label {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      margin: 0;
      cursor: pointer;
    }
    .vehicle-types-group input[type="checkbox"],
    .vehicle-types-group input[type="radio"] {
      accent-color: #22c55e;
    }

    .mod-levels {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.4rem;
    }

    .image-preview {
      margin-top: 0.4rem;
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.4rem;
      text-align: center;
    }
    .image-preview img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE Card Library â€“ Admin</h1>
        <small>Manage cards, edit fields, and export drive-card.json for the public site.</small>
      </div>
      <button id="exportJsonBtn">Export JSON (drive-card.json)</button>
    </header>

    <div class="layout">
      <!-- LEFT: Card list -->
      <section class="panel">
        <h2>Card Library</h2>
        <div class="toolbar">
          <input id="searchListInput" type="text" placeholder="Search by name, type, set, card #" />
          <button id="newCardBtn" type="button">+ New Card</button>
          <small id="countLabel"></small>
        </div>
        <div class="card-list">
          <div class="card-list-header">
            <div>Name</div>
            <div>Type</div>
            <div>Set</div>
            <div>#</div>
          </div>
          <div id="cardListBody" class="card-list-body"></div>
        </div>
      </section>

      <!-- RIGHT: Card editor -->
      <section class="panel">
        <h2 id="editorTitle">New Card</h2>
        <div class="toolbar">
          <button id="saveCardBtn" type="button">ðŸ’¾ Save Card</button>
          <button id="deleteCardBtn" class="danger" type="button">ðŸ—‘ Delete</button>
          <button id="duplicateCardBtn" class="secondary" type="button">ðŸ“„ Duplicate</button>
        </div>

        <div class="field">
          <label for="cardNameInput">Card Name</label>
          <input id="cardNameInput" type="text" placeholder="e.g. Pops, Junkyard Dog" />
        </div>

        <div class="field-group">
          <div class="field">
            <label for="cardTypeSelect">Card Type</label>
            <select id="cardTypeSelect">
              <option value="">Select typeâ€¦</option>
              <option value="Crew">Crew</option>
              <option value="Driver">Driver</option>
              <option value="Named Driver">Named Driver</option>
              <option value="Vehicle">Vehicle</option>
              <option value="Named Vehicle">Named Vehicle</option>
              <option value="Mod">Mod</option>
              <option value="Track">Track</option>
              <option value="Condition">Condition</option>
            </select>
          </div>
          <div class="field">
            <label for="rarityInput">Rarity</label>
            <input id="rarityInput" type="text" placeholder="e.g. Common, Rare" />
          </div>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="setNameInput">Set Name</label>
            <input id="setNameInput" type="text" placeholder="e.g. Set 1, Junkyard Mini Set" />
          </div>
          <div class="field">
            <label for="cardNumberInput">Card Number</label>
            <input id="cardNumberInput" type="text" placeholder="e.g. 001" />
          </div>
        </div>

        <div class="field">
          <label for="tagsInput">Tags (comma separated)</label>
          <input id="tagsInput" type="text" class="tag-input" placeholder="e.g. junkyard, drag, starter" />
        </div>

        <div class="field">
          <label for="rulesTextInput">Rules Text</label>
          <textarea id="rulesTextInput" placeholder="Card rules / effects text"></textarea>
        </div>

        <!-- Type-specific sections -->
        <div id="driverSection" style="display:none; margin-top:0.4rem;">
          <div class="field">
            <label>Vehicle Types (Driver / Named Driver / Track)</label>
            <div class="vehicle-types-group">
              <label><input type="checkbox" class="vehTypeMulti" value="Drag" /> Drag</label>
              <label><input type="checkbox" class="vehTypeMulti" value="Drift" /> Drift</label>
              <label><input type="checkbox" class="vehTypeMulti" value="Off-Road" /> Off-Road</label>
              <label><input type="checkbox" class="vehTypeMulti" value="Rally" /> Rally</label>
            </div>
            <div class="small-note">Drivers, Named Drivers, and Tracks can work with multiple vehicle types.</div>
          </div>
        </div>

        <div id="vehicleSection" style="display:none; margin-top:0.4rem;">
          <div class="field">
            <label>Vehicle Type</label>
            <div class="vehicle-types-group">
              <label><input type="radio" name="vehicleTypeSingle" value="Drag" /> Drag</label>
              <label><input type="radio" name="vehicleTypeSingle" value="Drift" /> Drift</label>
              <label><input type="radio" name="vehicleTypeSingle" value="Off-Road" /> Off-Road</label>
              <label><input type="radio" name="vehicleTypeSingle" value="Rally" /> Rally</label>
            </div>
          </div>
          <div class="field-group">
            <div class="field">
              <label for="hpInput">HP</label>
              <input id="hpInput" type="number" min="0" placeholder="e.g. 8" />
            </div>
            <div class="field">
              <label for="conInput">CON</label>
              <input id="conInput" type="number" min="0" placeholder="e.g. 2" />
            </div>
          </div>
          <div class="small-note">Vehicle and Named Vehicle cards use a single type plus HP/CON.</div>
        </div>

        <div id="modSection" style="display:none; margin-top:0.4rem;">
          <div class="field">
            <label for="modBasePartInput">Base Part</label>
            <input id="modBasePartInput" type="text" placeholder="e.g. Engine, Headers, Tires" />
          </div>
          <div class="mod-levels">
            <div class="field">
              <label for="modLevel1Input">Level 1</label>
              <input id="modLevel1Input" type="text" placeholder="e.g. 1/2" />
            </div>
            <div class="field">
              <label for="modLevel2Input">Level 2</label>
              <input id="modLevel2Input" type="text" placeholder="e.g. 2/2" />
            </div>
            <div class="field">
              <label for="modLevel3Input">Level 3</label>
              <input id="modLevel3Input" type="text" placeholder="e.g. 3/3" />
            </div>
            <div class="field">
              <label for="modLevel4Input">Level 4</label>
              <input id="modLevel4Input" type="text" placeholder="e.g. 5/3 or â€”" />
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:0.6rem;">
          <label for="imageInput">Card Image (PNG/JPEG)</label>
          <input id="imageInput" type="file" accept="image/*" />
          <div class="image-preview" id="imagePreview">
            <small>No image loaded yet.</small>
          </div>
        </div>

        <div class="small-note">
          Images are stored as data URLs (base64) in drive-card.json. The public site and deck builder already use <code>imageData</code>.
        </div>
      </section>
    </div>
  </div>

  <script>
    let cards = [];
    let selectedIndex = -1;
    let currentImageData = "";

    const searchListInput = document.getElementById("searchListInput");
    const cardListBody = document.getElementById("cardListBody");
    const countLabel = document.getElementById("countLabel");

    const newCardBtn = document.getElementById("newCardBtn");
    const saveCardBtn = document.getElementById("saveCardBtn");
    const deleteCardBtn = document.getElementById("deleteCardBtn");
    const duplicateCardBtn = document.getElementById("duplicateCardBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const editorTitle = document.getElementById("editorTitle");

    const cardNameInput = document.getElementById("cardNameInput");
    const cardTypeSelect = document.getElementById("cardTypeSelect");
    const rarityInput = document.getElementById("rarityInput");
    const setNameInput = document.getElementById("setNameInput");
    const cardNumberInput = document.getElementById("cardNumberInput");
    const tagsInput = document.getElementById("tagsInput");
    const rulesTextInput = document.getElementById("rulesTextInput");

    const driverSection = document.getElementById("driverSection");
    const vehicleSection = document.getElementById("vehicleSection");
    const modSection = document.getElementById("modSection");

    const vehTypeMultiInputs = Array.from(document.querySelectorAll(".vehTypeMulti"));
    const hpInput = document.getElementById("hpInput");
    const conInput = document.getElementById("conInput");

    const modBasePartInput = document.getElementById("modBasePartInput");
    const modLevel1Input = document.getElementById("modLevel1Input");
    const modLevel2Input = document.getElementById("modLevel2Input");
    const modLevel3Input = document.getElementById("modLevel3Input");
    const modLevel4Input = document.getElementById("modLevel4Input");

    const imageInput = document.getElementById("imageInput");
    const imagePreview = document.getElementById("imagePreview");

    async function loadExistingJson() {
      try {
        const res = await fetch("drive-card.json", { cache: "no-store" });
        if (!res.ok) {
          cards = [];
          return;
        }
        const json = await res.json();
        if (Array.isArray(json)) {
          cards = json;
        } else {
          cards = [];
        }
      } catch (e) {
        console.warn("Unable to load drive-card.json; starting with empty library.");
        cards = [];
      }
    }

    function renderCardList() {
      const q = searchListInput.value.trim().toLowerCase();
      let filtered = cards.map((c, idx) => ({ card: c, index: idx }));

      if (q) {
        filtered = filtered.filter(({ card }) => {
          const text =
            (card.name || "") + " " +
            (card.type || "") + " " +
            (card.setName || "") + " " +
            (card.cardNumber || "");
          return text.toLowerCase().includes(q);
        });
      }

      countLabel.textContent = `${filtered.length} cards shown / ${cards.length} total`;

      cardListBody.innerHTML = "";
      filtered.forEach(({ card, index }) => {
        const row = document.createElement("div");
        row.className = "card-list-row" + (index === selectedIndex ? " active" : "");
        row.dataset.index = index;

        const nameDiv = document.createElement("div");
        nameDiv.textContent = card.name || "(No Name)";

        const typeDiv = document.createElement("div");
        typeDiv.textContent = card.type || "";

        const setDiv = document.createElement("div");
        setDiv.textContent = card.setName || "";

        const numDiv = document.createElement("div");
        numDiv.textContent = card.cardNumber || "";

        row.appendChild(nameDiv);
        row.appendChild(typeDiv);
        row.appendChild(setDiv);
        row.appendChild(numDiv);

        row.addEventListener("click", () => {
          selectedIndex = index;
          loadCardIntoForm(cards[index]);
          renderCardList();
        });

        cardListBody.appendChild(row);
      });
    }

    function setTypeSectionsVisibility(type) {
      driverSection.style.display = "none";
      vehicleSection.style.display = "none";
      modSection.style.display = "none";

      if (type === "Driver" || type === "Named Driver" || type === "Track") {
        driverSection.style.display = "block";
      }
      if (type === "Vehicle" || type === "Named Vehicle") {
        vehicleSection.style.display = "block";
      }
      if (type === "Mod") {
        modSection.style.display = "block";
      }
    }

    function clearForm() {
      editorTitle.textContent = "New Card";
      selectedIndex = -1;

      cardNameInput.value = "";
      cardTypeSelect.value = "";
      rarityInput.value = "";
      setNameInput.value = "";
      cardNumberInput.value = "";
      tagsInput.value = "";
      rulesTextInput.value = "";

      vehTypeMultiInputs.forEach(el => el.checked = false);
      const vehTypeSingle = document.querySelectorAll("input[name='vehicleTypeSingle']");
      vehTypeSingle.forEach(el => el.checked = false);
      hpInput.value = "";
      conInput.value = "";

      modBasePartInput.value = "";
      modLevel1Input.value = "";
      modLevel2Input.value = "";
      modLevel3Input.value = "";
      modLevel4Input.value = "";

      currentImageData = "";
      imagePreview.innerHTML = "<small>No image loaded yet.</small>";

      setTypeSectionsVisibility("");
    }

    function loadCardIntoForm(card) {
      editorTitle.textContent = `Edit Card: ${card.name || ""}`;
      cardNameInput.value = card.name || "";
      cardTypeSelect.value = card.type || "";
      rarityInput.value = card.rarity || "";
      setNameInput.value = card.setName || "";
      cardNumberInput.value = card.cardNumber || "";
      tagsInput.value = (card.tags || []).join(", ");
      rulesTextInput.value = card.notes || "";

      const extra = card.extra || {};
      setTypeSectionsVisibility(card.type || "");

      vehTypeMultiInputs.forEach(el => el.checked = false);
      const vehTypeSingle = document.querySelectorAll("input[name='vehicleTypeSingle']");
      vehTypeSingle.forEach(el => el.checked = false);
      hpInput.value = "";
      conInput.value = "";

      modBasePartInput.value = "";
      modLevel1Input.value = "";
      modLevel2Input.value = "";
      modLevel3Input.value = "";
      modLevel4Input.value = "";

      if ((card.type === "Driver" || card.type === "Named Driver" || card.type === "Track") &&
          Array.isArray(extra.vehicleTypes)) {
        vehTypeMultiInputs.forEach(el => {
          if (extra.vehicleTypes.includes(el.value)) {
            el.checked = true;
          }
        });
      }

      if (card.type === "Vehicle" || card.type === "Named Vehicle") {
        if (extra.vehicleType) {
          const match = document.querySelector(
            "input[name='vehicleTypeSingle'][value='" + extra.vehicleType + "']"
          );
          if (match) match.checked = true;
        }
        if (extra.hp != null) hpInput.value = extra.hp;
        if (extra.con != null) conInput.value = extra.con;
      }

      if (card.type === "Mod") {
        modBasePartInput.value = extra.modBasePart || "";
        modLevel1Input.value = extra.modLevel1 || "";
        modLevel2Input.value = extra.modLevel2 || "";
        modLevel3Input.value = extra.modLevel3 || "";
        modLevel4Input.value = extra.modLevel4 || "";
      }

      currentImageData = card.imageData || "";
      if (currentImageData) {
        imagePreview.innerHTML = `<img src="${currentImageData}" alt="Card image" />`;
      } else {
        imagePreview.innerHTML = "<small>No image loaded yet.</small>";
      }
    }

    function buildCardFromForm(existingCard) {
      const name = cardNameInput.value.trim();
      const type = cardTypeSelect.value;
      const rarity = rarityInput.value.trim();
      const setName = setNameInput.value.trim();
      const cardNumber = cardNumberInput.value.trim();
      const tags = tagsInput.value
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
      const notes = rulesTextInput.value.trim();

      if (!name) {
        alert("Card Name is required.");
        return null;
      }
      if (!type) {
        alert("Card Type is required.");
        return null;
      }

      let extra = {};
      if (type === "Driver" || type === "Named Driver" || type === "Track") {
        const selectedTypes = vehTypeMultiInputs
          .filter(el => el.checked)
          .map(el => el.value);
        if (selectedTypes.length) {
          extra.vehicleTypes = selectedTypes;
        }
      }

      if (type === "Vehicle" || type === "Named Vehicle") {
        const vehTypeSingle = document.querySelector("input[name='vehicleTypeSingle']:checked");
        if (vehTypeSingle) {
          extra.vehicleType = vehTypeSingle.value;
        }
        if (hpInput.value !== "") extra.hp = parseInt(hpInput.value, 10);
        if (conInput.value !== "") extra.con = parseInt(conInput.value, 10);
      }

      if (type === "Mod") {
        extra.modBasePart = modBasePartInput.value.trim();
        extra.modLevel1 = modLevel1Input.value.trim();
        extra.modLevel2 = modLevel2Input.value.trim();
        extra.modLevel3 = modLevel3Input.value.trim();
        extra.modLevel4 = modLevel4Input.value.trim();
      }

      const card = existingCard ? { ...existingCard } : {};

      if (!card.id) {
        card.id = "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
      }

      card.name = name;
      card.type = type;
      card.rarity = rarity;
      card.setName = setName;
      card.cardNumber = cardNumber;
      card.tags = tags;
      card.notes = notes;
      card.extra = extra;

      card.imageData = currentImageData || card.imageData || "";

      return card;
    }

    function exportJson() {
      const blob = new Blob([JSON.stringify(cards, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "drive-card.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        currentImageData = e.target.result;
        imagePreview.innerHTML = `<img src="${currentImageData}" alt="Card image" />`;
      };
      reader.readAsDataURL(file);
    });

    cardTypeSelect.addEventListener("change", () => {
      setTypeSectionsVisibility(cardTypeSelect.value);
    });

    newCardBtn.addEventListener("click", () => {
      clearForm();
      renderCardList();
    });

    saveCardBtn.addEventListener("click", () => {
      const existing = selectedIndex >= 0 ? cards[selectedIndex] : null;
      const card = buildCardFromForm(existing);
      if (!card) return;

      if (selectedIndex >= 0) {
        cards[selectedIndex] = card;
      } else {
        cards.push(card);
        selectedIndex = cards.length - 1;
      }

      renderCardList();
      loadCardIntoForm(card);
      alert("Card saved.");
    });

    deleteCardBtn.addEventListener("click", () => {
      if (selectedIndex < 0) {
        alert("No card selected.");
        return;
      }
      const card = cards[selectedIndex];
      if (!confirm(`Delete card "${card.name}"? This cannot be undone.`)) return;
      cards.splice(selectedIndex, 1);
      clearForm();
      renderCardList();
    });

    duplicateCardBtn.addEventListener("click", () => {
      if (selectedIndex < 0) {
        alert("Select a card to duplicate.");
        return;
      }
      const original = cards[selectedIndex];
      const copy = { ...original };
      copy.id = "card-" + Date.now() + "-" + Math.floor(Math.random() * 100000);
      copy.name = original.name + " (Copy)";
      cards.push(copy);
      selectedIndex = cards.length - 1;
      renderCardList();
      loadCardIntoForm(copy);
    });

    exportJsonBtn.addEventListener("click", exportJson);
    searchListInput.addEventListener("input", renderCardList);

    (async function init() {
      await loadExistingJson();
      clearForm();
      renderCardList();
    })();
  </script>
</body>
</html>
