<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Card Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header small {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .mode-toggle {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
    }
    .mode-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mode-btn {
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease, box-shadow 0.08s ease;
    }
    .mode-btn:hover {
      background: #030712;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .mode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.1);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
      margin-bottom: 0.75rem;
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }
    .layout-three {
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr) minmax(0, 1.1fr);
      gap: 0.75rem;
    }
    @media (max-width: 1100px) {
      .layout-three {
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      }
    }
    @media (max-width: 900px) {
      .layout-three {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .toolbar input[type="text"],
    .toolbar select {
      padding: 0.3rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .toolbar select {
      min-width: 120px;
    }
    .toolbar .spacer {
      flex: 1;
    }
    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.08s ease, box-shadow 0.08s ease, transform 0.05s ease;
    }
    .button:hover {
      background: #020617;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }
    .button.secondary {
      background: #020617;
    }
    .button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    .button.danger:hover {
      background: #7f1d1d;
    }

    /* Card grid – auto-fit height */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
      max-height: calc(100vh - 260px);
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .card-tile {
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(148,163,184,0.16), #020617);
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .card-tile:hover {
      transform: translateY(-2px);
      border-color: #22c55e;
      box-shadow: 0 12px 28px rgba(0,0,0,0.8);
    }
    .card-image-wrapper {
      aspect-ratio: 3/4;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .card-image-wrapper img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }
    .card-info {
      padding: 0.35rem 0.45rem 0.4rem;
      font-size: 0.78rem;
    }
    .card-title {
      font-weight: 600;
      margin-bottom: 0.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-sub {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
      color: #9ca3af;
      font-size: 0.72rem;
    }
    .card-sub span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.8);
      color: #e5e7eb;
    }

    /* Detail view */
    .detail-layout {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .detail-card {
      display: flex;
      gap: 0.6rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(96,165,250,0.12), #020617);
      box-shadow: 0 10px 24px rgba(0,0,0,0.7);
      padding: 0.6rem;
    }
    .detail-image-wrapper {
      flex: 0 0 40%;
      max-width: 40%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #020617;
      border-radius: 0.6rem;
      overflow: hidden;
    }
    .detail-image-wrapper img {
      max-width: 100%;
      max-height: 320px;
      object-fit: contain;
    }
    .detail-body {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.82rem;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
      align-items: baseline;
    }
    .detail-name {
      font-size: 1rem;
      font-weight: 600;
    }
    .detail-type {
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .detail-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.78rem;
      color: #9ca3af;
    }
    .detail-label {
      font-weight: 600;
      color: #e5e7eb;
    }
    .detail-text {
      border-radius: 0.5rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      padding: 0.4rem 0.5rem;
      white-space: pre-wrap;
      font-size: 0.8rem;
    }
    .detail-actions {
      margin-top: 0.35rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    /* Deck builder */
    .deck-layout {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .deck-header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
    }
    .deck-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
    }
    .deck-tab {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 0.25rem 0.7rem;
      font-size: 0.78rem;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease, box-shadow 0.08s ease;
    }
    .deck-tab.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.12);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }
    .deck-main {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 0.5rem;
    }
    @media (max-width: 700px) {
      .deck-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Deck list – auto-fit */
    .deck-list {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      background: #020617;
      font-size: 0.78rem;
    }
    .deck-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.4rem;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }
    .deck-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .deck-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .deck-row-main {
      flex: 1;
      min-width: 0;
    }
    .deck-row-main strong {
      display: block;
    }
    .deck-row-main span {
      display: block;
      color: #9ca3af;
      font-size: 0.7rem;
    }
    .deck-row-controls {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .deck-row-controls input[type="number"] {
      width: 3rem;
      padding: 0.1rem 0.2rem;
      border-radius: 0.45rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.78rem;
    }
    .deck-stats-box {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.4rem 0.5rem;
      background: radial-gradient(circle at top left, rgba(251,191,36,0.12), #020617);
      font-size: 0.8rem;
    }
    .deck-stats-box h3 {
      margin: 0 0 0.25rem;
      font-size: 0.95rem;
    }
    .deck-issues {
      margin-top: 0.25rem;
      font-size: 0.78rem;
    }
    .deck-issues .ok { color: #4ade80; }
    .deck-issues .warn { color: #facc15; }
    .deck-issues .err { color: #f97373; }

    /* Compare */
    .compare-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 0.5rem;
    }
    @media (max-width: 900px) {
      .compare-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .compare-card {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, rgba(129,140,248,0.12), #020617);
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      min-height: 180px;
    }
    .compare-card header {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
      align-items: baseline;
      margin-bottom: 0.25rem;
    }
    .compare-card h3 {
      margin: 0;
      font-size: 0.9rem;
    }
    .compare-badge {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .compare-body {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 0.4rem;
      font-size: 0.78rem;
    }
    @media (max-width: 700px) {
      .compare-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Compare image – auto-fit */
    .compare-image {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      max-height: calc(100vh - 340px);
    }
    .compare-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .compare-meta {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .compare-section {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }
    .compare-label {
      font-weight: 600;
      color: #e5e7eb;
    }
    .compare-value {
      color: #9ca3af;
    }
    .compare-empty {
      font-size: 0.78rem;
      color: #6b7280;
      font-style: italic;
    }

    /* Full card overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }
    .overlay.open {
      display: flex;
    }
    .overlay-card {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      max-width: 960px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0,0,0,0.9);
    }
    .overlay-header {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .overlay-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .overlay-close-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 0.2rem 0.55rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .overlay-close-btn:hover {
      background: #111827;
    }
    .overlay-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 0.6rem;
    }
    @media (max-width: 900px) {
      .overlay-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .overlay-image {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      max-height: 520px;
    }
    .overlay-image img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .overlay-meta {
      font-size: 0.85rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .overlay-meta-row {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
      font-size: 0.8rem;
    }
    .overlay-meta-label {
      font-weight: 600;
      color: #e5e7eb;
    }
    .overlay-meta-value {
      color: #9ca3af;
    }
    .overlay-rules {
      border-radius: 0.55rem;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 0.4rem 0.5rem;
      background: rgba(15,23,42,0.95);
      white-space: pre-wrap;
      font-size: 0.82rem;
    }
    .overlay-actions {
      margin-top: 0.4rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    /* Precons – auto-fit lists */
    .precon-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 0.6rem;
    }
    @media (max-width: 900px) {
      .precon-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .precon-list {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem;
      font-size: 0.8rem;
    }
    .precon-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }
    .precon-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .precon-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .precon-row-main {
      flex: 1;
      min-width: 0;
    }
    .precon-row-main strong {
      display: block;
    }
    .precon-row-main span {
      display: block;
      color: #9ca3af;
      font-size: 0.72rem;
    }
    .precon-cards {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem;
      font-size: 0.8rem;
    }
    .precon-card-row {
      display: flex;
      justify-content: space-between;
      gap: 0.35rem;
      padding: 0.2rem 0.3rem;
      border-radius: 0.4rem;
    }
    .precon-card-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .precon-card-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Card Library</h1>
        <small>Browse cards, build decks, and view preconstructed decks.</small>
      </div>
    </header>

    <div class="mode-toggle">
      <span class="mode-label">View:</span>
      <button id="modeCardsBtn" class="mode-btn active" type="button">Cards</button>
      <button id="modeDecksBtn" class="mode-btn" type="button">Deck Builder</button>
      <button id="modeCompareBtn" class="mode-btn" type="button">Compare</button>
      <button id="modePreconsBtn" class="mode-btn" type="button">Precons</button>
    </div>

    <!-- CARDS MODE -->
    <div id="cardsModePanel">
      <section class="panel">
        <h2>Card Library</h2>
        <div class="toolbar">
          <input id="searchInput" type="text" placeholder="Search name / rules / set..." />
          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="Crew">Crew</option>
            <option value="Driver">Driver</option>
            <option value="Named Driver">Named Driver</option>
            <option value="Mod">Mod</option>
            <option value="Vehicle">Vehicle</option>
            <option value="Named Vehicle">Named Vehicle</option>
            <option value="Track">Track</option>
            <option value="Condition">Condition</option>
            <option value="Misc">Misc</option>
          </select>
          <select id="setFilter">
            <option value="">All Sets</option>
          </select>
          <select id="rarityFilter">
            <option value="">All Rarities</option>
          </select>
          <select id="vehicleFilter">
            <option value="">All Vehicle Types</option>
            <option value="Drag">Drag</option>
            <option value="Drift">Drift</option>
            <option value="Off-Road">Off-Road</option>
            <option value="Rally">Rally</option>
          </select>
          <span class="spacer"></span>
          <span id="cardCountLabel" class="small-note">0 cards</span>
        </div>
        <div class="layout-three">
          <div>
            <div id="cardGrid" class="card-grid"></div>
          </div>
          <div>
            <h2>Card Details</h2>
            <div id="detailContainer" class="detail-layout">
              <p class="small-note">
                Select a card to view its details, add it to a deck, or send it to the compare view.
              </p>
            </div>
          </div>
          <div>
            <h2>Quick Actions</h2>
            <div class="deck-stats-box">
              <h3>Deck & Compare Shortcuts</h3>
              <p class="small-note">
                From the card details or full view:
                <br />– <strong>Add to Deck</strong>: quickly increase quantity in the active deck.
                <br />– <strong>Add to Compare</strong>: toggle the card in one of the two compare slots.
              </p>
              <p class="small-note">
                Open the full card modal for a large preview and more actions.
              </p>
            </div>
            <button id="openFullCardBtn" class="button secondary" type="button" disabled>
              Open Selected Card in Full View
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- DECK MODE -->
    <div id="decksModePanel" style="display:none;">
      <section class="panel">
        <h2>Deck Builder</h2>
        <div class="deck-layout">
          <div class="deck-header">
            <div class="deck-tabs">
              <button class="deck-tab active" data-deck-index="0" type="button">Deck 1</button>
              <button class="deck-tab" data-deck-index="1" type="button">Deck 2</button>
              <button class="deck-tab" data-deck-index="2" type="button">Deck 3</button>
            </div>
            <input id="deckNameInput" type="text" placeholder="Deck Name" style="flex:1; padding:0.35rem 0.6rem; border-radius:999px; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:0.8rem;" />
            <button id="clearDeckBtn" class="button danger" type="button">Clear Deck</button>
          </div>
          <div class="deck-main">
            <div>
              <div id="deckList" class="deck-list"></div>
            </div>
            <div>
              <div id="deckStats" class="deck-stats-box">
                <h3>Deck Stats</h3>
                <p class="small-note">No cards yet.</p>
              </div>
              <div id="deckLegal" class="deck-issues small-note"></div>
              <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.4rem;">
                <button id="exportDeckJsonBtn" class="button secondary" type="button">Export Deck as JSON</button>
                <button id="exportDeckTextBtn" class="button secondary" type="button">Export Deck as Text</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- COMPARE MODE -->
    <div id="compareModePanel" style="display:none;">
      <section class="panel">
        <h2>Compare Cards</h2>
        <div class="toolbar">
          <select id="compareSelectA">
            <option value="">Select Card A</option>
          </select>
          <button id="clearCompareABtn" class="button secondary" type="button">Clear A</button>
          <select id="compareSelectB">
            <option value="">Select Card B</option>
          </select>
          <button id="clearCompareBBtn" class="button secondary" type="button">Clear B</button>
        </div>
        <div id="compareViewer" class="compare-layout"></div>
      </section>
    </div>

    <!-- PRECONS MODE -->
    <div id="preconsModePanel" style="display:none;">
      <section class="panel">
        <h2>Preconstructed Decks</h2>
        <div class="toolbar">
          <select id="preconSelect">
            <option value="">Select Precon</option>
          </select>
          <button id="refreshPreconsBtn" class="button secondary" type="button">Reload Precons</button>
          <span class="spacer"></span>
          <span id="preconStats" class="small-note"></span>
        </div>
        <div class="precon-layout">
          <div>
            <div id="preconList" class="precon-list"></div>
          </div>
          <div>
            <h3 style="margin-top:0; font-size:0.95rem;">Precon Details</h3>
            <p id="preconDesc" class="small-note">Select a precon to see its contents.</p>
            <div id="preconCards" class="precon-cards"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- FULL CARD OVERLAY -->
  <div id="fullCardOverlay" class="overlay">
    <div class="overlay-card">
      <div class="overlay-header">
        <h2 id="fullCardTitle">Card</h2>
        <button id="closeFullCardBtn" class="overlay-close-btn" type="button">✕</button>
      </div>
      <div class="overlay-body">
        <div class="overlay-image">
          <img id="fullCardImage" src="" alt="Card" />
        </div>
        <div class="overlay-meta">
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Type:</span>
            <span id="fullCardType" class="overlay-meta-value"></span>
          </div>
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Set:</span>
            <span id="fullCardSet" class="overlay-meta-value"></span>
          </div>
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Rarity:</span>
            <span id="fullCardRarity" class="overlay-meta-value"></span>
          </div>
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Vehicle Types:</span>
            <span id="fullCardVehicles" class="overlay-meta-value"></span>
          </div>
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Tags:</span>
            <span id="fullCardTags" class="overlay-meta-value"></span>
          </div>
          <div class="overlay-meta-row">
            <span class="overlay-meta-label">Mod Stats / HP/CON:</span>
            <span id="fullCardStats" class="overlay-meta-value"></span>
          </div>
          <div>
            <span class="overlay-meta-label">Rules Text:</span>
            <div id="fullCardRules" class="overlay-rules"></div>
          </div>
          <div class="overlay-actions">
            <button id="fullAddToDeckBtn" class="button" type="button">Add to Active Deck</button>
            <button id="fullAddToCompareBtn" class="button secondary" type="button">Add/Toggle in Compare</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const AppState = {
      cards: [],
      cardsById: {},
      decks: [
        { name: "Deck 1", cards: {} },
        { name: "Deck 2", cards: {} },
        { name: "Deck 3", cards: {} }
      ],
      activeDeckIndex: 0,
      compareSlots: [null, null],
      precons: []
    };

    const STORAGE_KEYS = { decks: "driveDecks_v1" };

    const Dom = {
      modeCardsBtn: document.getElementById("modeCardsBtn"),
      modeDecksBtn: document.getElementById("modeDecksBtn"),
      modeCompareBtn: document.getElementById("modeCompareBtn"),
      modePreconsBtn: document.getElementById("modePreconsBtn"),
      cardsModePanel: document.getElementById("cardsModePanel"),
      decksModePanel: document.getElementById("decksModePanel"),
      compareModePanel: document.getElementById("compareModePanel"),
      preconsModePanel: document.getElementById("preconsModePanel"),

      searchInput: document.getElementById("searchInput"),
      typeFilter: document.getElementById("typeFilter"),
      setFilter: document.getElementById("setFilter"),
      rarityFilter: document.getElementById("rarityFilter"),
      vehicleFilter: document.getElementById("vehicleFilter"),
      cardGrid: document.getElementById("cardGrid"),
      cardCountLabel: document.getElementById("cardCountLabel"),
      detailContainer: document.getElementById("detailContainer"),
      openFullCardBtn: document.getElementById("openFullCardBtn"),

      deckTabs: document.querySelectorAll(".deck-tab"),
      deckNameInput: document.getElementById("deckNameInput"),
      deckList: document.getElementById("deckList"),
      deckStats: document.getElementById("deckStats"),
      deckLegal: document.getElementById("deckLegal"),
      clearDeckBtn: document.getElementById("clearDeckBtn"),
      exportDeckJsonBtn: document.getElementById("exportDeckJsonBtn"),
      exportDeckTextBtn: document.getElementById("exportDeckTextBtn"),

      fullCardOverlay: document.getElementById("fullCardOverlay"),
      fullCardTitle: document.getElementById("fullCardTitle"),
      fullCardImage: document.getElementById("fullCardImage"),
      fullCardType: document.getElementById("fullCardType"),
      fullCardSet: document.getElementById("fullCardSet"),
      fullCardRarity: document.getElementById("fullCardRarity"),
      fullCardVehicles: document.getElementById("fullCardVehicles"),
      fullCardTags: document.getElementById("fullCardTags"),
      fullCardStats: document.getElementById("fullCardStats"),
      fullCardRules: document.getElementById("fullCardRules"),
      fullAddToDeckBtn: document.getElementById("fullAddToDeckBtn"),
      fullAddToCompareBtn: document.getElementById("fullAddToCompareBtn"),
      closeFullCardBtn: document.getElementById("closeFullCardBtn"),

      compareSelectA: document.getElementById("compareSelectA"),
      compareSelectB: document.getElementById("compareSelectB"),
      clearCompareABtn: document.getElementById("clearCompareABtn"),
      clearCompareBBtn: document.getElementById("clearCompareBBtn"),
      compareViewer: document.getElementById("compareViewer"),

      preconSelect: document.getElementById("preconSelect"),
      refreshPreconsBtn: document.getElementById("refreshPreconsBtn"),
      preconDesc: document.getElementById("preconDesc"),
      preconStats: document.getElementById("preconStats"),
      preconList: document.getElementById("preconList"),
      preconCards: document.getElementById("preconCards")
    };

    let selectedCardId = null;

    const CardData = {
      async load() {
        try {
          const res = await fetch("drive-card.json");
          if (!res.ok) {
            AppState.cards = [];
            AppState.cardsById = {};
            return;
          }
          const json = await res.json();
          AppState.cards = Array.isArray(json) ? json : [];
        } catch (e) {
          console.error("Failed to load drive-card.json", e);
          AppState.cards = [];
        }

        AppState.cardsById = {};
        AppState.cards.forEach(c => {
          if (!c.id) c.id = "card-" + Math.random().toString(36).slice(2);
          if (!c.extra) c.extra = {};
          if (!Array.isArray(c.tags)) c.tags = [];
          if (typeof c.imageUrl !== "string") c.imageUrl = "";
          AppState.cardsById[c.id] = c;
        });
      },
      getCardById(id) {
        return AppState.cardsById[id] || null;
      },
      getVehicleTypes(card) {
        if (!card) return [];
        if (card.extra && Array.isArray(card.extra.vehicleTypes) && card.extra.vehicleTypes.length) {
          return card.extra.vehicleTypes;
        }
        if (card.extra && typeof card.extra.vehicleType === "string" && card.extra.vehicleType.trim()) {
          return [card.extra.vehicleType.trim()];
        }
        return [];
      },
      getModStats(card) {
        if (!card || card.type !== "Mod") return "";
        const e = card.extra || {};
        const parts = [];
        if (e.modBasePart) parts.push(`Base: ${e.modBasePart}`);
        const levels = [];
        if (e.modLevel1) levels.push(`L1 ${e.modLevel1}`);
        if (e.modLevel2) levels.push(`L2 ${e.modLevel2}`);
        if (e.modLevel3) levels.push(`L3 ${e.modLevel3}`);
        if (e.modLevel4) levels.push(`L4 ${e.modLevel4}`);
        if (levels.length) parts.push(levels.join(" · "));
        return parts.join(" | ");
      },
      getVehicleStats(card) {
        if (!card || (card.type !== "Vehicle" && card.type !== "Named Vehicle")) return "";
        const e = card.extra || {};
        const bits = [];
        if (typeof e.hp === "number") bits.push(`HP: ${e.hp}`);
        if (typeof e.con === "number") bits.push(`CON: ${e.con}`);
        return bits.join(" · ");
      }
    };

    const Mode = {
      setMode(mode) {
        Dom.cardsModePanel.style.display = mode === "cards" ? "" : "none";
        Dom.decksModePanel.style.display = mode === "decks" ? "" : "none";
        Dom.compareModePanel.style.display = mode === "compare" ? "" : "none";
        Dom.preconsModePanel.style.display = mode === "precons" ? "" : "none";

        Dom.modeCardsBtn.classList.toggle("active", mode === "cards");
        Dom.modeDecksBtn.classList.toggle("active", mode === "decks");
        Dom.modeCompareBtn.classList.toggle("active", mode === "compare");
        Dom.modePreconsBtn.classList.toggle("active", mode === "precons");
      },
      init() {
        Dom.modeCardsBtn.addEventListener("click", () => Mode.setMode("cards"));
        Dom.modeDecksBtn.addEventListener("click", () => Mode.setMode("decks"));
        Dom.modeCompareBtn.addEventListener("click", () => Mode.setMode("compare"));
        Dom.modePreconsBtn.addEventListener("click", () => Mode.setMode("precons"));
      }
    };

    const CardGrid = {
      buildFilterOptions() {
        const sets = new Set();
        const rarities = new Set();
        AppState.cards.forEach(card => {
          if (card.setName) sets.add(card.setName);
          if (card.rarity) rarities.add(card.rarity);
        });
        Dom.setFilter.innerHTML = '<option value="">All Sets</option>';
        Array.from(sets).sort().forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          Dom.setFilter.appendChild(opt);
        });
        Dom.rarityFilter.innerHTML = '<option value="">All Rarities</option>';
        Array.from(rarities).sort().forEach(r => {
          const opt = document.createElement("option");
          opt.value = r;
          opt.textContent = r;
          Dom.rarityFilter.appendChild(opt);
        });
      },
      getFilteredCards() {
        const q = Dom.searchInput.value.trim().toLowerCase();
        const type = Dom.typeFilter.value;
        const setName = Dom.setFilter.value;
        const rarity = Dom.rarityFilter.value;
        const vehType = Dom.vehicleFilter.value;

        return AppState.cards.filter(card => {
          if (type && card.type !== type) return false;
          if (setName && card.setName !== setName) return false;
          if (rarity && card.rarity !== rarity) return false;
          if (vehType) {
            const vt = CardData.getVehicleTypes(card);
            if (!vt.includes(vehType)) return false;
          }
          if (q) {
            const haystack = [
              card.name || "",
              card.type || "",
              card.setName || "",
              card.rarity || "",
              card.notes || ""
            ].join(" ").toLowerCase();
            if (!haystack.includes(q)) return false;
          }
          return true;
        });
      },
      renderGrid() {
        const cards = CardGrid.getFilteredCards();
        Dom.cardGrid.innerHTML = "";
        Dom.cardCountLabel.textContent = `${cards.length} card${cards.length === 1 ? "" : "s"} found`;

        if (!cards.length) {
          Dom.cardGrid.innerHTML = "<p class='small-note'>No cards match the current filters.</p>";
          return;
        }

        cards
          .slice()
          .sort((a,b) => {
            const typeCmp = (a.type || "").localeCompare(b.type || "");
            if (typeCmp !== 0) return typeCmp;
            const setCmp = (a.setName || "").localeCompare(b.setName || "");
            if (setCmp !== 0) return setCmp;
            const numCmp = (a.cardNumber || "").localeCompare(b.cardNumber || "");
            if (numCmp !== 0) return numCmp;
            return (a.name || "").localeCompare(b.name || "");
          })
          .forEach(card => {
            const tile = document.createElement("div");
            tile.className = "card-tile";

            const imgWrap = document.createElement("div");
            imgWrap.className = "card-image-wrapper";
            const img = document.createElement("img");
            img.src = card.imageUrl || "";
            img.alt = card.name || "Card";
            imgWrap.appendChild(img);

            const info = document.createElement("div");
            info.className = "card-info";
            const title = document.createElement("div");
            title.className = "card-title";
            title.textContent = card.name || "(No Name)";
            const sub = document.createElement("div");
            sub.className = "card-sub";
            const left = document.createElement("span");
            left.textContent = card.type || "";
            const right = document.createElement("span");
            right.textContent = (card.setName || "") + (card.cardNumber ? ` #${card.cardNumber}` : "");
            sub.appendChild(left);
            sub.appendChild(right);
            info.appendChild(title);
            info.appendChild(sub);

            tile.appendChild(imgWrap);
            tile.appendChild(info);

            tile.addEventListener("click", () => {
              selectedCardId = card.id;
              DetailPanel.render(card.id);
              Dom.openFullCardBtn.disabled = false;
            });

            Dom.cardGrid.appendChild(tile);
          });
      },
      init() {
        ["input", "change"].forEach(evt => {
          Dom.searchInput.addEventListener(evt, () => CardGrid.renderGrid());
          Dom.typeFilter.addEventListener(evt, () => CardGrid.renderGrid());
          Dom.setFilter.addEventListener(evt, () => CardGrid.renderGrid());
          Dom.rarityFilter.addEventListener(evt, () => CardGrid.renderGrid());
          Dom.vehicleFilter.addEventListener(evt, () => CardGrid.renderGrid());
        });
      }
    };

    const DetailPanel = {
      render(cardId) {
        const card = CardData.getCardById(cardId);
        Dom.detailContainer.innerHTML = "";
        if (!card) {
          Dom.detailContainer.innerHTML = "<p class='small-note'>No card selected.</p>";
          return;
        }

        const wrapper = document.createElement("div");
        wrapper.className = "detail-card";

        const imgWrap = document.createElement("div");
        imgWrap.className = "detail-image-wrapper";
        const img = document.createElement("img");
        img.src = card.imageUrl || "";
        img.alt = card.name || "Card";
        imgWrap.appendChild(img);

        const body = document.createElement("div");
        body.className = "detail-body";

        const header = document.createElement("div");
        header.className = "detail-header";

        const nameEl = document.createElement("div");
        nameEl.className = "detail-name";
        nameEl.textContent = card.name || "(No Name)";

        const typeEl = document.createElement("div");
        typeEl.className = "detail-type";
        typeEl.textContent = card.type || "";

        header.appendChild(nameEl);
        header.appendChild(typeEl);

        const row1 = document.createElement("div");
        row1.className = "detail-row";
        row1.innerHTML =
          `<span class="detail-label">Set:</span> <span>${card.setName || ""}</span>` +
          ` · <span class="detail-label">Rarity:</span> <span>${card.rarity || ""}</span>` +
          (card.cardNumber ? ` · <span class="detail-label">Card #:</span> <span>${card.cardNumber}</span>` : "");

        const row2 = document.createElement("div");
        row2.className = "detail-row";
        const vt = CardData.getVehicleTypes(card);
        const tags = card.tags || [];
        row2.innerHTML =
          `<span class="detail-label">Vehicle Types:</span> <span>${vt.length ? vt.join(", ") : "—"}</span>` +
          ` · <span class="detail-label">Tags:</span> <span>${tags.length ? tags.join(", ") : "—"}</span>`;

        const row3 = document.createElement("div");
        row3.className = "detail-row";
        const modStats = CardData.getModStats(card);
        const vehStats = CardData.getVehicleStats(card);
        const statPieces = [];
        if (modStats) statPieces.push(modStats);
        if (vehStats) statPieces.push(vehStats);
        row3.innerHTML =
          `<span class="detail-label">Stats:</span> <span>${statPieces.length ? statPieces.join(" | ") : "—"}</span>`;

        const rulesBox = document.createElement("div");
        rulesBox.className = "detail-text";
        rulesBox.textContent = card.notes || "";

        const actions = document.createElement("div");
        actions.className = "detail-actions";

        const addToDeckBtn = document.createElement("button");
        addToDeckBtn.type = "button";
        addToDeckBtn.className = "button";
        addToDeckBtn.textContent = "Add to Active Deck";
        addToDeckBtn.addEventListener("click", () => {
          DeckManager.addCard(card.id, 1);
        });

        const addToCompareBtn = document.createElement("button");
        addToCompareBtn.type = "button";
        addToCompareBtn.className = "button secondary";
        addToCompareBtn.textContent = "Add/Toggle in Compare";
        addToCompareBtn.addEventListener("click", () => {
          CompareModule.addCardToCompare(card.id);
        });

        const openFullBtn = document.createElement("button");
        openFullBtn.type = "button";
        openFullBtn.className = "button secondary";
        openFullBtn.textContent = "Open Full Card View";
        openFullBtn.addEventListener("click", () => {
          FullCardModal.open(card.id);
        });

        actions.appendChild(addToDeckBtn);
        actions.appendChild(addToCompareBtn);
        actions.appendChild(openFullBtn);

        body.appendChild(header);
        body.appendChild(row1);
        body.appendChild(row2);
        body.appendChild(row3);
        body.appendChild(rulesBox);
        body.appendChild(actions);

        wrapper.appendChild(imgWrap);
        wrapper.appendChild(body);
        Dom.detailContainer.appendChild(wrapper);
      }
    };

    const DeckManager = {
      loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.decks);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed) || parsed.length !== 3) return;
          AppState.decks = parsed.map(d => ({
            name: d.name || "Deck",
            cards: d.cards || {}
          }));
        } catch {}
      },
      saveToStorage() {
        localStorage.setItem(STORAGE_KEYS.decks, JSON.stringify(AppState.decks));
      },
      setActiveDeck(index) {
        if (index < 0 || index > 2) return;
        AppState.activeDeckIndex = index;
        Dom.deckTabs.forEach(tab => {
          tab.classList.toggle("active", Number(tab.dataset.deckIndex) === index);
        });
        const deck = AppState.decks[index];
        Dom.deckNameInput.value = deck.name || "";
        DeckManager.renderDeck();
      },
      renderDeck() {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        Dom.deckList.innerHTML = "";
        const entries = Object.entries(deck.cards)
          .map(([cardId, qty]) => {
            const card = CardData.getCardById(cardId);
            return { cardId, card, qty: Number(qty) || 0 };
          })
          .filter(e => e.card && e.qty > 0)
          .sort((a,b) => {
            const typeCmp = (a.card.type || "").localeCompare(b.card.type || "");
            if (typeCmp !== 0) return typeCmp;
            return (a.card.name || "").localeCompare(b.card.name || "");
          });

        if (!entries.length) {
          Dom.deckList.innerHTML = "<p class='small-note'>No cards in this deck yet.</p>";
        } else {
          entries.forEach(entry => {
            const { cardId, card, qty } = entry;
            const row = document.createElement("div");
            row.className = "deck-row";

            const main = document.createElement("div");
            main.className = "deck-row-main";
            main.innerHTML = `<strong>${qty}x ${card.name}</strong>
              <span>${card.type || ""} · ${card.setName || ""}</span>`;

            const controls = document.createElement("div");
            controls.className = "deck-row-controls";

            const input = document.createElement("input");
            input.type = "number";
            input.min = "0";
            input.value = String(qty);
            input.addEventListener("change", () => {
              const newQty = Math.max(0, Number(input.value) || 0);
              DeckManager.setCardQuantity(cardId, newQty);
            });

            const minusBtn = document.createElement("button");
            minusBtn.type = "button";
            minusBtn.className = "button secondary";
            minusBtn.textContent = "-";
            minusBtn.addEventListener("click", () => {
              DeckManager.addCard(cardId, -1);
            });

            const plusBtn = document.createElement("button");
            plusBtn.type = "button";
            plusBtn.className = "button secondary";
            plusBtn.textContent = "+";
            plusBtn.addEventListener("click", () => {
              DeckManager.addCard(cardId, 1);
            });

            controls.appendChild(minusBtn);
            controls.appendChild(input);
            controls.appendChild(plusBtn);

            row.appendChild(main);
            row.appendChild(controls);
            Dom.deckList.appendChild(row);
          });
        }

        DeckManager.updateStats(deck);
      },
      updateStats(deck) {
        const total = Object.values(deck.cards).reduce((sum, qty) => sum + Number(qty || 0), 0);
        const typeCounts = {};
        let vehicleCount = 0;
        Object.entries(deck.cards).forEach(([cardId, qty]) => {
          const card = CardData.getCardById(cardId);
          if (!card) return;
          const n = Number(qty) || 0;
          const type = card.type || "Unknown";
          typeCounts[type] = (typeCounts[type] || 0) + n;
          if (type === "Vehicle" || type === "Named Vehicle") vehicleCount += n;
        });

        let html = `<h3>Deck Stats</h3>`;
        html += `<div class="small-note">Total Cards: ${total}</div>`;
        const lines = [];
        Object.entries(typeCounts)
          .sort((a,b) => a[0].localeCompare(b[0]))
          .forEach(([type, count]) => lines.push(`${type}: ${count}`));
        if (vehicleCount) lines.push(`Vehicles / Named Vehicles: ${vehicleCount}`);
        if (lines.length) html += `<div class="small-note">${lines.join("<br>")}</div>`;
        Dom.deckStats.innerHTML = html;
        DeckManager.updateLegality(total, vehicleCount);
      },
      updateLegality(total, vehicleCount) {
        const issues = [];
        if (total !== 50) {
          issues.push({ level: "err", text: `Deck must contain exactly 50 cards (current: ${total}).` });
        } else {
          issues.push({ level: "ok", text: "Deck has 50 cards." });
        }
        if (vehicleCount < 2) {
          issues.push({ level: "warn", text: `Deck should contain at least 2 Vehicles / Named Vehicles (current: ${vehicleCount}).` });
        } else {
          issues.push({ level: "ok", text: `Vehicles / Named Vehicles: ${vehicleCount}.` });
        }
        Dom.deckLegal.innerHTML = issues
          .map(issue => `<div class="${issue.level}">${issue.text}</div>`)
          .join("");
      },
      addCard(cardId, delta) {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        const current = Number(deck.cards[cardId] || 0);
        const next = Math.max(0, current + delta);
        if (next === 0) delete deck.cards[cardId];
        else deck.cards[cardId] = next;
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },
      setCardQuantity(cardId, qty) {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        if (qty <= 0) delete deck.cards[cardId];
        else deck.cards[cardId] = qty;
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },
      clearDeck() {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        if (!confirm("Clear all cards from this deck?")) return;
        deck.cards = {};
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },
      exportDeckAsJson() {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        const payload = {
          name: deck.name || `Deck ${AppState.activeDeckIndex + 1}`,
          cards: deck.cards
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${(deck.name || "deck").replace(/\s+/g,"_")}.json`;
        a.click();
        URL.revokeObjectURL(url);
      },
      exportDeckAsText() {
        const deck = AppState.decks[AppState.activeDeckIndex];
        if (!deck) return;
        const lines = [];
        lines.push(deck.name || `Deck ${AppState.activeDeckIndex + 1}`);
        lines.push("================================");
        const entries = Object.entries(deck.cards)
          .map(([cardId, qty]) => {
            const card = CardData.getCardById(cardId);
            return { card, qty: Number(qty) || 0 };
          })
          .filter(e => e.card && e.qty > 0)
          .sort((a,b) => (a.card.type || "").localeCompare(b.card.type || "") ||
                        (a.card.name || "").localeCompare(b.card.name || ""));
        entries.forEach(e => {
          lines.push(`${e.qty}x ${e.card.name} [${e.card.type || ""}]`);
        });
        const blob = new Blob([lines.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${(deck.name || "deck").replace(/\s+/g,"_")}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      },
      init() {
        DeckManager.loadFromStorage();
        Dom.deckTabs.forEach(tab => {
          tab.addEventListener("click", () => {
            const idx = Number(tab.dataset.deckIndex);
            DeckManager.setActiveDeck(idx);
          });
        });
        Dom.deckNameInput.addEventListener("input", () => {
          const deck = AppState.decks[AppState.activeDeckIndex];
          if (!deck) return;
          deck.name = Dom.deckNameInput.value.trim() || `Deck ${AppState.activeDeckIndex + 1}`;
          DeckManager.saveToStorage();
        });
        Dom.clearDeckBtn.addEventListener("click", () => DeckManager.clearDeck());
        Dom.exportDeckJsonBtn.addEventListener("click", () => DeckManager.exportDeckAsJson());
        Dom.exportDeckTextBtn.addEventListener("click", () => DeckManager.exportDeckAsText());
        DeckManager.setActiveDeck(AppState.activeDeckIndex);
      }
    };

    const FullCardModal = {
      open(cardId) {
        const card = CardData.getCardById(cardId);
        if (!card) return;
        Dom.fullCardTitle.textContent = card.name || "(No Name)";
        Dom.fullCardImage.src = card.imageUrl || "";
        Dom.fullCardImage.alt = card.name || "Card";
        Dom.fullCardType.textContent = card.type || "";
        Dom.fullCardSet.textContent = card.setName || "";
        Dom.fullCardRarity.textContent = card.rarity || "";
        const vt = CardData.getVehicleTypes(card);
        Dom.fullCardVehicles.textContent = vt.length ? vt.join(", ") : "—";
        const tags = card.tags || [];
        Dom.fullCardTags.textContent = tags.length ? tags.join(", ") : "—";
        const modStats = CardData.getModStats(card);
        const vehStats = CardData.getVehicleStats(card);
        const statPieces = [];
        if (modStats) statPieces.push(modStats);
        if (vehStats) statPieces.push(vehStats);
        Dom.fullCardStats.textContent = statPieces.length ? statPieces.join(" | ") : "—";
        Dom.fullCardRules.textContent = card.notes || "";

        Dom.fullAddToDeckBtn.onclick = () => DeckManager.addCard(card.id, 1);
        Dom.fullAddToCompareBtn.onclick = () => CompareModule.addCardToCompare(card.id);

        Dom.fullCardOverlay.classList.add("open");
      },
      close() {
        Dom.fullCardOverlay.classList.remove("open");
      },
      init() {
        Dom.openFullCardBtn.addEventListener("click", () => {
          if (!selectedCardId) return;
          FullCardModal.open(selectedCardId);
        });
        Dom.closeFullCardBtn.addEventListener("click", () => FullCardModal.close());
        Dom.fullCardOverlay.addEventListener("click", e => {
          if (e.target === Dom.fullCardOverlay) FullCardModal.close();
        });
      }
    };

    const CompareModule = {
      addCardToCompare(cardId) {
        const slots = AppState.compareSlots;
        if (slots[0] === cardId) slots[0] = null;
        else if (slots[1] === cardId) slots[1] = null;
        else if (!slots[0]) slots[0] = cardId;
        else if (!slots[1]) slots[1] = cardId;
        else slots[1] = cardId;
        CompareModule.syncSelects();
        CompareModule.render();
      },
      syncSelects() {
        const optsA = ['<option value="">Select Card A</option>'];
        const optsB = ['<option value="">Select Card B</option>'];
        AppState.cards
          .slice()
          .sort((a,b) => (a.name || "").localeCompare(b.name || ""))
          .forEach(card => {
            optsA.push(`<option value="${card.id}">${card.name}</option>`);
            optsB.push(`<option value="${card.id}">${card.name}</option>`);
          });
        Dom.compareSelectA.innerHTML = optsA.join("");
        Dom.compareSelectB.innerHTML = optsB.join("");
        Dom.compareSelectA.value = AppState.compareSlots[0] || "";
        Dom.compareSelectB.value = AppState.compareSlots[1] || "";
      },
      render() {
        const [idA, idB] = AppState.compareSlots;
        const cardA = CardData.getCardById(idA);
        const cardB = CardData.getCardById(idB);
        Dom.compareViewer.innerHTML = "";

        const createCompareCard = (label, card) => {
          const box = document.createElement("div");
          box.className = "compare-card";

          const header = document.createElement("header");
          const h3 = document.createElement("h3");
          h3.textContent = card ? (card.name || "(No Name)") : `Slot ${label}`;
          const badge = document.createElement("span");
          badge.className = "compare-badge";
          badge.textContent = card ? (card.type || "") : "No card selected.";
          header.appendChild(h3);
          header.appendChild(badge);
          box.appendChild(header);

          if (!card) {
            const p = document.createElement("p");
            p.className = "compare-empty";
            p.textContent = "Choose a card from the dropdown above or add via the card view.";
            box.appendChild(p);
            return box;
          }

          const body = document.createElement("div");
          body.className = "compare-body";

          const imgWrap = document.createElement("div");
          imgWrap.className = "compare-image";
          const img = document.createElement("img");
          img.src = card.imageUrl || "";
          img.alt = card.name || "Card";
          imgWrap.appendChild(img);

          const meta = document.createElement("div");
          meta.className = "compare-meta";

          const vt = CardData.getVehicleTypes(card);
          const tags = card.tags || [];
          const modStats = CardData.getModStats(card);
          const vehStats = CardData.getVehicleStats(card);
          const statsPieces = [];
          if (modStats) statsPieces.push(modStats);
          if (vehStats) statsPieces.push(vehStats);

          meta.innerHTML = `
            <div class="compare-section">
              <span class="compare-label">Type:</span>
              <span class="compare-value">${card.type || ""}</span>
            </div>
            <div class="compare-section">
              <span class="compare-label">Set / Rarity:</span>
              <span class="compare-value">${card.setName || ""} ${card.cardNumber ? ("#" + card.cardNumber) : ""} · ${card.rarity || ""}</span>
            </div>
            <div class="compare-section">
              <span class="compare-label">Vehicle Types:</span>
              <span class="compare-value">${vt.length ? vt.join(", ") : "—"}</span>
            </div>
            <div class="compare-section">
              <span class="compare-label">Tags:</span>
              <span class="compare-value">${tags.length ? tags.join(", ") : "—"}</span>
            </div>
            <div class="compare-section">
              <span class="compare-label">Stats:</span>
              <span class="compare-value">${statsPieces.length ? statsPieces.join(" | ") : "—"}</span>
            </div>
            <div class="compare-section">
              <span class="compare-label">Rules:</span>
              <span class="compare-value">${(card.notes || "").replace(/\n/g,"<br>")}</span>
            </div>
          `;

          body.appendChild(imgWrap);
          body.appendChild(meta);
          box.appendChild(body);
          return box;
        };

        Dom.compareViewer.appendChild(createCompareCard("A", cardA));
        Dom.compareViewer.appendChild(createCompareCard("B", cardB));
      },
      init() {
        Dom.compareSelectA.addEventListener("change", () => {
          AppState.compareSlots[0] = Dom.compareSelectA.value || null;
          CompareModule.render();
        });
        Dom.compareSelectB.addEventListener("change", () => {
          AppState.compareSlots[1] = Dom.compareSelectB.value || null;
          CompareModule.render();
        });
        Dom.clearCompareABtn.addEventListener("click", () => {
          AppState.compareSlots[0] = null;
          CompareModule.syncSelects();
          CompareModule.render();
        });
        Dom.clearCompareBBtn.addEventListener("click", () => {
          AppState.compareSlots[1] = null;
          CompareModule.syncSelects();
          CompareModule.render();
        });
      }
    };

    const PreconViewer = {
      async loadPrecons() {
        try {
          const res = await fetch("drive-precons.json");
          if (!res.ok) {
            AppState.precons = [];
            return;
          }
          const json = await res.json();
          AppState.precons = Array.isArray(json) ? json : [];
        } catch (e) {
          console.error("Failed to load drive-precons.json", e);
          AppState.precons = [];
        }
        PreconViewer.renderSelect();
      },
      renderSelect() {
        Dom.preconSelect.innerHTML = '<option value="">Select Precon</option>';
        AppState.precons.forEach((p, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = p.name || `Precon ${idx + 1}`;
          Dom.preconSelect.appendChild(opt);
        });
        Dom.preconStats.textContent = AppState.precons.length
          ? `${AppState.precons.length} precon deck${AppState.precons.length === 1 ? "" : "s"} loaded`
          : "No precons found.";
      },
      renderPrecon(indexStr) {
        Dom.preconList.innerHTML = "";
        Dom.preconCards.innerHTML = "";
        Dom.preconDesc.textContent = "";
        if (!indexStr) return;
        const idx = Number(indexStr);
        const precon = AppState.precons[idx];
        if (!precon) return;

        Dom.preconDesc.textContent = precon.notes || "No description.";
        const cardsObj = precon.cards || {};
        const entries = Object.entries(cardsObj)
          .map(([cardId, qty]) => {
            const card = CardData.getCardById(cardId);
            return { cardId, card, qty: Number(qty) || 0 };
          })
          .filter(e => e.card && e.qty > 0)
          .sort((a,b) => (a.card.type || "").localeCompare(b.card.type || "") ||
                        (a.card.name || "").localeCompare(b.card.name || ""));

        let total = 0;
        entries.forEach(e => total += e.qty);

        if (!entries.length) {
          Dom.preconCards.innerHTML = "<p class='small-note'>No cards in this precon.</p>";
        } else {
          entries.forEach(entry => {
            const { card, qty } = entry;
            const row = document.createElement("div");
            row.className = "precon-card-row";

            const main = document.createElement("div");
            main.style.flex = "1";
            main.style.minWidth = "0";
            main.innerHTML = `<strong>${qty}x ${card.name}</strong>
              <div class="small-note">${card.type || ""} · ${card.setName || ""}</div>`;

            const img = document.createElement("img");
            img.src = card.imageUrl || "";
            img.alt = card.name || "Card";
            img.style.maxWidth = "40px";
            img.style.borderRadius = "0.35rem";
            img.style.border = "1px solid #1f2937";

            row.appendChild(main);
            row.appendChild(img);
            Dom.preconCards.appendChild(row);
          });
        }

        Dom.preconList.innerHTML =
          `<div class="precon-row">
            <div class="precon-row-main">
              <strong>${precon.name || "Unnamed Precon"}</strong>
              <span>Total cards: ${total}</span>
            </div>
          </div>`;
      },
      init() {
        Dom.preconSelect.addEventListener("change", () => {
          PreconViewer.renderPrecon(Dom.preconSelect.value);
        });
        Dom.refreshPreconsBtn.addEventListener("click", () => PreconViewer.loadPrecons());
      }
    };

    (async function init() {
      Mode.init();
      DeckManager.init();
      FullCardModal.init();
      CompareModule.init();
      PreconViewer.init();

      await CardData.load();
      CardGrid.buildFilterOptions();
      CardGrid.init();
      CardGrid.renderGrid();
      CompareModule.syncSelects();
      CompareModule.render();
      PreconViewer.loadPrecons();

      Mode.setMode("cards");
    })();
  </script>
</body>
</html>
