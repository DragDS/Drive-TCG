<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Card Library & Deck Builder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    a {
      color: #38bdf8;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.25rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header small {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .mode-toggle {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .mode-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mode-btn {
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease,
        box-shadow 0.08s ease;
    }
    .mode-btn:hover {
      background: #030712;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .mode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.8fr) minmax(0, 1.6fr);
      gap: 0.75rem;
    }
    @media (max-width: 1040px) {
      .layout {
        grid-template-columns: minmax(0,1.5fr) minmax(0,1.5fr);
        grid-auto-rows: auto;
      }
      .panel-deck {
        grid-column: 1 / -1;
      }
    }
    @media (max-width: 760px) {
      .layout {
        grid-template-columns: minmax(0,1fr);
      }
      .panel-deck {
        grid-column: 1 / -1;
      }
    }

    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.08s ease, box-shadow 0.08s ease,
        transform 0.05s ease;
    }
    button:hover {
      background: #020617;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }
    button.secondary {
      background: #020617;
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button.danger:hover {
      background: #7f1d1d;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
      align-items: center;
    }
    .toolbar small {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .filters {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.35rem;
      margin-bottom: 0.4rem;
    }
    @media (max-width: 760px) {
      .filters {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.4rem;
      max-height: calc(100vh - 250px);
      overflow-y: auto;
      padding-right: 0.2rem;
    }
    @media (max-width: 760px) {
      .card-grid {
        max-height: 360px;
      }
    }

    .card-item {
      background: rgba(15,23,42,0.8);
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.25rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      transition: border-color 0.08s ease, transform 0.05s ease,
        box-shadow 0.08s ease, background 0.1s ease;
    }
    .card-item:hover {
      border-color: #22c55e;
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.55);
    }
    .card-item img {
      width: 100%;
      border-radius: 0.45rem;
      object-fit: contain;
      max-height: 160px;
      background: #020617;
    }
    .card-item-name {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-item-sub {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    /* Detail panel */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.45rem;
      flex-wrap: wrap;
    }
    .detail-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 0.6rem;
    }
    @media (max-width: 1040px) {
      .detail-body {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .detail-image {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .detail-image img {
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
      border-radius: 0.45rem;
    }
    .detail-meta {
      font-size: 0.8rem;
    }
    .detail-meta h3 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
    }
    .detail-row {
      margin-bottom: 0.15rem;
    }
    .detail-label {
      color: #9ca3af;
    }
    .detail-rules {
      margin-top: 0.4rem;
      padding-top: 0.35rem;
      border-top: 1px solid #1f2937;
      font-size: 0.8rem;
      white-space: pre-wrap;
    }

    /* Compare tray */
    .compare-tray {
      margin-top: 0.5rem;
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem 0.4rem;
      background: rgba(15,23,42,0.8);
      font-size: 0.78rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
    }
    .compare-tray-label {
      color: #9ca3af;
      font-size: 0.76rem;
    }
    .compare-slot {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      border: 1px solid #374151;
      background: #020617;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-slot-empty {
      color: #4b5563;
      font-style: italic;
    }
    .compare-remove {
      border: none;
      background: transparent;
      color: #9ca3af;
      padding: 0;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .compare-remove:hover {
      color: #fca5a5;
    }

    /* Deck panel */
    .deck-header {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.35rem;
      flex-wrap: wrap;
    }
    .deck-name-input {
      flex: 1;
      min-width: 0;
    }
    .deck-tabs {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    .deck-tab {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.78rem;
      border: 1px solid #374151;
      background: #020617;
      cursor: pointer;
    }
    .deck-tab.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
    }

    .deck-list {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      max-height: 260px;
      overflow-y: auto;
      background: #020617;
      font-size: 0.78rem;
    }
    .deck-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.2rem;
      border-radius: 0.4rem;
    }
    .deck-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .deck-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .deck-row-info {
      flex: 1;
      min-width: 0;
    }
    .deck-row-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .deck-row-sub {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .deck-row-qty {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      flex-shrink: 0;
    }
    .deck-qty-number {
      min-width: 1.2rem;
      text-align: center;
    }
    .deck-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.05rem 0.4rem;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .deck-btn:hover {
      background: #020617;
    }

    .deck-stats {
      margin-top: 0.3rem;
      font-size: 0.76rem;
      color: #9ca3af;
    }
    .deck-legal {
      margin-top: 0.2rem;
      font-size: 0.8rem;
    }
    .legal-ok {
      color: #4ade80;
    }
    .legal-bad {
      color: #f97373;
    }

    /* Precon panel */
    .precon-panel h2 {
      margin-bottom: 0.4rem;
    }
    .precon-header {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .precon-desc {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.35rem;
      white-space: pre-wrap;
    }

    /* Modal overlay for full card and compare */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }
    .modal {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 0.75rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: #fca5a5;
    }

    .compare-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.5rem;
      font-size: 0.8rem;
    }
    @media (max-width: 760px) {
      .compare-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .compare-card {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.4rem;
      background: rgba(15,23,42,0.75);
    }
    .compare-card h3 {
      margin: 0 0 0.3rem;
      font-size: 0.95rem;
    }
    .compare-image {
      text-align: center;
      margin-bottom: 0.4rem;
    }
    .compare-image img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      border-radius: 0.45rem;
    }
    .compare-section {
      margin-bottom: 0.25rem;
    }
    .compare-label {
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Card Library</h1>
        <small>Browse official cards, build decks, compare cards, and view precon decks.</small>
      </div>
    </header>

    <div class="mode-toggle">
      <span class="mode-label">View:</span>
      <button id="modeCardsBtn" class="mode-btn active">Cards & Deck Builder</button>
      <button id="modePreconsBtn" class="mode-btn">Precon Viewer</button>
    </div>

    <div id="cardsLayout" class="layout">
      <!-- Card browser -->
      <section class="panel">
        <h2>Card Library</h2>
        <div class="toolbar">
          <input id="searchInput" type="text" placeholder="Search name / text / tags..." />
          <small id="cardCountLabel"></small>
        </div>
        <div class="filters">
          <select id="typeFilter">
            <option value="">All Types</option>
          </select>
          <select id="setFilter">
            <option value="">All Sets</option>
          </select>
          <select id="rarityFilter">
            <option value="">All Rarities</option>
          </select>
          <select id="vehicleFilter">
            <option value="">All Vehicle Types</option>
            <option value="Drag">Drag</option>
            <option value="Drift">Drift</option>
            <option value="Off-Road">Off-Road</option>
            <option value="Rally">Rally</option>
          </select>
        </div>
        <div id="cardGrid" class="card-grid"></div>
      </section>

      <!-- Detail + compare -->
      <section class="panel">
        <div class="detail-header">
          <h2>Card Details</h2>
          <div>
            <button id="openFullCardBtn" class="secondary" type="button">Open Larger View</button>
          </div>
        </div>
        <div id="detailContainer" class="detail-body">
          <div class="detail-image">
            <span class="small-note">Select a card on the left to view details.</span>
          </div>
          <div class="detail-meta">
            <!-- Filled dynamically -->
          </div>
        </div>

        <div class="compare-tray">
          <span class="compare-tray-label">Compare:</span>
          <div id="compareSlotA" class="compare-slot">
            <span class="compare-slot-empty">Slot A empty</span>
          </div>
          <div id="compareSlotB" class="compare-slot">
            <span class="compare-slot-empty">Slot B empty</span>
          </div>
          <button id="compareNowBtn" class="secondary" type="button">Compare Now</button>
        </div>
      </section>

      <!-- Deck builder -->
      <section class="panel panel-deck">
        <h2>Deck Builder</h2>
        <div class="deck-header">
          <div class="deck-tabs">
            <button class="deck-tab active" data-deck-index="0">Deck 1</button>
            <button class="deck-tab" data-deck-index="1">Deck 2</button>
            <button class="deck-tab" data-deck-index="2">Deck 3</button>
          </div>
          <input id="deckNameInput" type="text" class="deck-name-input" placeholder="Deck name..." />
          <button id="clearDeckBtn" class="secondary" type="button">Clear Deck</button>
        </div>

        <div id="deckList" class="deck-list"></div>

        <div class="deck-stats" id="deckStats"></div>
        <div class="deck-legal" id="deckLegal"></div>

        <div class="toolbar" style="margin-top:0.4rem;">
          <button id="exportDeckJsonBtn" type="button">Export Deck JSON</button>
          <button id="exportDeckTextBtn" type="button">Export Deck Text</button>
        </div>
        <p class="small-note">
          Deck rules: exactly 50 cards · max 4 copies of any non-named card · named cards (Named Driver, Named Vehicle) are limited to 1 copy each · minimum 2 Vehicle/Named Vehicle cards.
        </p>
      </section>
    </div>

    <!-- Precon Viewer Layout -->
    <div id="preconsLayout" class="panel precon-panel" style="display:none; margin-top:0.75rem;">
      <h2>Precon Deck Viewer</h2>
      <div class="precon-header">
        <select id="preconSelect"></select>
        <button id="refreshPreconsBtn" class="secondary" type="button">Reload Precons JSON</button>
      </div>
      <div id="preconDesc" class="precon-desc"></div>
      <div id="preconStats" class="small-note"></div>
      <div id="preconList" class="deck-list" style="margin-top:0.35rem;"></div>
    </div>
  </div>

  <!-- Full card modal -->
  <div id="fullCardOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="fullCardTitle">Card</div>
        <button class="modal-close" data-close-modal="fullCardOverlay">&times;</button>
      </div>
      <div class="detail-body" id="fullCardBody">
        <!-- Filled dynamically -->
      </div>
      <div style="margin-top:0.4rem; display:flex; gap:0.4rem; flex-wrap:wrap;">
        <button id="fullAddToDeckBtn" type="button">+ Add to Active Deck</button>
        <button id="fullAddToCompareBtn" class="secondary" type="button">+ Add to Compare</button>
      </div>
    </div>
  </div>

  <!-- Compare modal -->
  <div id="compareOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Compare Cards</div>
        <button class="modal-close" data-close-modal="compareOverlay">&times;</button>
      </div>
      <div id="compareBody" class="compare-grid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <script>
    // ----------------- Data & state -----------------
    let cards = [];
    let cardsById = {};
    let selectedCardId = null;

    // Decks: up to 3 stored in localStorage
    const DECKS_KEY = "driveDecks_v1";
    let decks = [
      { name: "Deck 1", cards: {} },
      { name: "Deck 2", cards: {} },
      { name: "Deck 3", cards: {} },
    ];
    let activeDeckIndex = 0;

    // Comparison slots (store card IDs)
    let compareSlots = [null, null];

    // Precons (from drive-precons.json)
    let precons = [];

    // ----------------- DOM references -----------------
    const modeCardsBtn = document.getElementById("modeCardsBtn");
    const modePreconsBtn = document.getElementById("modePreconsBtn");
    const cardsLayout = document.getElementById("cardsLayout");
    const preconsLayout = document.getElementById("preconsLayout");

    const searchInput = document.getElementById("searchInput");
    const typeFilter = document.getElementById("typeFilter");
    const setFilter = document.getElementById("setFilter");
    const rarityFilter = document.getElementById("rarityFilter");
    const vehicleFilter = document.getElementById("vehicleFilter");
    const cardGrid = document.getElementById("cardGrid");
    const cardCountLabel = document.getElementById("cardCountLabel");

    const detailContainer = document.getElementById("detailContainer");
    const openFullCardBtn = document.getElementById("openFullCardBtn");

    const compareSlotA = document.getElementById("compareSlotA");
    const compareSlotB = document.getElementById("compareSlotB");
    const compareNowBtn = document.getElementById("compareNowBtn");

    const deckTabs = document.querySelectorAll(".deck-tab");
    const deckNameInput = document.getElementById("deckNameInput");
    const deckList = document.getElementById("deckList");
    const deckStats = document.getElementById("deckStats");
    const deckLegal = document.getElementById("deckLegal");
    const clearDeckBtn = document.getElementById("clearDeckBtn");
    const exportDeckJsonBtn = document.getElementById("exportDeckJsonBtn");
    const exportDeckTextBtn = document.getElementById("exportDeckTextBtn");

    const fullCardOverlay = document.getElementById("fullCardOverlay");
    const fullCardTitle = document.getElementById("fullCardTitle");
    const fullCardBody = document.getElementById("fullCardBody");
    const fullAddToDeckBtn = document.getElementById("fullAddToDeckBtn");
    const fullAddToCompareBtn = document.getElementById("fullAddToCompareBtn");

    const compareOverlay = document.getElementById("compareOverlay");
    const compareBody = document.getElementById("compareBody");

    const preconSelect = document.getElementById("preconSelect");
    const refreshPreconsBtn = document.getElementById("refreshPreconsBtn");
    const preconDesc = document.getElementById("preconDesc");
    const preconStats = document.getElementById("preconStats");
    const preconList = document.getElementById("preconList");

    // ----------------- Utility helpers -----------------
    function getCardById(id) {
      return cardsById[id] || null;
    }

    function formatExtra(card) {
      if (!card.extra) return "";
      const extra = card.extra;
      const pieces = [];

      if (card.type === "Vehicle" || card.type === "Named Vehicle") {
        if (extra.vehicleType) pieces.push("Vehicle Type: " + extra.vehicleType);
        if (extra.hp != null || extra.con != null) {
          pieces.push("HP/CON: " + (extra.hp ?? "?") + "/" + (extra.con ?? "?"));
        }
      }

      if (card.type === "Driver" || card.type === "Named Driver" || card.type === "Track") {
        if (Array.isArray(extra.vehicleTypes) && extra.vehicleTypes.length) {
          pieces.push("Vehicle Types: " + extra.vehicleTypes.join(", "));
        }
      }

      if (card.type === "Mod") {
        if (extra.modBasePart) pieces.push("Base Part: " + extra.modBasePart);
        const lv = [];
        if (extra.modLevel1) lv.push("L1 " + extra.modLevel1);
        if (extra.modLevel2) lv.push("L2 " + extra.modLevel2);
        if (extra.modLevel3) lv.push("L3 " + extra.modLevel3);
        if (extra.modLevel4) lv.push("L4 " + extra.modLevel4);
        if (lv.length) pieces.push("Levels: " + lv.join(" · "));
      }

      return pieces.join(" | ");
    }

    function isNamedCard(card) {
      if (!card || !card.type) return false;
      return card.type.startsWith("Named");
    }

    function cardMatchesFilters(card) {
      const q = searchInput.value.trim().toLowerCase();
      const t = typeFilter.value;
      const s = setFilter.value;
      const r = rarityFilter.value;
      const v = vehicleFilter.value;

      if (t && card.type !== t) return false;
      if (s && card.setName !== s) return false;
      if (r && card.rarity !== r) return false;

      if (v) {
        const extra = card.extra || {};
        let types = [];
        if (Array.isArray(extra.vehicleTypes)) types = extra.vehicleTypes;
        else if (extra.vehicleType) types = [extra.vehicleType];
        if (!types.includes(v)) return false;
      }

      if (q) {
        const haystack = [
          card.name || "",
          card.type || "",
          card.rarity || "",
          card.setName || "",
          card.cardNumber || "",
          (card.notes || ""),
          (card.tags || []).join(" "),
        ]
          .join(" ")
          .toLowerCase();
        if (!haystack.includes(q)) return false;
      }

      return true;
    }

    // ----------------- Rendering: cards -----------------
    function populateFilterOptions() {
      const typeSet = new Set();
      const setSet = new Set();
      const rarSet = new Set();

      cards.forEach(c => {
        if (c.type) typeSet.add(c.type);
        if (c.setName) setSet.add(c.setName);
        if (c.rarity) rarSet.add(c.rarity);
      });

      function fillSelect(sel, values, label) {
        sel.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "All " + label;
        sel.appendChild(optAll);

        Array.from(values).sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
      }

      fillSelect(typeFilter, typeSet, "Types");
      fillSelect(setFilter, setSet, "Sets");
      fillSelect(rarityFilter, rarSet, "Rarities");
    }

    function renderCardGrid() {
      cardGrid.innerHTML = "";
      const filtered = cards.filter(cardMatchesFilters);
      cardCountLabel.textContent = `${filtered.length} shown / ${cards.length} total`;

      filtered.forEach(card => {
        const div = document.createElement("div");
        div.className = "card-item";
        div.dataset.cardId = card.id;

        const img = document.createElement("img");
        img.src = card.imageData || "";
        img.alt = card.name || "Card";

        const nameDiv = document.createElement("div");
        nameDiv.className = "card-item-name";
        nameDiv.textContent = card.name || "(No Name)";

        const subDiv = document.createElement("div");
        subDiv.className = "card-item-sub";
        const setLabel = card.setName || "";
        const num = card.cardNumber ? ` #${card.cardNumber}` : "";
        subDiv.textContent = `${card.type || ""} · ${setLabel}${num}`;

        div.appendChild(img);
        div.appendChild(nameDiv);
        div.appendChild(subDiv);

        div.addEventListener("click", () => {
          selectCard(card.id);
        });

        cardGrid.appendChild(div);
      });
    }

    // ----------------- Card selection & detail -----------------
    function selectCard(cardId) {
      selectedCardId = cardId;
      const card = getCardById(cardId);
      if (!card) return;
      renderCardDetail(card);
    }

    function renderCardDetail(card) {
      const left = detailContainer.querySelector(".detail-image");
      const right = detailContainer.querySelector(".detail-meta");

      left.innerHTML = "";
      const img = document.createElement("img");
      img.src = card.imageData || "";
      img.alt = card.name || "Card";
      left.appendChild(img);

      right.innerHTML = "";

      const h3 = document.createElement("h3");
      h3.textContent = card.name || "(No Name)";

      const metaLines = document.createElement("div");
      metaLines.innerHTML = `
        <div class="detail-row"><span class="detail-label">Type:</span> ${card.type || ""}</div>
        <div class="detail-row"><span class="detail-label">Rarity:</span> ${card.rarity || ""}</div>
        <div class="detail-row"><span class="detail-label">Set / #: </span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
        <div class="detail-row"><span class="detail-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
        <div class="detail-row"><span class="detail-label">Extra:</span> ${formatExtra(card) || "-"}</div>
      `;

      const rulesDiv = document.createElement("div");
      rulesDiv.className = "detail-rules";
      rulesDiv.textContent = card.notes || "No rules text.";

      const actions = document.createElement("div");
      actions.style.marginTop = "0.35rem";
      actions.style.display = "flex";
      actions.style.flexWrap = "wrap";
      actions.style.gap = "0.35rem";

      const addBtn = document.createElement("button");
      addBtn.type = "button";
      addBtn.textContent = "+ Add to Active Deck";
      addBtn.addEventListener("click", () => {
        addCardToActiveDeck(card.id);
      });

      const compareBtn = document.createElement("button");
      compareBtn.type = "button";
      compareBtn.className = "secondary";
      compareBtn.textContent = "+ Add to Compare";
      compareBtn.addEventListener("click", () => {
        addCardToCompare(card.id);
      });

      actions.appendChild(addBtn);
      actions.appendChild(compareBtn);

      right.appendChild(h3);
      right.appendChild(metaLines);
      right.appendChild(rulesDiv);
      right.appendChild(actions);
    }

    // ----------------- Full card modal -----------------
    function openFullCardModal() {
      if (!selectedCardId) {
        alert("Select a card first.");
        return;
      }
      const card = getCardById(selectedCardId);
      if (!card) return;

      fullCardTitle.textContent = card.name || "Card";
      fullCardBody.innerHTML = "";

      // reuse same layout as detail
      const bodyDiv = document.createElement("div");
      bodyDiv.className = "detail-body";

      const left = document.createElement("div");
      left.className = "detail-image";
      const img = document.createElement("img");
      img.src = card.imageData || "";
      img.alt = card.name || "Card";
      left.appendChild(img);

      const right = document.createElement("div");
      right.className = "detail-meta";

      const h3 = document.createElement("h3");
      h3.textContent = card.name || "(No Name)";

      const metaLines = document.createElement("div");
      metaLines.innerHTML = `
        <div class="detail-row"><span class="detail-label">Type:</span> ${card.type || ""}</div>
        <div class="detail-row"><span class="detail-label">Rarity:</span> ${card.rarity || ""}</div>
        <div class="detail-row"><span class="detail-label">Set / #: </span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
        <div class="detail-row"><span class="detail-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
        <div class="detail-row"><span class="detail-label">Extra:</span> ${formatExtra(card) || "-"}</div>
      `;

      const rulesDiv = document.createElement("div");
      rulesDiv.className = "detail-rules";
      rulesDiv.textContent = card.notes || "No rules text.";

      right.appendChild(h3);
      right.appendChild(metaLines);
      right.appendChild(rulesDiv);

      bodyDiv.appendChild(left);
      bodyDiv.appendChild(right);

      fullCardBody.appendChild(bodyDiv);

      fullAddToDeckBtn.onclick = () => addCardToActiveDeck(card.id);
      fullAddToCompareBtn.onclick = () => addCardToCompare(card.id);

      fullCardOverlay.style.display = "flex";
    }

    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    }

    document.querySelectorAll(".modal-close").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-close-modal");
        if (target) closeModal(target);
      });
    });

    [fullCardOverlay, compareOverlay].forEach(overlay => {
      overlay.addEventListener("click", e => {
        if (e.target === overlay) {
          overlay.style.display = "none";
        }
      });
    });

    openFullCardBtn.addEventListener("click", openFullCardModal);

    // ----------------- Compare logic -----------------
    function renderCompareTray() {
      const slots = [compareSlotA, compareSlotB];

      slots.forEach((slotEl, idx) => {
        const cardId = compareSlots[idx];
        slotEl.innerHTML = "";
        if (!cardId) {
          const span = document.createElement("span");
          span.className = "compare-slot-empty";
          span.textContent = idx === 0 ? "Slot A empty" : "Slot B empty";
          slotEl.appendChild(span);
          return;
        }
        const card = getCardById(cardId);
        if (!card) {
          const span = document.createElement("span");
          span.className = "compare-slot-empty";
          span.textContent = "Missing card";
          slotEl.appendChild(span);
          return;
        }
        const nameSpan = document.createElement("span");
        nameSpan.textContent = card.name || "(No Name)";

        const removeBtn = document.createElement("button");
        removeBtn.className = "compare-remove";
        removeBtn.type = "button";
        removeBtn.innerHTML = "&times;";
        removeBtn.addEventListener("click", () => {
          compareSlots[idx] = null;
          renderCompareTray();
        });

        slotEl.appendChild(nameSpan);
        slotEl.appendChild(removeBtn);
      });
    }

    function addCardToCompare(cardId) {
      // if already in compare, remove it
      if (compareSlots[0] === cardId) {
        compareSlots[0] = null;
      } else if (compareSlots[1] === cardId) {
        compareSlots[1] = null;
      } else if (!compareSlots[0]) {
        compareSlots[0] = cardId;
      } else if (!compareSlots[1]) {
        compareSlots[1] = cardId;
      } else {
        // both filled, replace slot B
        compareSlots[1] = cardId;
      }
      renderCompareTray();
    }

    function openCompareModal() {
      const [idA, idB] = compareSlots;
      if (!idA || !idB) {
        alert("Select two cards to compare (fill both Slot A and Slot B).");
        return;
      }
      const cardA = getCardById(idA);
      const cardB = getCardById(idB);
      if (!cardA || !cardB) {
        alert("One of the comparison cards is missing.");
        return;
      }

      compareBody.innerHTML = "";
      const cardsToShow = [cardA, cardB];
      cardsToShow.forEach(card => {
        const div = document.createElement("div");
        div.className = "compare-card";

        const h3 = document.createElement("h3");
        h3.textContent = card.name || "(No Name)";

        const imgWrap = document.createElement("div");
        imgWrap.className = "compare-image";
        const img = document.createElement("img");
        img.src = card.imageData || "";
        img.alt = card.name || "Card";
        imgWrap.appendChild(img);

        const meta = document.createElement("div");
        meta.innerHTML = `
          <div class="compare-section"><span class="compare-label">Type:</span> ${card.type || ""}</div>
          <div class="compare-section"><span class="compare-label">Rarity:</span> ${card.rarity || ""}</div>
          <div class="compare-section"><span class="compare-label">Set / #:</span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
          <div class="compare-section"><span class="compare-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
          <div class="compare-section"><span class="compare-label">Extra:</span> ${formatExtra(card) || "-"}</div>
          <div class="compare-section"><span class="compare-label">Rules:</span></div>
          <div class="compare-section" style="white-space:pre-wrap;">${card.notes || "No rules text."}</div>
        `;

        div.appendChild(h3);
        div.appendChild(imgWrap);
        div.appendChild(meta);
        compareBody.appendChild(div);
      });

      compareOverlay.style.display = "flex";
    }

    compareNowBtn.addEventListener("click", openCompareModal);

    // ----------------- Deck builder logic -----------------
    function loadDecksFromStorage() {
      try {
        const raw = localStorage.getItem(DECKS_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length === 3) {
          decks = parsed;
        }
      } catch (e) {
        console.warn("Failed to load decks from storage", e);
      }
    }

    function saveDecksToStorage() {
      localStorage.setItem(DECKS_KEY, JSON.stringify(decks));
    }

    function getActiveDeck() {
      return decks[activeDeckIndex];
    }

    function setActiveDeckIndex(idx) {
      activeDeckIndex = idx;
      deckTabs.forEach(tab => {
        tab.classList.toggle(
          "active",
          Number(tab.dataset.deckIndex) === activeDeckIndex
        );
      });
      renderDeck();
    }

    deckTabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const idx = Number(tab.dataset.deckIndex);
        setActiveDeckIndex(idx);
      });
    });

    deckNameInput.addEventListener("input", () => {
      const deck = getActiveDeck();
      deck.name = deckNameInput.value || `Deck ${activeDeckIndex + 1}`;
      saveDecksToStorage();
    });

    function addCardToActiveDeck(cardId) {
      const deck = getActiveDeck();
      const card = getCardById(cardId);
      if (!deck || !card) return;

      const isNamed = isNamedCard(card);
      const limit = isNamed ? 1 : 4;

      const current = deck.cards[cardId] || 0;
      if (current >= limit) {
        alert(
          `Copy limit reached for this card.\n` +
            (isNamed
              ? "Named cards are limited to 1 copy per deck."
              : "Non-named cards are limited to 4 copies per deck.")
        );
        return;
      }

      deck.cards[cardId] = current + 1;
      saveDecksToStorage();
      renderDeck();
    }

    function removeCardFromActiveDeck(cardId) {
      const deck = getActiveDeck();
      if (!deck || !deck.cards[cardId]) return;
      deck.cards[cardId] -= 1;
      if (deck.cards[cardId] <= 0) delete deck.cards[cardId];
      saveDecksToStorage();
      renderDeck();
    }

    function clearActiveDeck() {
      const deck = getActiveDeck();
      if (!deck) return;
      if (!confirm("Clear all cards from this deck?")) return;
      deck.cards = {};
      saveDecksToStorage();
      renderDeck();
    }

    clearDeckBtn.addEventListener("click", clearActiveDeck);

    function computeDeckStats(deck) {
      let total = 0;
      const typeCounts = {};
      let vehicleCount = 0;

      Object.entries(deck.cards).forEach(([cardId, qty]) => {
        const card = getCardById(cardId);
        if (!card) return;
        const n = Number(qty) || 0;
        total += n;
        const type = card.type || "Unknown";
        typeCounts[type] = (typeCounts[type] || 0) + n;
        if (type === "Vehicle" || type === "Named Vehicle") {
          vehicleCount += n;
        }
      });

      const issues = [];

      if (total !== 50) {
        issues.push(`Deck must contain exactly 50 cards (current: ${total}).`);
      }
      if (vehicleCount < 2) {
        issues.push(`Deck must contain at least 2 Vehicles / Named Vehicles (current: ${vehicleCount}).`);
      }

      // copy limits
      Object.entries(deck.cards).forEach(([cardId, qty]) => {
        const card = getCardById(cardId);
        if (!card) return;
        const n = Number(qty) || 0;
        const isNamed = isNamedCard(card);
        const limit = isNamed ? 1 : 4;
        if (n > limit) {
          issues.push(
            `"${card.name}" exceeds its copy limit (${n}/${limit}).`
          );
        }
      });

      return { total, typeCounts, vehicleCount, issues };
    }

    function renderDeck() {
      const deck = getActiveDeck();
      if (!deck) return;
      deckNameInput.value = deck.name || `Deck ${activeDeckIndex + 1}`;

      deckList.innerHTML = "";
      const entries = Object.entries(deck.cards);
      if (!entries.length) {
        deckList.innerHTML = "<div class='small-note'>No cards in this deck yet. Select a card and click “Add to Active Deck”.</div>";
      } else {
        entries
          .sort(([aId],[bId]) => {
            const a = getCardById(aId);
            const b = getCardById(bId);
            if (!a || !b) return 0;
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(([cardId, qty]) => {
            const card = getCardById(cardId);
            if (!card) return;
            const row = document.createElement("div");
            row.className = "deck-row";

            const info = document.createElement("div");
            info.className = "deck-row-info";

            const main = document.createElement("div");
            main.className = "deck-row-main";
            main.textContent = `${qty}x ${card.name}`;

            const sub = document.createElement("div");
            sub.className = "deck-row-sub";
            const setLabel = card.setName || "";
            const num = card.cardNumber ? ` #${card.cardNumber}` : "";
            sub.textContent = `[${card.type || ""}] ${setLabel}${num}`;

            info.appendChild(main);
            info.appendChild(sub);

            const qtyDiv = document.createElement("div");
            qtyDiv.className = "deck-row-qty";

            const minusBtn = document.createElement("button");
            minusBtn.className = "deck-btn";
            minusBtn.type = "button";
            minusBtn.textContent = "−";
            minusBtn.onclick = () => removeCardFromActiveDeck(cardId);

            const numSpan = document.createElement("span");
            numSpan.className = "deck-qty-number";
            numSpan.textContent = qty;

            const plusBtn = document.createElement("button");
            plusBtn.className = "deck-btn";
            plusBtn.type = "button";
            plusBtn.textContent = "+";
            plusBtn.onclick = () => addCardToActiveDeck(cardId);

            qtyDiv.appendChild(minusBtn);
            qtyDiv.appendChild(numSpan);
            qtyDiv.appendChild(plusBtn);

            row.appendChild(info);
            row.appendChild(qtyDiv);
            deckList.appendChild(row);
          });
      }

      const stats = computeDeckStats(deck);
      const orderedTypes = [
        "Vehicle","Named Vehicle","Driver","Named Driver",
        "Crew","Mod","Track","Condition"
      ];
      const statsParts = [];
      orderedTypes.forEach(t => {
        if (stats.typeCounts[t]) statsParts.push(`${t}: ${stats.typeCounts[t]}`);
      });
      Object.entries(stats.typeCounts).forEach(([t,count]) => {
        if (!orderedTypes.includes(t)) statsParts.push(`${t}: ${count}`);
      });

      deckStats.textContent = `Total: ${stats.total} · ` +
        (statsParts.length ? statsParts.join(" · ") : "No cards yet");

      if (!stats.issues.length) {
        deckLegal.innerHTML = `<span class="legal-ok">✅ Deck is legal under the current rules.</span>`;
      } else {
        deckLegal.innerHTML =
          `<span class="legal-bad">❌ Deck is not legal:</span><br>${stats.issues
            .map(i => "• " + i)
            .join("<br>")}`;
      }
    }

    function exportDeckJson() {
      const deck = getActiveDeck();
      if (!deck) return;
      const payload = {
        name: deck.name,
        cards: deck.cards,
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (deck.name || "deck") + ".json";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportDeckText() {
      const deck = getActiveDeck();
      if (!deck) return;
      let lines = [];
      lines.push(deck.name || "Deck");
      lines.push("");
      const entries = Object.entries(deck.cards);
      entries
        .sort(([aId],[bId]) => {
          const a = getCardById(aId);
          const b = getCardById(bId);
          if (!a || !b) return 0;
          return (a.type || "").localeCompare(b.type || "") ||
                 (a.name || "").localeCompare(b.name || "");
        })
        .forEach(([cardId, qty]) => {
          const card = getCardById(cardId);
          if (!card) return;
          const setLabel = card.setName || "";
          const num = card.cardNumber ? ` #${card.cardNumber}` : "";
          lines.push(`${qty}x ${card.name} [${card.type}] ${setLabel}${num}`);
        });

      const blob = new Blob([lines.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (deck.name || "deck") + ".txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    exportDeckJsonBtn.addEventListener("click", exportDeckJson);
    exportDeckTextBtn.addEventListener("click", exportDeckText);

    // ----------------- Precon viewer -----------------
    async function loadPrecons() {
      try {
        const res = await fetch("drive-precons.json", { cache: "no-store" });
        if (!res.ok) {
          precons = [];
          preconSelect.innerHTML =
            "<option value=''>No precons found</option>";
          preconDesc.textContent = "";
          preconList.innerHTML = "<div class='small-note'>No precons JSON found.</div>";
          preconStats.textContent = "";
          return;
        }
        const json = await res.json();
        precons = Array.isArray(json) ? json : [];
      } catch (e) {
        console.warn("Failed to load drive-precons.json", e);
        precons = [];
      }

      renderPreconSelect();
      renderPrecon();
    }

    function renderPreconSelect() {
      preconSelect.innerHTML = "";
      if (!precons.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "No precons available";
        preconSelect.appendChild(opt);
        return;
      }
      precons.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = p.name || `Precon ${idx + 1}`;
        preconSelect.appendChild(opt);
      });
      preconSelect.value = "0";
    }

    function renderPrecon() {
      if (!precons.length) {
        preconDesc.textContent = "";
        preconStats.textContent = "";
        preconList.innerHTML = "<div class='small-note'>No precon decks available.</div>";
        return;
      }
      const idx = Number(preconSelect.value) || 0;
      const p = precons[idx] || precons[0];

      preconDesc.textContent = p.notes || "";
      preconList.innerHTML = "";

      const entries = Object.entries(p.cards || {});
      if (!entries.length) {
        preconList.innerHTML = "<div class='small-note'>This precon has no cards.</div>";
        preconStats.textContent = "";
        return;
      }

      let total = 0;
      const typeCounts = {};
      let vehicleCount = 0;

      entries
        .sort(([aId],[bId]) => {
          const a = getCardById(aId);
          const b = getCardById(bId);
          if (!a || !b) return 0;
          return (a.type || "").localeCompare(b.type || "") ||
                 (a.name || "").localeCompare(b.name || "");
        })
        .forEach(([cardId, qty]) => {
          const card = getCardById(cardId);
          const n = Number(qty) || 0;
          total += n;
          if (card) {
            const t = card.type || "Unknown";
            typeCounts[t] = (typeCounts[t] || 0) + n;
            if (t === "Vehicle" || t === "Named Vehicle") vehicleCount += n;
          }

          const row = document.createElement("div");
          row.className = "deck-row";

          const info = document.createElement("div");
          info.className = "deck-row-info";

          const main = document.createElement("div");
          main.className = "deck-row-main";
          main.textContent = `${qty}x ${card ? card.name : "(Unknown card)"}`;

          const sub = document.createElement("div");
          sub.className = "deck-row-sub";
          if (card) {
            const setLabel = card.setName || "";
            const num = card.cardNumber ? ` #${card.cardNumber}` : "";
            sub.textContent = `[${card.type}] ${setLabel}${num}`;
          } else {
            sub.textContent = cardId;
          }

          info.appendChild(main);
          info.appendChild(sub);

          row.appendChild(info);
          preconList.appendChild(row);

          row.addEventListener("click", () => {
            if (card) {
              selectedCardId = card.id;
              renderCardDetail(card);
              // Switch back to cards view but leave precon view visible if desired
              window.scrollTo({ top: 0, behavior: "smooth" });
            }
          });
        });

      const orderedTypes = [
        "Vehicle","Named Vehicle","Driver","Named Driver",
        "Crew","Mod","Track","Condition"
      ];
      const parts = [];
      orderedTypes.forEach(t => {
        if (typeCounts[t]) parts.push(`${t}: ${typeCounts[t]}`);
      });
      Object.entries(typeCounts).forEach(([t,c]) => {
        if (!orderedTypes.includes(t)) parts.push(`${t}: ${c}`);
      });

      const legalIssues = [];
      if (total !== 50) {
        legalIssues.push(`Not 50 cards (current: ${total}).`);
      }
      if (vehicleCount < 2) {
        legalIssues.push(`Has fewer than 2 Vehicle / Named Vehicle cards (current: ${vehicleCount}).`);
      }

      const legalSummary =
        legalIssues.length === 0
          ? "✅ This precon is a legal 50-card deck."
          : "⚠️ This precon does not meet all deck rules.";

      preconStats.textContent =
        `Total: ${total}` +
        (parts.length ? " · " + parts.join(" · ") : "") +
        " · " + legalSummary;
    }

    preconSelect.addEventListener("change", renderPrecon);
    refreshPreconsBtn.addEventListener("click", loadPrecons);

    // ----------------- Mode toggle -----------------
    function setMode(mode) {
      if (mode === "cards") {
        cardsLayout.style.display = "";
        preconsLayout.style.display = "none";
        modeCardsBtn.classList.add("active");
        modePreconsBtn.classList.remove("active");
      } else {
        cardsLayout.style.display = "grid";
        preconsLayout.style.display = "";
        modeCardsBtn.classList.remove("active");
        modePreconsBtn.classList.add("active");
      }
    }

    modeCardsBtn.addEventListener("click", () => setMode("cards"));
    modePreconsBtn.addEventListener("click", () => setMode("precons"));

    // ----------------- Init -----------------
    async function loadCards() {
      try {
        const res = await fetch("drive-card.json", { cache: "no-store" });
        if (!res.ok) {
          cards = [];
          cardsById = {};
          return;
        }
        const json = await res.json();
        cards = Array.isArray(json) ? json : [];
      } catch (e) {
        console.error("Failed to load drive-card.json", e);
        cards = [];
      }
      cardsById = {};
      cards.forEach(c => {
        if (!c.id) {
          c.id = "card-" + Math.random().toString(36).slice(2);
        }
        cardsById[c.id] = c;
      });
    }

    function attachFilterListeners() {
      [searchInput, typeFilter, setFilter, rarityFilter, vehicleFilter].forEach(el => {
        el.addEventListener("input", renderCardGrid);
        el.addEventListener("change", renderCardGrid);
      });
    }

    function init() {
      attachFilterListeners();
      compareNowBtn.disabled = false;
      loadDecksFromStorage();
      setActiveDeckIndex(0);
      renderCompareTray();
    }

    (async function main() {
      init();
      await loadCards();
      populateFilterOptions();
      renderCardGrid();
      renderDeck();
      await loadPrecons();
    })();
  </script>
</body>
</html>
