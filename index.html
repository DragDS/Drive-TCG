<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Card Library & Tools</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    a {
      color: #38bdf8;
    }
    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1.25rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header small {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .mode-toggle {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .mode-label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mode-btn {
      border-radius: 999px;
      padding: 0.3rem 0.8rem;
      font-size: 0.8rem;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.08s ease, border-color 0.08s ease,
        box-shadow 0.08s ease;
    }
    .mode-btn:hover {
      background: #030712;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .mode-btn.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.8fr) minmax(0, 1.8fr);
      gap: 0.75rem;
    }
    @media (max-width: 760px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      padding: 0.75rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }
    .panel h2 {
      margin: 0 0 0.5rem;
      font-size: 1.05rem;
    }

    input[type="text"],
    select {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
    }

    button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.08s ease, box-shadow 0.08s ease,
        transform 0.05s ease;
    }
    button:hover {
      background: #020617;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }
    button.secondary {
      background: #020617;
    }
    button.danger {
      border-color: #b91c1c;
      color: #fecaca;
    }
    button.danger:hover {
      background: #7f1d1d;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
      align-items: center;
    }
    .toolbar small {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .filters {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.35rem;
      margin-bottom: 0.4rem;
    }
    @media (max-width: 760px) {
      .filters {
        grid-template-columns: minmax(0,1fr);
      }
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.4rem;
      max-height: calc(100vh - 250px);
      overflow-y: auto;
      padding-right: 0.2rem;
    }
    @media (max-width: 760px) {
      .card-grid {
        max-height: 360px;
      }
    }

    .card-item {
      background: rgba(15,23,42,0.8);
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.25rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      transition: border-color 0.08s ease, transform 0.05s ease,
        box-shadow 0.08s ease, background 0.1s ease;
    }
    .card-item:hover {
      border-color: #22c55e;
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.55);
    }
    .card-item img {
      width: 100%;
      border-radius: 0.45rem;
      object-fit: contain;
      max-height: 160px;
      background: #020617;
    }
    .card-item-name {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-item-sub {
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .small-note {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    /* Detail panel */
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.45rem;
      flex-wrap: wrap;
    }
    .detail-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 0.6rem;
    }
    @media (max-width: 1040px) {
      .detail-body {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .detail-image {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.35rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .detail-image img {
      max-width: 100%;
      max-height: 260px;
      object-fit: contain;
      border-radius: 0.45rem;
    }
    .detail-meta {
      font-size: 0.8rem;
    }
    .detail-meta h3 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
    }
    .detail-row {
      margin-bottom: 0.15rem;
    }
    .detail-label {
      color: #9ca3af;
    }
    .detail-rules {
      margin-top: 0.4rem;
      padding-top: 0.35rem;
      border-top: 1px solid #1f2937;
      font-size: 0.8rem;
      white-space: pre-wrap;
    }

    /* Deck panel */
    .deckbuilder-panel h2 {
      margin-bottom: 0.4rem;
    }
    .deck-header {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.35rem;
      flex-wrap: wrap;
    }
    .deck-name-input {
      flex: 1;
      min-width: 0;
    }
    .deck-tabs {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
    }
    .deck-tab {
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.78rem;
      border: 1px solid #374151;
      background: #020617;
      cursor: pointer;
    }
    .deck-tab.active {
      border-color: #22c55e;
      background: rgba(34,197,94,0.08);
    }

    .deck-list {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.35rem;
      max-height: 260px;
      overflow-y: auto;
      background: #020617;
      font-size: 0.78rem;
    }
    .deck-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.35rem;
      padding: 0.15rem 0.2rem;
      border-radius: 0.4rem;
    }
    .deck-row:nth-child(odd) {
      background: rgba(15,23,42,0.7);
    }
    .deck-row:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }
    .deck-row-info {
      flex: 1;
      min-width: 0;
    }
    .deck-row-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .deck-row-sub {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .deck-row-qty {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      flex-shrink: 0;
    }
    .deck-qty-number {
      min-width: 1.2rem;
      text-align: center;
    }
    .deck-btn {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 0.05rem 0.4rem;
      font-size: 0.75rem;
      cursor: pointer;
    }
    .deck-btn:hover {
      background: #020617;
    }

    .deck-stats {
      margin-top: 0.3rem;
      font-size: 0.76rem;
      color: #9ca3af;
    }
    .deck-legal {
      margin-top: 0.2rem;
      font-size: 0.8rem;
    }
    .legal-ok {
      color: #4ade80;
    }
    .legal-bad {
      color: #f97373;
    }

    /* Precon panel */
    .precon-panel h2 {
      margin-bottom: 0.4rem;
    }
    .precon-header {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .precon-desc {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 0.35rem;
      white-space: pre-wrap;
    }

    /* Modal overlay for full card only */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }
    .modal {
      background: #020617;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 0.75rem;
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
    }
    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .modal-close {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: #fca5a5;
    }

    /* Comparison viewer */
    .compare-panel h2 {
      margin-bottom: 0.4rem;
    }
    .compare-controls {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }
    @media (max-width: 760px) {
      .compare-controls {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .compare-control-block {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.4rem;
      background: rgba(15,23,42,0.7);
      font-size: 0.78rem;
    }
    .compare-control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
    }
    .compare-slot-label {
      font-weight: 600;
    }
    .compare-grid {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap: 0.5rem;
      font-size: 0.8rem;
    }
    @media (max-width: 760px) {
      .compare-grid {
        grid-template-columns: minmax(0,1fr);
      }
    }
    .compare-card {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      padding: 0.4rem;
      background: rgba(15,23,42,0.75);
    }
    .compare-card h3 {
      margin: 0 0 0.3rem;
      font-size: 0.95rem;
    }
    .compare-image {
      text-align: center;
      margin-bottom: 0.4rem;
    }
    .compare-image img {
      max-width: 100%;
      max-height: 220px;
      object-fit: contain;
      border-radius: 0.45rem;
    }
    .compare-section {
      margin-bottom: 0.25rem;
    }
    .compare-label {
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Card Library</h1>
        <small>Browse official cards, build decks, compare cards, and view precon decks.</small>
      </div>
    </header>

    <div class="mode-toggle">
      <span class="mode-label">View:</span>
      <button id="modeCardsBtn" class="mode-btn active">Cards</button>
      <button id="modeDeckBtn" class="mode-btn">Deck Builder</button>
      <button id="modePreconsBtn" class="mode-btn">Precon Viewer</button>
      <button id="modeCompareBtn" class="mode-btn">Card Comparison</button>
    </div>

    <!-- Cards layout -->
    <div id="cardsLayout" class="layout">
      <!-- Card browser -->
      <section class="panel">
        <h2>Card Library</h2>
        <div class="toolbar">
          <input id="searchInput" type="text" placeholder="Search name / text / tags..." />
          <small id="cardCountLabel"></small>
        </div>
        <div class="filters">
          <select id="typeFilter">
            <option value="">All Types</option>
          </select>
          <select id="setFilter">
            <option value="">All Sets</option>
          </select>
          <select id="rarityFilter">
            <option value="">All Rarities</option>
          </select>
          <select id="vehicleFilter">
            <option value="">All Vehicle Types</option>
            <option value="Drag">Drag</option>
            <option value="Drift">Drift</option>
            <option value="Off-Road">Off-Road</option>
            <option value="Rally">Rally</option>
          </select>
        </div>
        <div id="cardGrid" class="card-grid"></div>
      </section>

      <!-- Card details -->
      <section class="panel">
        <div class="detail-header">
          <h2>Card Details</h2>
          <div>
            <button id="openFullCardBtn" class="secondary" type="button">Open Larger View</button>
          </div>
        </div>
        <div id="detailContainer" class="detail-body">
          <div class="detail-image">
            <span class="small-note">Select a card on the left to view details.</span>
          </div>
          <div class="detail-meta">
            <!-- Filled dynamically -->
          </div>
        </div>
      </section>
    </div>

    <!-- Deck Builder layout -->
    <div id="deckbuilderLayout" class="panel deckbuilder-panel" style="display:none; margin-top:0.75rem;">
      <h2>Deck Builder</h2>
      <p class="small-note">
        Build local decks using cards from the library. You can also add cards directly from the Card view using “Add to Active Deck”.
      </p>
      <div class="deck-header">
        <div class="deck-tabs">
          <button class="deck-tab active" data-deck-index="0">Deck 1</button>
          <button class="deck-tab" data-deck-index="1">Deck 2</button>
          <button class="deck-tab" data-deck-index="2">Deck 3</button>
        </div>
        <input id="deckNameInput" type="text" class="deck-name-input" placeholder="Deck name..." />
        <button id="clearDeckBtn" class="secondary" type="button">Clear Deck</button>
      </div>

      <div id="deckList" class="deck-list"></div>

      <div class="deck-stats" id="deckStats"></div>
      <div class="deck-legal" id="deckLegal"></div>

      <div class="toolbar" style="margin-top:0.4rem;">
        <button id="exportDeckJsonBtn" type="button">Export Deck JSON</button>
        <button id="exportDeckTextBtn" type="button">Export Deck Text</button>
      </div>
      <p class="small-note">
        Deck rules: exactly 50 cards · max 4 copies of any non-named card · named cards (Named Driver, Named Vehicle) are limited to 1 copy each · minimum 2 Vehicle/Named Vehicle cards.
      </p>
    </div>

    <!-- Precon Viewer layout -->
    <div id="preconsLayout" class="panel precon-panel" style="display:none; margin-top:0.75rem;">
      <h2>Precon Deck Viewer</h2>
      <div class="precon-header">
        <select id="preconSelect"></select>
        <button id="refreshPreconsBtn" class="secondary" type="button">Reload Precons JSON</button>
      </div>
      <div id="preconDesc" class="precon-desc"></div>
      <div id="preconStats" class="small-note"></div>
      <div id="preconList" class="deck-list" style="margin-top:0.35rem;"></div>
    </div>

    <!-- Card Comparison layout -->
    <div id="compareLayout" class="panel compare-panel" style="display:none; margin-top:0.75rem;">
      <h2>Card Comparison</h2>
      <p class="small-note">
        Choose any two cards to compare side-by-side. You can also mark cards from the Card view using the “Add to Compare” button.
      </p>
      <div class="compare-controls">
        <div class="compare-control-block">
          <div class="compare-control-header">
            <span class="compare-slot-label">Slot A</span>
            <button id="clearCompareABtn" class="secondary" type="button">Clear A</button>
          </div>
          <select id="compareSelectA"></select>
        </div>
        <div class="compare-control-block">
          <div class="compare-control-header">
            <span class="compare-slot-label">Slot B</span>
            <button id="clearCompareBBtn" class="secondary" type="button">Clear B</button>
          </div>
          <select id="compareSelectB"></select>
        </div>
      </div>
      <div id="compareViewer" class="compare-grid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

  <!-- Full card modal -->
  <div id="fullCardOverlay" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="fullCardTitle">Card</div>
        <button class="modal-close" data-close-modal="fullCardOverlay">&times;</button>
      </div>
      <div class="detail-body" id="fullCardBody">
        <!-- Filled dynamically -->
      </div>
      <div style="margin-top:0.4rem; display:flex; gap:0.4rem; flex-wrap:wrap;">
        <button id="fullAddToDeckBtn" type="button">+ Add to Active Deck</button>
        <button id="fullAddToCompareBtn" class="secondary" type="button">+ Add to Compare</button>
      </div>
    </div>
  </div>

  <script>
    // ========= GLOBAL APP STATE =========
    const AppState = {
      cards: [],
      cardsById: {},
      decks: [
        { name: "Deck 1", cards: {} },
        { name: "Deck 2", cards: {} },
        { name: "Deck 3", cards: {} }
      ],
      activeDeckIndex: 0,
      compareSlots: [null, null],
      precons: []
    };

    const STORAGE_KEYS = {
      decks: "driveDecks_v1"
    };

    // ========= DOM REFERENCES =========
    const Dom = {
      // Mode buttons
      modeCardsBtn: document.getElementById("modeCardsBtn"),
      modeDeckBtn: document.getElementById("modeDeckBtn"),
      modePreconsBtn: document.getElementById("modePreconsBtn"),
      modeCompareBtn: document.getElementById("modeCompareBtn"),

      // Layouts
      cardsLayout: document.getElementById("cardsLayout"),
      deckbuilderLayout: document.getElementById("deckbuilderLayout"),
      preconsLayout: document.getElementById("preconsLayout"),
      compareLayout: document.getElementById("compareLayout"),

      // Card browser
      searchInput: document.getElementById("searchInput"),
      typeFilter: document.getElementById("typeFilter"),
      setFilter: document.getElementById("setFilter"),
      rarityFilter: document.getElementById("rarityFilter"),
      vehicleFilter: document.getElementById("vehicleFilter"),
      cardGrid: document.getElementById("cardGrid"),
      cardCountLabel: document.getElementById("cardCountLabel"),
      detailContainer: document.getElementById("detailContainer"),
      openFullCardBtn: document.getElementById("openFullCardBtn"),

      // Deck builder
      deckTabs: document.querySelectorAll(".deck-tab"),
      deckNameInput: document.getElementById("deckNameInput"),
      deckList: document.getElementById("deckList"),
      deckStats: document.getElementById("deckStats"),
      deckLegal: document.getElementById("deckLegal"),
      clearDeckBtn: document.getElementById("clearDeckBtn"),
      exportDeckJsonBtn: document.getElementById("exportDeckJsonBtn"),
      exportDeckTextBtn: document.getElementById("exportDeckTextBtn"),

      // Full card modal
      fullCardOverlay: document.getElementById("fullCardOverlay"),
      fullCardTitle: document.getElementById("fullCardTitle"),
      fullCardBody: document.getElementById("fullCardBody"),
      fullAddToDeckBtn: document.getElementById("fullAddToDeckBtn"),
      fullAddToCompareBtn: document.getElementById("fullAddToCompareBtn"),

      // Precons
      preconSelect: document.getElementById("preconSelect"),
      refreshPreconsBtn: document.getElementById("refreshPreconsBtn"),
      preconDesc: document.getElementById("preconDesc"),
      preconStats: document.getElementById("preconStats"),
      preconList: document.getElementById("preconList"),

      // Comparison
      compareSelectA: document.getElementById("compareSelectA"),
      compareSelectB: document.getElementById("compareSelectB"),
      clearCompareABtn: document.getElementById("clearCompareABtn"),
      clearCompareBBtn: document.getElementById("clearCompareBBtn"),
      compareViewer: document.getElementById("compareViewer")
    };

    let selectedCardId = null;

    // ========= MODULE: CardData =========
    const CardData = {
      async load() {
        try {
          const res = await fetch("drive-card.json", { cache: "no-store" });
          if (!res.ok) {
            AppState.cards = [];
            AppState.cardsById = {};
            return;
          }
          const json = await res.json();
          AppState.cards = Array.isArray(json) ? json : [];
        } catch (e) {
          console.error("Failed to load drive-card.json", e);
          AppState.cards = [];
        }

        AppState.cardsById = {};
        AppState.cards.forEach(c => {
          if (!c.id) {
            c.id = "card-" + Math.random().toString(36).slice(2);
          }
          AppState.cardsById[c.id] = c;
        });
      },

      getCardById(id) {
        return AppState.cardsById[id] || null;
      },

      isNamedCard(card) {
        if (!card || !card.type) return false;
        return card.type.startsWith("Named");
      },

      formatExtra(card) {
        if (!card.extra) return "";
        const extra = card.extra;
        const pieces = [];

        // Vehicles
        if (card.type === "Vehicle" || card.type === "Named Vehicle") {
          if (extra.vehicleType) pieces.push("Vehicle Type: " + extra.vehicleType);
          if (extra.hp != null || extra.con != null) {
            pieces.push("HP/CON: " + (extra.hp ?? "?") + "/" + (extra.con ?? "?"));
          }
        }

        // Drivers / Tracks
        if (card.type === "Driver" || card.type === "Named Driver" || card.type === "Track") {
          if (Array.isArray(extra.vehicleTypes) && extra.vehicleTypes.length) {
            pieces.push("Vehicle Types: " + extra.vehicleTypes.join(", "));
          }
        }

        // Mods
        if (card.type === "Mod") {
          if (extra.modBasePart) pieces.push("Base Part: " + extra.modBasePart);
          const lv = [];
          if (extra.modLevel1) lv.push("L1 " + extra.modLevel1);
          if (extra.modLevel2) lv.push("L2 " + extra.modLevel2);
          if (extra.modLevel3) lv.push("L3 " + extra.modLevel3);
          if (extra.modLevel4) lv.push("L4 " + extra.modLevel4);
          if (lv.length) pieces.push("Levels: " + lv.join(" · "));
        }

        return pieces.join(" | ");
      }
    };

    // ========= MODULE: DeckManager =========
    const DeckManager = {
      loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEYS.decks);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length === 3) {
            AppState.decks = parsed;
          }
        } catch (e) {
          console.warn("Failed to load decks from storage", e);
        }
      },

      saveToStorage() {
        localStorage.setItem(STORAGE_KEYS.decks, JSON.stringify(AppState.decks));
      },

      getActiveDeck() {
        return AppState.decks[AppState.activeDeckIndex];
      },

      setActiveDeckIndex(idx) {
        AppState.activeDeckIndex = idx;
        Dom.deckTabs.forEach(tab => {
          tab.classList.toggle(
            "active",
            Number(tab.dataset.deckIndex) === AppState.activeDeckIndex
          );
        });
        DeckManager.renderDeck();
      },

      addCardToActiveDeck(cardId) {
        const deck = DeckManager.getActiveDeck();
        const card = CardData.getCardById(cardId);
        if (!deck || !card) return;

        const isNamed = CardData.isNamedCard(card);
        const limit = isNamed ? 1 : 4;
        const current = deck.cards[cardId] || 0;

        if (current >= limit) {
          alert(
            `Copy limit reached for this card.\n` +
              (isNamed
                ? "Named cards are limited to 1 copy per deck."
                : "Non-named cards are limited to 4 copies per deck.")
          );
          return;
        }

        deck.cards[cardId] = current + 1;
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },

      removeCardFromActiveDeck(cardId) {
        const deck = DeckManager.getActiveDeck();
        if (!deck || !deck.cards[cardId]) return;
        deck.cards[cardId] -= 1;
        if (deck.cards[cardId] <= 0) delete deck.cards[cardId];
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },

      clearActiveDeck() {
        const deck = DeckManager.getActiveDeck();
        if (!deck) return;
        if (!confirm("Clear all cards from this deck?")) return;
        deck.cards = {};
        DeckManager.saveToStorage();
        DeckManager.renderDeck();
      },

      computeDeckStats(deck) {
        let total = 0;
        const typeCounts = {};
        let vehicleCount = 0;
        const issues = [];

        Object.entries(deck.cards).forEach(([cardId, qty]) => {
          const card = CardData.getCardById(cardId);
          if (!card) return;
          const n = Number(qty) || 0;
          total += n;
          const type = card.type || "Unknown";
          typeCounts[type] = (typeCounts[type] || 0) + n;
          if (type === "Vehicle" || type === "Named Vehicle") {
            vehicleCount += n;
          }
        });

        if (total !== 50) {
          issues.push(`Deck must contain exactly 50 cards (current: ${total}).`);
        }
        if (vehicleCount < 2) {
          issues.push(`Deck must contain at least 2 Vehicles / Named Vehicles (current: ${vehicleCount}).`);
        }

        Object.entries(deck.cards).forEach(([cardId, qty]) => {
          const card = CardData.getCardById(cardId);
          if (!card) return;
          const n = Number(qty) || 0;
          const isNamed = CardData.isNamedCard(card);
          const limit = isNamed ? 1 : 4;
          if (n > limit) {
            issues.push(`"${card.name}" exceeds its copy limit (${n}/${limit}).`);
          }
        });

        return { total, typeCounts, vehicleCount, issues };
      },

      renderDeck() {
        const deck = DeckManager.getActiveDeck();
        if (!deck) return;
        Dom.deckNameInput.value = deck.name || `Deck ${AppState.activeDeckIndex + 1}`;

        Dom.deckList.innerHTML = "";
        const entries = Object.entries(deck.cards);

        if (!entries.length) {
          Dom.deckList.innerHTML = "<div class='small-note'>No cards in this deck yet. Use the Card view and click “Add to Active Deck”, or add from here.</div>";
        } else {
          entries
            .sort(([aId],[bId]) => {
              const a = CardData.getCardById(aId);
              const b = CardData.getCardById(bId);
              if (!a || !b) return 0;
              return (a.type || "").localeCompare(b.type || "") ||
                     (a.name || "").localeCompare(b.name || "");
            })
            .forEach(([cardId, qty]) => {
              const card = CardData.getCardById(cardId);
              if (!card) return;
              const row = document.createElement("div");
              row.className = "deck-row";

              const info = document.createElement("div");
              info.className = "deck-row-info";

              const main = document.createElement("div");
              main.className = "deck-row-main";
              main.textContent = `${qty}x ${card.name}`;

              const sub = document.createElement("div");
              sub.className = "deck-row-sub";
              const setLabel = card.setName || "";
              const num = card.cardNumber ? ` #${card.cardNumber}` : "";
              sub.textContent = `[${card.type || ""}] ${setLabel}${num}`;

              info.appendChild(main);
              info.appendChild(sub);

              const qtyDiv = document.createElement("div");
              qtyDiv.className = "deck-row-qty";

              const minusBtn = document.createElement("button");
              minusBtn.className = "deck-btn";
              minusBtn.type = "button";
              minusBtn.textContent = "−";
              minusBtn.onclick = () => DeckManager.removeCardFromActiveDeck(cardId);

              const numSpan = document.createElement("span");
              numSpan.className = "deck-qty-number";
              numSpan.textContent = qty;

              const plusBtn = document.createElement("button");
              plusBtn.className = "deck-btn";
              plusBtn.type = "button";
              plusBtn.textContent = "+";
              plusBtn.onclick = () => DeckManager.addCardToActiveDeck(cardId);

              qtyDiv.appendChild(minusBtn);
              qtyDiv.appendChild(numSpan);
              qtyDiv.appendChild(plusBtn);

              row.appendChild(info);
              row.appendChild(qtyDiv);
              Dom.deckList.appendChild(row);
            });
        }

        const stats = DeckManager.computeDeckStats(deck);
        const orderedTypes = [
          "Vehicle","Named Vehicle","Driver","Named Driver",
          "Crew","Mod","Track","Condition"
        ];
        const statsParts = [];
        orderedTypes.forEach(t => {
          if (stats.typeCounts[t]) statsParts.push(`${t}: ${stats.typeCounts[t]}`);
        });
        Object.entries(stats.typeCounts).forEach(([t,count]) => {
          if (!orderedTypes.includes(t)) statsParts.push(`${t}: ${count}`);
        });

        Dom.deckStats.textContent = `Total: ${stats.total} · ` +
          (statsParts.length ? statsParts.join(" · ") : "No cards yet");

        if (!stats.issues.length) {
          Dom.deckLegal.innerHTML = `<span class="legal-ok">✅ Deck is legal under the current rules.</span>`;
        } else {
          Dom.deckLegal.innerHTML =
            `<span class="legal-bad">❌ Deck is not legal:</span><br>${stats.issues
              .map(i => "• " + i)
              .join("<br>")}`;
        }
      },

      exportDeckJson() {
        const deck = DeckManager.getActiveDeck();
        if (!deck) return;
        const payload = {
          name: deck.name,
          cards: deck.cards
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = (deck.name || "deck") + ".json";
        a.click();
        URL.revokeObjectURL(url);
      },

      exportDeckText() {
        const deck = DeckManager.getActiveDeck();
        if (!deck) return;
        let lines = [];
        lines.push(deck.name || "Deck");
        lines.push("");
        const entries = Object.entries(deck.cards);
        entries
          .sort(([aId],[bId]) => {
            const a = CardData.getCardById(aId);
            const b = CardData.getCardById(bId);
            if (!a || !b) return 0;
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(([cardId, qty]) => {
            const card = CardData.getCardById(cardId);
            if (!card) return;
            const setLabel = card.setName || "";
            const num = card.cardNumber ? ` #${card.cardNumber}` : "";
            lines.push(`${qty}x ${card.name} [${card.type}] ${setLabel}${num}`);
          });

        const blob = new Blob([lines.join("\n")], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = (deck.name || "deck") + ".txt";
        a.click();
        URL.revokeObjectURL(url);
      },

      init() {
        DeckManager.loadFromStorage();
        Dom.deckTabs.forEach(tab => {
          tab.addEventListener("click", () => {
            const idx = Number(tab.dataset.deckIndex);
            DeckManager.setActiveDeckIndex(idx);
          });
        });

        Dom.deckNameInput.addEventListener("input", () => {
          const deck = DeckManager.getActiveDeck();
          deck.name = Dom.deckNameInput.value || `Deck ${AppState.activeDeckIndex + 1}`;
          DeckManager.saveToStorage();
        });

        Dom.clearDeckBtn.addEventListener("click", () => DeckManager.clearActiveDeck());
        Dom.exportDeckJsonBtn.addEventListener("click", () => DeckManager.exportDeckJson());
        Dom.exportDeckTextBtn.addEventListener("click", () => DeckManager.exportDeckText());

        DeckManager.setActiveDeckIndex(0);
      }
    };

    // ========= MODULE: CompareModule =========
    const CompareModule = {
      addCardToCompare(cardId) {
        const slots = AppState.compareSlots;
        if (slots[0] === cardId) {
          slots[0] = null;
        } else if (slots[1] === cardId) {
          slots[1] = null;
        } else if (!slots[0]) {
          slots[0] = cardId;
        } else if (!slots[1]) {
          slots[1] = cardId;
        } else {
          slots[1] = cardId;
        }
        CompareModule.syncSelectors();
        CompareModule.renderViewer();
      },

      populateSelectOptions() {
        function fillSelect(select) {
          select.innerHTML = "";
          const optNone = document.createElement("option");
          optNone.value = "";
          optNone.textContent = "None";
          select.appendChild(optNone);

          AppState.cards
            .slice()
            .sort((a,b) => {
              return (a.type || "").localeCompare(b.type || "") ||
                     (a.name || "").localeCompare(b.name || "");
            })
            .forEach(card => {
              const opt = document.createElement("option");
              opt.value = card.id;
              opt.textContent = `${card.name || "(No Name)"} [${card.type || ""}]`;
              select.appendChild(opt);
            });
        }

        fillSelect(Dom.compareSelectA);
        fillSelect(Dom.compareSelectB);
        CompareModule.syncSelectors();
      },

      syncSelectors() {
        Dom.compareSelectA.value = AppState.compareSlots[0] || "";
        Dom.compareSelectB.value = AppState.compareSlots[1] || "";
      },

      renderViewer() {
        Dom.compareViewer.innerHTML = "";
        const [idA, idB] = AppState.compareSlots;

        const cardA = idA ? CardData.getCardById(idA) : null;
        const cardB = idB ? CardData.getCardById(idB) : null;

        if (!cardA && !cardB) {
          Dom.compareViewer.innerHTML =
            "<div class='small-note'>Select cards for Slot A and Slot B to compare them here.</div>";
          return;
        }

        const cards = [cardA, cardB];
        cards.forEach((card, idx) => {
          const div = document.createElement("div");
          div.className = "compare-card";

          if (!card) {
            const label = idx === 0 ? "Slot A" : "Slot B";
            div.innerHTML = `<div class="small-note">${label} is empty. Choose a card from the dropdown.</div>`;
            Dom.compareViewer.appendChild(div);
            return;
          }

          const h3 = document.createElement("h3");
          h3.textContent = card.name || "(No Name)";

          const imgWrap = document.createElement("div");
          imgWrap.className = "compare-image";
          const img = document.createElement("img");
          img.src = card.imageData || "";
          img.alt = card.name || "Card";
          imgWrap.appendChild(img);

          const meta = document.createElement("div");
          meta.innerHTML = `
            <div class="compare-section"><span class="compare-label">Type:</span> ${card.type || ""}</div>
            <div class="compare-section"><span class="compare-label">Rarity:</span> ${card.rarity || ""}</div>
            <div class="compare-section"><span class="compare-label">Set / #:</span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
            <div class="compare-section"><span class="compare-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
            <div class="compare-section"><span class="compare-label">Extra:</span> ${CardData.formatExtra(card) || "-"}</div>
            <div class="compare-section"><span class="compare-label">Rules:</span></div>
            <div class="compare-section" style="white-space:pre-wrap;">${card.notes || "No rules text."}</div>
          `;

          div.appendChild(h3);
          div.appendChild(imgWrap);
          div.appendChild(meta);
          Dom.compareViewer.appendChild(div);
        });
      },

      init() {
        Dom.compareSelectA.addEventListener("change", () => {
          AppState.compareSlots[0] = Dom.compareSelectA.value || null;
          CompareModule.renderViewer();
        });
        Dom.compareSelectB.addEventListener("change", () => {
          AppState.compareSlots[1] = Dom.compareSelectB.value || null;
          CompareModule.renderViewer();
        });

        Dom.clearCompareABtn.addEventListener("click", () => {
          AppState.compareSlots[0] = null;
          CompareModule.syncSelectors();
          CompareModule.renderViewer();
        });
        Dom.clearCompareBBtn.addEventListener("click", () => {
          AppState.compareSlots[1] = null;
          CompareModule.syncSelectors();
          CompareModule.renderViewer();
        });
      }
    };

    // ========= MODULE: CardBrowser =========
    const CardBrowser = {
      cardMatchesFilters(card) {
        const q = Dom.searchInput.value.trim().toLowerCase();
        const t = Dom.typeFilter.value;
        const s = Dom.setFilter.value;
        const r = Dom.rarityFilter.value;
        const v = Dom.vehicleFilter.value;

        if (t && card.type !== t) return false;
        if (s && card.setName !== s) return false;
        if (r && card.rarity !== r) return false;

        if (v) {
          const extra = card.extra || {};
          let types = [];
          if (Array.isArray(extra.vehicleTypes)) types = extra.vehicleTypes;
          else if (extra.vehicleType) types = [extra.vehicleType];
          if (!types.includes(v)) return false;
        }

        if (q) {
          const haystack = [
            card.name || "",
            card.type || "",
            card.rarity || "",
            card.setName || "",
            card.cardNumber || "",
            (card.notes || ""),
            (card.tags || []).join(" "),
          ]
            .join(" ")
            .toLowerCase();
          if (!haystack.includes(q)) return false;
        }
        return true;
      },

      populateFilterOptions() {
        const typeSet = new Set();
        const setSet = new Set();
        const rarSet = new Set();

        AppState.cards.forEach(c => {
          if (c.type) typeSet.add(c.type);
          if (c.setName) setSet.add(c.setName);
          if (c.rarity) rarSet.add(c.rarity);
        });

        function fillSelect(sel, values, label) {
          sel.innerHTML = "";
          const optAll = document.createElement("option");
          optAll.value = "";
          optAll.textContent = "All " + label;
          sel.appendChild(optAll);

          Array.from(values).sort().forEach(v => {
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        fillSelect(Dom.typeFilter, typeSet, "Types");
        fillSelect(Dom.setFilter, setSet, "Sets");
        fillSelect(Dom.rarityFilter, rarSet, "Rarities");
      },

      renderGrid() {
        Dom.cardGrid.innerHTML = "";
        const filtered = AppState.cards.filter(CardBrowser.cardMatchesFilters);
        Dom.cardCountLabel.textContent = `${filtered.length} shown / ${AppState.cards.length} total`;

        filtered.forEach(card => {
          const div = document.createElement("div");
          div.className = "card-item";
          div.dataset.cardId = card.id;

          const img = document.createElement("img");
          img.src = card.imageData || "";
          img.alt = card.name || "Card";

          const nameDiv = document.createElement("div");
          nameDiv.className = "card-item-name";
          nameDiv.textContent = card.name || "(No Name)";

          const subDiv = document.createElement("div");
          subDiv.className = "card-item-sub";
          const setLabel = card.setName || "";
          const num = card.cardNumber ? ` #${card.cardNumber}` : "";
          subDiv.textContent = `${card.type || ""} · ${setLabel}${num}`;

          div.appendChild(img);
          div.appendChild(nameDiv);
          div.appendChild(subDiv);

          div.addEventListener("click", () => {
            CardBrowser.selectCard(card.id);
          });

          Dom.cardGrid.appendChild(div);
        });
      },

      selectCard(cardId) {
        selectedCardId = cardId;
        const card = CardData.getCardById(cardId);
        if (!card) return;
        CardBrowser.renderDetail(card);
      },

      renderDetail(card) {
        const left = Dom.detailContainer.querySelector(".detail-image");
        const right = Dom.detailContainer.querySelector(".detail-meta");

        left.innerHTML = "";
        const img = document.createElement("img");
        img.src = card.imageData || "";
        img.alt = card.name || "Card";
        left.appendChild(img);

        right.innerHTML = "";

        const h3 = document.createElement("h3");
        h3.textContent = card.name || "(No Name)";

        const metaLines = document.createElement("div");
        metaLines.innerHTML = `
          <div class="detail-row"><span class="detail-label">Type:</span> ${card.type || ""}</div>
          <div class="detail-row"><span class="detail-label">Rarity:</span> ${card.rarity || ""}</div>
          <div class="detail-row"><span class="detail-label">Set / #: </span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
          <div class="detail-row"><span class="detail-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
          <div class="detail-row"><span class="detail-label">Extra:</span> ${CardData.formatExtra(card) || "-"}</div>
        `;

        const rulesDiv = document.createElement("div");
        rulesDiv.className = "detail-rules";
        rulesDiv.textContent = card.notes || "No rules text.";

        const actions = document.createElement("div");
        actions.style.marginTop = "0.35rem";
        actions.style.display = "flex";
        actions.style.flexWrap = "wrap";
        actions.style.gap = "0.35rem";

        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.textContent = "+ Add to Active Deck";
        addBtn.addEventListener("click", () => {
          DeckManager.addCardToActiveDeck(card.id);
        });

        const compareBtn = document.createElement("button");
        compareBtn.type = "button";
        compareBtn.className = "secondary";
        compareBtn.textContent = "+ Add to Compare";
        compareBtn.addEventListener("click", () => {
          CompareModule.addCardToCompare(card.id);
          alert("Card added to comparison slots. Switch to Card Comparison view to see side-by-side.");
        });

        actions.appendChild(addBtn);
        actions.appendChild(compareBtn);

        right.appendChild(h3);
        right.appendChild(metaLines);
        right.appendChild(rulesDiv);
        right.appendChild(actions);
      },

      openFullCardModal() {
        if (!selectedCardId) {
          alert("Select a card first.");
          return;
        }
        const card = CardData.getCardById(selectedCardId);
        if (!card) return;

        Dom.fullCardTitle.textContent = card.name || "Card";
        Dom.fullCardBody.innerHTML = "";

        const bodyDiv = document.createElement("div");
        bodyDiv.className = "detail-body";

        const left = document.createElement("div");
        left.className = "detail-image";
        const img = document.createElement("img");
        img.src = card.imageData || "";
        img.alt = card.name || "Card";
        left.appendChild(img);

        const right = document.createElement("div");
        right.className = "detail-meta";

        const h3 = document.createElement("h3");
        h3.textContent = card.name || "(No Name)";

        const metaLines = document.createElement("div");
        metaLines.innerHTML = `
          <div class="detail-row"><span class="detail-label">Type:</span> ${card.type || ""}</div>
          <div class="detail-row"><span class="detail-label">Rarity:</span> ${card.rarity || ""}</div>
          <div class="detail-row"><span class="detail-label">Set / #: </span> ${(card.setName || "")}${card.cardNumber ? " · #" + card.cardNumber : ""}</div>
          <div class="detail-row"><span class="detail-label">Tags:</span> ${(card.tags || []).join(", ") || "-"}</div>
          <div class="detail-row"><span class="detail-label">Extra:</span> ${CardData.formatExtra(card) || "-"}</div>
        `;

        const rulesDiv = document.createElement("div");
        rulesDiv.className = "detail-rules";
        rulesDiv.textContent = card.notes || "No rules text.";

        right.appendChild(h3);
        right.appendChild(metaLines);
        right.appendChild(rulesDiv);

        bodyDiv.appendChild(left);
        bodyDiv.appendChild(right);
        Dom.fullCardBody.appendChild(bodyDiv);

        Dom.fullAddToDeckBtn.onclick = () => DeckManager.addCardToActiveDeck(card.id);
        Dom.fullAddToCompareBtn.onclick = () => {
          CompareModule.addCardToCompare(card.id);
          alert("Card added to comparison slots. Switch to Card Comparison view to see side-by-side.");
        };

        Dom.fullCardOverlay.style.display = "flex";
      },

      init() {
        // Filters
        [Dom.searchInput, Dom.typeFilter, Dom.setFilter, Dom.rarityFilter, Dom.vehicleFilter].forEach(el => {
          el.addEventListener("input", () => CardBrowser.renderGrid());
          el.addEventListener("change", () => CardBrowser.renderGrid());
        });

        // Full-card modal
        Dom.openFullCardBtn.addEventListener("click", () => CardBrowser.openFullCardModal());

        // Modal close
        document.querySelectorAll(".modal-close").forEach(btn => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-close-modal");
            if (target === "fullCardOverlay") {
              Dom.fullCardOverlay.style.display = "none";
            }
          });
        });
        Dom.fullCardOverlay.addEventListener("click", e => {
          if (e.target === Dom.fullCardOverlay) {
            Dom.fullCardOverlay.style.display = "none";
          }
        });
      }
    };

    // ========= MODULE: PreconViewer =========
    const PreconViewer = {
      async loadPrecons() {
        try {
          const res = await fetch("drive-precons.json", { cache: "no-store" });
          if (!res.ok) {
            AppState.precons = [];
            PreconViewer.renderSelect();
            PreconViewer.renderPrecon();
            return;
          }
          const json = await res.json();
          AppState.precons = Array.isArray(json) ? json : [];
        } catch (e) {
          console.warn("Failed to load drive-precons.json", e);
          AppState.precons = [];
        }
        PreconViewer.renderSelect();
        PreconViewer.renderPrecon();
      },

      renderSelect() {
        Dom.preconSelect.innerHTML = "";
        if (!AppState.precons.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No precons available";
          Dom.preconSelect.appendChild(opt);
          return;
        }
        AppState.precons.forEach((p, idx) => {
          const opt = document.createElement("option");
          opt.value = String(idx);
          opt.textContent = p.name || `Precon ${idx + 1}`;
          Dom.preconSelect.appendChild(opt);
        });
        Dom.preconSelect.value = "0";
      },

      renderPrecon() {
        if (!AppState.precons.length) {
          Dom.preconDesc.textContent = "";
          Dom.preconStats.textContent = "";
          Dom.preconList.innerHTML = "<div class='small-note'>No precon decks available.</div>";
          return;
        }
        const idx = Number(Dom.preconSelect.value) || 0;
        const p = AppState.precons[idx] || AppState.precons[0];

        Dom.preconDesc.textContent = p.notes || "";
        Dom.preconList.innerHTML = "";

        const entries = Object.entries(p.cards || {});
        if (!entries.length) {
          Dom.preconList.innerHTML = "<div class='small-note'>This precon has no cards.</div>";
          Dom.preconStats.textContent = "";
          return;
        }

        let total = 0;
        const typeCounts = {};
        let vehicleCount = 0;

        entries
          .sort(([aId],[bId]) => {
            const a = CardData.getCardById(aId);
            const b = CardData.getCardById(bId);
            if (!a || !b) return 0;
            return (a.type || "").localeCompare(b.type || "") ||
                   (a.name || "").localeCompare(b.name || "");
          })
          .forEach(([cardId, qty]) => {
            const card = CardData.getCardById(cardId);
            const n = Number(qty) || 0;
            total += n;
            if (card) {
              const t = card.type || "Unknown";
              typeCounts[t] = (typeCounts[t] || 0) + n;
              if (t === "Vehicle" || t === "Named Vehicle") vehicleCount += n;
            }

            const row = document.createElement("div");
            row.className = "deck-row";

            const info = document.createElement("div");
            info.className = "deck-row-info";

            const main = document.createElement("div");
            main.className = "deck-row-main";
            main.textContent = `${qty}x ${card ? card.name : "(Unknown card)"}`;

            const sub = document.createElement("div");
            sub.className = "deck-row-sub";
            if (card) {
              const setLabel = card.setName || "";
              const num = card.cardNumber ? ` #${card.cardNumber}` : "";
              sub.textContent = `[${card.type}] ${setLabel}${num}`;
            } else {
              sub.textContent = cardId;
            }

            info.appendChild(main);
            info.appendChild(sub);

            row.appendChild(info);
            Dom.preconList.appendChild(row);

            row.addEventListener("click", () => {
              if (card) {
                selectedCardId = card.id;
                CardBrowser.renderDetail(card);
                ModeSwitcher.setMode("cards");
                window.scrollTo({ top: 0, behavior: "smooth" });
              }
            });
          });

        const orderedTypes = [
          "Vehicle","Named Vehicle","Driver","Named Driver",
          "Crew","Mod","Track","Condition"
        ];
        const parts = [];
        orderedTypes.forEach(t => {
          if (typeCounts[t]) parts.push(`${t}: ${typeCounts[t]}`);
        });
        Object.entries(typeCounts).forEach(([t,c]) => {
          if (!orderedTypes.includes(t)) parts.push(`${t}: ${c}`);
        });

        const legalIssues = [];
        if (total !== 50) {
          legalIssues.push(`Not 50 cards (current: ${total}).`);
        }
        if (vehicleCount < 2) {
          legalIssues.push(`Has fewer than 2 Vehicle / Named Vehicle cards (current: ${vehicleCount}).`);
        }

        const legalSummary =
          legalIssues.length === 0
            ? "✅ This precon is a legal 50-card deck."
            : "⚠️ This precon does not meet all deck rules.";

        Dom.preconStats.textContent =
          `Total: ${total}` +
          (parts.length ? " · " + parts.join(" · ") : "") +
          " · " + legalSummary;
      },

      init() {
        Dom.preconSelect.addEventListener("change", () => PreconViewer.renderPrecon());
        Dom.refreshPreconsBtn.addEventListener("click", () => PreconViewer.loadPrecons());
      }
    };

    // ========= MODULE: ModeSwitcher =========
    const ModeSwitcher = {
      setMode(mode) {
        if (mode === "cards") {
          Dom.cardsLayout.style.display = "grid";
          Dom.deckbuilderLayout.style.display = "none";
          Dom.preconsLayout.style.display = "none";
          Dom.compareLayout.style.display = "none";
          Dom.modeCardsBtn.classList.add("active");
          Dom.modeDeckBtn.classList.remove("active");
          Dom.modePreconsBtn.classList.remove("active");
          Dom.modeCompareBtn.classList.remove("active");
        } else if (mode === "deck") {
          Dom.cardsLayout.style.display = "none";
          Dom.deckbuilderLayout.style.display = "block";
          Dom.preconsLayout.style.display = "none";
          Dom.compareLayout.style.display = "none";
          Dom.modeCardsBtn.classList.remove("active");
          Dom.modeDeckBtn.classList.add("active");
          Dom.modePreconsBtn.classList.remove("active");
          Dom.modeCompareBtn.classList.remove("active");
        } else if (mode === "precons") {
          Dom.cardsLayout.style.display = "none";
          Dom.deckbuilderLayout.style.display = "none";
          Dom.preconsLayout.style.display = "block";
          Dom.compareLayout.style.display = "none";
          Dom.modeCardsBtn.classList.remove("active");
          Dom.modeDeckBtn.classList.remove("active");
          Dom.modePreconsBtn.classList.add("active");
          Dom.modeCompareBtn.classList.remove("active");
        } else if (mode === "compare") {
          Dom.cardsLayout.style.display = "none";
          Dom.deckbuilderLayout.style.display = "none";
          Dom.preconsLayout.style.display = "none";
          Dom.compareLayout.style.display = "block";
          Dom.modeCardsBtn.classList.remove("active");
          Dom.modeDeckBtn.classList.remove("active");
          Dom.modePreconsBtn.classList.remove("active");
          Dom.modeCompareBtn.classList.add("active");
          CompareModule.renderViewer();
        }
      },

      init() {
        Dom.modeCardsBtn.addEventListener("click", () => ModeSwitcher.setMode("cards"));
        Dom.modeDeckBtn.addEventListener("click", () => ModeSwitcher.setMode("deck"));
        Dom.modePreconsBtn.addEventListener("click", () => ModeSwitcher.setMode("precons"));
        Dom.modeCompareBtn.addEventListener("click", () => ModeSwitcher.setMode("compare"));
      }
    };

    // ========= APP INIT =========
    (async function main() {
      ModeSwitcher.init();
      DeckManager.init();
      CompareModule.init();
      PreconViewer.init();
      CardBrowser.init();

      await CardData.load();
      CardBrowser.populateFilterOptions();
      CardBrowser.renderGrid();
      DeckManager.renderDeck();
      CompareModule.populateSelectOptions();
      await PreconViewer.loadPrecons();

      ModeSwitcher.setMode("cards");
    })();
  </script>
</body>
</html>
