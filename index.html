<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRIVE TCG – Card Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0f172a, #020617 55%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .app { max-width: 1280px; margin: 0 auto; padding: 1rem 1.25rem 2.5rem; }

    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    header h1 { margin: 0; font-size: 1.4rem; letter-spacing: 0.04em; }
    header p { margin: 0; font-size: 0.8rem; color: #9ca3af; }

    .panel {
      border-radius: 1rem;
      border: 1px solid #1f2937;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), #020617);
      padding: 0.75rem;
      box-shadow: 0 20px 45px rgba(0, 0, 0, 0.8);
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 0.75rem;
    }

    @media (max-width: 1080px) {
      .layout-main { grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr); grid-template-rows: auto auto; }
      .detail-column { grid-column: 1 / -1; }
    }

    @media (max-width: 760px) { .layout-main { grid-template-columns: 1fr; } }

    h2 { margin: 0 0 0.5rem; font-size: 1rem; letter-spacing: 0.03em; }

    .small-note { font-size: 0.78rem; color: #9ca3af; margin: 0.1rem 0; }

    .controls { display: flex; flex-direction: column; gap: 0.5rem; }

    .field { display: flex; flex-direction: column; gap: 0.25rem; }
    .field label { font-size: 0.8rem; color: #9ca3af; }

    input[type="text"], select {
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 0.25rem 0.5rem;
      font-size: 0.82rem;
      outline: none;
      min-height: 1.9rem;
    }

    input[type="text"]:focus, select:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
    }

    .chip-row { display: flex; flex-wrap: wrap; gap: 0.25rem; }
    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      color: #cbd5f5;
    }
    .chip-primary { border-color: #60a5fa; background: radial-gradient(circle at top left, #1d4ed8, #020617); }
    .chip-muted { opacity: 0.8; }

    .cards-grid {
      margin-top: 0.25rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.5rem;
      max-height: calc(100vh - 240px);
      overflow-y: auto;
      padding-right: 0.25rem;
    }

    .card-tile {
      border-radius: 0.6rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.16), #020617);
      padding: 0.4rem 0.45rem;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.78rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
      transition: transform 0.08s ease, box-shadow 0.1s ease, border-color 0.1s ease;
    }

    .card-tile:hover {
      transform: translateY(-1px);
      border-color: #3b82f6;
      box-shadow: 0 16px 30px rgba(37, 99, 235, 0.4);
    }

    .card-tile.selected {
      border-color: #facc15;
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.9), 0 14px 30px rgba(234, 179, 8, 0.4);
    }

    .card-tile-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-tile-row { display: flex; justify-content: space-between; gap: 0.3rem; align-items: baseline; }
    .card-tile-type { font-size: 0.73rem; color: #9ca3af; }
    .card-tile-set { font-size: 0.73rem; color: #c4b5fd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-tile-rarity { font-size: 0.72rem; color: #a7f3d0; }
    .card-tile-tags { display: flex; flex-wrap: wrap; gap: 0.2rem; }

    .status-line { font-size: 0.78rem; color: #9ca3af; margin-top: 0.15rem; }
    .status-line span { color: #e5e7eb; }

    .detail-card {
      border-radius: 0.9rem;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.16), #020617);
      padding: 0.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      min-height: 200px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.8);
    }

    .detail-header { display: flex; justify-content: space-between; gap: 0.5rem; align-items: baseline; flex-wrap: wrap; }
    .detail-name { font-size: 1.05rem; font-weight: 600; }
    .detail-type { font-size: 0.8rem; color: #9ca3af; }

    .detail-columns { display: flex; gap: 0.6rem; flex-wrap: wrap; }

    .detail-image {
      flex: 0 0 42%;
      max-width: 42%;
      background: #020617;
      border-radius: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      min-height: 160px;
    }

    .detail-image img { max-width: 100%; max-height: 260px; object-fit: contain; }

    .detail-meta {
      flex: 1;
      min-width: 0;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .detail-row-label { font-weight: 600; color: #e5e7eb; margin-right: 0.25rem; }

    .detail-rules {
      border-radius: 0.6rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.98);
      padding: 0.45rem 0.55rem;
      font-size: 0.78rem;
      white-space: pre-wrap;
    }

    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 0.05rem 0.4rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>DRIVE TCG – Card Library</h1>
        <p>Search and browse the released DRIVE cards.</p>
      </div>
      <div>
        <p class="small-note">
          Data from <span class="inline-code">drive-card.json</span>.
        </p>
      </div>
    </header>

    <section class="panel">
      <div class="layout-main">
        <!-- LEFT: Filters -->
        <div>
          <h2>Filters</h2>
          <div class="controls">
            <div class="field">
              <label for="searchInput">Search</label>
              <input id="searchInput" type="text" placeholder="Name, type, set, tags, text…" />
            </div>

            <div class="field">
              <label for="typeFilter">Type</label>
              <select id="typeFilter">
                <option value="">All Types</option>
              </select>
            </div>

            <div class="field">
              <label for="setFilter">Set</label>
              <select id="setFilter">
                <option value="">All Sets</option>
              </select>
            </div>

            <div class="field">
              <label for="rarityFilter">Rarity</label>
              <select id="rarityFilter">
                <option value="">All Rarities</option>
              </select>
            </div>

            <div class="field">
              <label for="preconFilter">Precon</label>
              <select id="preconFilter">
                <option value="">All Cards</option>
              </select>
            </div>

            <p id="filterStatus" class="status-line"></p>
            <p id="preconStatus" class="status-line"></p>
          </div>
        </div>

        <!-- MIDDLE: Card grid -->
        <div>
          <h2>Cards</h2>
          <div id="cardsGrid" class="cards-grid">
            <p class="small-note">Loading card data…</p>
          </div>
        </div>

        <!-- RIGHT: Detail view -->
        <div class="detail-column">
          <h2>Details</h2>
          <div id="detailCard" class="detail-card">
            <p class="small-note">Select a card from the list to see full details.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // --------------------------------------------------------------------
    // RELEASE CONTROL: limit which sets appear on the public site.
    // --------------------------------------------------------------------
    //
    // If RELEASED_SETS is:
    //   - null or []:  all sets in drive-card.json will be shown.
    //   - an array:    only printings with setId in that array are visible.
    //
    const RELEASED_SETS = null;
    // const RELEASED_SETS = ["SET 1", "SET 2"];

    const AppState = {
      cards: [],
      filteredCards: [],
      selectedCardId: null,
      sets: [],
      types: [],
      rarities: [],
      precons: [],
      selectedPreconId: ""
    };

    const Dom = {
      searchInput: document.getElementById("searchInput"),
      typeFilter: document.getElementById("typeFilter"),
      setFilter: document.getElementById("setFilter"),
      rarityFilter: document.getElementById("rarityFilter"),
      preconFilter: document.getElementById("preconFilter"),
      filterStatus: document.getElementById("filterStatus"),
      preconStatus: document.getElementById("preconStatus"),
      cardsGrid: document.getElementById("cardsGrid"),
      detailCard: document.getElementById("detailCard")
    };

    // ---------------------------- Helpers ----------------------------

    function parseTags(str) {
      if (!str) return [];
      return String(str)
        .split(/[;,]/)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function parseHpCon(val) {
      const out = { hp: undefined, con: undefined };
      if (!val) return out;
      const cleaned = String(val).replace(/\s/g, "");
      const parts = cleaned.split("/");
      if (parts[0] !== undefined && parts[0] !== "") out.hp = Number(parts[0]);
      if (parts[1] !== undefined && parts[1] !== "") out.con = Number(parts[1]);
      return out;
    }

    function isSetReleased(setId) {
      if (!setId) return true;
      if (!RELEASED_SETS || !RELEASED_SETS.length) return true;
      return RELEASED_SETS.includes(setId);
    }

    function normalizeRarity(raw) {
      const s = String(raw || "").trim();
      if (!s) return "";
      const key = s.toLowerCase();
      const map = {
        common: "Common",
        uncommon: "Uncommon",
        rare: "Rare",
        epic: "Epic",
        legendary: "Legendary",
        promo: "Promo"
      };
      return map[key] || (s[0].toUpperCase() + s.slice(1).toLowerCase());
    }

    function normalizeType(raw) {
      const s = String(raw || "").trim();
      if (!s) return "";
      const key = s.toLowerCase();
      const map = {
        "named driver": "Named Driver",
        "named vehicle": "Named Vehicle",
        driver: "Driver",
        vehicle: "Vehicle",
        mod: "Mod",
        track: "Track",
        condition: "Condition",
        crew: "Crew"
      };
      return map[key] || s;
    }

    function normalizePrints(card) {
      if (!card) return;

      if (!Array.isArray(card.prints)) card.prints = [];

      if (!card.prints.length && (card.setName || card.cardNumber)) {
        card.prints.push({
          setId: card.setName || "",
          cardNumber: card.cardNumber || ""
        });
      }

      const primary = card.prints[0];
      if (primary) {
        card.setName = primary.setId || card.setName || "";
        card.cardNumber = primary.cardNumber || card.cardNumber || "";
      } else {
        card.setName = card.setName || "";
        card.cardNumber = card.cardNumber || "";
      }

      card.visiblePrints = (card.prints || []).filter(p => isSetReleased(p.setId));
    }

    const CardData = {
      getVehicleTypes(card) {
        if (!card) return [];
        if (Array.isArray(card.vehicleTypes) && card.vehicleTypes.length) return card.vehicleTypes;
        const e = card.extra || {};
        if (Array.isArray(e.vehicleTypes) && e.vehicleTypes.length) return e.vehicleTypes;
        if (e.vehicleType) return [e.vehicleType];
        return [];
      },
      getModStats(card) {
        if (!card || card.type !== "Mod") return null;
        const e = card.extra || {};
        const parts = [];
        if (e.modLevel1) parts.push(`L1 ${e.modLevel1}`);
        if (e.modLevel2) parts.push(`L2 ${e.modLevel2}`);
        if (e.modLevel3) parts.push(`L3 ${e.modLevel3}`);
        if (e.modLevel4) parts.push(`L4 ${e.modLevel4}`);
        if (!parts.length && !e.modBasePart) return null;
        const label = e.modType ? `${e.modType} ${e.modBasePart || "Mod"}` : (e.modBasePart || "Mod");
        return parts.length ? `${label}: ${parts.join(" / ")}` : label;
      },
      getVehicleStats(card) {
        if (!card || (card.type !== "Vehicle" && card.type !== "Named Vehicle")) return null;
        const e = card.extra || {};
        const bits = [];
        if (e.hp !== undefined || e.con !== undefined) {
          bits.push(`HP/CON: ${(e.hp ?? "?")}/${(e.con ?? "?")}`);
        }
        if (e.pitCost !== undefined) bits.push(`PIT: ${e.pitCost}`);
        return bits.length ? bits.join(" | ") : null;
      }
    };

    // ---------------------------- Precons ----------------------------

    function loadPrecons() {
      return fetch("precon.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch precon.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json)) throw new Error("precon.json is not an array.");
          AppState.precons = json;

          Dom.preconFilter.innerHTML = '<option value="">All Cards</option>';
          AppState.precons.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.name || p.id;
            Dom.preconFilter.appendChild(opt);
          });
        })
        .catch(err => {
          console.warn("[precon.json]", err);
          AppState.precons = [];
          Dom.preconFilter.innerHTML = '<option value="">All Cards</option>';
        });
    }

    function getSelectedPreconCardSet() {
      const pid = AppState.selectedPreconId;
      if (!pid) return null;
      const precon = AppState.precons.find(p => p.id === pid);
      if (!precon || !precon.cards) return null;
      return new Set(Object.keys(precon.cards));
    }

    function renderPreconStatus() {
      const pid = AppState.selectedPreconId;
      if (!pid) {
        Dom.preconStatus.textContent = "";
        return;
      }

      const precon = AppState.precons.find(p => p.id === pid);
      if (!precon) {
        Dom.preconStatus.textContent = "";
        return;
      }

      const ids = Object.keys(precon.cards || {});
      const totalCards = ids.reduce((sum, id) => sum + (precon.cards[id] || 0), 0);

      // Since library is unfinished, we report missing IDs rather than erroring.
      const cardIdSet = new Set(AppState.cards.map(c => c.id));
      const missing = ids.filter(id => !cardIdSet.has(id));

      Dom.preconStatus.innerHTML =
        `Precon: <span>${totalCards}</span> cards · Missing: <span>${missing.length}</span>`;
    }

    // ---------------------------- Cards load ----------------------------

    function loadCards() {
      Dom.cardsGrid.innerHTML = "<p class='small-note'>Loading card data…</p>";
      return fetch("drive-card.json")
        .then(res => {
          if (!res.ok) throw new Error("Failed to fetch drive-card.json");
          return res.json();
        })
        .then(json => {
          if (!Array.isArray(json)) throw new Error("drive-card.json is not an array.");

          AppState.cards = json.map(raw => {
            const card = Object.assign({}, raw);

            card.type = normalizeType(card.type);
            card.rarity = normalizeRarity(card.rarity);

            if (!card.extra) card.extra = {};
            if (!Array.isArray(card.tags)) card.tags = parseTags(card.tags);
            if (typeof card.imageUrl !== "string") card.imageUrl = card.imageUrl || "";

            normalizePrints(card);

            if (!Array.isArray(card.vehicleTypes)) {
              const vt = card.extra.vehicleTypes || card.extra.vehicleType || [];
              card.vehicleTypes = Array.isArray(vt) ? vt : (vt ? [vt] : []);
            }

            if ((card.type === "Vehicle" || card.type === "Named Vehicle") &&
                !("hp" in card.extra) && !("con" in card.extra)) {
              const fromField = card.extra.hpCon || card.vehicleHpCon || card.HP_CON || "";
              const parsed = parseHpCon(fromField);
              if (parsed.hp !== undefined) card.extra.hp = parsed.hp;
              if (parsed.con !== undefined) card.extra.con = parsed.con;
            }

            return card;
          });

          // If release filtering is enabled, hide cards with no visible printings.
          AppState.cards = AppState.cards.filter(card => {
            if (!card.prints || !card.prints.length) {
              if (!RELEASED_SETS || !RELEASED_SETS.length) {
                card.visiblePrints = [];
                return true;
              }
              return false;
            }
            return card.visiblePrints && card.visiblePrints.length > 0;
          });

          extractFilterValues();
          applyFiltersAndRender();
        })
        .catch(err => {
          console.error(err);
          Dom.cardsGrid.innerHTML =
            "<p class='small-note'>Error loading drive-card.json. Check the console for details.</p>";
        });
    }

    function extractFilterValues() {
      const types = new Set();
      const sets = new Set();
      const rarities = new Set();

      AppState.cards.forEach(card => {
        if (card.type) types.add(card.type);
        if (card.rarity) rarities.add(card.rarity);
        (card.visiblePrints || []).forEach(p => { if (p.setId) sets.add(p.setId); });
      });

      AppState.types = Array.from(types).sort();
      AppState.sets = Array.from(sets).sort();
      AppState.rarities = Array.from(rarities).sort();

      Dom.typeFilter.innerHTML = '<option value="">All Types</option>';
      AppState.types.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        Dom.typeFilter.appendChild(opt);
      });

      Dom.setFilter.innerHTML = '<option value="">All Sets</option>';
      AppState.sets.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        Dom.setFilter.appendChild(opt);
      });

      Dom.rarityFilter.innerHTML = '<option value="">All Rarities</option>';
      AppState.rarities.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        Dom.rarityFilter.appendChild(opt);
      });
    }

    function applyFiltersAndRender() {
      const q = Dom.searchInput.value.toLowerCase().trim();
      const typeFilter = Dom.typeFilter.value;
      const setFilter = Dom.setFilter.value;
      const rarityFilter = Dom.rarityFilter.value;

      let cards = AppState.cards.slice();

      // Precon filter (if selected)
      const preconSet = getSelectedPreconCardSet();
      if (preconSet) {
        cards = cards.filter(c => preconSet.has(c.id));
      }

      cards = cards.filter(card => {
        const prints = card.visiblePrints || [];
        if (prints.length === 0 && setFilter) return false;

        if (typeFilter && card.type !== typeFilter) return false;
        if (rarityFilter && card.rarity !== rarityFilter) return false;

        if (setFilter) {
          if (!prints.some(p => p.setId === setFilter)) return false;
        }

        if (q) {
          const setBits = (prints || [])
            .map(p => `${p.setId || ""} ${p.cardNumber || ""}`.trim())
            .filter(Boolean);

          const vtBits = (CardData.getVehicleTypes(card) || []).filter(Boolean);
          const tagBits = (card.tags || []).filter(Boolean);

          const e = card.extra || {};
          const extraBits = [
            e.modType,
            e.modBasePart,
            e.modLevel1,
            e.modLevel2,
            e.modLevel3,
            e.modLevel4
          ].filter(Boolean);

          const textParts = [
            card.name,
            card.type,
            card.rarity,
            card.setName,
            card.cardNumber,
            ...setBits,
            ...vtBits,
            ...tagBits,
            ...extraBits,
            (card.notes || "").replace(/\s+/g, " ")
          ];

          const haystack = textParts.join(" | ").toLowerCase();
          if (!haystack.includes(q)) return false;
        }

        return true;
      });

      // Sort: type → setId → cardNumber → name
      cards.sort((a, b) => {
        const t = (a.type || "").localeCompare(b.type || "");
        if (t !== 0) return t;

        const ap = (a.visiblePrints && a.visiblePrints[0]) ? a.visiblePrints[0] : null;
        const bp = (b.visiblePrints && b.visiblePrints[0]) ? b.visiblePrints[0] : null;

        const aset = (ap?.setId || a.setName || "");
        const bset = (bp?.setId || b.setName || "");
        const s = aset.localeCompare(bset);
        if (s !== 0) return s;

        const anum = (ap?.cardNumber || a.cardNumber || "");
        const bnum = (bp?.cardNumber || b.cardNumber || "");
        const n = anum.localeCompare(bnum);
        if (n !== 0) return n;

        return (a.name || "").localeCompare(b.name || "");
      });

      AppState.filteredCards = cards;
      renderCardsGrid();
      renderFilterStatus();
      renderPreconStatus();
      renderDetailCard();
    }

    function renderFilterStatus() {
      const total = AppState.cards.length;
      const shown = AppState.filteredCards.length;
      Dom.filterStatus.innerHTML = `Showing <span>${shown}</span> of <span>${total}</span> cards.`;
    }

    function renderCardsGrid() {
      const grid = Dom.cardsGrid;
      grid.innerHTML = "";

      if (!AppState.filteredCards.length) {
        grid.innerHTML = "<p class='small-note'>No cards match the current filters.</p>";
        return;
      }

      AppState.filteredCards.forEach(card => {
        const tile = document.createElement("div");
        tile.className = "card-tile";
        if (card.id === AppState.selectedCardId) tile.classList.add("selected");

        const header = document.createElement("div");
        header.className = "card-tile-name";
        header.textContent = card.name || "(No Name)";

        const row1 = document.createElement("div");
        row1.className = "card-tile-row";
        const typeSpan = document.createElement("span");
        typeSpan.className = "card-tile-type";
        typeSpan.textContent = card.type || "";
        const raritySpan = document.createElement("span");
        raritySpan.className = "card-tile-rarity";
        raritySpan.textContent = card.rarity || "";
        row1.appendChild(typeSpan);
        row1.appendChild(raritySpan);

        const row2 = document.createElement("div");
        row2.className = "card-tile-row";
        const sets = (card.visiblePrints || []).map(p => p.setId).filter(Boolean);
        const setSpan = document.createElement("span");
        setSpan.className = "card-tile-set";
        setSpan.textContent = sets.length ? sets.join(" & ") : "—";
        row2.appendChild(setSpan);

        const tagsRow = document.createElement("div");
        tagsRow.className = "card-tile-tags";
        const tags = card.tags || [];
        if (tags.length) {
          tags.slice(0, 3).forEach(t => {
            const chip = document.createElement("span");
            chip.className = "chip chip-muted";
            chip.textContent = t;
            tagsRow.appendChild(chip);
          });
          if (tags.length > 3) {
            const extra = document.createElement("span");
            extra.className = "chip chip-muted";
            extra.textContent = `+${tags.length - 3}`;
            tagsRow.appendChild(extra);
          }
        }

        tile.appendChild(header);
        tile.appendChild(row1);
        tile.appendChild(row2);
        if (tags.length) tile.appendChild(tagsRow);

        tile.addEventListener("click", () => {
          AppState.selectedCardId = card.id;
          renderCardsGrid();
          renderDetailCard();
        });

        grid.appendChild(tile);
      });
    }

    function renderDetailCard() {
      const container = Dom.detailCard;
      container.innerHTML = "";

      const card = AppState.cards.find(c => c.id === AppState.selectedCardId);
      if (!card) {
        container.innerHTML = "<p class='small-note'>Select a card from the list to see its full details.</p>";
        return;
      }

      const header = document.createElement("div");
      header.className = "detail-header";
      const nameEl = document.createElement("div");
      nameEl.className = "detail-name";
      nameEl.textContent = card.name || "(No Name)";
      const typeEl = document.createElement("div");
      typeEl.className = "detail-type";
      typeEl.textContent = card.type || "";
      header.appendChild(nameEl);
      header.appendChild(typeEl);

      const columns = document.createElement("div");
      columns.className = "detail-columns";

      const imgBox = document.createElement("div");
      imgBox.className = "detail-image";
      if (card.imageUrl) {
        const img = document.createElement("img");
        img.src = card.imageUrl;
        img.alt = card.name || "Card image";
        imgBox.appendChild(img);
      } else {
        const placeholder = document.createElement("span");
        placeholder.className = "small-note";
        placeholder.textContent = "No image";
        imgBox.appendChild(placeholder);
      }

      const meta = document.createElement("div");
      meta.className = "detail-meta";

      const setsRow = document.createElement("div");
      const setsLabel = document.createElement("span");
      setsLabel.className = "detail-row-label";
      setsLabel.textContent = "Set(s):";
      setsRow.appendChild(setsLabel);

      const setChips = document.createElement("div");
      setChips.className = "chip-row";
      const prints = card.visiblePrints || [];
      if (!prints.length && (!RELEASED_SETS || !RELEASED_SETS.length)) {
        const chip = document.createElement("span");
        chip.className = "chip chip-muted";
        chip.textContent = card.setName || "—";
        setChips.appendChild(chip);
      } else if (!prints.length) {
        const chip = document.createElement("span");
        chip.className = "chip chip-muted";
        chip.textContent = "Hidden (unreleased set)";
        setChips.appendChild(chip);
      } else {
        prints.forEach(p => {
          const label = p.cardNumber ? `${p.setId} – ${p.cardNumber}` : p.setId;
          const chip = document.createElement("span");
          chip.className = "chip chip-primary";
          chip.textContent = label;
          setChips.appendChild(chip);
        });
      }
      setsRow.appendChild(setChips);

      const rarityRow = document.createElement("div");
      const rarityLabel = document.createElement("span");
      rarityLabel.className = "detail-row-label";
      rarityLabel.textContent = "Rarity:";
      const rarityVal = document.createElement("span");
      rarityVal.textContent = card.rarity || "—";
      rarityRow.appendChild(rarityLabel);
      rarityRow.appendChild(rarityVal);

      const vtRow = document.createElement("div");
      const vtLabel = document.createElement("span");
      vtLabel.className = "detail-row-label";
      vtLabel.textContent = "Vehicle Types:";
      const vtVal = document.createElement("span");
      const vt = CardData.getVehicleTypes(card);
      vtVal.textContent = vt.length ? vt.join(", ") : "—";
      vtRow.appendChild(vtLabel);
      vtRow.appendChild(vtVal);

      const tagsRow = document.createElement("div");
      const tagsLabel = document.createElement("span");
      tagsLabel.className = "detail-row-label";
      tagsLabel.textContent = "Tags:";
      const tagsVal = document.createElement("span");
      const tags = card.tags || [];
      tagsVal.textContent = tags.length ? tags.join(", ") : "—";
      tagsRow.appendChild(tagsLabel);
      tagsRow.appendChild(tagsVal);

      const statsRow = document.createElement("div");
      const statsLabel = document.createElement("span");
      statsLabel.className = "detail-row-label";
      statsLabel.textContent = "Stats:";
      const statsVal = document.createElement("span");
      const modStats = CardData.getModStats(card);
      const vehStats = CardData.getVehicleStats(card);
      const pieces = [];
      if (modStats) pieces.push(modStats);
      if (vehStats) pieces.push(vehStats);
      statsVal.textContent = pieces.length ? pieces.join(" | ") : "—";
      statsRow.appendChild(statsLabel);
      statsRow.appendChild(statsVal);

      meta.appendChild(setsRow);
      meta.appendChild(rarityRow);
      meta.appendChild(vtRow);
      meta.appendChild(tagsRow);
      meta.appendChild(statsRow);

      columns.appendChild(imgBox);
      columns.appendChild(meta);

      const rules = document.createElement("div");
      rules.className = "detail-rules";
      rules.textContent = card.notes || "No rules text.";

      container.appendChild(header);
      container.appendChild(columns);
      container.appendChild(rules);
    }

    // ---------------------------- Init ----------------------------

    function init() {
      Dom.searchInput.addEventListener("input", applyFiltersAndRender);
      Dom.typeFilter.addEventListener("change", applyFiltersAndRender);
      Dom.setFilter.addEventListener("change", applyFiltersAndRender);
      Dom.rarityFilter.addEventListener("change", applyFiltersAndRender);

      Dom.preconFilter.addEventListener("change", () => {
        AppState.selectedPreconId = Dom.preconFilter.value;
        applyFiltersAndRender();
      });

      // Load precons (if missing, we still run fine), then load cards.
      loadPrecons().finally(() => loadCards());
    }

    init();
  </script>
</body>
</html>
